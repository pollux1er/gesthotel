<?php if (!@$framed and !@$_GET['framed'] and !@$_POST['framed']) { ?><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
        "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>  </title>
<style type="text/css">
 .tab_disp {font-size:70%;}
 .t_book {  border-radius: 8px; }
 .t_book td {  border-radius: 8px; }
 div.agreem { max-width: 600px; border: 1px solid black; padding: 3px; }
 select { background-color: #ffffff; }
</style>
</head>
<body style="background-color: #ffffff; color: #000000; padding: 0; margin: 0;">


<div style="text-align: center; padding: 10px;"><big><big>
Check availability</big></big><br><br>

<table style="margin-left: auto;  margin-right: auto; background-color: #ebebeb; border-radius: 14px;" border=1 cellspacing=0 cellpadding=16>
<tr><td style=" border-radius: 14px;">
<table style="text-align: left; margin-left: 0;" border=0 cellspacing=0 cellpadding=0><tr><td>





<!-- END OF THE FIRST PART OF CUSTOM HTML  -->


<?php
} # fine if (!$framed and !$_GET['framed'] and !$_POST['framed'])


# BEGINNING OF MODIFIABLE VARIABLES (modify the value on the right)

# Insert in this variable the name of the page if $PHP_SELF is not defined
$var_page_name = "";

$var_year = 2014;
$var_db_type = "mysql";
$var_db_name = "hotel";
$var_db_host = "localhost";
$var_db_port = "3306";
$var_db_user = "root";
$var_db_password = "";
$var_db_load_extension = "NO";
$var_db_tables_prefix = "t1";
$var_template_language = "fr";
$var_money_format = "europe";
$var_dates_format = "europe";
$var_currency_name_in_front = "NO";
$var_lists_user = "test";
$var_extend_last_date = "YES";
$var_periods_no_requests = "0";
$var_rates_to_show = array( 1 => "YES", 2 => "YES", 3 => "YES", 4 => "YES", 5 => "YES", 6 => "YES", 7 => "YES", 8 => "YES");
$var_imposed_rates_names = array();
$var_ask_number_apartments_for_type = "YES";
$var_maximum_number_apartments_for_type = "0";
$var_add_other_types = "YES";
$var_maximum_number_other_types = "3";
$var_ask_people_number = "YES";
$var_maximum_number_people = "0";
$var_cost_add_beds = "";
$var_maximum_number_extra_beds = "2";
$var_add_extra_costs = "YES";
$var_ask_for_extra_costs_in_insertion_page = "YES";
$var_extra_costs_columns_number = "2";
$var_extra_costs_to_show = array();
$var_imposed_extra_costs_names = array();
$var_imposed_extra_costs_categories = array();
$var_assign_with_rule1 = "YES";
$var_motivations_of_rule1_to_consider = array();
$var_show_alternative_phrase_for_rule1 = "NO";
$var_show_deposit = "YES";
$var_show_request_by_mail = "YES";
$var_email_address = "";
$var_send_copy_of_request_email = "NO";
$var_masquerade_email_envelope = "YES";
$var_show_full_days = "NO";
$var_show_paypal_button = "NO";
$var_paypal_template_name = "";
$var_message_user = "admin";
$var_reservation_origin = "";

$var_ask_surname = "YES";
$var_ask_name = "YES";
$var_ask_email = "YES";
$var_ask_sex = "NO";
$var_ask_birthdate = "NO";
$var_ask_document = "NO";
$var_ask_nation = "optional";
$var_ask_city = "NO";
$var_ask_region = "NO";
$var_ask_street = "NO";
$var_ask_housenumber = "NO";
$var_ask_postalcode = "NO";
$var_ask_telephone = "optional";
$var_ask_telephone2 = "NO";
$var_ask_telephone3 = "NO";
$var_ask_fax = "NO";
$var_ask_comment = "optional";
$var_ask_checkintime = "NO";
$var_ask_paymentmethod = "NO";
$var_payment_methods_to_ask = array();
$var_imposed_payment_methods_names = array();
$var_custom_form_fields = array();
$var_ask_custom_form_fields = array();
$var_doc_conditions_form_fields = array();
$var_ask_doc_conditions_form_fields = array();

$var_show_availability_overview = "NO";
$var_group_availability_overview_with_rule_2 = "NO";
$var_group_availability_overview_with_people = "NO";
$var_background_color_availability_overview = "#dddddd";
$var_color_week_beginning_availability_overview = "#bbbbbb";
$var_color_free_availability_overview = "#0cc80c";
$var_color_full_availability_overview = "#f8011e";
$var_opening_font_availability_overview = "";
$var_closing_font_availability_overview = "";
$var_show_free_number_availability_overview = "NO";
$var_align_availability_with_arrival = "NO";

$var_show_dates_picker_calendar = "YES";
$var_calendar_box_style = "style=\"z-index: 1; visibility: hidden; position: absolute; top: 0px; left: 0px; background: #FFFFFF; padding: 2px; border: 1px solid #000000; font: bold 10px Verdana, Arial, Helvetica, sans-serif; color: #000000; text-align: center;\"";
$var_calendar_table_style = "style=\"border-collapse: collapse; font-size: 10px; margin-left: auto; margin-right: auto; cursor: default; text-align: center; padding: 2px\"";
$var_calendar_buttons_style = "style=\"font-size: 9px; padding: 0 3px 0 3px; border-color: #333333; border-width: 1px;\"";
$var_open_calendar_button_style = "style=\"padding: 0; border-color: #333333; border-width: 1px;\"";
$var_color_active_calendar_date = "#d8e1e6";
$var_color_selected_calendar_date = "#eeeeee";

$var_font_tag_opening = "";
$var_font_tag_closing = "";
$var_red_font_tag_opening = "<b style=\"color: red;\">";
$var_red_font_tag_closing = "</b>";
$var_reservation_table_style = "border=1 cellpadding=5 cellspacing=1";
$var_framed_css_file = "";
$var_open_new_window_from_frame = "NO";
$var_window_from_frame_width = "700";
$var_window_from_frame_height = "620";
$var_template_theme = "default";
$var_theme_color_1 = "#000000";
$var_theme_color_2 = "#ffffff";
$var_theme_color_3 = "#ebebeb";
$var_theme_value_1 = "";
$var_theme_value_2 = "";
$var_theme_value_3 = "Back to HOME";

# PHRASES
$var_phr_Currency_sing = "Euros";
$var_phr_Currency_plur = "Euros";
$var_phr_apartments = "rooms";
$var_phr_apartment = "room";
$var_phr_rule1_alternative = "Uncertain availability for the choosen type, contact us by email for more information";
$var_phr_in = "in";
$var_phr_There_is_not_availability_anymore = "There is not availability anymore";
$var_phr_Check_availability = "Check availability";
$var_phr_from = "from";
$var_phr_to = "to";
$var_phr_for_type = "for type";
$var_phr_rate = "rate";
$var_phr_Number_of = "Number of";
$var_phr_Add_a_new_type = "Add a new type";
$var_phr_Delete_this_type = "Delete this type";
$var_phr_for = "for";
$var_phr_Arrival_date = "Arrival date";
$var_phr_Departure_date = "Departure date";
$var_phr_Type = "Type";
$var_phr_Dates_are_wrong = "Dates are wrong";
$var_phr_Type_is_wrong = "The type is wrong";
$var_phr_The_number_of = "The number of";
$var_phr_inserted_is_wrong = "inserted is wrong";
$var_phr_word_the = "The";
$var_phr_word_week = "day";
$var_phr_is = "is";
$var_phr_full = "full";
$var_phr_There_is_not_availability_anymore_in_the_requested_period = "There is not availability anymore in the requested period";
$var_phr_There_is_still_availability = "There is still availability";
$var_phr_in_the_requested_period = "in the requested period";
$var_phr_in_the_requested_periods = "in the requested periods";
$var_phr_for_requested_types = "for requested types";
$var_phr_Period_of = "Period of";
$var_phr_word_weeks = "days";
$var_phr_type = "type";
$var_phr_There_is_still_not_rate_for_the_requested_type_etc = "There is still not any rate for the requested type in this period";
$var_fr_The_number_of_people_is_needed_etc = "The number of people is needed for this type";
$var_phr_Price = "Price";
$var_phr_Total = "Total";
$var_phr_Deposit = "Deposit";
$var_phr_including = "including";
$var_phr_of = "of";
$var_phr_Go_back = "Go back";
$var_phr_New_check = "New check";
$var_phr_Send_the_request_for_reservation = "Send the request for reservation";
$var_phr_Request_for_reservation_sent = "Request for reservation sent";
$var_phr_It_was_not_possible_to_send_the_request = "It was not possible to send the request";
$var_phr_Choose_the_weeks_to_be_applied_for = "Choose the days to be applied for";
$var_phr_people = "people";
$var_phr_person = "person";
$var_phr_Continue = "Continue";
$var_phr_for_each = "for each";
$var_phr_The_number_of_people_must_be_inserted_for = "The number of people must be inserted for";
$var_phr_Error_in_requested_optional_services = "Error in requested optional services";
$var_phr_with_selected_optional_services = "with selected optional services";
$var_phr_is_bigger_than_the_maximum_capacity_of_requested_type = "is bigger than the maximum capacity of requested type";
$var_phr_Indicative_availability_overview = "Indicative availability overview";
$var_phr_January = "January";
$var_phr_February = "February";
$var_phr_March = "March";
$var_phr_April = "April";
$var_phr_May = "May";
$var_phr_June = "June";
$var_phr_July = "July";
$var_phr_August = "August";
$var_phr_September = "September";
$var_phr_October = "October";
$var_phr_November = "November";
$var_phr_December = "December";
$var_phr_Surname = "Surname";
$var_phr_Name = "Name";
$var_phr_Email = "Email";
$var_phr_Comment = "Comment";
$var_phr_Gender = "Gender";
$var_phr_Birthdate = "Birthdate";
$var_phr_Document = "Document";
$var_phr_Nation = "Nation";
$var_phr_City = "City";
$var_phr_Region = "Region";
$var_phr_Street = "Street";
$var_phr_House_number = "House number";
$var_phr_Postal_code = "Postal code";
$var_phr_Telephone = "Telephone";
$var_phr_Second_telephone = "Second telephone";
$var_phr_Third_telephone = "Third telephone";
$var_phr_Fax = "Fax";
$var_phr_Estimated_arrival_time = "Estimated arrival time";
$var_phr_I_accept = "I accept";
$var_phr_Deposit_payment_method = "Deposit method";
$var_phr_required_fields = "<small>required fields</small>";
$var_phr_black_asterisk = "<small>*</small>";
$var_phr_red_asterisk = "<span style=\"color: red;\">*</span>";
$var_phr_male = "M";
$var_phr_female = "F";
$var_phr_Book = "Book";
$var_phr_from2 = "from";
$var_fr_OR_dashes = "--- OR ---";
$var_fr_Instant_booking_with_PayPal = "Instant booking with PayPal";
$var_phr_Close = "Close";
$var_phr_Reservation_request = "Reservation request";
$var_phr_We_have_received_your_reservation_request_etc = "We have received your reservation request and will answer as soon as possible";
$var_phr_A_copy_of_the_request_has_been_sent_to = "A copy of the request has been sent to";

# EMAIL PHRASES
$var_phre_Email = "Email";
$var_phre_Name = "Name";
$var_phre_Comment = "Comment";
$var_phre_Period = "Period";
$var_phre_from = "from";
$var_phre_to = "to";
$var_phre_Rate = "Rate";
$var_phre_Extra_costs = "Extra costs";
$var_phre_weeks = "";
$var_phre_Number_of_apartments = "Number of rooms";
$var_phre_Total_price = "Total price";
$var_phre_Reference = "Reference";
$var_phre_Reservation_request = "Reservation request";
$var_phre_Deposit = "Deposit";
$var_phre_People = "People";
$var_phre_Surname = "Surname";
$var_phre_Gender = "Gender";
$var_phre_Birthdate = "Birthdate";
$var_phre_Document = "Document";
$var_phre_Nation = "Nation";
$var_phre_City = "City";
$var_phre_Region = "Region";
$var_phre_Street = "Street";
$var_phre_House_number = "House number";
$var_phre_Postal_code = "Postal code";
$var_phre_Telephone = "Telephone";
$var_phre_Second_telephone = "Second telephone";
$var_phre_Third_telephone = "Third telephone";
$var_phre_Fax = "Fax";
$var_phre_Estimated_arrival_time = "Estimated arrival time";
$var_phre_Deposit_payment_method = "Deposit method";

# MENUS PERIODS
$var_menu_periods = "<option value=\"2014-01-01\">Jan 01 Me, 2014</option>
<option value=\"2014-01-02\">Jan 02 Je, 2014</option>
<option value=\"2014-01-03\">Jan 03 Ve, 2014</option>
<option value=\"2014-01-04\">Jan 04 Sa, 2014</option>
<option value=\"2014-01-05\">Jan 05 Di, 2014</option>
<option value=\"2014-01-06\">Jan 06 Lu, 2014</option>
<option value=\"2014-01-07\">Jan 07 Ma, 2014</option>
<option value=\"2014-01-08\">Jan 08 Me, 2014</option>
<option value=\"2014-01-09\">Jan 09 Je, 2014</option>
<option value=\"2014-01-10\">Jan 10 Ve, 2014</option>
<option value=\"2014-01-11\">Jan 11 Sa, 2014</option>
<option value=\"2014-01-12\">Jan 12 Di, 2014</option>
<option value=\"2014-01-13\">Jan 13 Lu, 2014</option>
<option value=\"2014-01-14\">Jan 14 Ma, 2014</option>
<option value=\"2014-01-15\">Jan 15 Me, 2014</option>
<option value=\"2014-01-16\">Jan 16 Je, 2014</option>
<option value=\"2014-01-17\">Jan 17 Ve, 2014</option>
<option value=\"2014-01-18\">Jan 18 Sa, 2014</option>
<option value=\"2014-01-19\">Jan 19 Di, 2014</option>
<option value=\"2014-01-20\">Jan 20 Lu, 2014</option>
<option value=\"2014-01-21\">Jan 21 Ma, 2014</option>
<option value=\"2014-01-22\">Jan 22 Me, 2014</option>
<option value=\"2014-01-23\">Jan 23 Je, 2014</option>
<option value=\"2014-01-24\">Jan 24 Ve, 2014</option>
<option value=\"2014-01-25\">Jan 25 Sa, 2014</option>
<option value=\"2014-01-26\">Jan 26 Di, 2014</option>
<option value=\"2014-01-27\">Jan 27 Lu, 2014</option>
<option value=\"2014-01-28\">Jan 28 Ma, 2014</option>
<option value=\"2014-01-29\">Jan 29 Me, 2014</option>
<option value=\"2014-01-30\">Jan 30 Je, 2014</option>
<option value=\"2014-01-31\">Jan 31 Ve, 2014</option>
<option value=\"2014-02-01\">Fev 01 Sa, 2014</option>
<option value=\"2014-02-02\">Fev 02 Di, 2014</option>
<option value=\"2014-02-03\">Fev 03 Lu, 2014</option>
<option value=\"2014-02-04\">Fev 04 Ma, 2014</option>
<option value=\"2014-02-05\">Fev 05 Me, 2014</option>
<option value=\"2014-02-06\">Fev 06 Je, 2014</option>
<option value=\"2014-02-07\">Fev 07 Ve, 2014</option>
<option value=\"2014-02-08\">Fev 08 Sa, 2014</option>
<option value=\"2014-02-09\">Fev 09 Di, 2014</option>
<option value=\"2014-02-10\">Fev 10 Lu, 2014</option>
<option value=\"2014-02-11\">Fev 11 Ma, 2014</option>
<option value=\"2014-02-12\">Fev 12 Me, 2014</option>
<option value=\"2014-02-13\">Fev 13 Je, 2014</option>
<option value=\"2014-02-14\">Fev 14 Ve, 2014</option>
<option value=\"2014-02-15\">Fev 15 Sa, 2014</option>
<option value=\"2014-02-16\">Fev 16 Di, 2014</option>
<option value=\"2014-02-17\">Fev 17 Lu, 2014</option>
<option value=\"2014-02-18\">Fev 18 Ma, 2014</option>
<option value=\"2014-02-19\">Fev 19 Me, 2014</option>
<option value=\"2014-02-20\">Fev 20 Je, 2014</option>
<option value=\"2014-02-21\">Fev 21 Ve, 2014</option>
<option value=\"2014-02-22\">Fev 22 Sa, 2014</option>
<option value=\"2014-02-23\">Fev 23 Di, 2014</option>
<option value=\"2014-02-24\">Fev 24 Lu, 2014</option>
<option value=\"2014-02-25\">Fev 25 Ma, 2014</option>
<option value=\"2014-02-26\">Fev 26 Me, 2014</option>
<option value=\"2014-02-27\">Fev 27 Je, 2014</option>
<option value=\"2014-02-28\">Fev 28 Ve, 2014</option>
<option value=\"2014-03-01\">Mar 01 Sa, 2014</option>
<option value=\"2014-03-02\">Mar 02 Di, 2014</option>
<option value=\"2014-03-03\">Mar 03 Lu, 2014</option>
<option value=\"2014-03-04\">Mar 04 Ma, 2014</option>
<option value=\"2014-03-05\">Mar 05 Me, 2014</option>
<option value=\"2014-03-06\">Mar 06 Je, 2014</option>
<option value=\"2014-03-07\">Mar 07 Ve, 2014</option>
<option value=\"2014-03-08\">Mar 08 Sa, 2014</option>
<option value=\"2014-03-09\">Mar 09 Di, 2014</option>
<option value=\"2014-03-10\">Mar 10 Lu, 2014</option>
<option value=\"2014-03-11\">Mar 11 Ma, 2014</option>
<option value=\"2014-03-12\">Mar 12 Me, 2014</option>
<option value=\"2014-03-13\">Mar 13 Je, 2014</option>
<option value=\"2014-03-14\">Mar 14 Ve, 2014</option>
<option value=\"2014-03-15\">Mar 15 Sa, 2014</option>
<option value=\"2014-03-16\">Mar 16 Di, 2014</option>
<option value=\"2014-03-17\">Mar 17 Lu, 2014</option>
<option value=\"2014-03-18\">Mar 18 Ma, 2014</option>
<option value=\"2014-03-19\">Mar 19 Me, 2014</option>
<option value=\"2014-03-20\">Mar 20 Je, 2014</option>
<option value=\"2014-03-21\">Mar 21 Ve, 2014</option>
<option value=\"2014-03-22\">Mar 22 Sa, 2014</option>
<option value=\"2014-03-23\">Mar 23 Di, 2014</option>
<option value=\"2014-03-24\">Mar 24 Lu, 2014</option>
<option value=\"2014-03-25\">Mar 25 Ma, 2014</option>
<option value=\"2014-03-26\">Mar 26 Me, 2014</option>
<option value=\"2014-03-27\">Mar 27 Je, 2014</option>
<option value=\"2014-03-28\">Mar 28 Ve, 2014</option>
<option value=\"2014-03-29\">Mar 29 Sa, 2014</option>
<option value=\"2014-03-30\">Mar 30 Di, 2014</option>
<option value=\"2014-03-31\">Mar 31 Lu, 2014</option>
<option value=\"2014-04-01\">Avr 01 Ma, 2014</option>
<option value=\"2014-04-02\">Avr 02 Me, 2014</option>
<option value=\"2014-04-03\">Avr 03 Je, 2014</option>
<option value=\"2014-04-04\">Avr 04 Ve, 2014</option>
<option value=\"2014-04-05\">Avr 05 Sa, 2014</option>
<option value=\"2014-04-06\">Avr 06 Di, 2014</option>
<option value=\"2014-04-07\">Avr 07 Lu, 2014</option>
<option value=\"2014-04-08\">Avr 08 Ma, 2014</option>
<option value=\"2014-04-09\">Avr 09 Me, 2014</option>
<option value=\"2014-04-10\">Avr 10 Je, 2014</option>
<option value=\"2014-04-11\">Avr 11 Ve, 2014</option>
<option value=\"2014-04-12\">Avr 12 Sa, 2014</option>
<option value=\"2014-04-13\">Avr 13 Di, 2014</option>
<option value=\"2014-04-14\">Avr 14 Lu, 2014</option>
<option value=\"2014-04-15\">Avr 15 Ma, 2014</option>
<option value=\"2014-04-16\">Avr 16 Me, 2014</option>
<option value=\"2014-04-17\">Avr 17 Je, 2014</option>
<option value=\"2014-04-18\">Avr 18 Ve, 2014</option>
<option value=\"2014-04-19\">Avr 19 Sa, 2014</option>
<option value=\"2014-04-20\">Avr 20 Di, 2014</option>
<option value=\"2014-04-21\">Avr 21 Lu, 2014</option>
<option value=\"2014-04-22\">Avr 22 Ma, 2014</option>
<option value=\"2014-04-23\">Avr 23 Me, 2014</option>
<option value=\"2014-04-24\">Avr 24 Je, 2014</option>
<option value=\"2014-04-25\">Avr 25 Ve, 2014</option>
<option value=\"2014-04-26\">Avr 26 Sa, 2014</option>
<option value=\"2014-04-27\">Avr 27 Di, 2014</option>
<option value=\"2014-04-28\">Avr 28 Lu, 2014</option>
<option value=\"2014-04-29\">Avr 29 Ma, 2014</option>
<option value=\"2014-04-30\">Avr 30 Me, 2014</option>
<option value=\"2014-05-01\">Mai 01 Je, 2014</option>
<option value=\"2014-05-02\">Mai 02 Ve, 2014</option>
<option value=\"2014-05-03\">Mai 03 Sa, 2014</option>
<option value=\"2014-05-04\">Mai 04 Di, 2014</option>
<option value=\"2014-05-05\">Mai 05 Lu, 2014</option>
<option value=\"2014-05-06\">Mai 06 Ma, 2014</option>
<option value=\"2014-05-07\">Mai 07 Me, 2014</option>
<option value=\"2014-05-08\">Mai 08 Je, 2014</option>
<option value=\"2014-05-09\">Mai 09 Ve, 2014</option>
<option value=\"2014-05-10\">Mai 10 Sa, 2014</option>
<option value=\"2014-05-11\">Mai 11 Di, 2014</option>
<option value=\"2014-05-12\">Mai 12 Lu, 2014</option>
<option value=\"2014-05-13\">Mai 13 Ma, 2014</option>
<option value=\"2014-05-14\">Mai 14 Me, 2014</option>
<option value=\"2014-05-15\">Mai 15 Je, 2014</option>
<option value=\"2014-05-16\">Mai 16 Ve, 2014</option>
<option value=\"2014-05-17\">Mai 17 Sa, 2014</option>
<option value=\"2014-05-18\">Mai 18 Di, 2014</option>
<option value=\"2014-05-19\">Mai 19 Lu, 2014</option>
<option value=\"2014-05-20\">Mai 20 Ma, 2014</option>
<option value=\"2014-05-21\">Mai 21 Me, 2014</option>
<option value=\"2014-05-22\">Mai 22 Je, 2014</option>
<option value=\"2014-05-23\">Mai 23 Ve, 2014</option>
<option value=\"2014-05-24\">Mai 24 Sa, 2014</option>
<option value=\"2014-05-25\">Mai 25 Di, 2014</option>
<option value=\"2014-05-26\">Mai 26 Lu, 2014</option>
<option value=\"2014-05-27\">Mai 27 Ma, 2014</option>
<option value=\"2014-05-28\">Mai 28 Me, 2014</option>
<option value=\"2014-05-29\">Mai 29 Je, 2014</option>
<option value=\"2014-05-30\">Mai 30 Ve, 2014</option>
<option value=\"2014-05-31\">Mai 31 Sa, 2014</option>
<option value=\"2014-06-01\">Juin 01 Di, 2014</option>
<option value=\"2014-06-02\">Juin 02 Lu, 2014</option>
<option value=\"2014-06-03\">Juin 03 Ma, 2014</option>
<option value=\"2014-06-04\">Juin 04 Me, 2014</option>
<option value=\"2014-06-05\">Juin 05 Je, 2014</option>
<option value=\"2014-06-06\">Juin 06 Ve, 2014</option>
<option value=\"2014-06-07\">Juin 07 Sa, 2014</option>
<option value=\"2014-06-08\">Juin 08 Di, 2014</option>
<option value=\"2014-06-09\">Juin 09 Lu, 2014</option>
<option value=\"2014-06-10\">Juin 10 Ma, 2014</option>
<option value=\"2014-06-11\">Juin 11 Me, 2014</option>
<option value=\"2014-06-12\">Juin 12 Je, 2014</option>
<option value=\"2014-06-13\">Juin 13 Ve, 2014</option>
<option value=\"2014-06-14\">Juin 14 Sa, 2014</option>
<option value=\"2014-06-15\">Juin 15 Di, 2014</option>
<option value=\"2014-06-16\">Juin 16 Lu, 2014</option>
<option value=\"2014-06-17\">Juin 17 Ma, 2014</option>
<option value=\"2014-06-18\">Juin 18 Me, 2014</option>
<option value=\"2014-06-19\">Juin 19 Je, 2014</option>
<option value=\"2014-06-20\">Juin 20 Ve, 2014</option>
<option value=\"2014-06-21\">Juin 21 Sa, 2014</option>
<option value=\"2014-06-22\">Juin 22 Di, 2014</option>
<option value=\"2014-06-23\">Juin 23 Lu, 2014</option>
<option value=\"2014-06-24\">Juin 24 Ma, 2014</option>
<option value=\"2014-06-25\">Juin 25 Me, 2014</option>
<option value=\"2014-06-26\">Juin 26 Je, 2014</option>
<option value=\"2014-06-27\">Juin 27 Ve, 2014</option>
<option value=\"2014-06-28\">Juin 28 Sa, 2014</option>
<option value=\"2014-06-29\">Juin 29 Di, 2014</option>
<option value=\"2014-06-30\">Juin 30 Lu, 2014</option>
<option value=\"2014-07-01\">Juil 01 Ma, 2014</option>
<option value=\"2014-07-02\">Juil 02 Me, 2014</option>
<option value=\"2014-07-03\">Juil 03 Je, 2014</option>
<option value=\"2014-07-04\">Juil 04 Ve, 2014</option>
<option value=\"2014-07-05\">Juil 05 Sa, 2014</option>
<option value=\"2014-07-06\">Juil 06 Di, 2014</option>
<option value=\"2014-07-07\">Juil 07 Lu, 2014</option>
<option value=\"2014-07-08\">Juil 08 Ma, 2014</option>
<option value=\"2014-07-09\">Juil 09 Me, 2014</option>
<option value=\"2014-07-10\">Juil 10 Je, 2014</option>
<option value=\"2014-07-11\">Juil 11 Ve, 2014</option>
<option value=\"2014-07-12\">Juil 12 Sa, 2014</option>
<option value=\"2014-07-13\">Juil 13 Di, 2014</option>
<option value=\"2014-07-14\">Juil 14 Lu, 2014</option>
<option value=\"2014-07-15\">Juil 15 Ma, 2014</option>
<option value=\"2014-07-16\">Juil 16 Me, 2014</option>
<option value=\"2014-07-17\">Juil 17 Je, 2014</option>
<option value=\"2014-07-18\">Juil 18 Ve, 2014</option>
<option value=\"2014-07-19\">Juil 19 Sa, 2014</option>
<option value=\"2014-07-20\">Juil 20 Di, 2014</option>
<option value=\"2014-07-21\">Juil 21 Lu, 2014</option>
<option value=\"2014-07-22\">Juil 22 Ma, 2014</option>
<option value=\"2014-07-23\">Juil 23 Me, 2014</option>
<option value=\"2014-07-24\">Juil 24 Je, 2014</option>
<option value=\"2014-07-25\">Juil 25 Ve, 2014</option>
<option value=\"2014-07-26\">Juil 26 Sa, 2014</option>
<option value=\"2014-07-27\">Juil 27 Di, 2014</option>
<option value=\"2014-07-28\">Juil 28 Lu, 2014</option>
<option value=\"2014-07-29\">Juil 29 Ma, 2014</option>
<option value=\"2014-07-30\">Juil 30 Me, 2014</option>
<option value=\"2014-07-31\">Juil 31 Je, 2014</option>
<option value=\"2014-08-01\">Aout 01 Ve, 2014</option>
<option value=\"2014-08-02\">Aout 02 Sa, 2014</option>
<option value=\"2014-08-03\">Aout 03 Di, 2014</option>
<option value=\"2014-08-04\">Aout 04 Lu, 2014</option>
<option value=\"2014-08-05\">Aout 05 Ma, 2014</option>
<option value=\"2014-08-06\">Aout 06 Me, 2014</option>
<option value=\"2014-08-07\">Aout 07 Je, 2014</option>
<option value=\"2014-08-08\">Aout 08 Ve, 2014</option>
<option value=\"2014-08-09\">Aout 09 Sa, 2014</option>
<option value=\"2014-08-10\">Aout 10 Di, 2014</option>
<option value=\"2014-08-11\">Aout 11 Lu, 2014</option>
<option value=\"2014-08-12\">Aout 12 Ma, 2014</option>
<option value=\"2014-08-13\">Aout 13 Me, 2014</option>
<option value=\"2014-08-14\">Aout 14 Je, 2014</option>
<option value=\"2014-08-15\">Aout 15 Ve, 2014</option>
<option value=\"2014-08-16\">Aout 16 Sa, 2014</option>
<option value=\"2014-08-17\">Aout 17 Di, 2014</option>
<option value=\"2014-08-18\">Aout 18 Lu, 2014</option>
<option value=\"2014-08-19\">Aout 19 Ma, 2014</option>
<option value=\"2014-08-20\">Aout 20 Me, 2014</option>
<option value=\"2014-08-21\">Aout 21 Je, 2014</option>
<option value=\"2014-08-22\">Aout 22 Ve, 2014</option>
<option value=\"2014-08-23\">Aout 23 Sa, 2014</option>
<option value=\"2014-08-24\">Aout 24 Di, 2014</option>
<option value=\"2014-08-25\">Aout 25 Lu, 2014</option>
<option value=\"2014-08-26\">Aout 26 Ma, 2014</option>
<option value=\"2014-08-27\">Aout 27 Me, 2014</option>
<option value=\"2014-08-28\">Aout 28 Je, 2014</option>
<option value=\"2014-08-29\">Aout 29 Ve, 2014</option>
<option value=\"2014-08-30\">Aout 30 Sa, 2014</option>
<option value=\"2014-08-31\">Aout 31 Di, 2014</option>
<option value=\"2014-09-01\">Sep 01 Lu, 2014</option>
<option value=\"2014-09-02\">Sep 02 Ma, 2014</option>
<option value=\"2014-09-03\">Sep 03 Me, 2014</option>
<option value=\"2014-09-04\">Sep 04 Je, 2014</option>
<option value=\"2014-09-05\">Sep 05 Ve, 2014</option>
<option value=\"2014-09-06\">Sep 06 Sa, 2014</option>
<option value=\"2014-09-07\">Sep 07 Di, 2014</option>
<option value=\"2014-09-08\">Sep 08 Lu, 2014</option>
<option value=\"2014-09-09\">Sep 09 Ma, 2014</option>
<option value=\"2014-09-10\">Sep 10 Me, 2014</option>
<option value=\"2014-09-11\">Sep 11 Je, 2014</option>
<option value=\"2014-09-12\">Sep 12 Ve, 2014</option>
<option value=\"2014-09-13\">Sep 13 Sa, 2014</option>
<option value=\"2014-09-14\">Sep 14 Di, 2014</option>
<option value=\"2014-09-15\">Sep 15 Lu, 2014</option>
<option value=\"2014-09-16\">Sep 16 Ma, 2014</option>
<option value=\"2014-09-17\">Sep 17 Me, 2014</option>
<option value=\"2014-09-18\">Sep 18 Je, 2014</option>
<option value=\"2014-09-19\">Sep 19 Ve, 2014</option>
<option value=\"2014-09-20\">Sep 20 Sa, 2014</option>
<option value=\"2014-09-21\">Sep 21 Di, 2014</option>
<option value=\"2014-09-22\">Sep 22 Lu, 2014</option>
<option value=\"2014-09-23\">Sep 23 Ma, 2014</option>
<option value=\"2014-09-24\">Sep 24 Me, 2014</option>
<option value=\"2014-09-25\">Sep 25 Je, 2014</option>
<option value=\"2014-09-26\">Sep 26 Ve, 2014</option>
<option value=\"2014-09-27\">Sep 27 Sa, 2014</option>
<option value=\"2014-09-28\">Sep 28 Di, 2014</option>
<option value=\"2014-09-29\">Sep 29 Lu, 2014</option>
<option value=\"2014-09-30\">Sep 30 Ma, 2014</option>
<option value=\"2014-10-01\">Oct 01 Me, 2014</option>
<option value=\"2014-10-02\">Oct 02 Je, 2014</option>
<option value=\"2014-10-03\">Oct 03 Ve, 2014</option>
<option value=\"2014-10-04\">Oct 04 Sa, 2014</option>
<option value=\"2014-10-05\">Oct 05 Di, 2014</option>
<option value=\"2014-10-06\">Oct 06 Lu, 2014</option>
<option value=\"2014-10-07\">Oct 07 Ma, 2014</option>
<option value=\"2014-10-08\">Oct 08 Me, 2014</option>
<option value=\"2014-10-09\">Oct 09 Je, 2014</option>
<option value=\"2014-10-10\">Oct 10 Ve, 2014</option>
<option value=\"2014-10-11\">Oct 11 Sa, 2014</option>
<option value=\"2014-10-12\">Oct 12 Di, 2014</option>
<option value=\"2014-10-13\">Oct 13 Lu, 2014</option>
<option value=\"2014-10-14\">Oct 14 Ma, 2014</option>
<option value=\"2014-10-15\">Oct 15 Me, 2014</option>
<option value=\"2014-10-16\">Oct 16 Je, 2014</option>
<option value=\"2014-10-17\">Oct 17 Ve, 2014</option>
<option value=\"2014-10-18\">Oct 18 Sa, 2014</option>
<option value=\"2014-10-19\">Oct 19 Di, 2014</option>
<option value=\"2014-10-20\">Oct 20 Lu, 2014</option>
<option value=\"2014-10-21\">Oct 21 Ma, 2014</option>
<option value=\"2014-10-22\">Oct 22 Me, 2014</option>
<option value=\"2014-10-23\">Oct 23 Je, 2014</option>
<option value=\"2014-10-24\">Oct 24 Ve, 2014</option>
<option value=\"2014-10-25\">Oct 25 Sa, 2014</option>
<option value=\"2014-10-26\">Oct 26 Di, 2014</option>
<option value=\"2014-10-27\">Oct 27 Lu, 2014</option>
<option value=\"2014-10-28\">Oct 28 Ma, 2014</option>
<option value=\"2014-10-29\">Oct 29 Me, 2014</option>
<option value=\"2014-10-30\">Oct 30 Je, 2014</option>
<option value=\"2014-10-31\">Oct 31 Ve, 2014</option>
<option value=\"2014-11-01\">Nov 01 Sa, 2014</option>
<option value=\"2014-11-02\">Nov 02 Di, 2014</option>
<option value=\"2014-11-03\">Nov 03 Lu, 2014</option>
<option value=\"2014-11-04\">Nov 04 Ma, 2014</option>
<option value=\"2014-11-05\">Nov 05 Me, 2014</option>
<option value=\"2014-11-06\">Nov 06 Je, 2014</option>
<option value=\"2014-11-07\">Nov 07 Ve, 2014</option>
<option value=\"2014-11-08\">Nov 08 Sa, 2014</option>
<option value=\"2014-11-09\">Nov 09 Di, 2014</option>
<option value=\"2014-11-10\">Nov 10 Lu, 2014</option>
<option value=\"2014-11-11\">Nov 11 Ma, 2014</option>
<option value=\"2014-11-12\">Nov 12 Me, 2014</option>
<option value=\"2014-11-13\">Nov 13 Je, 2014</option>
<option value=\"2014-11-14\">Nov 14 Ve, 2014</option>
<option value=\"2014-11-15\">Nov 15 Sa, 2014</option>
<option value=\"2014-11-16\">Nov 16 Di, 2014</option>
<option value=\"2014-11-17\">Nov 17 Lu, 2014</option>
<option value=\"2014-11-18\">Nov 18 Ma, 2014</option>
<option value=\"2014-11-19\">Nov 19 Me, 2014</option>
<option value=\"2014-11-20\">Nov 20 Je, 2014</option>
<option value=\"2014-11-21\">Nov 21 Ve, 2014</option>
<option value=\"2014-11-22\">Nov 22 Sa, 2014</option>
<option value=\"2014-11-23\">Nov 23 Di, 2014</option>
<option value=\"2014-11-24\">Nov 24 Lu, 2014</option>
<option value=\"2014-11-25\">Nov 25 Ma, 2014</option>
<option value=\"2014-11-26\">Nov 26 Me, 2014</option>
<option value=\"2014-11-27\">Nov 27 Je, 2014</option>
<option value=\"2014-11-28\">Nov 28 Ve, 2014</option>
<option value=\"2014-11-29\">Nov 29 Sa, 2014</option>
<option value=\"2014-11-30\">Nov 30 Di, 2014</option>
<option value=\"2014-12-01\">Dec 01 Lu, 2014</option>
<option value=\"2014-12-02\">Dec 02 Ma, 2014</option>
<option value=\"2014-12-03\">Dec 03 Me, 2014</option>
<option value=\"2014-12-04\">Dec 04 Je, 2014</option>
<option value=\"2014-12-05\">Dec 05 Ve, 2014</option>
<option value=\"2014-12-06\">Dec 06 Sa, 2014</option>
<option value=\"2014-12-07\">Dec 07 Di, 2014</option>
<option value=\"2014-12-08\">Dec 08 Lu, 2014</option>
<option value=\"2014-12-09\">Dec 09 Ma, 2014</option>
<option value=\"2014-12-10\">Dec 10 Me, 2014</option>
<option value=\"2014-12-11\">Dec 11 Je, 2014</option>
<option value=\"2014-12-12\">Dec 12 Ve, 2014</option>
<option value=\"2014-12-13\">Dec 13 Sa, 2014</option>
<option value=\"2014-12-14\">Dec 14 Di, 2014</option>
<option value=\"2014-12-15\">Dec 15 Lu, 2014</option>
<option value=\"2014-12-16\">Dec 16 Ma, 2014</option>
<option value=\"2014-12-17\">Dec 17 Me, 2014</option>
<option value=\"2014-12-18\">Dec 18 Je, 2014</option>
<option value=\"2014-12-19\">Dec 19 Ve, 2014</option>
<option value=\"2014-12-20\">Dec 20 Sa, 2014</option>
<option value=\"2014-12-21\">Dec 21 Di, 2014</option>
<option value=\"2014-12-22\">Dec 22 Lu, 2014</option>
<option value=\"2014-12-23\">Dec 23 Ma, 2014</option>
<option value=\"2014-12-24\">Dec 24 Me, 2014</option>
<option value=\"2014-12-25\">Dec 25 Je, 2014</option>
<option value=\"2014-12-26\">Dec 26 Ve, 2014</option>
<option value=\"2014-12-27\">Dec 27 Sa, 2014</option>
<option value=\"2014-12-28\">Dec 28 Di, 2014</option>
<option value=\"2014-12-29\">Dec 29 Lu, 2014</option>
<option value=\"2014-12-30\">Dec 30 Ma, 2014</option>
<option value=\"2014-12-31\">Dec 31 Me, 2014</option>
<option value=\"2015-01-01\">Jan 01 Je, 2015</option>
";

$d_names = "\" Di\",\" Lu\",\" Ma\",\" Me\",\" Je\",\" Ve\",\" Sa\"";
$m_names = "\"Jan\",\"Fev\",\"Mar\",\"Avr\",\"Mai\",\"Juin\",\"Juil\",\"Aout\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"";

# END OF MODIFIABLE VARIABLES



############################################################################
###        DO NOT MODIFY ANYTHING FROM HERE
############################################################################


error_reporting(E_ALL ^ E_NOTICE);
$PHPR_LOG = "NO";
$pag = $var_page_name;
if (!$pag) {
if (@$PHP_SELF or @$_SERVER["PHP_SELF"] or @$HTTP_SERVER_VARS["PHP_SELF"]) {
if (@$_SERVER["PHP_SELF"]) $PHP_SELF = $_SERVER["PHP_SELF"];
else if (@$HTTP_SERVER_VARS["PHP_SELF"]) $PHP_SELF = $HTTP_SERVER_VARS["PHP_SELF"];
$pag = explode("/",$PHP_SELF);
$pag = $pag[(count($pag)-1)];
} # fine if (@$PHP_SELF or @$_SERVER["PHP_SELF"] or...
else echo "The \$PHP_SELF variable is not defined, you'll have to edit this page by hand to add its name.<br>";
} # fine if (!$pag)

define(C_PERCORSO_A_DATI,"C:\wamp\www\gesthotel\dati/");

$anno = $var_year;
$PHPR_DB_TYPE = $var_db_type;
$PHPR_DB_NAME = $var_db_name;
$PHPR_DB_HOST = $var_db_host;
$PHPR_DB_PORT = $var_db_port;
$PHPR_DB_USER = $var_db_user;
$PHPR_DB_PASS = $var_db_password;
if (strtoupper($var_db_load_extension) == "YES") $PHPR_LOAD_EXT = "SI";
else $PHPR_LOAD_EXT = "NO";
$PHPR_TAB_PRE = $var_db_tables_prefix;
$lingua_modello = $var_template_language;
if ($var_money_format == "europe") $stile_soldi = "europa";
if ($var_money_format == "usa") $stile_soldi = "usa";
if ($var_dates_format == "europe") $stile_data = "europa";
if ($var_dates_format == "usa") $stile_data = "usa";
if (strtoupper($var_currency_name_in_front) == "YES") $anteponi_nome_valuta = "SI";
else $anteponi_nome_valuta = "NO";
$utente_liste = $var_lists_user;
if (strtoupper($var_extend_last_date) == "YES") $estendi_ultima_data = "SI";
else $estendi_ultima_data = "NO";
$sett_no_prenota = $var_periods_no_requests;
unset($tariffe_mostra);
reset ($var_rates_to_show);
while (list ($key, $val) = each ($var_rates_to_show)) {
if (strtoupper($val) == "YES") $tariffe_mostra[$key] = "SI";
if (strtoupper($val) == "NO") $tariffe_mostra[$key] = "NO";
} # fine while
$n_tariffe_imposte = $var_imposed_rates_names;
if (strtoupper($var_ask_number_apartments_for_type) == "YES") $chiedi_num_app_tipologia = "SI";
else $chiedi_num_app_tipologia = "NO";
$max_num_app_tipologia = $var_maximum_number_apartments_for_type;
if (strtoupper($var_add_other_types) == "YES") $aggiungi_tipologie = "SI";
else $aggiungi_tipologie = "NO";
$max_num_tipologie = $var_maximum_number_other_types;
if (strtoupper($var_ask_people_number) == "YES") $chiedi_num_persone = "SI";
else $chiedi_num_persone = "NO";
$max_num_persone = $var_maximum_number_people;
$costo_aggiungi_letti = $var_cost_add_beds;
$max_num_aggiungi_letti = $var_maximum_number_extra_beds;
if (strtoupper($var_ask_for_extra_costs_in_insertion_page) == "YES") $mostra_costi_aggiuntivi = "SI";
else $mostra_costi_aggiuntivi = "NO";
$num_colonne_costi_agg = $var_extra_costs_columns_number;
if (strtoupper($var_add_extra_costs) == "YES") $aggiungi_costi_fissi = "SI";
else $aggiungi_costi_fissi = "NO";
unset($costi_agg_mostra);
reset ($var_extra_costs_to_show);
while (list ($key, $val) = each ($var_extra_costs_to_show)) {
if (strtoupper($val) == "YES") $costi_agg_mostra[$key] = "SI";
if (strtoupper($val) == "NO") $costi_agg_mostra[$key] = "NO";
} # fine while
$n_costi_agg_imposti = $var_imposed_extra_costs_names;
$cat_costi_agg_imposte = $var_imposed_extra_costs_categories;
if (strtoupper($var_assign_with_rule1) == "YES") $assegna_con_regola2 = "SI";
else $assegna_con_regola2 = "NO";
unset($motivazioni_regola1);
reset ($var_motivations_of_rule1_to_consider);
while (list ($key, $val) = each ($var_motivations_of_rule1_to_consider)) {
if (strtoupper($val) == "YES") $motivazioni_regola1[$key] = "SI";
if (strtoupper($val) == "NO") $motivazioni_regola1[$key] = "NO";
} # fine while
if (strtoupper($var_show_alternative_phrase_for_rule1) == "YES") $mostra_frase_alternativa_regola1 = "SI";
else $mostra_frase_alternativa_regola1 = "NO";
if (strtoupper($var_show_deposit) == "YES") $mostra_caparra = "SI";
else $mostra_caparra = "NO";
if (strtoupper($var_show_request_by_mail) == "YES") $mostra_richiesta_via_mail = "SI";
else $mostra_richiesta_via_mail = "NO";
$indirizzo_email = $var_email_address;
if (strtoupper($var_send_copy_of_request_email) == "YES") $manda_copia_richiesta_email = "SI";
else $manda_copia_richiesta_email = "NO";
if (strtoupper($var_masquerade_email_envelope) == "YES") $maschera_envelope = "SI";
else $maschera_envelope = "NO";
if (strtoupper($var_show_full_days) == "YES") $mostra_giorni_pieni = "SI";
else $mostra_giorni_pieni = "NO";
if (strtoupper($var_show_paypal_button) == "YES") $mostra_bottone_paypal = "SI";
else $mostra_bottone_paypal = "NO";
$nome_modello_paypal = $var_paypal_template_name;
$utente_messaggio = $var_message_user;
if (strtolower($utente_messaggio) == strtolower("everybody")) $utente_messaggio = "tutti";
$origine_prenotazione = $var_reservation_origin;

$chiedi_cognome = $var_ask_surname;
if (strtoupper($chiedi_cognome) == "YES") $chiedi_cognome = "SI";
if (strtoupper($chiedi_cognome) == "NO") $chiedi_cognome = "NO";
$chiedi_nome = $var_ask_name;
if (strtoupper($chiedi_nome) == "YES") $chiedi_nome = "SI";
if (strtoupper($chiedi_nome) == "NO") $chiedi_nome = "NO";
$chiedi_email = $var_ask_email;
if (strtoupper($chiedi_email) == "YES") $chiedi_email = "SI";
if (strtoupper($chiedi_email) == "NO") $chiedi_email = "NO";
$chiedi_sesso = $var_ask_sex;
if (strtoupper($chiedi_sesso) == "YES") $chiedi_sesso = "SI";
if (strtoupper($chiedi_sesso) == "NO") $chiedi_sesso = "NO";
$chiedi_datanascita = $var_ask_birthdate;
if (strtoupper($chiedi_datanascita) == "YES") $chiedi_datanascita = "SI";
if (strtoupper($chiedi_datanascita) == "NO") $chiedi_datanascita = "NO";
$chiedi_documento = $var_ask_document;
if (strtoupper($chiedi_documento) == "YES") $chiedi_documento = "SI";
if (strtoupper($chiedi_documento) == "NO") $chiedi_documento = "NO";
$chiedi_nazione = $var_ask_nation;
if (strtoupper($chiedi_nazione) == "YES") $chiedi_nazione = "SI";
if (strtoupper($chiedi_nazione) == "NO") $chiedi_nazione = "NO";
$chiedi_citta = $var_ask_city;
if (strtoupper($chiedi_citta) == "YES") $chiedi_citta = "SI";
if (strtoupper($chiedi_citta) == "NO") $chiedi_citta = "NO";
$chiedi_regione = $var_ask_region;
if (strtoupper($chiedi_regione) == "YES") $chiedi_regione = "SI";
if (strtoupper($chiedi_regione) == "NO") $chiedi_regione = "NO";
$chiedi_via = $var_ask_street;
if (strtoupper($chiedi_via) == "YES") $chiedi_via = "SI";
if (strtoupper($chiedi_via) == "NO") $chiedi_via = "NO";
$chiedi_numcivico = $var_ask_housenumber;
if (strtoupper($chiedi_numcivico) == "YES") $chiedi_numcivico = "SI";
if (strtoupper($chiedi_numcivico) == "NO") $chiedi_numcivico = "NO";
$chiedi_cap = $var_ask_postalcode;
if (strtoupper($chiedi_cap) == "YES") $chiedi_cap = "SI";
if (strtoupper($chiedi_cap) == "NO") $chiedi_cap = "NO";
$chiedi_telefono = $var_ask_telephone;
if (strtoupper($chiedi_telefono) == "YES") $chiedi_telefono = "SI";
if (strtoupper($chiedi_telefono) == "NO") $chiedi_telefono = "NO";
$chiedi_telefono2 = $var_ask_telephone2;
if (strtoupper($chiedi_telefono2) == "YES") $chiedi_telefono2 = "SI";
if (strtoupper($chiedi_telefono2) == "NO") $chiedi_telefono2 = "NO";
$chiedi_telefono3 = $var_ask_telephone3;
if (strtoupper($chiedi_telefono3) == "YES") $chiedi_telefono3 = "SI";
if (strtoupper($chiedi_telefono3) == "NO") $chiedi_telefono3 = "NO";
$chiedi_fax = $var_ask_fax;
if (strtoupper($chiedi_fax) == "YES") $chiedi_fax = "SI";
if (strtoupper($chiedi_fax) == "NO") $chiedi_fax = "NO";
$chiedi_commento = $var_ask_comment;
if (strtoupper($chiedi_commento) == "YES") $chiedi_commento = "SI";
if (strtoupper($chiedi_commento) == "NO") $chiedi_commento = "NO";
$chiedi_oracheckin = $var_ask_checkintime;
if (strtoupper($chiedi_oracheckin) == "YES") $chiedi_oracheckin = "SI";
if (strtoupper($chiedi_oracheckin) == "NO") $chiedi_oracheckin = "NO";
$chiedi_metodopagamento = $var_ask_paymentmethod;
if (strtoupper($chiedi_metodopagamento) == "YES") $chiedi_metodopagamento = "SI";
if (strtoupper($chiedi_metodopagamento) == "NO") $chiedi_metodopagamento = "NO";
unset($metodi_pagamento_da_chiedere);
reset ($var_payment_methods_to_ask);
while (list ($key, $val) = each ($var_payment_methods_to_ask)) {
if (strtoupper($val) == "YES") $metodi_pagamento_da_chiedere[$key] = "SI";
if (strtoupper($val) == "NO") $metodi_pagamento_da_chiedere[$key] = "NO";
} # fine while
$nomi_metodi_pagamento_imposti = $var_imposed_payment_methods_names;
$campi_form_personalizzati = $var_custom_form_fields;
unset($chiedi_campi_form_personalizzati);
reset ($var_ask_custom_form_fields);
while (list ($key, $val) = each ($var_ask_custom_form_fields)) {
if (strtoupper($val) == "YES") $chiedi_campi_form_personalizzati[$key] = "SI";
} # fine while
$campi_form_doc_condizioni = $var_doc_conditions_form_fields;
unset($chiedi_campi_form_doc_condizioni);
reset ($var_ask_doc_conditions_form_fields);
while (list ($key, $val) = each ($var_ask_doc_conditions_form_fields)) {
if (strtoupper($val) == "YES") $chiedi_campi_form_doc_condizioni[$key] = "SI";
} # fine while

$mostra_quadro_disp = "";
if (strtoupper($var_show_availability_overview) == "YES") {
$mostra_quadro_disp = "app";
if (strtoupper($var_group_availability_overview_with_people) == "YES") $mostra_quadro_disp = "pers";
if (strtoupper($var_group_availability_overview_with_rule_2) == "YES") $mostra_quadro_disp = "reg2";
} # fine if (strtoupper($var_show_availability_overview) == "YES")
$c_sfondo_tab_disp = $var_background_color_availability_overview;
$c_inisett_tab_disp = $var_color_week_beginning_availability_overview;
$c_libero_tab_disp = $var_color_free_availability_overview;
$c_occupato_tab_disp = $var_color_full_availability_overview;
$aper_font_tab_disp = $var_opening_font_availability_overview;
$chiu_font_tab_disp = $var_closing_font_availability_overview;
if (strtoupper($var_show_free_number_availability_overview) == "YES") $mostra_num_liberi = "SI";
else $mostra_num_liberi = "NO";
if (strtoupper($var_align_availability_with_arrival) == "YES") $allinea_disponibilita_con_arrivo = "SI";
else $allinea_disponibilita_con_arrivo = "NO";

if (strtoupper($var_show_dates_picker_calendar) == "YES") $mostra_calendario_scelta_date = "SI";
else $mostra_calendario_scelta_date = "NO";
$stile_riquadro_calendario = $var_calendar_box_style;
$stile_tabella_calendario = $var_calendar_table_style;
$stile_bottoni_calendario = $var_calendar_buttons_style;
$stile_bottone_apertura_calendario = $var_open_calendar_button_style;
$colore_data_attiva_calendario = $var_color_active_calendar_date;
$colore_data_selezionata_calendario = $var_color_selected_calendar_date;

$apertura_tag_font = $var_font_tag_opening;
$chiusura_tag_font = $var_font_tag_closing;
$apertura_tag_font_rosse = $var_red_font_tag_opening;
$chiusura_tag_font_rosse = $var_red_font_tag_closing;
$stile_tabella_prenotazione = $var_reservation_table_style;
$file_css_frame = $var_framed_css_file;
if (strtoupper($var_open_new_window_from_frame) == "YES") $apri_nuova_finestra_da_frame = "SI";
else $apri_nuova_finestra_da_frame = "NO";
$larghezza_finestra_da_frame = $var_window_from_frame_width;
$altezza_finestra_da_frame = $var_window_from_frame_height;
$extra_head_frame = "<style type=\"text/css\">
 body { background-color: #ebebeb; color: #000000; }
 div.ftxt { max-width: 350px; }
 div.ftxt div { padding: 4px; font-size: 80%; }
 div.ftxt select { font-size: 80%; margin: 0 0 0 6px; }
 div.ftxt input { font-size: 80%; margin: 0 0 0 6px; }
 div.arrdate input, div.depdate input { margin: 0; }
 div.submit_check { text-align: right; }
 span.ftxt_phr { display: block; }
</style>";
$tipo_periodi = "g";

# FRASI
$fr_Euro = $var_phr_Currency_sing;
$fr_Euros = $var_phr_Currency_plur;
$fr_appartamenti = $var_phr_apartments;
$fr_appartamento = $var_phr_apartment;
$fr_alternativa_regola1 = $var_phr_rule1_alternative;
$fr_in = $var_phr_in;
$fr_Non_c_e_piu_disponibilita = $var_phr_There_is_not_availability_anymore;
$fr_Controlla_la_disponibilita = $var_phr_Check_availability;
$fr_dal = $var_phr_from;
$fr_al = $var_phr_to;
$fr_per_la_tipologia = $var_phr_for_type;
$fr_tariffa = $var_phr_rate;
$fr_Numero_di = $var_phr_Number_of;
$fr_Aggiungi_una_nuova_tipologia = $var_phr_Add_a_new_type;
$fr_Elimina_questa_tipologia = $var_phr_Delete_this_type;
$fr_per = $var_phr_for;
$fr_Data_di_arrivo = $var_phr_Arrival_date;
$fr_Data_di_partenza = $var_phr_Departure_date;
$fr_Tipologia = $var_phr_Type;
$fr_Le_date_sono_sbagliate = $var_phr_Dates_are_wrong;
$fr_La_tipologia_e_sbagliata = $var_phr_Type_is_wrong;
$fr_Il_numero_di = $var_phr_The_number_of;
$fr_richiesto_e_sbagliato = $var_phr_inserted_is_wrong;
$fr_parola_La = $var_phr_word_the;
$fr_parola_settimana = $var_phr_word_week;
$fr_est = $var_phr_is;
$fr_piena = $var_phr_full;
$fr_Non_c_e_piu_disponibilita_nel_periodo_richiesto = $var_phr_There_is_not_availability_anymore_in_the_requested_period;
$fr_C_e_ancora_disponibilita = $var_phr_There_is_still_availability;
$fr_nel_periodo_richiesto = $var_phr_in_the_requested_period;
$fr_nei_periodi_richiesti = $var_phr_in_the_requested_periods;
$fr_per_le_tipologie_richieste = $var_phr_for_requested_types;
$fr_Periodo_di = $var_phr_Period_of;
$fr_parola_settimane = $var_phr_word_weeks;
$fr_tipologia = $var_phr_type;
$fr_Non_c_e_tariffa_per_questa_tipologia_ecc = $var_phr_There_is_still_not_rate_for_the_requested_type_etc;
$fr_E_necessario_inserire_il_numero_di_persone_ecc = $var_fr_The_number_of_people_is_needed_etc;
$fr_Prezzo = $var_phr_Price;
$fr_Totale = $var_phr_Total;
$fr_Caparra = $var_phr_Deposit;
$fr_compresi = $var_phr_including;
$fr_di = $var_phr_of;
$fr_Torna_indietro = $var_phr_Go_back;
$fr_Nuovo_controllo = $var_phr_New_check;
$fr_Invia_la_richiesta_di_prenotazione = $var_phr_Send_the_request_for_reservation;
$fr_Richiesta_di_prenotazione_inviata = $var_phr_Request_for_reservation_sent;
$fr_Non_e_stato_possibile_inviare_la_richiesta = $var_phr_It_was_not_possible_to_send_the_request;
$fr_Scegliere_le_settimane_in_cui_applicare = $var_phr_Choose_the_weeks_to_be_applied_for;
$fr_persone = $var_phr_people;
$fr_persona = $var_phr_person;
$fr_Continua = $var_phr_Continue;
$fr_per_ogni = $var_phr_for_each;
$fr_Si_deve_inserire_il_numero_delle_persone_per = $var_phr_The_number_of_people_must_be_inserted_for;
$fr_Errore_nei_servizi_opzionali_richiesti = $var_phr_Error_in_requested_optional_services;
$fr_con_i_servizi_opzionali_selezionati = $var_phr_with_selected_optional_services;
$fr_supera_la_capienza_massima_della_tipologia_richiesta = $var_phr_is_bigger_than_the_maximum_capacity_of_requested_type;
$fr_Quadro_indicativo_disponibilita = $var_phr_Indicative_availability_overview;
$fr_Gennaio = $var_phr_January;
$fr_Febbraio = $var_phr_February;
$fr_Marzo = $var_phr_March;
$fr_Aprile = $var_phr_April;
$fr_Maggio = $var_phr_May;
$fr_Giugno = $var_phr_June;
$fr_Luglio = $var_phr_July;
$fr_Agosto = $var_phr_August;
$fr_Settembre = $var_phr_September;
$fr_Ottobre = $var_phr_October;
$fr_Novembre = $var_phr_November;
$fr_Dicembre = $var_phr_December;
$fr_Cognome = $var_phr_Surname;
$fr_Nome = $var_phr_Name;
$fr_Email = $var_phr_Email;
$fr_Commento = $var_phr_Comment;
$fr_Genere = $var_phr_Gender;
$fr_Data_di_nascita = $var_phr_Birthdate;
$fr_Documento = $var_phr_Document;
$fr_Nazione = $var_phr_Nation;
$fr_Citta = $var_phr_City;
$fr_Regione = $var_phr_Region;
$fr_Via = $var_phr_Street;
$fr_Numero_civico = $var_phr_House_number;
$fr_Codice_postale = $var_phr_Postal_code;
$fr_Telefono = $var_phr_Telephone;
$fr_Secondo_telefono = $var_phr_Second_telephone;
$fr_Terzo_telefono = $var_phr_Third_telephone;
$fr_Fax = $var_phr_Fax;
$fr_Orario_stimato_di_arrivo = $var_phr_Estimated_arrival_time;
$fr_Accetto = $var_phr_I_accept;
$fr_Metodo_di_pagamento_della_caparra = $var_phr_Deposit_payment_method;
$fr_campi_necessari = $var_phr_required_fields;
$fr_asterisco_nero = $var_phr_black_asterisk;
$fr_asterisco_rosso = $var_phr_red_asterisk;
$fr_maschile = $var_phr_male;
$fr_femminile = $var_phr_female;
$fr_Prenota = $var_phr_Book;
$fr_da = $var_phr_from2;
$fr_OPPURE_linee = $var_fr_OR_dashes;
$fr_Prenotazione_istantanea_con_PayPal = $var_fr_Instant_booking_with_PayPal;
$fr_Chiudi = $var_phr_Close;
$fr_Richesta_prenotazione = $var_phr_Reservation_request;
$fr_Abbiamo_ricevuto_la_sua_richiesta_di_prenotazione_ecc = $var_phr_We_have_received_your_reservation_request_etc;
$fr_Copia_della_richiesta_e_stata_inviata_a = $var_phr_A_copy_of_the_request_has_been_sent_to;
$fre_Email = $var_phre_Email;
$fre_Nome = $var_phre_Name;
$fre_Commento = $var_phre_Comment;
$fre_Periodo = $var_phre_Period;
$fre_dal = $var_phre_from;
$fre_al = $var_phre_to;
$fre_Tariffa = $var_phre_Rate;
$fre_Costi_aggiuntivi = $var_phre_Extra_costs;
$fre_sett = $var_phre_weeks;
$fre_Numero_di_appartamenti = $var_phre_Number_of_apartments;
$fre_Prezzo_totale = $var_phre_Total_price;
$fre_Riferimento = $var_phre_Reference;
$fre_Richesta_prenotazione = $var_phre_Reservation_request;
$fre_Caparra = $var_phre_Deposit;
$fre_Persone = $var_phre_People;
$fre_Cognome = $var_phre_Surname;
$fre_Genere = $var_phre_Gender;
$fre_Data_di_nascita = $var_phre_Birthdate;
$fre_Documento = $var_phre_Document;
$fre_Nazione = $var_phre_Nation;
$fre_Citta = $var_phre_City;
$fre_Regione = $var_phre_Region;
$fre_Via = $var_phre_Street;
$fre_Numero_civico = $var_phre_House_number;
$fre_Codice_postale = $var_phre_Postal_code;
$fre_Telefono = $var_phre_Telephone;
$fre_Secondo_telefono = $var_phre_Second_telephone;
$fre_Terzo_telefono = $var_phre_Third_telephone;
$fre_Fax = $var_phre_Fax;
$fre_Orario_stimato_di_arrivo = $var_phre_Estimated_arrival_time;
$fre_Metodo_di_pagamento_della_caparra = $var_phre_Deposit_payment_method;

# PERIODI NEI MENU
$menu_periodi = $var_menu_periods;

function mex_data($messaggio) {

###########################################
###  INIZIO ./includes/lang/fr/giorni_mesi.php 
###########################################

switch ($messaggio) {

case " Do":  					$messaggio = " Di"; break;
case " Lu":  					$messaggio = " Lu"; break;
case " Ma":  					$messaggio = " Ma"; break;
case " Me":  					$messaggio = " Me"; break;
case " Gi":  					$messaggio = " Je"; break;
case " Ve":  					$messaggio = " Ve"; break;
case " Sa":  					$messaggio = " Sa"; break;
case "Gen":  					$messaggio = "Jan"; break;
case "Feb":  					$messaggio = "Fev"; break;
case "Mar":  					$messaggio = "Mar"; break;
case "Apr":  					$messaggio = "Avr"; break;
case "Mag":  					$messaggio = "Mai"; break;
case "Giu":  					$messaggio = "Juin"; break;
case "Lug":  					$messaggio = "Juil"; break;
case "Ago":  					$messaggio = "Aout"; break;
case "Set":  					$messaggio = "Sep"; break;
case "Ott":  					$messaggio = "Oct"; break;
case "Nov":  					$messaggio = "Nov"; break;
case "Dic":  					$messaggio = "Dec"; break;
case "Gennaio":  				$messaggio = "Janvier"; break;
case "Febbraio":  				$messaggio = "Fvrier"; break;
case "Marzo":  					$messaggio = "Mars"; break;
case "Aprile":  				$messaggio = "Avril"; break;
case "Maggio":  				$messaggio = "Mai"; break;
case "Giugno":  				$messaggio = "Juin"; break;
case "Luglio":  				$messaggio = "Juillet"; break;
case "Agosto":  				$messaggio = "Aot"; break;
case "Settembre":  				$messaggio = "Septembre"; break;
case "Ottobre":  				$messaggio = "Octobre"; break;
case "Novembre":  				$messaggio = "Novembre"; break;
case "Dicembre":  				$messaggio = "Decembre"; break;
case "Domenica":  				$messaggio = "Dimanche"; break;
case "Luned":  				$messaggio = "Lundi"; break;
case "Marted":  				$messaggio = "Mardi"; break;
case "Mercoled":  				$messaggio = "Mercredi"; break;
case "Gioved":  				$messaggio = "Jeudi"; break;
case "Venerd":  				$messaggio = "Vendredi"; break;
case "Sabato":  				$messaggio = "Samedi"; break;
case "":  		$messaggio = ""; break;
case "":  		$messaggio = ""; break;

} # fine switch ($messaggio)


###########################################
###  FINE ./includes/lang/fr/giorni_mesi.php 
###########################################

return $messaggio;
} # fine function mex_data


###########################################
###  INIZIO ./includes/funzioni_mysql.php 
###########################################

##################################################################################
#    HOTELDRUID
#    Copyright (C) 2001-2012 by Marco Maria Francesco De Santis (marco@digitaldruid.net)
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    any later version accepted by Marco Maria Francesco De Santis, which
#    shall act as a proxy as defined in Section 14 of version 3 of the
#    license.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
##################################################################################

#Funzioni per usare il database MYSQL

ignore_user_abort(1);

# variabili per le differenze nella sintassi delle query
#global $ILIKE,$LIKE;
$ILIKE = "LIKE";
$LIKE = "LIKE BINARY";
$DATETIME = "datetime";
$MEDIUMTEXT = "mediumtext";


function connetti_db ($database,$host,$port,$user,$password,$estensione) {

if ($estensione == "SI") dl("mysql.so");
$numconnessione = mysql_connect("$host:$port",$user,$password);
@mysql_query("SET NAMES 'utf8'");
mysql_select_db($database);

return $numconnessione;

} # fine function connetti_db


function disconnetti_db ($numconnessione) {

$risul = mysql_close($numconnessione);
return $risul;

} # fine function disconnetti_db


if (substr($PHPR_LOG,0,2) != "SI") {

function esegui_query ($query,$silenzio = "",$idlog = "") {

$risul = mysql_query($query);
if (!$risul and !$silenzio) {
global $PHPR_TAB_PRE;
echo "<br>ERROR IN: ".str_replace(" ".$PHPR_TAB_PRE," ",$query)." <br>".mysql_errno().": ".mysql_error()."<br>";
} # fine if (!$risul and !$silenzio)

return $risul;

} # fine function esegui_query

} # fine if (substr($PHPR_LOG,0,2) != "SI")


else {
if (!function_exists("inserisci_log")) include("./includes/funzioni_log.php");

function esegui_query ($query,$silenzio = "",$idlog = "") {

$risul = mysql_query($query);
if (!$risul and !$silenzio) {
global $PHPR_TAB_PRE;
echo "<br>ERROR IN: ".str_replace(" ".$PHPR_TAB_PRE," ",$query)." <br>".mysql_errno().": ".mysql_error()."<br>";
} # fine if (!$risul and !$silenzio)

if ($idlog != 1) inserisci_log($query,$idlog);

return $risul;

} # fine function esegui_query

} # fine else if (substr($PHPR_LOG,0,2) != "SI")


function risul_query ($query,$riga,$colonna,$tab="") {

$risul = mysql_result($query,$riga,$colonna);
#if (!$risul) echo "<br>Nessun risultato in riga $riga colonna $colonna<br>";

return $risul;

} # fine function risul_query


function numlin_query ($query) {

$risul = mysql_num_rows($query);
return $risul;

} # fine function numlin_query


function aggslashdb ($stringa) {

$risul = addslashes($stringa);
return $risul;

} # fine function aggslashdb


function arraylin_query ($query,$num) {

mysql_data_seek($query,$num);
$risul =  mysql_fetch_row($query);
return $risul;

} # fine function arraylin_query


function numcampi_query ($query) {

$risul = mysql_num_fields($query);
return $risul;

} # fine function numcampi_query


function nomecampo_query ($query,$num) {

$risul = mysql_field_name($query,$num);
return $risul;

} # fine function nomecampo_query


function tipocampo_query ($query,$num) {

$risul = mysql_field_type($query,$num);
return $risul;

} # fine function tipocampo_query


function dimcampo_query ($query,$num) {

$risul = mysql_field_len($query,$num);
return $risul;

} # fine function dimcampo_query


function lock_tabelle ($tabelle,$altre_tab_usate = "",$lock_dir = C_DATI_PATH) {

if (@is_array($tabelle)) {
for ($num1 = 0 ; $num1 < count($tabelle); $num1++) {
$lista_tabelle .= $tabelle[$num1]." write,";
} # fine for $num1
} # fine if (@is_array($tabelle))
if (@is_array($altre_tab_usate)) {
for ($num1 = 0 ; $num1 < count($altre_tab_usate); $num1++) {
$lista_tabelle .= $altre_tab_usate[$num1]." read,";
} # fine for $num1
} # fine if (@is_array($altre_tab_usate))
$lista_tabelle = substr($lista_tabelle,0,-1);
$risul = mysql_query("lock tables $lista_tabelle");
if (!$risul) echo "<br>ERROR IN: lock tables $lista_tabelle<br>".mysql_errno().": ".mysql_error()."<br>";

return $risul;

} # fine function lock_tabelle


function unlock_tabelle ($tabelle_lock,$azione = "") {

$risul = mysql_query("unlock tables");

} # fine function unlock_tabelle


function crea_indice ($tabella,$colonne,$nome) {

mysql_query("alter table $tabella add index $nome ($colonne)");

} # fine function crea_indice




###########################################
###  FINE ./includes/funzioni_mysql.php 
###########################################


$numconnessione = connetti_db($PHPR_DB_NAME,$PHPR_DB_HOST,$PHPR_DB_PORT,$PHPR_DB_USER,$PHPR_DB_PASS,$PHPR_LOAD_EXT);

###########################################
###  INIZIO ./includes/funzioni.php 
###########################################

##################################################################################
#    HOTELDRUID
#    Copyright (C) 2001-2012 by Marco Maria Francesco De Santis (marco@digitaldruid.net)
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    any later version accepted by Marco Maria Francesco De Santis, which
#    shall act as a proxy as defined in Section 14 of version 3 of the
#    license.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
##################################################################################


error_reporting(E_ALL ^ E_NOTICE);
if (function_exists('mb_internal_encoding')) mb_internal_encoding('UTF-8');
if (function_exists('date_default_timezone_set')) if (!ini_get('date.timezone')) date_default_timezone_set('UTC');


# nel caso fosse settato register_globals = Off
if (@is_array($_POST)) reset($_POST);
for($num1 = 0 ; $num1 < count($_POST); $num1++) {
$var_POST = key($_POST);
if (!isset($$var_POST)) $$var_POST = $_POST[$var_POST];
next($_POST);
} # fine for $num1
if (@is_array($_GET)) reset($_GET);
for($num1 = 0 ; $num1 < count($_GET); $num1++) {
$var_GET = key($_GET);
if (!isset($$var_GET)) $$var_GET = $_GET[$var_GET];
next($_GET);
} # fine for $num1


if (@is_file(C_DATI_PATH."/tema.php")) include(C_DATI_PATH."/tema.php");
else {
unset($tema);
$trad_ui = 0;
} # fine else if (@is_file(C_DATI_PATH."/tema.php"))

#$pag = explode("/", $SCRIPT_NAME);
#$pag = end($pag);
$tablepersonalizza = $PHPR_TAB_PRE."personalizza";

#@include("./includes/costanti.php");
#@include(C_DATI_PATH."/costanti.php");
define('C_PHPR_VERSIONE_NUM',2.03);
define('C_PHPR_VERSIONE_TXT',"2.0.3");

# Se non si specifica nessun anno uso l'attuale
$anno_corrente = date("Y",(time() + (C_DIFF_ORE * 3600)));
if (!$anno) {
if ($id_sessione) $anno = substr($id_sessione,0,4);
else {
if (!defined('C_GIORNI_NUOVO_ANNO')) include("./costanti.php");
$anno = date("Y",(time() + (C_DIFF_ORE * 3600) - (C_GIORNI_NUOVO_ANNO * 86400)));
# Se ci troviamo nel periodo di C_GIORNI_NUOVO_ANNO ma il nuovo anno  gi stato creato
if ($anno_corrente != $anno) {
if (@is_file(C_DATI_PATH."/selectperiodi$anno_corrente.1.php")) $anno = $anno_corrente;
} # fine if ($anno_corrente != $anno)
} # fine else if ($id_sessione)
} # fine if (!$anno)

if ($vers_hinc) $vers_hinc = "?v=".C_PHPR_VERSIONE_NUM;

if ($_SERVER['SERVER_NAME']) $HOSTNAME = $_SERVER['SERVER_NAME'];
elseif ($SERVER_NAME) $HOSTNAME = $SERVER_NAME;
$HOSTNAME = htmlspecialchars($HOSTNAME);

if (strstr($_SERVER['HTTP_USER_AGENT'],'(iP') or strstr($_SERVER['HTTP_USER_AGENT'],'Android') or strstr($_SERVER['HTTP_USER_AGENT'],'webOS') or strstr($_SERVER['HTTP_USER_AGENT'],'BlackBerry')) $mobile_device = 1;
else $mobile_device = 0;


if (function_exists("aggslashdb")) {
$anno = aggslashdb($anno);
$id_sessione = aggslashdb($id_sessione);
$HOSTNAME = aggslashdb($HOSTNAME);
} # fine if (function_exists("aggslashdb"))
else {
$anno = addslashes($anno);
$id_sessione = addslashes($id_sessione);
$HOSTNAME = addslashes($HOSTNAME);
} # fine else if (function_exists("aggslashdb"))



if (!$parole_sost) {
function mex ($messaggio,$pagina) {

global $lingua_mex;
if ($lingua_mex != "ita") {
include("./includes/lang/$lingua_mex/$pagina");
} # fine if ($lingua_mex != "ita")
elseif ($pagina == "unit.php") include("./includes/unit.php");

return $messaggio;

} # fine function mex
} # fine if (!$parole_sost)


else {
function mex ($messaggio,$pagina) {

global $lingua_mex;
if ($lingua_mex != "ita") {
include("./includes/lang/$lingua_mex/$pagina");
} # fine if ($lingua_mex != "ita")
elseif ($pagina == "unit.php") include("./includes/unit.php");
if (substr($messaggio,0,4) != 'var_') @include(C_DATI_PATH."/parole_sost.php");

return $messaggio;

} # fine function mex
} # fine else if (!$parole_sost)



function controlla_anno ($anno) {

$verificato = "SI";
$verifica_num = preg_replace("/[0-9]/","",$anno);
if (strcmp($verifica_num,"")) $verificato = "NO";
if (strlen($anno) != 4) $verificato = "NO";
$prime_cifre =substr ($anno,0,2);
if ($prime_cifre != 18 and $prime_cifre != 19 and $prime_cifre != 20 and $prime_cifre != 21) $verificato = "NO";

return $verificato;

} # fine function controlla_anno

# controllo che l'anno passato a tutte le pagine non sia falso
if (controlla_anno($anno) != "SI") $anno = "";



# parametro deve essere positivo o 0
function controlla_num_pos ($num) {

$verificato = "SI";
if (!strcmp($num,"")) $verificato = "NO";
$verifica_num = preg_replace("/[0-9]/","",$num);
if (strcmp($verifica_num,"")) $verificato = "NO";

return $verificato;

} # fine function controlla_num_pos



function controlla_num ($num) {

$verificato = "SI";
$uno = substr($num,0,1);
if ($uno == "-") $num = substr($num,1);
$verifica_num = preg_replace("/[0-9]/","",$num);
if (strcmp($verifica_num,"")) $verificato = "NO";

return $verificato;

} # fine function controlla_num



function nome_valuta ($id_utente_valuta = "") {

global $tablepersonalizza;
if ($id_utente_valuta) $id_utente = $id_utente_valuta;
else global $id_utente;
$nome_valuta = esegui_query("select * from $tablepersonalizza where idpersonalizza = 'valuta' and idutente = '$id_utente'");
$nome_valuta = risul_query($nome_valuta,0,'valpersonalizza');

return $nome_valuta;

} # fine function nome_valuta



function stile_data ($id_utente_st = "") {

global $tablepersonalizza;
if ($id_utente_st) $id_utente = $id_utente_st;
else global $id_utente;
$stile_data = esegui_query("select * from $tablepersonalizza where idpersonalizza = 'stile_data' and idutente = '$id_utente'");
$stile_data = risul_query($stile_data,0,'valpersonalizza');

return $stile_data;

} # fine function stile_data



function formatta_data ($data,$stile_data="europa") {

$giorno = substr($data,8,2);
$mese = substr($data,5,2);
$anno = substr($data,0,4);
#$formato = "d-m-Y";
#if ($stile_data == 'usa') $formato = "m-d-Y";
#$data_formattata = date ($formato, mktime(0,0,0,$mese,$giorno,$anno));
switch ($stile_data) {
case "usa": $data_formattata = $mese."-".$giorno."-".$anno; break;
default: $data_formattata = $giorno."-".$mese."-".$anno;
} # fine switch ($stile_data)
$data_formattata .= substr($data,10);

return $data_formattata;

} # fine function formatta_data



function stile_soldi ($id_utente_st = "") {

global $tablepersonalizza;
if ($id_utente_st) $id_utente = $id_utente_st;
else global $id_utente;
$stile_soldi = esegui_query("select * from $tablepersonalizza where idpersonalizza = 'stile_soldi' and idutente = '$id_utente'");
$stile_soldi = risul_query($stile_soldi,0,'valpersonalizza');

return $stile_soldi;

} # fine function stile_soldi



function punti_in_num ($num,$stile_soldi="europa",$decimali="") {

#$uno = substr ($num,0,1);
#if ($uno == "-") { $num = substr ($num,1); }
#$num = strrev($num);
#$num = chunk_split($num,3,".");
#$num = substr ($num,0,-1);
#$num = strrev($num);
#if ($uno == "-") { $num = "-".$num; }

if (!strcmp($decimali,"")) {
if (!strstr($num,".") or substr(strstr($num,"."),1) == 0) $decimali = 0;
else $decimali = 2;
} # fine (!strcmp($decimali,""))
if ($stile_soldi == "usa") $num = number_format((double) $num,$decimali);
else $num = number_format((double) $num,$decimali,",",".");

return $num;

} # fine function punti_in_num



function virgola_in_num ($num,$stile_soldi="europa") {

if ($stile_soldi == "europa") $num = str_replace(".",",",$num);

return $num;

} # fine function virgola_in_num



function controlla_soldi ($num,$pos="NO") {

$verificato = "SI";
$uno = substr ($num,0,1);
if ($uno == "-" and $pos == "NO") $num = substr($num,1);
#$num = str_replace(",",".",$num);
$parti = explode(".",$num);
if (count($parti) > 2) $verificato = "NO";
$num = str_replace(".","",$num);
$verifica_num = preg_replace("/[0-9]/","",$num);
if (strcmp($verifica_num,"")) $verificato = "NO";

return $verificato;

} # fine function controlla_soldi



function formatta_soldi ($num) {

$num = str_replace(",",".",$num);
$parti = explode(".",$num);
if (count($parti) == 2) {
if ($parti[1]) {
if (strlen($parti[1]) > 2) {
$parti[1] = substr($parti[1],0,2).".".substr($parti[1],2);
$parti[1] = round($parti[1]);
} # fine if (strlen($parti[1]) > 2)
$num = $parti[0].".".$parti[1];
settype ($num,double);
} # fine if ($parti[1])
else $num = $parti[0];
} # fine if (count($parti) == 2)

return $num;

} # fine function formatta_soldi



function togli_acapo($stringa) {

$stringa = str_replace("\r\n","",$stringa);
$stringa = str_replace("\r","",$stringa);
$stringa = str_replace("\n","",$stringa);
$stringa = str_replace("
","",$stringa);

return $stringa;

} # fine function togli_acapo



function aggiungi_slash($stringa) {

$stringa = str_replace("\\","\\\\",$stringa);
$stringa = str_replace("\$","\\\$",$stringa);
$stringa = str_replace("\"","\\\"",$stringa);

return $stringa;

} # fine function aggiungi_slash



function strip_magic_slashs ($val) {
if (@get_magic_quotes_gpc()) $val = stripslashes($val);
return $val;
} # fine function strip_magic_slashs



function prendi_numero_versione ($tableversioni,$idversioni="idversioni",$num_versione="num_versione") {

$versione = esegui_query("select * from $tableversioni where $idversioni = '2'");
if (numlin_query($versione)) {
$versione = risul_query($versione,0,$num_versione);
$versione = $versione + 1;
if ($versione >= 99999990) $versione = 100;
esegui_query("update $tableversioni set $num_versione = '$versione' where $idversioni = '2'");
} # fine if (numlin_query($versione))
else {
$versione = 100;
esegui_query("insert into $tableversioni ($idversioni,$num_versione) values ('2','100') ");
} # fine else if (numlin_query($versione))

return $versione;

} # fine function prendi_numero_versione



#Funzione per controllare le sessioni

$id_utente = "";


function controlla_login (&$numconnessione,&$PHPR_TAB_PRE,&$id_sessione,$nome_utente_phpr,$password_phpr,$anno) {

if (defined("C_FILE_SCADENZA_ACCOUNT") and C_FILE_SCADENZA_ACCOUNT != "") {
$scadenza = trim(@implode("",@file("./".C_FILE_SCADENZA_ACCOUNT)));
$adesso = date("YmdHis");
if (!$scadenza or $scadenza < $adesso) {
$disattivato = "SI";
if (defined("C_HTML_PRE_LOGIN") and C_HTML_PRE_LOGIN != "") echo C_HTML_PRE_LOGIN;
echo "Expired account.<br>";
if (defined("C_HTML_POST_LOGIN") and C_HTML_POST_LOGIN != "") echo C_HTML_POST_LOGIN;
} # fine (!$scadenza or $scadenza < $adesso)
} # fine (defined("C_FILE_SCADENZA_ACCOUNT") and C_FILE_SCADENZA_ACCOUNT != "")
if (!$disattivato) {

global $lingua_mex,$tema,$pag,$ILIKE,$LIKE,$DATETIME,$nome_utente_login,$PHPR_LOG;
@include(C_DATI_PATH."/lingua.php");
@include(C_DATI_PATH."/versione.php");
if ($lingua[1] and @is_dir("./includes/lang/".$lingua[1])) $lingua_mex = $lingua[1];
else $lingua_mex = "ita";
$nome_utente_login = "";


if (!is_file(C_DATI_PATH."/abilita_login")) $id_utente = 1;

else {

if (!$id_sessione) {
if ($nome_utente_phpr and $password_phpr) {
if (!$numconnessione) {
include(C_DATI_PATH."/dati_connessione.php");
include("./includes/funzioni_$PHPR_DB_TYPE.php");
$numconnessione = connetti_db($PHPR_DB_NAME,$PHPR_DB_HOST,$PHPR_DB_PORT,$PHPR_DB_USER,$PHPR_DB_PASS,$PHPR_LOAD_EXT);
} # fine if (!$numconnessione)
$nome_utente_phpr = aggslashdb($nome_utente_phpr);
$password_phpr = aggslashdb($password_phpr);
$tableutenti = $PHPR_TAB_PRE."utenti";
$tablesessioni = $PHPR_TAB_PRE."sessioni";
$tableversioni = $PHPR_TAB_PRE."versioni";
$tabletransazioni = $PHPR_TAB_PRE."transazioni";
$tablepersonalizza = $PHPR_TAB_PRE."personalizza";
$tabelle_lock = array($tableversioni,$tablesessioni,$tabletransazioni);
$altre_tab_lock = array($tablepersonalizza,$tableutenti);
$tabelle_lock = lock_tabelle($tabelle_lock,$altre_tab_lock);

$sec_log_sbagliati = 5;
$limite_login_sbagliati = date("Y-m-d H:i:s",(time() - $sec_log_sbagliati + (C_DIFF_ORE * 3600)));
$ultimo_login_sbagliato = esegui_query("select ultimo_accesso from $tabletransazioni where tipo_transazione = 'err_l' and ultimo_accesso >= '$limite_login_sbagliati'");
if (numlin_query($ultimo_login_sbagliato) > 0) {
$mostra_form_login = "SI";
$messaggio_errore .= mex("Dopo un login <div style=\"display: inline; color: red;\">errato</div> si devono attendere","funzioni.php")." $sec_log_sbagliati ".mex("secondi","funzioni.php").".<br><br>";
} # fine if (numlin_query($ultimo_login_sbagliato) > 0)
else {
$num_log_sbagliati = 7;
$num_log_avviso = 3;
$minuti_durata_sessione = esegui_query("select valpersonalizza_num from $tablepersonalizza where idpersonalizza = 'minuti_durata_sessione' and idutente = '1'");
$minuti_durata_sessione = risul_query($minuti_durata_sessione,0,'valpersonalizza_num');
$limite_transazioni_vecchie = date("Y-m-d H:i:s",(time() - ($minuti_durata_sessione * 60) + (C_DIFF_ORE * 3600)));
esegui_query("delete from $tabletransazioni where ultimo_accesso <= '$limite_transazioni_vecchie'");
$login_sbagliati = esegui_query("select tipo_transazione from $tabletransazioni where tipo_transazione = 'err_l' and dati_transazione1 = '$nome_utente_phpr'");
$login_sbagliati = numlin_query($login_sbagliati);
if ($login_sbagliati >= $num_log_sbagliati) $messaggio_errore .= mex("Numero eccesivo di login <div style=\"display: inline; color: red;\">errati</div> negli ultimi","funzioni.php")." $minuti_durata_sessione ".mex("minuti","funzioni.php").".<br><br>";
else {

$utente = esegui_query("select * from $tableutenti where nome_utente = '$nome_utente_phpr'");
if (numlin_query($utente) == 1) {
$nome_utente_login = risul_query($utente,0,'nome_utente');
$tipo_pass = risul_query($utente,0,'tipo_pass');
$password = risul_query($utente,0,'password');
if ($tipo_pass == "5") {
if (C_VERSIONE_ATTUALE > 1.32) {
$salt = risul_query($utente,0,'salt');
for ($num1 = 0 ; $num1 < 15 ; $num1++) $password_phpr = md5($password_phpr.substr($salt,0,(20 - $num1)));
} # fine if (C_VERSIONE_ATTUALE > 1.32)
else $password_phpr = md5($password_phpr);
} # fine if ($tipo_pass == "5")

# login effettuato con successo
if ($password == $password_phpr and $tipo_pass != "n") {
$id_utente = risul_query($utente,0,'idutenti');
$adesso = $anno.date("mdHis",(time() + (C_DIFF_ORE * 3600)));
$versione_unica = prendi_numero_versione($tableversioni);
list($usec, $sec) = explode(' ', microtime());
mt_srand((float) $sec + ((float) $usec * 100000));
$val_casuale = mt_rand(100000,999999);
$id_sessione = $adesso.$val_casuale.$versione_unica;
$ultimo_accesso = date("Y-m-d H:i:s",(time() + (C_DIFF_ORE * 3600)));
global $_SERVER,$REMOTE_ADDR,$REMOTE_PORT,$HTTP_USER_AGENT;
if ($_SERVER['REMOTE_ADDR']) $REMOTE_ADDR = $_SERVER['REMOTE_ADDR'];
$REMOTE_ADDR = aggslashdb($REMOTE_ADDR);
if ($_SERVER['REMOTE_PORT']) $REMOTE_PORT = $_SERVER['REMOTE_PORT'];
$REMOTE_PORT = aggslashdb($REMOTE_PORT);
if ($_SERVER['HTTP_USER_AGENT']) $HTTP_USER_AGENT = $_SERVER['HTTP_USER_AGENT'];
$HTTP_USER_AGENT = aggslashdb($HTTP_USER_AGENT);
esegui_query("insert into $tablesessioni (idsessioni,idutente,indirizzo_ip,user_agent,ultimo_accesso) values ('$id_sessione','$id_utente','$REMOTE_ADDR','$HTTP_USER_AGENT','$ultimo_accesso')","",$id_utente);
} # fine if ($password == $password_phpr and $tipo_pass != "n")

else $login_fallito = "SI";
} # fine if (numlin_query($utente) == 1)
else $login_fallito = "SI";
if ($login_fallito == "SI") {
$mostra_form_login = "SI";
$messaggio_errore .= mex("Nome utente o password <div style=\"display: inline; color: red;\">errati</div>","funzioni.php").".<br>";
if ($login_sbagliati >= ($num_log_sbagliati - $num_log_avviso - 1)) {
if (($num_log_sbagliati - $login_sbagliati - 1) > 1) $messaggio_errore .= mex("Mancano solo","funzioni.php")." <span class=\"colred\"><b>".($num_log_sbagliati - $login_sbagliati - 1)."</b></span> ".mex("tentativi prima del blocco dei login","funzioni.php").".<br>";
if (($num_log_sbagliati - $login_sbagliati - 1) == 1) $messaggio_errore .= mex("Manca solo","funzioni.php")." <span class=\"colred\"><b>1</b></span> ".mex("tentativo prima del blocco dei login","funzioni.php").".<br>";
} # fine if (numlin_query($utente) == 1)
$messaggio_errore .= "<br>";
$versione_transazione = prendi_numero_versione($tableversioni);
$adesso = date("YmdHis",(time() + (C_DIFF_ORE * 3600)));
list($usec, $sec) = explode(' ', microtime());
mt_srand((float) $sec + ((float) $usec * 100000));
$val_casuale = mt_rand(100000,999999);
$ultimo_accesso = date("Y-m-d H:i:s",(time() + (C_DIFF_ORE * 3600)));
global $_SERVER,$REMOTE_ADDR;
if ($_SERVER['REMOTE_ADDR']) $REMOTE_ADDR = $_SERVER['REMOTE_ADDR'];
$REMOTE_ADDR = aggslashdb($REMOTE_ADDR);
$id_transazione = $adesso.$val_casuale.$versione_transazione;
esegui_query("insert into $tabletransazioni (idtransazioni,tipo_transazione,dati_transazione1,dati_transazione2,ultimo_accesso) values ('$id_transazione','err_l','$nome_utente_phpr','$REMOTE_ADDR','$ultimo_accesso')");
} # fine if ($login_fallito == "SI")

} # fine else if ($login_sbagliati >= $num_log_sbagliati)
} # fine else if (numlin_query($ultimo_login_sbagliato) > 0)
unlock_tabelle($tabelle_lock);
} # fine if ($nome_utente and $password)
else $mostra_form_login = "SI";
} # fine if (!$id_sessione)

else {
if (!$numconnessione) {
include(C_DATI_PATH."/dati_connessione.php");
include("./includes/funzioni_$PHPR_DB_TYPE.php");
$numconnessione = connetti_db($PHPR_DB_NAME,$PHPR_DB_HOST,$PHPR_DB_PORT,$PHPR_DB_USER,$PHPR_DB_PASS,$PHPR_LOAD_EXT);
} # fine if ($numconnessione)
$tableutenti = $PHPR_TAB_PRE."utenti";
$tablesessioni = $PHPR_TAB_PRE."sessioni";
$tablepersonalizza = $PHPR_TAB_PRE."personalizza";
$tabelle_lock = array($tableutenti,$tablesessioni);
$altre_tab_lock = array($tablepersonalizza);
$tabelle_lock = lock_tabelle($tabelle_lock,$altre_tab_lock);
$minuti_durata_sessione = esegui_query("select valpersonalizza_num from $tablepersonalizza where idpersonalizza = 'minuti_durata_sessione' and idutente = '1'");
$minuti_durata_sessione = risul_query($minuti_durata_sessione,0,'valpersonalizza_num');
$limite_sessioni_vecchie = date("Y-m-d H:i:s",(time() - ($minuti_durata_sessione * 60) + (C_DIFF_ORE * 3600)));
esegui_query("delete from $tablesessioni where ultimo_accesso <= '$limite_sessioni_vecchie'");
$ultimo_accesso = date("Y-m-d H:i:s",(time() + (C_DIFF_ORE * 3600)));
global $_SERVER,$REMOTE_ADDR,$REMOTE_PORT,$HTTP_USER_AGENT;
if ($_SERVER['REMOTE_ADDR']) $REMOTE_ADDR = $_SERVER['REMOTE_ADDR'];
$REMOTE_ADDR = aggslashdb($REMOTE_ADDR);
if ($_SERVER['REMOTE_PORT']) $REMOTE_PORT = $_SERVER['REMOTE_PORT'];
$REMOTE_PORT = aggslashdb($REMOTE_PORT);
if ($_SERVER['HTTP_USER_AGENT']) $HTTP_USER_AGENT = $_SERVER['HTTP_USER_AGENT'];
$HTTP_USER_AGENT = aggslashdb($HTTP_USER_AGENT);
$sessione = esegui_query("select * from $tablesessioni where idsessioni = '$id_sessione'");
if (numlin_query($sessione) == 1) {
$indirizzo_ip = risul_query($sessione,0,'indirizzo_ip');
$user_agent = risul_query($sessione,0,'user_agent');
if ($indirizzo_ip == $REMOTE_ADDR and $user_agent == $HTTP_USER_AGENT) {
$id_utente_presunto = risul_query($sessione,0,'idutente');
$utente_presente = esegui_query("select nome_utente from $tableutenti where idutenti = '$id_utente_presunto'");
if (numlin_query($utente_presente) == 1) {
$nome_utente_login = risul_query($utente_presente,0,'nome_utente');
$id_utente = $id_utente_presunto;
esegui_query("update $tablesessioni set ultimo_accesso = '$ultimo_accesso' where idsessioni = '$id_sessione'");
} # fine if (numlin_query($utente_presente) == 1)
else $sessione_scaduta = "SI";
} # fine if ($indirizzo_ip == $REMOTE_ADDR and $user_agent == $HTTP_USER_AGENT)
else $sessione_scaduta = "SI";
} # fine if (numlin_query($sessione) == 1)
else $sessione_scaduta = "SI";
unlock_tabelle($tabelle_lock);
if ($sessione_scaduta == "SI") {
$mostra_form_login = "SI";
$messaggio_errore .= "".mex("Sessione <div style=\"display: inline; color: red;\">scaduta</div>","funzioni.php").".<br><br>";
} # fine if ($sessione_scaduta == "SI")
} # fine else if (!$id_sessione)

if ($messaggio_errore or $mostra_form_login == "SI") {
if ($pag == "aggiorna.php") $action = "aggiorna.php";
else {
if ((@is_array($_POST) or @is_array($_GET)) and $pag) {
$action = $pag;
if (@is_array($_POST)) {
reset($_POST);
for ($num1 = 0 ; $num1 < count($_POST); $num1++) {
$key = key($_POST);
if ($key != "id_sessione" and $key != "nome_utente_phpr" and $key != "password_phpr" and $key != "pass_cc" and $key != "logout") $input_var_passate .= "<input type=\"hidden\" name=\"$key\" value=\"".htmlspecialchars(strip_magic_slashs(current($_POST)))."\">";
next($_POST);
} # fine for $num1
} # fine if (@is_array($_POST))
if (@is_array($_GET)) {
reset($_GET);
for ($num1 = 0 ; $num1 < count($_GET); $num1++) {
$key = key($_GET);
if ($key != "id_sessione" and $key != "nome_utente_phpr" and $key != "password_phpr" and $key != "pass_cc" and $key != "logout") $input_var_passate .= "<input type=\"hidden\" name=\"$key\" value=\"".htmlspecialchars(strip_magic_slashs(current($_GET)))."\">";
next($_GET);
} # fine for $num1
} # fine if (@is_array($_GET))
} # fine if ((@is_array($_POST) or @is_array($_GET)) and $pag)
else $action = "inizio.php";
} # fine else if ($pag == "aggiorna.php")
$pag = "login";
if (C_NASCONDI_MARCA == "SI") $titolo = "Login";
else $titolo = mex("Login per HotelDruid","funzioni.php");
$show_bar = "NO";
$tema_corr = $tema[1];
if ($tema[1] and $tema[1] != "base" and @is_dir("./themes/".$tema[1]."/php")) include("./themes/".$tema[1]."/php/head.php");
else include("./includes/head.php");
if (!defined('C_URL_LOGO') or C_URL_LOGO == "") echo "<div id=\"flogin\">";
else echo "<div style=\"background: url(".C_URL_LOGO.") no-repeat right top; padding: 5px; line-height: 1.6;\">";
echo $messaggio_errore;
} # fine if ($messaggio_errore or $mostra_form_login == "SI")
if ($mostra_form_login == "SI") {
if (@is_file(C_DATI_PATH."/dati_subordinazione.php")) include(C_DATI_PATH."/dati_subordinazione.php");
if (defined("C_HTML_PRE_LOGIN") and C_HTML_PRE_LOGIN != "") echo C_HTML_PRE_LOGIN;
$mess = $titolo;
if ($commento_subordinazione) $mess .= " ($commento_subordinazione)";
echo "<big><big>$mess:</big></big><br><div style=\"height: 6px\"></div>
<form accept-charset=\"utf-8\" method=\"post\" action=\"$action\"><div>
<input type=\"hidden\" name=\"vers_hinc\" value=\"1\">
$input_var_passate
".mex("Nome utente","funzioni.php").": <input type=\"text\" name=\"nome_utente_phpr\" size=\"12\"><br>
".mex("Password","funzioni.php").": <input type=\"password\" name=\"password_phpr\" size=\"12\" autocorrect=\"off\" autocapitalize=\"off\"><br>
<table><tr><td style=\"height: 2px;\"></td></tr></table>
<input class=\"sbutton\" type=\"submit\" name=\"effettua_login\" value=\"".mex("Entra","funzioni.php")."\">
</div></form>";
if (defined("C_HTML_POST_LOGIN") and C_HTML_POST_LOGIN != "") echo C_HTML_POST_LOGIN;
} # fine if ($mostra_form_login == "SI")
if ($messaggio_errore or $mostra_form_login == "SI") {

# You are not authorized to remove the following copyright notice. Ask for permission info@digitaldruid.net
if (C_MOSTRA_COPYRIGHT != "NO") {
echo "<div style=\"position: absolute; bottom: 3%; right: 1%; background: #ffffff; color: #000000; font-size: 11px;\">
&nbsp;Website <a style=\"color: #000000;\" href=\"./mostra_sorgente.php\">engine code</a> is copyright  by DigitalDruid.Net.
<a style=\"color: #000000;\" href=\"http://www.hoteldruid.com\">HotelDruid</a> is a free software released under the GNU/AGPL.</div>";
} # fine if (C_MOSTRA_COPYRIGHT != "NO")
echo "<div>";

if ($tema[1] and $tema[1] != "base" and @is_dir("./themes/".$tema[1]."/php")) include("./themes/".$tema[1]."/php/foot.php");
else include("./includes/foot.php");
} # fine if ($messaggio_errore or $mostra_form_login == "SI")

if ($id_utente and ($lingua[$id_utente] == "ita" or @is_dir("./includes/lang/".$lingua[$id_utente]))) $lingua_mex = $lingua[$id_utente];
} # fine else if (!is_file(C_DATI_PATH."/abilita_login"))


if ($id_utente and $tema[$id_utente] != "base" and (!$tema[$id_utente] or !@is_dir("./themes/".$tema[$id_utente]."/php"))) $tema[$id_utente] = "base";

if (C_VERSIONE_ATTUALE < C_PHPR_VERSIONE_NUM and $id_utente and $pag != "aggiorna.php") {
if (@is_file(C_DATI_PATH."/dati_connessione.php") or @is_file("./dati/connessione_db.php") or @is_file("./datipermanenti/connessione_db.inc")) {
if ($pag == "interconnessioni.php" and $id_utente != 1) {
$id_utente_az = esegui_query("select idlocale from $PHPR_TAB_PRE"."interconnessioni where tipoid = 'id_utente_az' ");
if (numlin_query($id_utente_az) == 1) $id_utente_azione_ic = risul_query($id_utente_az,0,'idlocale');
} # fine if ($pag == "interconnessioni.php" and $id_utente != 1)
if ($id_utente == $id_utente_azione_ic) {
include("./includes/funzioni_aggiorna.php");
aggiorna_versione_phpr($numconnessione,$id_utente,$id_sessione,$nome_utente_phpr,$password_phpr,$anno);
} # fine if ($id_utente == $id_utente_azione_ic) 
else {
$show_bar = "NO";
if ($tema[$id_utente] and $tema[$id_utente] != "base" and @is_dir("./themes/".$tema[$id_utente]."/php")) include("./themes/".$tema[$id_utente]."/php/head.php");
else include("./includes/head.php");
echo mex("Il database deve essere aggiornato","funzioni.php").".<br>";
echo "<form method=\"post\" action=\"aggiorna.php\"><div>
<input type=\"hidden\" name=\"anno\" value=\"$anno\">
<input type=\"hidden\" name=\"id_sessione\" value=\"$id_sessione\">
<input class=\"sbutton\" type=\"submit\" value=\"".mex("Aggiorna","funzioni.php")."\">
</div></form>";
if ($tema[$id_utente] and $tema[$id_utente] != "base" and @is_dir("./themes/".$tema[$id_utente]."/php")) include("./themes/".$tema[$id_utente]."/php/foot.php");
else include("./includes/foot.php");
} # fine else if ($id_utente == $id_utente_azione_ic) 
unset($id_utente);
} # fine if (@is_file(C_DATI_PATH."/dati_connessione.php") or...
} # fine if (C_VERSIONE_ATTUALE < C_PHPR_VERSIONE_NUM and...


return $id_utente;

} # fine if (!$disattivato)

} # fine function controlla_login



function scrivi_file ($linee,$nome_file) {

$scrittura_corretta = "SI";
if ($fileaperto = fopen("$nome_file.tmp","w+")) {
flock($fileaperto,2);
if (!@is_array($linee)) {
$linee2 = $linee;
unset($linee);
$linee[0] = $linee2;
unset($linee2);
} # fine if (!@is_array($linee))
for ($num1 = 0 ; $num1 < count($linee) ; $num1++) fwrite($fileaperto,$linee[$num1]);
flock($fileaperto,3);
fclose($fileaperto);
$linee2 = @file("$nome_file.tmp");
$num_linee2 = 0;
$ultima_linea = "";
for ($num1 = 0 ; $num1 < count($linee) ; $num1++) {
$linee[$num1] = str_replace("\r\n","\n",$linee[$num1]);
$linee[$num1] = str_replace("
","\n",$linee[$num1]);
$sub_linee = explode("\n",$linee[$num1]);
for ($num2 = 0 ; $num2 < count($sub_linee) ; $num2++) {
if ($num2 == 0)  $sub_linee[$num2] = $ultima_linea.$sub_linee[$num2];
if ($num2 != (count($sub_linee)-1)) {
if (togli_acapo($linee2[$num_linee2]) != $sub_linee[$num2]) $scrittura_corretta = "NO";
$num_linee2++;
} # fine if ($num2 != (count($sub_linee)-1))
else $ultima_linea = $sub_linee[$num2];
} # fine for $num2
} # fine for $num1
if (togli_acapo($linee2[$num_linee2]) != $ultima_linea) $scrittura_corretta = "NO";
if ($scrittura_corretta != "NO") {
@unlink("$nome_file");
if (!rename("$nome_file.tmp","$nome_file")) $scrittura_corretta = "NO";
} # fine if ($scrittura_corretta != "NO")
} # fine if ($fileaperto = fopen("$nome_file.tmp","w+"))
else $scrittura_corretta = "NO";
if ($scrittura_corretta == "NO") {
@unlink("$nome_file.tmp");
echo mex("<div style=\"display: inline; color: red;\">ERRORE</div> di scrittura del file","funzioni.php")." $nome_file.<br>";
} # fine if ($scrittura_corretta == "NO")

return $scrittura_corretta;

} # fine function scrivi_file



function crea_lock_file ($nome_file) {

$filelock = fopen("$nome_file.lock","w+");
flock($filelock,2);

return $filelock;

} # fine function crea_lock_file



function distruggi_lock_file ($filelock,$nome_file) {

flock($filelock,3);
fclose($filelock);
@unlink("$nome_file.lock");

} # fine function distruggi_lock_file



function elimina_caratteri_slash ($var) {

$var = str_replace ("'","",$var);
$var = str_replace ("\\","",$var);
$var = str_replace ("\"","",$var);

return $var;

} # fine function elimina_caratteri_slash



function recupera_dati_transazione ($id_transazione,$id_sessione,$anno,$lock_tabletransazioni,&$tipo_transazione,$minuti_durata_sessione="",$cond_sessione="SI",$cond_tipo="NO",$transazioni="transazioni") {

global $PHPR_TAB_PRE;
$tabletransazioni = $PHPR_TAB_PRE.$transazioni;
$tablepersonalizza = $PHPR_TAB_PRE."personalizza";

$tipo_transazione = "";
if ($id_transazione) {
$tabelle_lock = array($tabletransazioni);
if (!$minuti_durata_sessione) $altre_tab_lock = array($tablepersonalizza);
else $altre_tab_lock = array();
if ($lock_tabletransazioni == "SI") $tabelle_lock = lock_tabelle($tabelle_lock,$altre_tab_lock);
if (!$minuti_durata_sessione) {
$minuti_durata_sessione = esegui_query("select valpersonalizza_num from $tablepersonalizza where idpersonalizza = 'minuti_durata_sessione' and idutente = '1'");
$minuti_durata_sessione = risul_query($minuti_durata_sessione,0,'valpersonalizza_num');
} # fine if (!$minuti_durata_sessione)
$limite_transazioni_vecchie = date("Y-m-d H:i:s",(time() - ($minuti_durata_sessione * 60) + (C_DIFF_ORE * 3600)));
if ($cond_tipo != "NO") $cond_tipo = " and tipo_transazione = '$cond_tipo'";
else $cond_tipo = "";
esegui_query("delete from $tabletransazioni where ultimo_accesso <= '$limite_transazioni_vecchie' $cond_tipo");
$id_transazione = aggslashdb($id_transazione);
if ($cond_sessione == "SI") $cond_sessione = " and idsessione = '$id_sessione'";
else $cond_sessione = "";
$dati_transazione = esegui_query("select * from $tabletransazioni where idtransazioni = '$id_transazione' $cond_sessione");
if (numlin_query($dati_transazione) == 1) {
if ($anno == risul_query($dati_transazione,0,'anno')) {
$tipo_transazione = risul_query($dati_transazione,0,'tipo_transazione');
$ultimo_accesso = date("Y-m-d H:i:s",(time() + (C_DIFF_ORE * 3600)));
esegui_query("update $tabletransazioni set ultimo_accesso = '$ultimo_accesso' where idtransazioni = '$id_transazione' $cond_sessione");
} # fine if ($anno == risul_query($dati_transazione,0,'anno'))
} # fine if (numlin_query($dati_transazione) == 1)
if ($lock_tabletransazioni == "SI") unlock_tabelle($tabelle_lock);
} # fine if ($id_transazione)

return $dati_transazione;

} # fine function recupera_dati_transazione



# Function che calcola l'id del periodo corrente per le prenotazioni gi iniziate ==> fisse
function calcola_id_periodo_corrente ($anno,$anticipare="SI") {

global $id_utente;
global $PHPR_TAB_PRE;
$tableperiodi = $PHPR_TAB_PRE."periodi".$anno;
if ($anticipare == "SI") {
$tablepersonalizza = $PHPR_TAB_PRE."personalizza";
if ($id_utente == "") $id_utente_anticipa_ore = 1;
else $id_utente_anticipa_ore = $id_utente;
$ore_anticipa_periodo_corrente = esegui_query("select valpersonalizza_num from $tablepersonalizza where idpersonalizza = 'ore_anticipa_periodo_corrente' and idutente = '$id_utente_anticipa_ore'");
$ore_anticipa_periodo_corrente = risul_query($ore_anticipa_periodo_corrente,0,'valpersonalizza_num');
} # fine if ($anticipare == "SI")
else $ore_anticipa_periodo_corrente = 0;
$oggi = date("Y-m-d",(time() + ($ore_anticipa_periodo_corrente * 3600) + (C_DIFF_ORE * 3600)));
$idperiodocorrente = esegui_query("select idperiodi from $tableperiodi where datainizio <= '$oggi' and datafine >= '$oggi' ");
$numidperiodocorrente = numlin_query($idperiodocorrente);
if ($numidperiodocorrente >= 1) {
$num_risposta = 0;
if ($numidperiodocorrente == 2) $num_risposta = 1;
$idperiodocorrente = risul_query($idperiodocorrente,$num_risposta,'idperiodi');
} # fine if ($numidperiodocorrente >= 1)
else {
$annocorrente = date("Y",(time() + (C_DIFF_ORE * 3600)));
if ($anno < $annocorrente) $idperiodocorrente = 100000;
if ($anno >= $annocorrente) $idperiodocorrente = -1;
} # fine else if ($numidperiodocorrente >= 1)

return $idperiodocorrente;

} # fine function calcola_id_periodo_corrente



function mostra_menu_date ($file,$name_date_var,$date_selected,$show_blank_option,$blank_selected,$id_utente,$tema,$standalone_dates_menu="",$second_date_selected="",$js="") {

global $last_dates_menu,$hide_default_dates,$y_ini_menu,$m_ini_menu,$d_ini_menu,$n_dates_menu,$d_increment,$d_names,$m_names,$dates_options_list,$current_dates_menu,$mos_tut_dat,$modifica_pers,$partial_dates;

if ($last_dates_menu != $file) {
$y_ini_menu = "";
$m_ini_menu = "";
$d_ini_menu = "";
$n_dates_menu = "";
$d_increment = "";
$partial_dates = 0;
if (!$standalone_dates_menu) $current_dates_menu = 1;
else $current_dates_menu = 0;
if (substr($file,0,(strlen(C_DATI_PATH) + 15)) == C_DATI_PATH."/selperiodimenu" and $mos_tut_dat == "SI" and $modifica_pers != "NO") include(C_DATI_PATH."/selectperiodi".substr($file,(strlen(C_DATI_PATH) + 15)));
else include("$file");
} # fine if ($last_dates_menu != $file)
else if (!$standalone_dates_menu) $current_dates_menu++;

if ($blank_selected) $date_selected = "";
$num_periodi_date = count($d_increment);
if (($num_periodi_date > 1 or $d_increment[0] > 1) and $date_selected) {
for ($num1 = 0 ; $num1 < $num_periodi_date ; $num1++) {
for ($num2 = 0 ; $num2 < $n_dates_menu[$num1] ; $num2++) {
$data_corr = date("Y-m-d",mktime(0,0,0,($m_ini_menu[$num1] + 1),($d_ini_menu[$num1] + ($num2 * $d_increment[$num1])),$y_ini_menu[$num1]));
if ($data_corr == $date_selected) break;
if ((int) str_replace("-","",$data_corr) > (int) str_replace("-","",$date_selected)) {
if (floor($current_dates_menu / 2) == (($current_dates_menu - 1) / 2)) $date_selected = $data_prec;
else $date_selected = $data_corr;
break;
} # fine if ((int) str_replace("-","",$data_corr) > (int) str_replace("-","",$date_selected))
$data_prec = $data_corr;
} # fine for $num2
if ($data_corr == $date_selected or $data_prec == $date_selected) break;
} # fine for $num1
} # fine if (($num_periodi_date > 1 or $d_increment[0] > 1) and $date_selected)

if ($tema[$id_utente] != "base") include("./themes/".$tema[$id_utente]."/php/selectperiod.php");

if (!$hide_default_dates) {
if (!$js) $out = "<select name=\"$name_date_var\">";
else $out = "<select name=\"'+$name_date_var+'\">";
if ($show_blank_option) $out .= "<option value=\"\"$blank_selected>----</option>";
$out .= str_replace("value=\"$date_selected\">","value=\"$date_selected\" selected>",$dates_options_list);
$out .= "</select>";
if (!$js) echo $out;
else echo "$js += '".str_replace("\n","\\\n",$out)."';
";
} # fine if (!$hide_default_dates)
else unset($dates_options_list);

if (substr($file,0,(strlen(C_DATI_PATH) + 15)) == C_DATI_PATH."/selperiodimenu" and floor($current_dates_menu / 2) != (($current_dates_menu - 1) / 2) and $mos_tut_dat != "SI" and $modifica_pers != "NO" and $partial_dates) {
if (@is_array($_POST)) reset($_POST);
for($num1 = 0 ; $num1 < count($_POST); $num1++) {
if (key($_POST) != "mos_tut_dat" and substr(key($_POST),0,8) != "modifica") $lista_var .= "&amp;".htmlspecialchars(key($_POST))."=".htmlspecialchars(strip_magic_slashs($_POST[key($_POST)]));
next($_POST);
} # fine for $num1
if (@is_array($_GET)) reset($_GET);
for($num1 = 0 ; $num1 < count($_GET); $num1++) {
if (key($_GET) != "mos_tut_dat" and substr(key($_GET),0,8) != "modifica") $lista_var .= "&amp;".htmlspecialchars(key($_GET))."=".htmlspecialchars(strip_magic_slashs($_GET[key($_GET)]));
next($_GET);
} # fine for $num1
if ($lista_var) {
$lista_var = "?mos_tut_dat=SI".$lista_var;
$out = "<a href=\"$pag$lista_var\" style=\"text-decoration: none;\" title=\"".mex("mostra tutte le date","inizio.php")."\"><b style=\"font-weight: normal; color: #666666;\">&prime;</b></a>";
if (!$js) echo $out;
else echo "$js += '".str_replace("\n","\\\n",$out)."';
";
} # fine if ($lista_var)
} # fine if (substr($file,0,(strlen(C_DATI_PATH) + 15)) == C_DATI_PATH."/selperiodimenu" and floor($current_dates_menu / 2) != (($current_dates_menu - 1) / 2) and...

$last_dates_menu = $file;

} # fine function mostra_menu_date



function allunga_tempo_limite ($n_lim="") {

if (function_exists('set_time_limit')) {
if (!strcmp($n_lim,"")) $n_lim = 420;
$lim_att = 30;
if (function_exists('ini_get')) $lim_att = ini_get('max_execution_time');
if ($lim_att < $n_lim) set_time_limit($n_lim);
} # fine if (function_exists('set_time_limit')

} # fine function allunga_tempo_limite



function http_keep_alive ($car=" ") {

echo $car;
flush();
if (function_exists('ob_flush')) ob_flush();

} # fine function http_keep_alive



/*
function aggiorna_interconnessioni ($nome_funz1,$nome_funz2,$anno,$PHPR_TAB_PRE,$lock) {

$file_interconnessioni = C_DATI_PATH."/dati_interconnessioni.php";
if (@is_file($file_interconnessioni)) {
include($file_interconnessioni);
if (@is_array($ic_present)) {
$interconn_dir = opendir("./includes/interconnect/");
while ($mod_ext = readdir($interconn_dir)) {
if ($mod_ext != "." and $mod_ext != ".." and @is_dir("./includes/interconnect/$mod_ext")) {
include("./includes/interconnect/$mod_ext/name.php");
if ($ic_present[$interconnection_name] == "SI") {
$funz_agg_interconn = $nome_funz1.$interconnection_name;
if (!function_exists($funz_agg_interconn)) include("./includes/interconnect/$mod_ext/functions.php");
$funz_agg_interconn($file_interconnessioni,$anno,$PHPR_TAB_PRE,$lock);
if ($nome_funz2) {
$funz_agg_interconn = $nome_funz2.$interconnection_name;
$funz_agg_interconn($file_interconnessioni,$anno,$PHPR_TAB_PRE,$lock);
} # fine if ($nome_funz2)
} # fine if ($ic_present[$interconnection_name] == "SI")
} # fine if ($modello_ext != "." and $modello_ext != ".." and...
} # fine while ($mod_ext = readdir($interconn_dir))
closedir($interconn_dir);
} # fine if (@is_array($ic_present))
} # fine if (@is_file($file_interconnessioni))

} # fine function aggiorna_interconnessioni
*/




###########################################
###  FINE ./includes/funzioni.php 
###########################################

###########################################
###  INIZIO ./dati/versione.php 
###########################################
define(C_VERSIONE_ATTUALE,2.03);
define(C_DIFF_ORE,0);

###########################################
###  FINE ./dati/versione.php 
###########################################

###########################################
###  INIZIO ./includes/liberasettimane.php 
###########################################

##################################################################################
#    HOTELDRUID
#    Copyright (C) 2001-2012 by Marco Maria Francesco De Santis (marco@digitaldruid.net)
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    any later version accepted by Marco Maria Francesco De Santis, which
#    shall act as a proxy as defined in Section 14 of version 3 of the
#    license.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
##################################################################################



$debug = "off";
$sec_limite_libsett = "";
#apd_set_pprof_trace();


# Function per passare dalla tabella prenota alle variabili
function tab_a_var (&$limiti_var,&$app_prenota_id,&$app_orig_prenota_id,&$inizio_prenota_id,&$fine_prenota_id,&$app_assegnabili_id,&$prenota_in_app_sett,$anno,&$dati_app,$profondita,$nome_tab_prenota = "prenota") {
global $PHPR_TAB_PRE,$sec_limite_libsett,$debug;
$tableprenota = $nome_tab_prenota . $anno . $profondita['iniziale'];
$tableperiodi = $PHPR_TAB_PRE."periodi".$anno;
$tableappartamenti = $PHPR_TAB_PRE."appartamenti";

if (!$limiti_var['idperiodocorrente']) $limiti_var['idperiodocorrente'] = calcola_id_periodo_corrente($anno);
if (!$limiti_var['tutti_fissi']) {
$tablepersonalizza = $PHPR_TAB_PRE."personalizza";
$prenota_tutte_fisse = esegui_query("select valpersonalizza from $tablepersonalizza where idpersonalizza = 'tutti_fissi' and idutente = '1'");
$limiti_var['tutti_fissi'] = risul_query($prenota_tutte_fisse,0,'valpersonalizza');
if ($limiti_var['tutti_fissi'] != "SI") {
if (defined("C_SEC_LIMITE_LIBERA_APP") and C_SEC_LIMITE_LIBERA_APP != "") $sec_limite_libsett = C_SEC_LIMITE_LIBERA_APP;
else $sec_limite_libsett = $limiti_var['tutti_fissi'];
$limiti_var['t_limite'] = (time() + $sec_limite_libsett);
} # fine if ($limiti_var['tutti_fissi'] != "SI")
} # fine if (!$limiti_var['tutti_fissi'])
if (!$limiti_var['lim_prenota_temp']) {
$minuti_durata_insprenota = esegui_query("select valpersonalizza_num from $tablepersonalizza where idpersonalizza = 'minuti_durata_insprenota' and idutente = '1'");
$minuti_durata_insprenota = risul_query($minuti_durata_insprenota,0,'valpersonalizza_num');
$limiti_var['lim_prenota_temp'] = date("Y-m-d H:i:s",(time() + (C_DIFF_ORE * 3600) - ($minuti_durata_insprenota * 60)));
} # fine if (!$limiti_var['lim_prenota_temp'])

# metto i dati della tabella appartamenti in $dati_app
if (!$dati_app) {
$idapp = esegui_query("select idappartamenti,maxoccupanti,app_vicini from $tableappartamenti order by priorita");
$numappartamenti = numlin_query($idapp);
for ($num1 = 0 ; $num1 < $numappartamenti ; $num1++) {
$numapp = risul_query($idapp,$num1,'idappartamenti');
$maxocc = risul_query($idapp,$num1,'maxoccupanti');
$dati_app['posizione'][$num1] = $numapp;
$dati_app['maxocc'][$numapp] = $maxocc;
$dati_app['vicini'][$numapp] = risul_query($idapp,$num1,'app_vicini');
if ($dati_app['vicini'][$numapp]) $dati_app['vicini'][$numapp] .= ",$numapp";
else $dati_app['vicini'][$numapp] = "$numapp";
} # fine for $num1
asort ($dati_app['maxocc']);
reset ($dati_app['maxocc']);
$dati_app['minocc'] = current($dati_app['maxocc']);
$lista_tutti_app = ",";
while (list($key, $val) = each($dati_app['posizione'])) $lista_tutti_app .= "$val,";
$dati_app['lista'] = $lista_tutti_app;
$dati_app['totapp'] = $numappartamenti;
} # fine if (!$dati_app)

if ((string) $limiti_var['ini'] == "") $limiti_var['ini'] = ($limiti_var['n_fine'] + 1);
if ((string) $limiti_var['fine'] == "") $limiti_var['fine'] = ($limiti_var['n_ini'] - 1);
for ($num_rip = 0 ; $num_rip < 2 ; $num_rip++) {
if ($num_rip) {
if ($lista_comp) {
$lista_comp = explode(",",substr($lista_comp,1));
$num_lista_comp = count($lista_comp);
for ($num1 = 0 ; $num1 < $num_lista_comp ; $num1++) {
if (!$app_prenota_id[$lista_comp[$num1]]) {
$query_comp .= "idprenota = '".$lista_comp[$num1]."' or ";
} # fine if (!$app_prenota_id[$lista_comp[$num1]])
} # fine for $num1
$query_comp = substr($query_comp,0,-3);
} # fine if ($lista_comp)
if ($query_comp) $prenota_in_var = esegui_query("select idprenota,idclienti,idappartamenti,iddatainizio,iddatafine,assegnazioneapp,app_assegnabili,num_persone,idprenota_compagna,checkin,datainserimento from $tableprenota where $query_comp ");
else break;
} # fine if ($num_rip)
else $prenota_in_var = esegui_query("select idprenota,idclienti,idappartamenti,iddatainizio,iddatafine,assegnazioneapp,app_assegnabili,num_persone,idprenota_compagna,checkin,datainserimento from $tableprenota where (iddatainizio < '".$limiti_var[ini]."' and iddatafine >= '".$limiti_var[n_ini]."') or (iddatainizio <= '".$limiti_var[n_fine]."' and iddatafine > '".$limiti_var[fine]."')");
$num_prenota_in_var = numlin_query($prenota_in_var);
for ($num1 = 0 ; $num1 < $num_prenota_in_var ; $num1++) {
$ins_prenota = 1;
if (risul_query($prenota_in_var,$num1,'idclienti') == "0") {
if ($limiti_var['lim_prenota_temp'] > risul_query($prenota_in_var,$num1,'datainserimento')) $ins_prenota = 0;
} # fine if (risul_query($prenota_in_var,$num1,'idclienti') == "0")
$idprenota = risul_query($prenota_in_var,$num1,'idprenota');
if (!$app_prenota_id[$idprenota] and $ins_prenota) {
$app_prenota = risul_query($prenota_in_var,$num1,'idappartamenti');
if (strstr($dati_app['lista'],",".$app_prenota.",")) {
$app_prenota_id[$idprenota] = $app_prenota;
$app_orig_prenota_id[$idprenota] = $app_prenota_id[$idprenota];
$inizio_prenota_id[$idprenota] = risul_query($prenota_in_var,$num1,'iddatainizio');
$fine_prenota_id[$idprenota] = risul_query($prenota_in_var,$num1,'iddatafine');
$app_assegnabili_id[0][$idprenota] = risul_query($prenota_in_var,$num1,'idprenota_compagna');
if ($app_assegnabili_id[0][$idprenota]) $lista_comp .= ",".$app_assegnabili_id[0][$idprenota];
for ($num2 = $inizio_prenota_id[$idprenota] ; $num2 <= $fine_prenota_id[$idprenota] ; $num2++) {
$prenota_in_app_sett[$app_prenota_id[$idprenota]][$num2] = $idprenota;
} # fine for $num2
$assegnazione_app = risul_query($prenota_in_var,$num1,'assegnazioneapp');
$checkin = risul_query($prenota_in_var,$num1,'checkin');
if ($inizio_prenota_id[$idprenota] > $limiti_var['idperiodocorrente'] and $assegnazione_app != "k" and $limiti_var['tutti_fissi'] != "SI" and !$checkin) {
$num_persone = risul_query($prenota_in_var,$num1,'num_persone');
$app_assegnabili = risul_query($prenota_in_var,$num1,'app_assegnabili');
if (!$num_persone or $num_persone <= $dati_app['minocc']) {
if ($assegnazione_app == "v") $app_assegnabili_id[$idprenota] = "v";
if ($assegnazione_app == "c") $app_assegnabili_id[$idprenota] = $app_assegnabili;
} # fine if (!$num_persone or $num_persone <= $dati_app['minocc'])
else {
if ($assegnazione_app == "v") $lista_app = $dati_app['lista'];
if ($assegnazione_app == "c") $lista_app = ",".$app_assegnabili.",";
$app_in_lista = explode (",", $lista_app);
$num_app_in_lista = count($app_in_lista) - 1;
for ($num2 = 1 ; $num2 < $num_app_in_lista ; $num2++) {
if ($dati_app['maxocc'][$app_in_lista[$num2]] and $dati_app['maxocc'][$app_in_lista[$num2]] < $num_persone) {
$lista_app = str_replace(",".$app_in_lista[$num2].",",",",$lista_app);
} # fine if ($dati_app['maxocc'][$app_in_lista[$num2]] and $dati_app['maxocc'][$app_in_lista[$num2]] < $num_persone)
} # fine for $num2
$lista_app = substr($lista_app,1,-1);
$app_assegnabili_id[$idprenota] = $lista_app;
} # fine else if (!$num_persone or $num_persone <= $dati_app[minocc])
} # fine if ($inizio_prenota_id[$idprenota] > $limiti_var['idperiodocorrente'] and $assegnazione_app != "k" and...
if ($debug == "on") echo "Aggiunta prenota $idprenota dal ".$inizio_prenota_id[$idprenota]." al ".$fine_prenota_id[$idprenota]." in ".$app_prenota_id[$idprenota]." assegnabile in ".$app_assegnabili_id[$idprenota]."<br>";
} # fine if (strstr($dati_app['lista'],",".$app_prenota.","))
} # fine if (!$app_prenota_id[$idprenota] and $ins_prenota)
} # fine for $num1
} # fine for $num_rip
if ($limiti_var['n_ini'] < $limiti_var['ini']) $limiti_var['ini'] = $limiti_var['n_ini'];
if ($limiti_var['n_fine'] > $limiti_var['fine']) $limiti_var['fine'] = $limiti_var['n_fine'];

} # fine function tab_a_var




# Function per trovare tutte le prenotazioni in un appartamento in un certo periodo
function prenota_in_app_e_periodo (&$app,&$ini_periodo,&$fine_periodo,&$prenota_in_app_sett,&$fine_prenota_id,&$num_pp) {
$num_pp = 0;
for ($num1 = $ini_periodo ; $num1 <= $fine_periodo ; $num1++) {
if ($prenota_in_app_sett[$app][$num1]) {
$num_pp++;
$prenota_presente[$num_pp] = $prenota_in_app_sett[$app][$num1];
$num1 = $fine_prenota_id[$prenota_in_app_sett[$app][$num1]];
} # fine if ($prenota_in_app_sett[$app][$num1])
} # fine for $num1
return $prenota_presente;
} # fine function prenota_in_app_e_periodo




function inserisci_prenota_fittizie ($info_periodi,&$profondita,&$app_prenota_id,&$inizio_prenota_id,&$fine_prenota_id,&$prenota_in_app_sett,&$app_assegnabili_id) {
for ($num1 = 0 ; $num1 < $info_periodi['numero'] ; $num1++) {
$id_app_periodo = $info_periodi['app'][$num1];
$idinizio_periodo = $info_periodi['ini'][$num1];
$idfine_periodo = $info_periodi['fine'][$num1];
$idinizio_prenota_falsa = $idinizio_periodo;
$prenota_falsa_da_inserire = "NO";
for ($num2 = $idinizio_periodo ; $num2 <= ($idfine_periodo + 1) ; $num2++) {
$prenota_presente = prenota_in_app_e_periodo($id_app_periodo,$num2,$num2,$prenota_in_app_sett,$fine_prenota_id,$num_pp);
if ($num_pp or $num2 == ($idfine_periodo + 1)) {
if ($prenota_falsa_da_inserire == "SI") {
$profondita['tot_prenota_attuale']++;
$app_prenota_id[$profondita['tot_prenota_attuale']] = $id_app_periodo;
$inizio_prenota_id[$profondita['tot_prenota_attuale']] = $idinizio_prenota_falsa;
$fine_prenota_id[$profondita['tot_prenota_attuale']] = $idfine_prenota_falsa;
for ($num3 = $idinizio_prenota_falsa ; $num3 <= $idfine_prenota_falsa ; $num3++) {
$prenota_in_app_sett[$id_app_periodo][$num3] = $profondita['tot_prenota_attuale'];
} # fine for $num3
} # fine if ($prenota_falsa_da_inserire == "SI")
$prenota_falsa_da_inserire = "NO";
$idinizio_prenota_falsa = $num2 + 1;
if ($num2 != ($idfine_periodo + 1)) {
reset($prenota_presente);
for ($num3 = 1 ; $num3 <= $num_pp ; $num3++) $app_assegnabili_id[$prenota_presente[$num3]] = "";
} # fine if ($num2 != ($idfine_periodo + 1))
} # fine if ($num_pp or $num2 == ($idfine_periodo + 1))
else {
$prenota_falsa_da_inserire = "SI";
$idfine_prenota_falsa = $num2;
} # fine else if ($num_pp or $num2 == ($idfine_periodo + 1))
} # fine for $num2
} # fine for $num1
} # fine function inserisci_prenota_fittizie




function incrocia_app_richiesti ($lista_app1,$lista_app2) {
if ((string) $lista_app1 != "" and (string) $lista_app2 != "") {
if ($lista_app1 == ",tutti,") $lista_app = $lista_app2;
if ($lista_app2 == ",tutti,") $lista_app = $lista_app1;
if ($lista_app1 != ",tutti," and $lista_app2 != ",tutti,") {
$lista_app1 = explode(",",$lista_app1);
$num_la1 = count($lista_app1);
for ($num1 = 0 ; $num1 < $num_la1 ; $num1++) {
if (str_replace(",".$lista_app1[$num1].",","",",".$lista_app2.",") != ",".$lista_app2.",") $lista_app .= $lista_app1[$num1].",";
} # fine for $num1
$lista_app = substr($lista_app,0,-1);
} # fine ($lista_app1 != ",tutti," and $lista_app2 != ",tutti,")
} # fine ((string) $lista_app1 != "" and (string) $lista_app2 != "")
return $lista_app;
} # fine function incrocia_app_richiesti




if (!function_exists("array_keys")) {
function array_keys($arr,$term="") {
$t = array();
while (list($k,$v) = each($arr)) {
if ($term && $v != $term) continue;
$t[] = $k;
} # fine while (list($k,$v) = each($arr))
return $t;
} # fine function array_keys
} # fine if (!function_exists("array_keys"))




function aggiorna_tableprenota ($app_prenota_id,$app_orig_prenota_id,$nome_tableprenota) {
$fatto = 1;
if (@is_array($app_orig_prenota_id)) {
reset($app_orig_prenota_id);
while (list($idprenota, $app_prenota) = each($app_orig_prenota_id)) if (!strcmp($app_prenota_id[$idprenota],"")) $fatto = 0;
if ($fatto) {
reset($app_orig_prenota_id);
while (list($idprenota, $app_prenota) = each($app_orig_prenota_id)) {
if ($app_prenota_id[$idprenota] != $app_prenota) {
esegui_query("update $nome_tableprenota set idappartamenti = '".aggslashdb($app_prenota_id[$idprenota])."' where idprenota = '$idprenota'");
#$adesso = date("Y-M-d H:i:s",(time() + (C_DIFF_ORE * 3600)));
#esegui_query("update $tableprenota set data_modifica = '$adesso' where idprenota = '$idprenota'");
} # fine if ($app_prenota_id[$idprenota] != $app_prenota)
} # fine while (list($key, $val) = each($app_orig_prenota_id))
} # fine if ($fatto)
else echo "<span class=\"colred\">ERROR in assignment engine: please report this bug to <a href=\"mailto:info@digitaldruid.net\">info@digitaldruid.net</a></span><br>";
} # fine if (@is_array($app_orig_prenota_id))
return $fatto;
} # fine function aggiorna_tableprenota




# function che controlla che gli app. richiesti non siano tutti occupati
function controlla_tutti_occupati ($idinizio,$idfine,$app_richiesti,&$prenota_in_app_sett,&$app_prenota_id,&$app_assegnabili_id,&$dati_app,&$fine_prenota_id) {
$tutti_occupati = "NO";
if ($app_richiesti) while (list($key, $val) = each($app_richiesti)) if ($val != "SI") unset($app_richiesti[$key]);
if (!$app_richiesti) $num_app_controlla_orig = $dati_app['totapp'];
else $num_app_controlla_orig = count($app_richiesti);
for ($num1 = $idinizio ; $num1 <= $idfine ; $num1++) {
$num_prenota_presenti_in_settimana = 0;
for ($num2 = 0 ; $num2 < $dati_app['totapp'] ; $num2++) {
if ($prenota_in_app_sett[$dati_app['posizione'][$num2]][$num1]) $num_prenota_presenti_in_settimana++;
} # fine for $num2
if ($num_prenota_presenti_in_settimana >= $num_app_controlla_orig) {
if (!$app_richiesti) { $tutti_occupati = "SI"; break; }
else {
$app_controlla = $app_richiesti;
$uno_libero = "NO";
reset($app_controlla);
while (list($key, $val) = each($app_controlla)) {
$prenotainperiodo = prenota_in_app_e_periodo($key,$num1,$num1,$prenota_in_app_sett,$fine_prenota_id,$num_pp);
if (!$num_pp) { $uno_libero = "SI"; break; }
$app_assegnabili_prenota = $app_assegnabili_id[$prenotainperiodo[1]];
if ($app_assegnabili_prenota == "v") {
if ($num_prenota_presenti_in_settimana < $dati_app['totapp']) $uno_libero = "SI";
break;
} # fine if ($app_assegnabili_prenota == "v")
if ($app_assegnabili_prenota) {
$app_assegnabili_prenota = explode (",", $app_assegnabili_prenota);
$n_app_assegnabili_prenota = count($app_assegnabili_prenota);
for ($num2 = 0 ; $num2 < $n_app_assegnabili_prenota ; $num2++) if (!$app_controlla[$app_assegnabili_prenota[$num2]]) $app_controlla[$app_assegnabili_prenota[$num2]] = "SI";
} # fine if ($app_assegnabili_prenota)
} # fine while (list($key, $val) = each($app_controlla))
if ($uno_libero == "NO") { $tutti_occupati = "SI"; break; }
} # fine else if (!$app_richiesti)
} # fine if ($num_prenota_presenti_in_settimana >= $num_app_controlla_orig)
} # fine for $num1
return $tutti_occupati;
} # fine function controlla_tutti_occupati




# function che trova tutte le prenotazioni in un periodo
function lista_prenota_periodo ($idinizio,$idfine,&$dati_app,&$prenota_in_app_sett,&$pren_pres_in_lista,&$lista_prenota_periodo,&$num_lista_pren_per) {
for ($num1 = $idinizio ; $num1 <= $idfine ; $num1++) {
for ($num2 = 0 ; $num2 < $dati_app['totapp'] ; $num2++) {
$pren_in_sett = $prenota_in_app_sett[$dati_app['posizione'][$num2]][$num1];
if ($pren_in_sett and !$pren_pres_in_lista[$pren_in_sett]) {
$pren_pres_in_lista[$pren_in_sett] = 1;
$lista_prenota_periodo[$num_lista_pren_per] = $pren_in_sett;
$num_lista_pren_per++;
} # fine if ($pren_in_sett and !$pren_pres_in_lista[$pren_in_sett])
} # fine for $num2
} # fine for $num1
} # fine function lista_prenota_periodo




# function che cancella le prenotazioni vicine e prepara le variabili per liberasettimane
function cancella_prenota_compagne ($idprenota_comp,$num_idprenota_comp,&$idinizioprenota,&$idfineprenota,&$app_richiesti,$inizio_prenota_id,$fine_prenota_id,$app_assegnabili_id,$app_prenota_id,&$prenota_in_app_sett) {
$id_ric = 1;
$idinizioprenota_vett = "";
$idfineprenota_vett = "";
$idinizioprenota_vett[$id_ric] = $idinizioprenota;
$idfineprenota_vett[$id_ric] = $idfineprenota;
$idinizioprenota = $idinizioprenota_vett;
$idfineprenota = $idfineprenota_vett;
$app_richiesti_vett = "";
if (!$app_richiesti) $app_richiesti_vett[$id_ric] = ",tutti,";
else {
while (list($key, $val) = each($app_richiesti)) if ($val == "SI") $app_richiesti_vett[$id_ric] .= $key.",";
$app_richiesti_vett[$id_ric] = substr($app_richiesti_vett[$id_ric],0,-1);
} # fine else if (!$app_richiesti)
$app_richiesti = $app_richiesti_vett;
$app_richiesti[',vicini,'] = "SI";
$app_richiesti[',numero,'] = $num_idprenota_comp + 1;
for ($num1 = 0 ; $num1 < $num_idprenota_comp ; $num1++) {
$id_comp = $idprenota_comp[$num1];
if ($fine_prenota_id[$id_comp]) {
$id_ric++;
$idinizioprenota[$id_ric] = $inizio_prenota_id[$id_comp];
$idfineprenota[$id_ric] = $fine_prenota_id[$id_comp];
$app_richiesti[$id_ric] = $app_assegnabili_id[$id_comp];
if (!$app_assegnabili_id[$id_comp]) $app_richiesti[$id_ric] = $app_prenota_id[$id_comp];
if ($app_assegnabili_id[$id_comp] == "v") $app_richiesti[$id_ric] = ",tutti,";
for ($num2 = $idinizioprenota[$id_ric] ; $num2 <= $idfineprenota[$id_ric] ; $num2++) {
$prenota_in_app_sett[$app_prenota_id[$id_comp]][$num2] = "";
} # fine for $num2
#$app_prenota_id[$id_comp] = "";
} # fine if ($fine_prenota_id[$id_comp])
} # fine for $num1
} # fine function cancella_prenota_compagne




function ripristina_prenota_compagne ($idprenota_comp,$num_idprenota_comp,&$idinizioprenota,&$idfineprenota,&$appartamento,&$app_prenota_id,&$prenota_in_app_sett,$fine_prenota_id,$profondita) {
global $debug;
for ($num1 = 0 ; $num1 < $num_idprenota_comp ; $num1++) {
$id_comp = $idprenota_comp[$num1];
if ($fine_prenota_id[$id_comp]) {
$id_ric = $num1 + 2;
$app_prenota_id[$id_comp] = $appartamento[$id_ric];
if ($debug == "on") {
echo "&nbsp;";
for ($i = 0 ; $i < $profondita['attuale'] ; $i++) echo "&nbsp;&nbsp;";
echo "<b>".$profondita['attuale']."</b> spostata pren $id_comp in  ".$appartamento[$id_ric]."<br>";
} # fine if ($debug == "on")
for ($num2 = $idinizioprenota[$id_ric] ; $num2 <= $idfineprenota[$id_ric] ; $num2++) {
$prenota_in_app_sett[$appartamento[$id_ric]][$num2] = $id_comp;
} # fine for $num2
} # fine if ($fine_prenota_id[$id_comp])
} # fine for $num1
$idinizioprenota = $idinizioprenota[1];
$idfineprenota = $idfineprenota[1];
$appartamento = $appartamento[1];
} # fine function ripristina_prenota_compagne




function aggiorna_app_aggiunti (&$limiti_var,&$limiti_var_orig,&$app_orig_prenota_id,&$app_prenota_id,&$inizio_prenota_id,&$fine_prenota_id,&$prenota_in_app_sett) {
if ($limiti_var['ini'] < $limiti_var_orig['ini'] or $limiti_var['fine'] > $limiti_var_orig['fine']) {
if (@is_array($app_orig_prenota_id)) {
reset($app_orig_prenota_id);
while (list($idp,$app) = each($app_orig_prenota_id)) {
if (!strcmp($app_prenota_id[$idp],"")) {
$app_prenota_id[$idp] = $app;
for ($num1 = $inizio_prenota_id[$idp] ; $num1 <= $fine_prenota_id[$idp] ; $num1++) {
$prenota_in_app_sett[$app][$num1] = $idp;
} # fine for $num1
} # fine if (!strcmp($app_prenota_id[$key2],""))
} # fine while (list($key2, $val2) = each($app_orig_prenota_id))
} # fine if (@is_array($app_orig_prenota_id))
} # fine if ($limiti_var['ini'] < $limiti_var_orig['ini'] or...
} # fine function aggiorna_app_aggiunti




# Struttura delle variabili sulle prenotazioni create con tab_a_var() :
#
# $prenota_in_app_sett[id_app][id_settimana] = id_prenota ("" se vuoto)
# $inizio_prenota_id[id_prenota] = "id_settimana"
# $fine_prenota_id[id_prenota] = "id_settimana"
# $app_prenota_id[id_prenota] = "id_app"
# $app_assegnabili_id[id_prenota] = {"id_app,id_app,...,id_app" | "v" | ""} (app. fisso se vuoto)
# $app_assegnabili_id[0][id_prenota] = {"id_prenota,...,id_prenota" | ""} (nessuna prenota compagna se vuoto)





#
# LIBERASETTIMANE: function ricorsiva per l'assegnazione degli appartamenti.
#
function liberasettimane ($idinizio,$idfine,&$limiti_var,$anno,&$fatto,&$appartamento,$profondita,$app_richiesti,&$app_prenota_id,&$app_orig_prenota_id,&$inizio_prenota_id,&$fine_prenota_id,&$app_assegnabili_id,&$prenota_in_app_sett,&$dati_app,$nome_tab_prenota = "prenota") {
global $debug;

if ($app_richiesti[',numero,']) {
$app_richiesti_vett = $app_richiesti;
$idinizio_vett = $idinizio;
$idfine_vett = $idfine;
if (@is_array($appartamento)) $appartamento_vett = $appartamento;
if (!$app_richiesti_vett['id']) {
$app_richiesti_vett['id'] = 1;
$limiti_var['n_ini'] = "";
$limiti_var['n_fine'] = "";
for ($num1 = 1 ; $num1 <= $app_richiesti_vett[',numero,'] ; $num1++) {
if (!$limiti_var['n_ini'] or $limiti_var['n_ini'] > $idinizio_vett[$num1]) $limiti_var['n_ini'] = $idinizio_vett[$num1];
if (!$limiti_var['n_fine'] or $limiti_var['n_fine'] < $idfine_vett[$num1]) $limiti_var['n_fine'] = $idfine_vett[$num1];
} # fine for $num1
} # fine if (!$app_richiesti_vett['id'])
else {
$app_richiesti_vett['id']++;
$limiti_var['n_ini'] = $idinizio_vett[$app_richiesti_vett['id']];
$limiti_var['n_fine'] = $idfine_vett[$app_richiesti_vett['id']];
} # fine else if (!$app_richiesti_vett['id'])
unset($app_richiesti);
if ($app_richiesti_vett[$app_richiesti_vett['id']] != ",tutti,") {
$vett_app = explode(",",$app_richiesti_vett[$app_richiesti_vett['id']]);
$n_vett_app = count($vett_app);
for ($num1 = 0 ; $num1 < $n_vett_app ; $num1++) $app_richiesti[$vett_app[$num1]] = "SI";
} # fine if ($app_richiesti_vett[$app_richiesti_vett[id]] != ",tutti,")
$idinizio = $idinizio_vett[$app_richiesti_vett['id']];
$idfine = $idfine_vett[$app_richiesti_vett['id']];
$appartamento = "";
} # fine if ($app_richiesti[',numero,'])
else {
$limiti_var['n_ini'] = $idinizio;
$limiti_var['n_fine'] = $idfine;
} # fine else if ($app_richiesti[',numero,'])

if (!@is_array($profondita)) {
$primo_ciclo = "SI";
$prof_copia = $profondita;
$profondita = "";
$profondita['iniziale'] = $prof_copia;
$profondita['attuale'] = $prof_copia;
$tableprenota = $nome_tab_prenota . $anno . $profondita['iniziale'];
$max_prenota = esegui_query("select max(idprenota) from $tableprenota");
$tot_prenota = risul_query($max_prenota,0,0);
$profondita['tot_prenota_ini'] = $tot_prenota;
$profondita['tot_prenota_attuale'] = $tot_prenota;
tab_a_var($limiti_var,$app_prenota_id,$app_orig_prenota_id,$inizio_prenota_id,$fine_prenota_id,$app_assegnabili_id,$prenota_in_app_sett,$anno,$dati_app,$profondita,$nome_tab_prenota);
} # fine if (!@is_array($profondita))
if ($profondita['controllato_tutti_occupati'] != "SI") {
$tutti_occupati = controlla_tutti_occupati($idinizio,$idfine,$app_richiesti,$prenota_in_app_sett,$app_prenota_id,$app_assegnabili_id,$dati_app,$fine_prenota_id);
$profondita['controllato_tutti_occupati'] = "SI";
} # fine if ($profondita[controllato_tutti_occupati] != "SI")
if ($tutti_occupati == "SI") $fatto = "SI";
else $fatto = "NO";
$num_da_liberare = 1;
$num_da_liberare2 = 1;


# cicli da ripetere per ogni appartamento fino a che $fatto = SI

# primo ciclo che controlla se c' gi un appartamento libero
if ($fatto != "SI") {
for ($num1 = 0 ; $num1 < $dati_app['totapp'] ; $num1++) {
$numapp = $dati_app['posizione'][$num1];
if (!$app_richiesti or $app_richiesti[$numapp] == "SI") {
if ($app_richiesti_vett[',vicini,'] != "SI" or $dati_app['vicini'][$numapp] != $numapp) {
$prenotainperiodo = prenota_in_app_e_periodo($numapp,$idinizio,$idfine,$prenota_in_app_sett,$fine_prenota_id,$num_pp);
if (!$num_pp) {
$appartamento = $numapp;
$fatto = "SI";
if ($debug == "on") echo "LIBERATO1 $appartamento<br>";
break;
} # fine if (!$num_pp)
} # fine if ($app_richiesti_vett[',vicini,'] != "SI" or $dati_app['vicini'][$numapp] != $numapp)
} # fine if (!$app_richiesti or $app_richiesti[$numapp] == "SI")
} # fine for $num1
} # fine if ($fatto != "SI")

if ($fatto != "SI") {

# allargo il periodo passato dalla tabella alle variabili se necessario
$lista_prenota_periodo = "";
$pren_pres_in_lista = "";
$num_lista_pren_per = 0;
if (!$limiti_var[s_ini]) {
lista_prenota_periodo($idinizio,$idfine,$dati_app,$prenota_in_app_sett,$pren_pres_in_lista,$lista_prenota_periodo,$num_lista_pren_per);
$limiti_var[s_ini] = $idinizio;
$limiti_var[s_fine] = $idfine;
} # fine if (!$limiti_var[s_ini])
if ($limiti_var['s_ini'] > $idinizio) {
lista_prenota_periodo($idinizio,($limiti_var['s_ini'] - 1),$dati_app,$prenota_in_app_sett,$pren_pres_in_lista,$lista_prenota_periodo,$num_lista_pren_per);
$limiti_var['s_ini'] = $idinizio;
} # fine if ($limiti_var['s_ini'] > $idinizio)
if ($limiti_var['s_fine'] < $idfine) {
lista_prenota_periodo(($limiti_var['s_fine'] + 1),$idfine,$dati_app,$prenota_in_app_sett,$pren_pres_in_lista,$lista_prenota_periodo,$num_lista_pren_per);
$limiti_var['s_fine'] = $idfine;
} # fine if ($limiti_var['s_ini'] > $idinizio)
for ($num1 = 0 ; $num1 < $num_lista_pren_per ; $num1++) {
if ($inizio_prenota_id[$lista_prenota_periodo[$num1]] < $limiti_var['n_ini']) $limiti_var['n_ini'] = $inizio_prenota_id[$lista_prenota_periodo[$num1]];
if ($fine_prenota_id[$lista_prenota_periodo[$num1]] > $limiti_var['n_fine']) $limiti_var['n_fine'] = $fine_prenota_id[$lista_prenota_periodo[$num1]];
} # fine for $num1
if ($limiti_var['n_ini'] < $limiti_var['ini'] or $limiti_var['n_fine'] > $limiti_var['fine']) {
tab_a_var ($limiti_var,$app_prenota_id,$app_orig_prenota_id,$inizio_prenota_id,$fine_prenota_id,$app_assegnabili_id,$prenota_in_app_sett,$anno,$dati_app,$profondita,$nome_tab_prenota);
} # fine if ($limiti_var['n_ini'] < $limiti_var['ini'] or $limiti_var['n_fine'] > $limiti_var['fine'])

# ciclo che prova a spostare le prime prenotazioni ed eventualmente le
# mette in $da_liberare o $da_scambiare
for ($num1 = 0 ; $num1 < $dati_app['totapp'] ; $num1++) {
$numapp = $dati_app['posizione'][$num1];
if (!$app_richiesti or $app_richiesti[$numapp] == "SI") {
$prenotainperiodo = prenota_in_app_e_periodo($numapp,$idinizio,$idfine,$prenota_in_app_sett,$fine_prenota_id,$num_pp);
$idiniziop = "";
$idfinep = "";
unset($app_assegnabili);
$mobile = "SI";
$tutti_liberabili = "SI";

# Trovo le prenotazioni del periodo per l'appartamento $numapp, controllo
# che si posssano muovere e trovo le settimane iniziale e finale, e i 
# vincoli sull'appartamento di destinazione ($num_min_persome, $numcasa e
# $num_piano).
for ($num2 = 1 ; $num2 <= $num_pp ; $num2++) {
$idprenotainperiodo = $prenotainperiodo[$num2];
if ($app_assegnabili_id[$idprenotainperiodo] and $app_assegnabili_id[$idprenotainperiodo] != "v") {
$vett_assegnabili = explode (",", $app_assegnabili_id[$idprenotainperiodo]);
$num_assegnabili = count($vett_assegnabili);
for ($num3 = 0 ; $num3 < $num_assegnabili ; $num3++) {
$app_ = $vett_assegnabili[$num3];
$app_assegnabili[$idprenotainperiodo][$app_] = "SI";
} # fine for $num3
} # fine if ($app_assegnabili_id[$idprenotainperiodo] and $app_assegnabili_id[$idprenotainperiodo] != "v")
if ($app_assegnabili_id[$idprenotainperiodo]) {
if (!$idiniziop or $idiniziop > $inizio_prenota_id[$idprenotainperiodo]) {
$idiniziop = $inizio_prenota_id[$idprenotainperiodo];
} # fine if (!$idiniziop or $idiniziop > $inizio_prenota_id[$idprenotainperiodo])
if (!$idfinep or $idfinep < $fine_prenota_id[$idprenotainperiodo]) {
$idfinep = $fine_prenota_id[$idprenotainperiodo];
} # fine if (!$idfinep or $idfinep < $fine_prenota_id[$idprenotainperiodo])
} # fine if ($app_assegnabili_id[$idprenotainperiodo])
else $mobile = "NO";
if ($app_richiesti_vett[',vicini,'] == "SI" and !$dati_app['vicini'][$numapp] == $numapp) $mobile = "NO";
} # fine for $num2


if ($mobile == "SI") {
# Provo a spostare le prenotazioni dell'appartamento $numapp.
$mobile2 = "SI";
$prenota_comp_presente = "NO";
#$liberabile = "";
#$scambiabile = "";
#$da_scambiare = "";
for ($num2 = 1 ; $num2 <= $num_pp ; $num2++) {
$idprenotainperiodo = $prenotainperiodo[$num2];
for ($num3 = 0 ; $num3 < $dati_app['totapp'] ; $num3++) {
if ($num3 != $num1) {
$numapp2 = $dati_app[posizione][$num3];
if ($app_assegnabili_id[$idprenotainperiodo] == "v" or $app_assegnabili[$idprenotainperiodo][$numapp2] == "SI") {
$prenotainperiodo2 = prenota_in_app_e_periodo($numapp2,$inizio_prenota_id[$idprenotainperiodo],$fine_prenota_id[$idprenotainperiodo],$prenota_in_app_sett,$fine_prenota_id,$num_pp2);
if (!$num_pp2 and !$app_assegnabili_id[0][$idprenotainperiodo]) {
$nuovo_app[$idprenotainperiodo] = $numapp2;
$liberabile[$idprenotainperiodo] = "SI";
$scambiabile[$idprenotainperiodo] = "NO";
break;
} # fine (!$num_pp2 and...
else {
# Se non si possono spostare vedere se sono da scambiare
if ($app_assegnabili_id[0][$idprenotainperiodo]) $prenota_comp_presente = "SI";
$prenota_fissa_presente = "NO";
for ($num4 = 1 ; $num4 <= $num_pp2 ; $num4++) {
$idprenotainperiodo2 = $prenotainperiodo2[$num4];
if (!$app_assegnabili_id[$idprenotainperiodo2]) $prenota_fissa_presente = "SI";
else {
# se $idprenotainperiodo  uguale o minore di $idprenotainperiodo2 e ne contiene gli app. assegnabili  inutile fare lo scambio
if ($inizio_prenota_id[$idprenotainperiodo2] <= $inizio_prenota_id[$idprenotainperiodo] and $fine_prenota_id[$idprenotainperiodo2] >= $fine_prenota_id[$idprenotainperiodo]) {
if ($app_assegnabili_id[$idprenotainperiodo] == "v") $prenota_fissa_presente = "SI";
else {
if ($app_assegnabili_id[$idprenotainperiodo2] != "v" and !$app_assegnabili_id[0][$idprenotainperiodo]) {
$vett_assegnabili = explode (",",$app_assegnabili_id[$idprenotainperiodo2]);
$num_assegnabili = count($vett_assegnabili);
$lista_app_contenuta = "SI";
for ($num5 = 0 ; $num5 < $num_assegnabili ; $num5++) {
if ($app_assegnabili[$idprenotainperiodo][$vett_assegnabili[$num5]] != "SI") { $lista_app_contenuta = "NO"; break; }
} # fine for $num5
if ($lista_app_contenuta == "SI") $prenota_fissa_presente = "SI";
} # fine if ($app_assegnabili_id[$idprenotainperiodo2] != "v" and !$app_assegnabili_id[0][$idprenotainperiodo])
} # fine else if ($app_assegnabili_id[$idprenotainperiodo] == "v")
} # fine if ($inizio_prenota_id[$idprenotainperiodo2] <= $inizio_prenota_id[$idprenotainperiodo] and...
} # fine else if (!$app_assegnabili_id[$idprenotainperiodo2])
} # fine fine for $num4
if ($prenota_fissa_presente == "NO") {
$scambiabile[$idprenotainperiodo] = "SI";
$da_scambiare[$idprenotainperiodo][$numapp2] = "SI";
} # fine if ($prenota_fissa_presente == "NO")
} # fine else if (!$num_pp2)
} # fine if ($app_assegnabili_id[$idprenotainperiodo] == "v" or ...
} # fine if ($num3 != $num1)
} # fine for $num3

if ($liberabile[$idprenotainperiodo] != "SI") $tutti_liberabili = "NO";
if ($liberabile[$idprenotainperiodo] != "SI" and $scambiabile[$idprenotainperiodo] != "SI") $mobile2 = "NO";
} # fine for $num2

# Applico gli eventuali spostamenti, altrimenti metto i dati in $da_liberare
if ($tutti_liberabili != "NO") {
for ($num2 = 1 ; $num2 <= $num_pp ; $num2++) {
$idprenotainperiodo = $prenotainperiodo[$num2];
$n_app = $nuovo_app[$idprenotainperiodo];
for ($num3 = $inizio_prenota_id[$idprenotainperiodo] ; $num3 <= $fine_prenota_id[$idprenotainperiodo] ; $num3++) {
$prenota_in_app_sett[$numapp][$num3] = "";
$prenota_in_app_sett[$n_app][$num3] = $idprenotainperiodo;
} # fine for $num3
$app_prenota_id[$idprenotainperiodo] = $n_app;
} # fine for $num2
$appartamento = $numapp;
$fatto = "SI";
if ($debug == "on") echo "LIBERATO2 $appartamento<br>";
break;
} # fine if ($tutti_liberabili != "NO")

if ($mobile2 == "SI") {
if ($prenota_comp_presente == "NO") {
$idinizio_da_liberare[$num_da_liberare] = $idiniziop;
$idfine_da_liberare[$num_da_liberare] = $idfinep;
$app_da_liberare[$num_da_liberare] = $numapp;
$prenotainperiodo_da_liberare[$num_da_liberare] = $prenotainperiodo;
$num_pp_da_liberare[$num_da_liberare] = $num_pp;
$num_da_liberare++;
} # fine if ($prenota_comp_presente == "NO")
else {
$idinizio_da_liberare2[$num_da_liberare2] = $idiniziop;
$idfine_da_liberare2[$num_da_liberare2] = $idfinep;
$app_da_liberare2[$num_da_liberare2] = $numapp;
$prenotainperiodo_da_liberare2[$num_da_liberare2] = $prenotainperiodo;
$num_pp_da_liberare2[$num_da_liberare2] = $num_pp;
$num_da_liberare2++;
} # fine else if ($prenota_comp_presente == "NO")
} # fine if ($mobile2 == "SI")
else $riprova_app[$numapp] = "NO";

if ($fatto == "SI") { break; }
} # fine if ($mobile == "SI")
else $riprova_app[$numapp] = "NO";
} # fine if (!$app_richiesti or $app_richiesti[$numapp] == "SI")
} # fine for $num1

} # fine if ($fatto != "SI")




# Se non  ancora $fatto chiamo ricorsivamente liberasettimane con i dati
# in $da_liberare e $da_scambiare, operando su una variabile temporanea.
if ($fatto == "NO" and $limiti_var['t_limite'] >= time()) {
$nuova_profondita = $profondita;
$nuova_profondita['attuale'] = $profondita['attuale'] + 1;
$num_da_lib_no_comp = $num_da_liberare;
for ($num1 = 1 ; $num1 < $num_da_liberare2 ; $num1++) {
$idinizio_da_liberare[$num_da_liberare] = $idinizio_da_liberare2[$num1];
$idfine_da_liberare[$num_da_liberare] = $idfine_da_liberare2[$num1];
$app_da_liberare[$num_da_liberare] = $app_da_liberare2[$num1];
$prenotainperiodo_da_liberare[$num_da_liberare] = $prenotainperiodo_da_liberare2[$num1];
$num_pp_da_liberare[$num_da_liberare] = $num_pp_da_liberare2[$num1];
$num_da_liberare++;
} # fine for $num1

for ($num1 = 1 ; $num1 < $num_da_liberare ; $num1++) {
if ($app_da_liberare[$num1] != ",,NO") {
$n_app_prenota_id = $app_prenota_id;
$n_prenota_in_app_sett = $prenota_in_app_sett;
$nuova_profondita['tot_prenota_attuale'] = $profondita['tot_prenota_attuale'];
$idiniziop = $idinizio_da_liberare[$num1];
$idfinep = $idfine_da_liberare[$num1];
$numapp = $app_da_liberare[$num1];
$prenotainperiodo = $prenotainperiodo_da_liberare[$num1];
$num_pp = $num_pp_da_liberare[$num1];

# Muovo le prenotazioni liberabili
for ($num2 = 1 ; $num2 <= $num_pp ; $num2++) {
$idprenotainperiodo = $prenotainperiodo[$num2];
if ($liberabile[$idprenotainperiodo] == "SI") {
$n_app = $nuovo_app[$idprenotainperiodo];
for ($num3 = $inizio_prenota_id[$idprenotainperiodo] ; $num3 <= $fine_prenota_id[$idprenotainperiodo] ; $num3++) {
$n_prenota_in_app_sett[$numapp][$num3] = "";
$n_prenota_in_app_sett[$n_app][$num3] = $idprenotainperiodo;
} # fine for $num3
$n_app_prenota_id[$idprenotainperiodo] = $n_app;
} # fine if ($liberabile[$idpenotainperiodo] == "SI")
} # fine for $num2

# Riempio gli spazi vuoti con prenotazioni kostanti.
$idinizio_prenota_falsa = $idinizio;
$prenota_falsa_da_inserire = "NO";
for ($num2 = $idinizio ; $num2 <= ($idfine+1) ; $num2++) {
if ($n_prenota_in_app_sett[$numapp][$num2] or $num2 == ($idfine+1)) {
if ($prenota_falsa_da_inserire == "SI") {
$nuova_profondita['tot_prenota_attuale']++;
$n_app_prenota_id[$nuova_profondita['tot_prenota_attuale']] = $numapp;
$inizio_prenota_id[$nuova_profondita['tot_prenota_attuale']] = $idinizio_prenota_falsa;
$fine_prenota_id[$nuova_profondita['tot_prenota_attuale']] = $idfine_prenota_falsa;
for ($num3 = $idinizio_prenota_falsa ; $num3 <= $idfine_prenota_falsa ; $num3++) {
$n_prenota_in_app_sett[$numapp][$num3] = $nuova_profondita['tot_prenota_attuale'];
} # fine for $num3
} # fine if ($prenota_falsa_da_inserire == "SI")
$prenota_falsa_da_inserire = "NO";
$idinizio_prenota_falsa = $num2 + 1;
} # fine if ($n_prenota_in_app_sett[$numapp][$num2] or $num2 == ($idfine+1))
else {
$prenota_falsa_da_inserire = "SI";
$idfine_prenota_falsa = $num2;
} # fine else if ($n_prenota_in_app_sett[$numapp][$num2] or $num2 == ($idfine+1))
} # fine for $num2


#chiamo ricorsivamente liberasettimane con gli app. $da_scambiare
$fatto3 = "SI";
$limiti_var_orig = $limiti_var;
$num_pp_s = $num_pp;
$prenotainperiodo_s = $prenotainperiodo;
$scambiabile_s = $scambiabile;
unset($prenotainperiodo_agg);
for ($num2 = 1 ; $num2 <= $num_pp_s ; $num2++) {
$idprenotainperiodo = $prenotainperiodo_s[$num2];
if ($scambiabile_s[$idprenotainperiodo] == "SI") {
$idinizioprenota2 = $inizio_prenota_id[$idprenotainperiodo];
$idfineprenota2 = $fine_prenota_id[$idprenotainperiodo];
if ($idinizioprenota2 > $idinizio) { $idinizio_rimpicciolito = $idinizioprenota2; }
else { $idinizio_rimpicciolito = $idinizio; }
if ($idfineprenota2 < $idfine) { $idfine_rimpicciolito = $idfineprenota2; }
else { $idfine_rimpicciolito = $idfine; }

# Se la prenotazione scambiabile che c'era prima  stata spostata in un altro appartamento
# riempio gli spazi vuoti ed aggiungo eventuali nuove prenotazioni a $prenotainperiodo_s
if ($numapp != $n_app_prenota_id[$idprenotainperiodo]) {
$idinizio_prenota_falsa = $idinizio_rimpicciolito;
$prenota_falsa_da_inserire = "NO";
for ($num3 = $idinizio_rimpicciolito ; $num3 <= ($idfine_rimpicciolito + 1) ; $num3++) {
if ($n_prenota_in_app_sett[$numapp][$num3] and !$prenotainperiodo_agg[$n_prenota_in_app_sett[$numapp][$num3]] and $num3 != ($idfine_rimpicciolito + 1)) {
$prenotainperiodo_agg[$n_prenota_in_app_sett[$numapp][$num3]] = 1;
$num_pp_s++;
$prenotainperiodo_s[$num_pp_s] = $n_prenota_in_app_sett[$numapp][$num3];
$scambiabile_s[$n_prenota_in_app_sett[$numapp][$num3]] = "SI";
} # fine ($n_prenota_in_app_sett[$numapp][$num3] and !$prenotainperiodo_agg[$n_prenota_in_app_sett[$numapp][$num3]] and...
if ($n_prenota_in_app_sett[$numapp][$num3] or $num3 == ($idfine_rimpicciolito + 1)) {
if ($prenota_falsa_da_inserire == "SI") {
$nuova_profondita['tot_prenota_attuale']++;
$n_app_prenota_id[$nuova_profondita['tot_prenota_attuale']] = $numapp;
$inizio_prenota_id[$nuova_profondita['tot_prenota_attuale']] = $idinizio_prenota_falsa;
$fine_prenota_id[$nuova_profondita['tot_prenota_attuale']] = $idfine_prenota_falsa;
for ($num4 = $idinizio_prenota_falsa ; $num4 <= $idfine_prenota_falsa ; $num4++) {
$n_prenota_in_app_sett[$numapp][$num4] = $nuova_profondita['tot_prenota_attuale'];
} # fine for $num4
} # fine if ($prenota_falsa_da_inserire == "SI")
$prenota_falsa_da_inserire = "NO";
$idinizio_prenota_falsa = $num3 + 1;
} # fine if ($n_prenota_in_app_sett[$numapp][$num2] or $num2 == ($idfine+1))
else {
$prenota_falsa_da_inserire = "SI";
$idfine_prenota_falsa = $num3;
} # fine else if ($n_prenota_in_app_sett[$numapp][$num2] or $num2 == ($idfine+1))
} # fine for $num3
} # fine if ($numapp != $n_app_prenota_id[$idprenotainperiodo])

else {
$inizio_prenota_id[$idprenotainperiodo] = $idinizio_rimpicciolito;
$fine_prenota_id[$idprenotainperiodo] = $idfine_rimpicciolito;
for ($num3 = $idinizioprenota2 ; $num3 < $idinizio_rimpicciolito ; $num3++) {
$n_prenota_in_app_sett[$numapp][$num3] = "";
} # fine for $num3
for ($num3 = ($idfine_rimpicciolito + 1) ; $num3 <= $idfineprenota2 ; $num3++) {
$n_prenota_in_app_sett[$numapp][$num3] = "";
} # fine for $num3
$app_assegnabili_id2 = $app_assegnabili_id[$idprenotainperiodo];
$app_assegnabili_id[$idprenotainperiodo] = "";
$ap_ric = "";
for ($num3 = 0 ; $num3 < $dati_app['totapp'] ; $num3++) {
$numapp2 = $dati_app['posizione'][$num3];
if ($da_scambiare[$idprenotainperiodo][$numapp2] == "SI") {
$ap_ric[$numapp2] = "SI";
} # fine if ($da_scambiare[$idprenotainperiodo][$numapp2] == "SI")
} # fine for $num3

# Se la prenotazione da scambiare ne ha altre compagne
if ($app_assegnabili_id[0][$idprenotainperiodo]) {
$idprenota_comp = explode(",",$app_assegnabili_id[0][$idprenotainperiodo]);
$num_idprenota_comp = count($idprenota_comp);
cancella_prenota_compagne($idprenota_comp,$num_idprenota_comp,$idinizioprenota2,$idfineprenota2,$ap_ric,$inizio_prenota_id,$fine_prenota_id,$app_assegnabili_id,$n_app_prenota_id,$n_prenota_in_app_sett);
} # fine if ($app_assegnabili_id[0][$idprenotainperiodo])

$appartamento2 = "";
$fatto2 = "";
if ($debug == "on") {
global $passo;
$passo++;
echo $passo;
for ($i = 0 ; $i < $profondita['attuale'] ; $i++) echo "&nbsp;&nbsp;";
if ($ap_ric[',numero,']) {
$ap_ric_ved = $ap_ric[1]." (pren $idprenotainperiodo + ".$app_assegnabili_id[0][$idprenotainperiodo].")";
$idinizioprenota2_ved = $idinizioprenota2[1];
$idfineprenota2_ved = $idfineprenota2[1];
} # fine if ($ap_ric[',numero,']) 
else {
$ap_ric_ved = implode(",",array_keys($ap_ric))." (pren $idprenotainperiodo)";;
$idinizioprenota2_ved = $idinizioprenota2;
$idfineprenota2_ved = $idfineprenota2;
} # fine else if ($ap_ric[',numero,']) 
echo "<b>".$profondita['attuale']."</b> <em>".date("H:i:s")."</em> libera il $numapp da $idinizioprenota2_ved a $idfineprenota2_ved negli app $ap_ric_ved<br>";
} # fine if ($debug == "on")
liberasettimane($idinizioprenota2,$idfineprenota2,$limiti_var,$anno,$fatto2,$appartamento2,$nuova_profondita,$ap_ric,$n_app_prenota_id,$app_orig_prenota_id,$inizio_prenota_id,$fine_prenota_id,$app_assegnabili_id,$n_prenota_in_app_sett,$dati_app,$nome_tab_prenota);
if ($debug == "on") {
echo $passo;
for ($i = 0 ; $i < $profondita['attuale'] ; $i++) echo "&nbsp;&nbsp;";
echo "<b>".$profondita['attuale']."</b> finito <em>".date("H:i:s")."</em> $fatto2 (app $appartamento2)<br>";
} # fine if ($debug == "on")

if ($app_assegnabili_id[0][$idprenotainperiodo]) {
$inizio_prenota_id[$idprenotainperiodo] = $idinizioprenota2[1];
$fine_prenota_id[$idprenotainperiodo] = $idfineprenota2[1];
if ($fatto2 == "SI") ripristina_prenota_compagne($idprenota_comp,$num_idprenota_comp,$idinizioprenota2,$idfineprenota2,$appartamento2,$n_app_prenota_id,$n_prenota_in_app_sett,$fine_prenota_id,$profondita);
} # fine if ($app_assegnabili_id[0][$idprenotainperiodo])
else {
$inizio_prenota_id[$idprenotainperiodo] = $idinizioprenota2;
$fine_prenota_id[$idprenotainperiodo] = $idfineprenota2;
} # fine else if ($app_assegnabili_id[0][$idprenotainperiodo])
$app_assegnabili_id[$idprenotainperiodo] = $app_assegnabili_id2;

if ($fatto2 == "SI") {
for ($num3 = $idinizio_rimpicciolito ; $num3 <= $idfine_rimpicciolito ; $num3++) {
$n_prenota_in_app_sett[$numapp][$num3] = "";
} # fine for $num3
for ($num3 = $idinizioprenota2 ; $num3 <= $idfineprenota2 ; $num3++) {
$n_prenota_in_app_sett[$appartamento2][$num3] = $idprenotainperiodo;
} # fine for $num3
$n_app_prenota_id[$idprenotainperiodo] = $appartamento2;
if ($debug == "on") {
echo $passo;
for ($i = 0 ; $i < $profondita['attuale'] ; $i++) echo "&nbsp;&nbsp;";
echo "<b>".$profondita['attuale']."</b> spostata pren $idprenotainperiodo in ".$appartamento2."<br>";
} # fine if ($debug == "on")
$nuova_profondita['tot_prenota_attuale']++;
$n_app_prenota_id[$nuova_profondita['tot_prenota_attuale']] = $numapp;
$inizio_prenota_id[$nuova_profondita['tot_prenota_attuale']] = $idinizio_rimpicciolito;
$fine_prenota_id[$nuova_profondita['tot_prenota_attuale']] = $idfine_rimpicciolito;
for ($num3 = $idinizio_rimpicciolito ; $num3 <= $idfine_rimpicciolito ; $num3++) {
$n_prenota_in_app_sett[$numapp][$num3] = $nuova_profondita['tot_prenota_attuale'];
} # fine for $num3
} # fine if ($fatto2 == "SI")
else {
$fatto3 = "NO";
aggiorna_app_aggiunti($limiti_var,$limiti_var_orig,$app_orig_prenota_id,$app_prenota_id,$inizio_prenota_id,$fine_prenota_id,$prenota_in_app_sett);
break;
} # fine else if ($fatto2 == "SI")
} # fine else if ($numapp != $n_app_prenota_id[$idprenotainperiodo])
} # fine if ($scambiabile_s[$idprenotainperiodo] == "SI")
} # fine for $num2


# cancello le prenotazioni kostanti
for ($num2 = ($profondita['tot_prenota_attuale'] + 1) ; $num2 <= $nuova_profondita['tot_prenota_attuale'] ; $num2++) {
for ($num3 = $inizio_prenota_id[$num2] ; $num3 <= $fine_prenota_id[$num2] ; $num3++) {
$n_prenota_in_app_sett[$numapp][$num3] = "";
} # fine for $num3
$n_app_prenota_id[$num2] = "";
$inizio_prenota_id[$num2] = "";
$fine_prenota_id[$num2] = "";
} # fine for $num2

if ($fatto3 == "SI") {
$app_prenota_id = $n_app_prenota_id;
$prenota_in_app_sett = $n_prenota_in_app_sett;
$fatto = "SI";
$appartamento = $numapp;
break;
} # fine if ($fatto3 == "SI")
else $riprova_app[$numapp] = "NO";

# Elimino gli appartamenti successivi che si possono scambiare con questo
if ($num1 != ($num_da_liberare - 1) and $num1 < $num_da_lib_no_comp) {
$lista_app_assegnabili = "";
for ($num2 = 1 ; $num2 <= $num_pp ; $num2++) {
$idprenotainperiodo = $prenotainperiodo[$num2];
if (!$lista_app_assegnabili or $lista_app_assegnabili == "v") $lista_app_assegnabili = $app_assegnabili_id[$idprenotainperiodo];
else {
$app_ass_num2 = $app_assegnabili_id[$idprenotainperiodo];
if ($app_ass_num2 != "v" and $app_ass_num2 != $lista_app_assegnabili) {
$app_ass_num2 = explode(",",$app_ass_num2);
$num_app_ass_num2 = (count($app_ass_num2) - 1);
$n_lista_app_assegnabili = "";
for ($num3 = 1 ; $num3 < $num_app_ass_num2 ; $num3++) {
if (str_replace(",".$app_ass_num2[$num3].",","",$lista_app_assegnabili) != $lista_app_assegnabili) $n_lista_app_assegnabili .= ",".$app_ass_num2[$num3];
} # fine for $num3
$lista_app_assegnabili = $n_lista_app_assegnabili;
if (!$lista_app_assegnabili) break;
else $lista_app_assegnabili .= ",";
} # fine if ($app_ass_num2 != "v" and $app_ass_num2 != $lista_app_assegnabili)
} # fine else if (!$lista_app_assegnabili or...
} # fine for $num2
if ($lista_app_assegnabili) {
for ($num2 = ($num1 + 1) ; $num2 < $num_da_liberare ; $num2++) {
$numapp2 = $app_da_liberare[$num2];
if (($lista_app_assegnabili == "v" or str_replace(",$numapp2,","",$lista_app_assegnabili) != $lista_app_assegnabili) and $numapp2 != ",,NO") {
if ($prenota_in_app_sett[$numapp2][$idiniziop]) $ini_blocco2 = $inizio_prenota_id[$prenota_in_app_sett[$numapp2][$idiniziop]];
else $ini_blocco2 = $idiniziop;
if ($prenota_in_app_sett[$numapp2][$idfinep]) $fine_blocco2 = $fine_prenota_id[$prenota_in_app_sett[$numapp2][$idfinep]];
else $fine_blocco2 = $idfinep;
if ($ini_blocco2 == $idiniziop and $fine_blocco2 == $idfinep) {
$scambiabili = "SI";
for ($num3 = $idiniziop ; $num3 <= $idfinep ; $num3++) {
if ($prenota_in_app_sett[$numapp2][$num3]) {
$app_ass_num3 = $app_assegnabili_id[$prenota_in_app_sett[$numapp2][$num3]];
if ($app_ass_num3 != "v" and str_replace(",$numapp,","",$app_ass_num3) == $app_ass_num3) {
$scambiabili = "NO";
break;
} # fine if ($app_ass_num5 != "v" and...
$num3 = $fine_prenota_id[$prenota_in_app_sett[$numapp2][$num3]];
} # fine if ($prenota_in_app_sett[$numapp3][$num3])
} # fine for $num3
if ($scambiabili == "SI") {
$app_da_liberare[$num2] = ",,NO";
$riprova_app[$numapp2] = "NO";
} # fine if ($scambiabili == "SI")
} # fine if ($ini_blocco2 == $ini_blocco1 and...
} # fine if (($lista_app_assegnabili == "v" or...
} # fine for $num2
} # fine if ($lista_app_assegnabili)
} # fine if ($num1 != ($num_da_liberare - 1) and...

} # fine if ($app_da_liberare[$num1] != ",,NO")
} # fine for $num1

} # fine if ($fatto == "NO")



if ($tutti_occupati == "SI") $fatto = "NO";


# Se bisogna liberare altri appartamenti oltre a quello appena liberato
if ($fatto == "SI" and $app_richiesti_vett[',numero,']) {
if ($app_richiesti_vett[',numero,'] > $app_richiesti_vett['id']) {
$nuova_profondita = $profondita;
$nuova_profondita['attuale']++;
$nuova_profondita['controllato_tutti_occupati'] = "NO";
$n_app_prenota_id = $app_prenota_id;
$n_prenota_in_app_sett = $prenota_in_app_sett;
$nuova_profondita['tot_prenota_attuale']++;
$id_prenota_lib = $nuova_profondita['tot_prenota_attuale'];
if ($debug == "on") echo "inserita ".$nuova_profondita['tot_prenota_attuale']." in $appartamento da $idinizio a $idfine<br>";
$n_app_prenota_id[$id_prenota_lib] = $appartamento;
$inizio_prenota_id[$id_prenota_lib] = $idinizio;
$fine_prenota_id[$id_prenota_lib] = $idfine;
for ($num1 = $idinizio ; $num1 <= $idfine ; $num1++) {
$n_prenota_in_app_sett[$appartamento][$num1] = $id_prenota_lib;
} # fine for $num1

# Se gli app devono essere vicini mantengo l'app liberato fisso e provo i restanti da liberare
if ($app_richiesti_vett[',vicini,'] == "SI") {
$fatto = "NO";
$lim_for = $app_richiesti_vett[',numero,'];
if ($lim_for != ($app_richiesti_vett['id'] + 1) and $limiti_var['t_limite'] < time()) {
$lim_for = ($app_richiesti_vett['id'] + 1);
if ($debug == "on") echo "timeout<br>";
} # fine if ($limiti_var['t_limite'] < time())
for ($num1 = ($app_richiesti_vett['id'] + 1) ; $num1 <= $lim_for ; $num1++) {
if ($provato[$idinizio_vett[$num1]][$idfine_vett[$num1]][$app_richiesti_vett[$num1]] != "SI") {
$provato[$idinizio_vett[$num1]][$idfine_vett[$num1]][$app_richiesti_vett[$num1]] = "SI";
$n_app_prenota_id2 = $n_app_prenota_id;
$n_prenota_in_app_sett2 = $n_prenota_in_app_sett;
$n_app_richiesti_vett = $app_richiesti_vett;
if ((string) $n_app_richiesti_vett[',app_vicini,'] == "") $n_app_richiesti_vett[',app_vicini,'] = $dati_app['vicini'][$appartamento];
else {
$app_vicini = explode(",",$dati_app['vicini'][$appartamento]);
$num_app_vicini = count($app_vicini);
for ($num2 = 0 ; $num2 < $num_app_vicini ; $num2++) {
if (str_replace(",".$app_vicini[$num2].",","",",".$n_app_richiesti_vett[',app_vicini,'].",") == ",".$n_app_richiesti_vett[',app_vicini,'].",") $n_app_richiesti_vett[',app_vicini,'] .= ",".$app_vicini[$num2];
} # fine for $num2
} # fine else if ((string) $app_richiesti_vett[',app_vicini,'] == "")
$n_app_richiesti_vett[$num1] = incrocia_app_richiesti($n_app_richiesti_vett[$num1],$n_app_richiesti_vett[',app_vicini,']);
if ((string) $n_app_richiesti_vett[$num1] != "") {
$n_idinizio_vett = $idinizio_vett;
$n_idfine_vett = $idfine_vett;
$val = $n_app_richiesti_vett[($app_richiesti_vett['id'] + 1)];
$n_app_richiesti_vett[($app_richiesti_vett['id'] + 1)] = $n_app_richiesti_vett[$num1];
$n_app_richiesti_vett[$num1] = $val;
$n_idinizio_vett[($app_richiesti_vett['id'] + 1)] = $idinizio_vett[$num1];
$n_idinizio_vett[$num1] = $idinizio_vett[($app_richiesti_vett['id'] + 1)];
$n_idfine_vett[($app_richiesti_vett['id'] + 1)] = $idfine_vett[$num1];
$n_idfine_vett[$num1] = $idfine_vett[($app_richiesti_vett['id'] + 1)];
if ($debug == "on") {
global $passo;
echo $passo;
for ($i = 0 ; $i < $profondita['attuale'] ; $i++) echo "&nbsp;&nbsp;";
echo "<b>".$profondita['attuale']."</b> libera vicini a $appartamento da ".$n_idinizio_vett[($app_richiesti_vett['id'] + 1)]." a ".$n_idfine_vett[($app_richiesti_vett['id'] + 1)]." in ".$n_app_richiesti_vett[($app_richiesti_vett['id'] + 1)]."<br>";
} # fine if ($debug == "on")
liberasettimane($n_idinizio_vett,$n_idfine_vett,$limiti_var,$anno,$fatto,$appartamento_vett,$nuova_profondita,$n_app_richiesti_vett,$n_app_prenota_id2,$app_orig_prenota_id,$inizio_prenota_id,$fine_prenota_id,$app_assegnabili_id,$n_prenota_in_app_sett2,$dati_app,$nome_tab_prenota);
if ($debug == "on") {
echo $passo;
for ($i = 0 ; $i < $profondita['attuale'] ; $i++) echo "&nbsp;&nbsp;";
echo "<b>".$profondita['attuale']."</b> fatto libera vicini a $appartamento $fatto<br>";
} # fine if ($debug == "on")
if ($fatto == "SI") {
$n_app_prenota_id = $n_app_prenota_id2;
$n_prenota_in_app_sett = $n_prenota_in_app_sett2;
$val = $appartamento_vett[($app_richiesti_vett['id'] + 1)];
$appartamento_vett[($app_richiesti_vett['id'] + 1)] = $appartamento_vett[$num1];
$appartamento_vett[$num1] = $val;
break;
} # fine if ($fatto == "SI")
} # fine if ((string) $n_app_richiesti_vett[$num1] != "")
} # fine if ($provato[$idinizio_vett[$num1]][$idfine_vett[$num1]][$app_richiesti_vett[$num1]] != "SI")
} # fine for $num1
if ($fatto != "SI") $riprova_senza_app_liberato = $appartamento;
} # fine if ($app_richiesti_vett[',vicini,'] == "SI")

else {
if ($app_richiesti_vett[$app_richiesti_vett['id']] == ",tutti,") $app_assegnabili_id[$id_prenota_lib] = "v";
else if (str_replace(",","",$app_richiesti_vett[$app_richiesti_vett['id']]) != $app_richiesti_vett[$app_richiesti_vett['id']]) $app_assegnabili_id[$id_prenota_lib] = $app_richiesti_vett[$app_richiesti_vett['id']];
liberasettimane($idinizio_vett,$idfine_vett,$limiti_var,$anno,$fatto,$appartamento_vett,$nuova_profondita,$app_richiesti_vett,$n_app_prenota_id,$app_orig_prenota_id,$inizio_prenota_id,$fine_prenota_id,$app_assegnabili_id,$n_prenota_in_app_sett,$dati_app,$nome_tab_prenota);
} # fine elseif ($app_richiesti[',vicini,'] == "SI")

if ($fatto == "SI") {
$app_prenota_id = $n_app_prenota_id;
$prenota_in_app_sett = $n_prenota_in_app_sett;
for ($num1 = $idinizio ; $num1 <= $idfine ; $num1++) {
$prenota_in_app_sett[$app_prenota_id[$id_prenota_lib]][$num1] = "";
} # fine for $num1
$appartamento_vett[$app_richiesti_vett['id']] = $app_prenota_id[$id_prenota_lib];
$app_prenota_id[$id_prenota_lib] = "";
} # fine if ($fatto == "SI")
else {
$appartamento_vett[$app_richiesti_vett['id']] = "";
aggiorna_app_aggiunti($limiti_var,$limiti_var_orig,$app_orig_prenota_id,$app_prenota_id,$inizio_prenota_id,$fine_prenota_id,$prenota_in_app_sett);
} # fine else if ($fatto == "SI")
$inizio_prenota_id[$id_prenota_lib] = "";
$fine_prenota_id[$id_prenota_lib] = "";
$app_assegnabili_id[$id_prenota_lib] = "";
} # fine if ($app_richiesti_vett[',numero,'] > $app_richiesti_vett['id'])
else $appartamento_vett[$app_richiesti_vett['id']] = $appartamento;
$appartamento = $appartamento_vett;
} # fine if ($fatto == "SI" and $app_richiesti_vett[',numero,'])


# Se si era liberato un appartamento ma non se ne sono trovati altri vicini riprovo
if ($riprova_senza_app_liberato) {
$n_lista_app_ric = "";
for ($num1 = 0 ; $num1 < $dati_app['totapp'] ; $num1++) {
$numapp = $dati_app['posizione'][$num1];
if ($numapp != $riprova_senza_app_liberato and $riprova_app[$numapp] != "NO") $n_lista_app_ric .= $numapp.",";
} # fine for $num1
$n_lista_app_ric = substr($n_lista_app_ric,0,-1);
$app_richiesti_vett[$app_richiesti_vett['id']] = incrocia_app_richiesti($app_richiesti_vett[$app_richiesti_vett['id']],$n_lista_app_ric);
if ((string) $app_richiesti_vett[$app_richiesti_vett['id']] != "") {
$nuova_profondita = $profondita;
$nuova_profondita['attuale']++;
$nuova_profondita['controllato_tutti_occupati'] = "NO";
$n_app_prenota_id = $app_prenota_id;
$n_prenota_in_app_sett = $prenota_in_app_sett;
if ($debug == "on") {
global $passo;
echo $passo;
for ($i = 0 ; $i < $profondita['attuale'] ; $i++) echo "&nbsp;&nbsp;";
echo "<b>".$profondita['attuale']."</b> <em>".date("H:i:s")."</em> riprova ".$app_richiesti_vett['id']." negli app ".$app_richiesti_vett[$app_richiesti_vett['id']]."<br>";
} # fine if ($debug == "on")
$app_richiesti_vett['id'] = $app_richiesti_vett['id'] - 1;
liberasettimane($idinizio_vett,$idfine_vett,$limiti_var,$anno,$fatto,$appartamento_vett,$nuova_profondita,$app_richiesti_vett,$n_app_prenota_id,$app_orig_prenota_id,$inizio_prenota_id,$fine_prenota_id,$app_assegnabili_id,$n_prenota_in_app_sett,$dati_app,$nome_tab_prenota);
if ($fatto == "SI") {
$app_prenota_id = $n_app_prenota_id;
$prenota_in_app_sett = $n_prenota_in_app_sett;
$appartamento = $appartamento_vett;
} # fine if ($fatto == "SI")
else aggiorna_app_aggiunti($limiti_var,$limiti_var_orig,$app_orig_prenota_id,$app_prenota_id,$inizio_prenota_id,$fine_prenota_id,$prenota_in_app_sett);
} # fine if ((string) $app_richiesti_vett[$app_richiesti_vett['id']] != "")
} # fine if ($riprova_senza_app_liberato)


if ($primo_ciclo == "SI" and $fatto == "SI") {
$risul_agg = aggiorna_tableprenota($app_prenota_id,$app_orig_prenota_id,$tableprenota);
if (!$risul_agg) $fatto = "NO";
} # fine if ($primo_ciclo == "SI" and $fatto == "SI")

} # fine function liberasettimane





###########################################
###  FINE ./includes/liberasettimane.php 
###########################################

###########################################
###  INIZIO ./includes/funzioni_tariffe.php 
###########################################

##################################################################################
#    HOTELDRUID
#    Copyright (C) 2001-2011 by Marco Maria Francesco De Santis (marco@digitaldruid.net)
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    any later version accepted by Marco Maria Francesco De Santis, which
#    shall act as a proxy as defined in Section 14 of version 3 of the
#    license.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
##################################################################################




function dati_tariffe ($tablenometariffe,$tariffa_sel="",$tablepersonalizza="",$tableregole="") {

$righe_tariffe = esegui_query("select * from $tablenometariffe where idntariffe < '11' order by idntariffe");
$dati_tariffe['num'] = risul_query($righe_tariffe,0,'nomecostoagg');

for ($num1 = 1 ; $num1 <= $dati_tariffe['num'] ; $num1++) {
if (!$tariffa_sel or $tariffa_sel == $num1) {
$dati_tariffe['tariffa'.$num1]['nome'] = risul_query($righe_tariffe,0,'tariffa'.$num1);
$dati_tariffe['tariffa'.$num1]['caparra_percent'] = risul_query($righe_tariffe,1,'tariffa'.$num1);
$dati_tariffe['tariffa'.$num1]['caparra_arrotond'] = risul_query($righe_tariffe,2,'tariffa'.$num1);
$dati_tariffe['tariffa'.$num1]['moltiplica'] = risul_query($righe_tariffe,3,'tariffa'.$num1);
$dati_tariffe['tariffa'.$num1]['tasse_percent'] = risul_query($righe_tariffe,4,'tariffa'.$num1);
$importa_prezzi = risul_query($righe_tariffe,5,'tariffa'.$num1);
if ($importa_prezzi) {
$importa_prezzi = explode(";",$importa_prezzi);
$dati_tariffe['tariffa'.$num1]['importa_prezzi'] = $importa_prezzi[0];
$dati_tariffe['tariffa'.$num1]['parte_prezzo'] = $importa_prezzi[1];
$dati_tariffe['tariffa'.$num1]['tipo_importa'] = $importa_prezzi[2];
$dati_tariffe['tariffa'.$num1]['val_importa'] = $importa_prezzi[3];
if ($importa_prezzi[2] == "p") $dati_tariffe['tariffa'.$num1]['arrotond_importa'] = $importa_prezzi[4];
$dati_tariffe['tariffa'.$importa_prezzi[0]]['esporta_prezzi'] .= "$num1,";
} # fine if ($importa_prezzi)
if ($tableregole) {
$comm = esegui_query("select * from $tableregole where tariffa_commissioni = '$num1' order by iddatainizio ");
$num_comm = numlin_query($comm);
for ($num2 = 0 ; $num2 < $num_comm ; $num2++) {
$comm_percent = risul_query($comm,$num2,'motivazione');
$comm_base = "t";
if (substr($comm_percent,0,1) == "s" or substr($comm_percent,0,1) == "c") {
$comm_base = substr($comm_percent,0,1);
$comm_percent = substr($comm_percent,1);
} # fine if (substr($comm_percent,0,1) == "s" or substr($comm_percent,0,1) == "c")
$iddataini = risul_query($comm,$num2,'iddatainizio');
if (!$iddataini) {
$dati_tariffe['tariffa'.$num1]['commissioni_percent']['def'] = $comm_percent;
$dati_tariffe['tariffa'.$num1]['commissioni_base']['def'] = $comm_base;
$dati_tariffe['tariffa'.$num1]['commissioni_arrotond']['def'] = risul_query($comm,$num2,'motivazione2');
} # fine if (!$iddataini)
else {
$iddatafin = risul_query($comm,$num2,'iddatafine');
$dati_tariffe['tariffa'.$num1]['commissioni_percent']["$iddataini-$iddatafin"] = $comm_percent;
$dati_tariffe['tariffa'.$num1]['commissioni_base']["$iddataini-$iddatafin"] = $comm_base;
$dati_tariffe['tariffa'.$num1]['commissioni_arrotond']["$iddataini-$iddatafin"] = risul_query($comm,$num2,'motivazione2');
} # fine else if (!$iddataini)
} # fine for $num2
} # fine if ($tableregole)
} # fine if (!$tariffa_sel or $tariffa_sel == $num1)
} # fine for $num1

if ($tablepersonalizza) {
global $id_utente;
if ($id_utente) $id_utente_pers = $id_utente;
else $id_utente_pers = 1;
$arrotond_tasse = esegui_query("select * from $tablepersonalizza where idpersonalizza = 'arrotond_tasse' and idutente = '$id_utente_pers'");
$dati_tariffe['tasse_arrotond'] = (double) risul_query($arrotond_tasse,0,'valpersonalizza');
} # fine if ($tablepersonalizza)

return $dati_tariffe;

} # fine function dati_tariffe




function trova_app_regola2 ($tipotariffa,&$regole2,&$num_regole2,&$app_regola2_predef,&$id_periodo_corrente,$idinizioperiodo,$idfineperiodo,$tipo_periodi,$anno,$tableregole) {

$app_regola2_predef = "";
if (!$regole2) {
$regole2 = esegui_query("select * from $tableregole where tariffa_per_app != ''");
$num_regole2 = numlin_query($regole2);
} # fine if (!$regole2)

for ($num1 = 0 ; $num1 < $num_regole2 ; $num1 = $num1 + 1) {
$tariffa_regola2 = risul_query($regole2,$num1,'tariffa_per_app');
if ($tipotariffa == $tariffa_regola2) {
$lista_app = risul_query($regole2,$num1,'motivazione');
$lista_appb = risul_query($regole2,$num1,'motivazione2');
if (strcmp($lista_appb,"")) {
if (!$id_periodo_corrente) $id_periodo_corrente = calcola_id_periodo_corrente($anno);
$ngiorni_reg2b = risul_query($regole2,$num1,'iddatainizio');
if ($ngiorni_reg2b) $diff_giorni = $idinizioperiodo - $id_periodo_corrente + 1;
else {
$ngiorni_reg2b = risul_query($regole2,$num1,'iddatafine');
$diff_giorni = $idfineperiodo - $id_periodo_corrente + 1;
} # fine else if ($ngiorni_reg2b)
if ($tipo_periodi == "s") $diff_giorni = $diff_giorni * 7;
if ($diff_giorni < $ngiorni_reg2b) {
$app_regola2_predef = $lista_app;
$lista_app = $lista_appb;
} # fine if ($diff_giorni < $ngiorni_reg2b)
} # fine if (strcmp($lista_appb,""))
break;
} # fine if ($tipotariffa == $tariffa_regola2)
} # fine for $num1

return $lista_app;

} # fine function trova_app_regola2




function calcola_commissioni ($dati_tariffe,$tipotariffa,$iddataini,$iddatafine,$tariffesettimanali,$sconto,$prezzo_costi_tot) {

$commissioni = (double) 0;
if (@is_array($dati_tariffe[$tipotariffa]['commissioni_percent'])) {
$costo_tariffa_corr = (double) 0;
$num_sett = 0;
$numsett = 0;
$tariffesettimanali = explode(";",$tariffesettimanali);
$tariffesettimanali = explode(",",$tariffesettimanali[0]);
$agg_sett_sconto = round((((double) $sconto * -1) / ($iddatafine - $iddataini + 1)),2);
$agg_sett_costi = round(((((double) $sconto * -1) + (double) $prezzo_costi_tot) / ($iddatafine - $iddataini + 1)),2);
for ($num1 = $iddataini ; $num1 <= $iddatafine ; $num1++) {

$costo_tariffa_sett = (double) $tariffesettimanali[$numsett];
$commissioni_percent = $dati_tariffe[$tipotariffa]['commissioni_percent']['def'];
$commissioni_arrotond = $dati_tariffe[$tipotariffa]['commissioni_arrotond']['def'];
$commissioni_base = $dati_tariffe[$tipotariffa]['commissioni_base']['def'];
reset($dati_tariffe[$tipotariffa]['commissioni_percent']);
while (list($per_comm,$val_comm) = each($dati_tariffe[$tipotariffa]['commissioni_percent'])) {
if ($per_comm != "def") {
$ini_comm = explode("-",$per_comm);
$fine_comm = $ini_comm[1];
$ini_comm = $ini_comm[0];
if ($num1 >= $ini_comm and $num1 <= $fine_comm) {
$commissioni_percent = $val_comm;
$commissioni_arrotond = $dati_tariffe[$tipotariffa]['commissioni_arrotond'][$per_comm];
$commissioni_base = $dati_tariffe[$tipotariffa]['commissioni_base'][$per_comm];
break;
} # fine if ($num1 >= $ini_comm and $num1 <= $fine_comm)
} # fine if ($per_comm != "def")
} # fine while (list($per_comm,$val_comm) = each($dati_tariffe[$tariffa]['commissioni_percent']))

if ($num1 != $iddataini and ($ultime_comm_perc != $commissioni_percent or $ultime_comm_arr != $commissioni_arrotond or $ultime_comm_base != $commissioni_base)) {
if ($ultime_comm_perc) {
if ($ultime_comm_arr == "val") $commissioni_corr = $ultime_comm_perc * $num_sett;
else {
$costo_base = (double) $costo_tariffa_corr;
if ($ultime_comm_base == "s") $costo_base = $costo_base + ((double) $agg_sett_sconto * $num_sett);
if ($ultime_comm_base == "c") $costo_base = $costo_base + ((double) $agg_sett_costi * $num_sett);
$commissioni_corr = ($costo_base * (double) $ultime_comm_perc) / 100;
$commissioni_corr = $commissioni_corr / $ultime_comm_arr;
$commissioni_corr = floor(round($commissioni_corr));
$commissioni_corr = $commissioni_corr * $ultime_comm_arr;
} # fine else if ($commissioni_arrotond == "val")
$commissioni += (double) $commissioni_corr;
} # fine if ($ultime_comm_perc)
$costo_tariffa_corr = (double) 0;
$num_sett = 0;
} # fine if ($num1 != $iddataini and ($ultime_comm_perc != $commissioni_percent or...

$num_sett++;
$ultime_comm_perc = $commissioni_percent;
$ultime_comm_arr = $commissioni_arrotond;
$ultime_comm_base = $commissioni_base;
$costo_tariffa_corr += (double) $tariffesettimanali[$numsett];
$numsett++;
} # fine for $num1

if ($ultime_comm_perc) {
if ($ultime_comm_arr == "val") $commissioni_corr = $ultime_comm_perc * $num_sett;
else {
$costo_base = (double) $costo_tariffa_corr;
if ($ultime_comm_base == "s") $costo_base = $costo_base + ((double) $agg_sett_sconto * $num_sett);
if ($ultime_comm_base == "c") $costo_base = $costo_base + ((double) $agg_sett_costi * $num_sett);
$commissioni_corr = ($costo_base * (double) $ultime_comm_perc) / 100;
$commissioni_corr = $commissioni_corr / $ultime_comm_arr;
$commissioni_corr = floor(round($commissioni_corr));
$commissioni_corr = $commissioni_corr * $ultime_comm_arr;
} # fine else if ($commissioni_arrotond == "val")
$commissioni += (double) $commissioni_corr;
} # fine if ($ultime_comm_perc)
} # fine if (@is_array($dati_tariffe[$tipotariffa]['commissioni_percent']))

return $commissioni;

} # fine function calcola_commissioni




function calcola_caparra ($dati_tariffe,$tipotariffa,$iddataini,$iddatafine,$costo_tariffa,$tariffesettimanali) {

$caparra = (double) 0;

$caparra_percent = $dati_tariffe[$tipotariffa]['caparra_percent'];
if ($caparra_percent) {
$caparra_arrotond = $dati_tariffe[$tipotariffa]['caparra_arrotond'];
if ($caparra_arrotond == "val") $caparra = $caparra_percent;
if ($caparra_arrotond == "gio") {
$lunghezza_periodo = ($iddatafine - $iddataini + 1);
if ($lunghezza_periodo <= $caparra_percent) $caparra = $costo_tariffa;
else {
$tariffesettimanali = explode(";",$tariffesettimanali);
$tariffesettimanali = explode(",",$tariffesettimanali[0]);
for ($num1 = 0 ; $num1 < $caparra_percent ; $num1++) $caparra += (double) $tariffesettimanali[$num1];
} # fine else if ($lunghezza_periodo >= $caparra_percent)
} # fine if ($caparra_arrotond == "gio")
if ($caparra_arrotond != "val" and $caparra_arrotond != "gio") {
$caparra = ($costo_tariffa * (double) $caparra_percent) / 100;
$caparra = $caparra / $caparra_arrotond;
$caparra = floor($caparra);
$caparra = $caparra * $caparra_arrotond;
if (!$caparra) {
$caparra = $caparra_arrotond;
if ($caparra > $costo_tariffa) $caparra = $costo_tariffa;
} # fine (!$caparra)
} # fine else if ($caparra_arrotond != "val" and $caparra_arrotond != "gio")
} # fine if ($caparra_percent)

return $caparra;

} # fine function calcola_caparra




function aggiorna_tariffe_esporta ($dati_tariffe,$tariffa_da,$idperiodo,$prezzoperiodo,$prezzoperiodop,$tableperiodi,&$agg_vett,&$num_agg) {
if ($dati_tariffe[$tariffa_da]['esporta_prezzi']) {

if (str_replace("-","",$idperiodo) != $idperiodo) {
$fine_per = explode("-",$idperiodo);
$ini_per = $fine_per[0];
$fine_per = $fine_per[1];
} # fine if (str_replace("-","",$idperiodo) != $idperiodo)
else {
$ini_per = $idperiodo;
$fine_per = $idperiodo;
} # fine else if (str_replace("-","",$idperiodo) != $idperiodo)

$tar_esporta = explode(",",$dati_tariffe[$tariffa_da]['esporta_prezzi']);
for ($num_tar = 0 ; $num_tar < (count($tar_esporta) - 1) ; $num_tar++) {
$tariffa = "tariffa".$tar_esporta[$num_tar];

if ($idperiodo == "opztariffa") {
$tablenometariffe = $prezzoperiodop;
$opztariffa = esegui_query("select * from $tableperiodi where $tariffa"."p is not NULL and $tariffa"."p != '' and $tariffa"."p != '0' ");
if (numlin_query($opztariffa)) $opztariffa = "p";
else $opztariffa = "s";
esegui_query("update $tablenometariffe set $tariffa = '$opztariffa' where idntariffe = '4' ");
} # fine if ($idperiodo == "opztariffa")
else {

$importa_percent = (double) $dati_tariffe[$tariffa]['val_importa'];
$importa_arrotond = (double) $dati_tariffe[$tariffa]['arrotond_importa'];
$tipo_percent = $dati_tariffe[$tariffa]['tipo_importa'];
if ($tipo_percent == "s" and !$agg_vett[$tariffa]) {
$agg_int = floor($importa_percent);
$resto_int = $importa_percent - (double) $agg_int;
$agg_gio = floor($agg_int / 7);
for ($num1 = 1 ; $num1 <= 7 ; $num1++) $agg_vett[$tariffa][$num1] = $agg_gio;
$resto = $agg_int - ($agg_gio * 7);
if ($resto >= 1) {
$agg_vett[$tariffa][1]++;
$resto--;
} # fine if ($resto >= 1)
for ($num1 = 7 ; $num1 > (7 - $resto) ; $num1--) $agg_vett[$tariffa][$num1]++;
$agg_vett[$tariffa][1] += $resto_int;
$num_agg[$tariffa]['s'] = 0;
$num_agg[$tariffa]['p'] = 0;
} # fine if ($tipo_percent == "s" and !$agg_vett[$tariffa])
if ($tipo_percent == "g") $perc = $importa_percent;

for ($num1 = $ini_per ; $num1 <= $fine_per ; $num1++) {

if ((string) $prezzoperiodo != "NO") {
if ($tipo_percent == "s") {
$num_agg[$tariffa]['s']++;
$perc = $agg_vett[$tariffa][$num_agg[$tariffa]['s']];
if ($num_agg[$tariffa]['s'] == 7) $num_agg[$tariffa]['s'] = 0;
} # fine if ($tipo_percent == "s")

$prezzo_a = (double) $prezzoperiodo;
if ($dati_tariffe[$tariffa]['parte_prezzo'] != "p") {
if ($tipo_percent == "p") $perc = (double) (($prezzo_a / 100.0) * $importa_percent);
if ($perc) {
if ($tipo_percent == "p") $perc = (round(($perc / $importa_arrotond),0) * $importa_arrotond);
$prezzo_a = $prezzo_a + $perc;
} # fine if ($perc)
} # fine if ($dati_tariffe[$tariffa]['parte_prezzo'] != "p")
if ($prezzo_a) esegui_query("update $tableperiodi set $tariffa = '$prezzo_a' where idperiodi = '$num1'");
else esegui_query("update $tableperiodi set $tariffa = NULL where idperiodi = '$num1'");
} # fine if ((string) $prezzoperiodo != "NO")

if ((string) $prezzoperiodop != "NO") {
if ($tipo_percent == "s") {
$num_agg[$tariffa]['p']++;
$perc = $agg_vett[$tariffa][$num_agg[$tariffa]['p']];
if ($num_agg[$tariffa]['p'] == 7) $num_agg[$tariffa]['p'] = 0;
} # fine if ($tipo_percent == "s")

$prezzo_a_p = (double) $prezzoperiodop;
if ($dati_tariffe[$tariffa]['parte_prezzo'] != "f") {
if ($tipo_percent == "p") $perc = (double) (($prezzo_a_p / 100.0) * $importa_percent);
if ($perc) {
if ($tipo_percent == "p") $perc = (round(($perc / $importa_arrotond),0) * $importa_arrotond);
$prezzo_a_p = $prezzo_a_p + $perc;
} # fine if ($perc)
} # fine if ($dati_tariffe[$tariffa]['parte_prezzo'] != "f")
if ($prezzo_a_p) esegui_query("update $tableperiodi set $tariffa"."p = '$prezzo_a_p' where idperiodi = '$num1'");
else esegui_query("update $tableperiodi set $tariffa"."p = NULL where idperiodi = '$num1'");
} # fine if ((string) $prezzoperiodop != "NO")

} # fine for $num1
} # fine else if ($idperiodo == "opztariffa")
} # fine for $num_tar
} # fine if ($dati_tariffe[$tipotariffa]['esporta_prezzi'])
} # fine function aggiorna_tariffe_esporta





###########################################
###  FINE ./includes/funzioni_tariffe.php 
###########################################

###########################################
###  INIZIO ./includes/funzioni_costi_agg.php 
###########################################

##################################################################################
#    HOTELDRUID
#    Copyright (C) 2001-2012 by Marco Maria Francesco De Santis (marco@digitaldruid.net)
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    any later version accepted by Marco Maria Francesco De Santis, which
#    shall act as a proxy as defined in Section 14 of version 3 of the
#    license.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
##################################################################################




function dati_costi_agg_ntariffe ($tablenometariffe,$num_tariffe,$solo_visibili = "NO",$ordine_imposto = "") {
global $LIKE;

if ($num_tariffe == "NO") $num_tariffe = 0;
else {
if (!$num_tariffe) {
$num_tariffe = esegui_query("select nomecostoagg from $tablenometariffe where idntariffe = 1 ");
$num_tariffe = risul_query($num_tariffe,0,'nomecostoagg');
} # fine if (!$num_tariffe)
} # fine else if ($num_tariffe == "NO")
if ($solo_visibili == "SI") $cond_visibili = " and mostra_ca $LIKE 's%'";
$ordine = "tipo_ca, idntariffe";
if ($ordine_imposto) $ordine = $ordine_imposto;
$costi = esegui_query("select * from $tablenometariffe where idntariffe > 10  and nomecostoagg != ''$cond_visibili order by $ordine");
$dati_ca['num'] = numlin_query($costi);
for ($num1 = 0 ; $num1 < $dati_ca['num'] ; $num1++) {
$dati_ca[$num1]['id'] = risul_query($costi,$num1,'idntariffe');
$dati_ca['id'][$dati_ca[$num1]['id']] = $num1;
$dati_ca[$num1]['nome'] = risul_query($costi,$num1,'nomecostoagg');
$dati_ca[$num1]['valore'] = risul_query($costi,$num1,'valore_ca');
$dati_ca[$num1]['tipo'] = risul_query($costi,$num1,'tipo_ca');
$dati_ca[$num1]['tipo_val'] = substr($dati_ca[$num1]['tipo'],1,1);
$dati_ca[$num1]['tipo'] = substr($dati_ca[$num1]['tipo'],0,1);
if ($dati_ca[$num1]['tipo_val'] != "f") {
$dati_ca[$num1]['valore_perc'] = risul_query($costi,$num1,'valore_perc_ca');
$dati_ca[$num1]['arrotonda'] = (double) risul_query($costi,$num1,'arrotonda_ca');
} # fine if ($dati_ca[$num1]['tipo_val'] != "f")
$dati_ca[$num1]['tasseperc'] = risul_query($costi,$num1,'tasseperc_ca');
for ($nt = 1 ; $nt <= $num_tariffe ; $nt++) {
$dati_ca[$num1]["tariffa".$nt] = risul_query($costi,$num1,"tariffa".$nt);
if ($dati_ca[$num1]["tariffa".$nt] != "i") {
$dati_ca[$num1]["tipo_associa_tariffa".$nt] = substr($dati_ca[$num1]["tariffa".$nt],0,1);
$dati_ca[$num1]["tariffa".$nt] = substr($dati_ca[$num1]["tariffa".$nt],1);
} # fine if ($dati_ca[$num1]["tariffa".$nt] != "i")
else {
$dati_ca[$num1]["tariffa".$nt] = "";
$dati_ca[$num1]["incomp_tariffa".$nt] = "i";
} # fine else if ($dati_ca[$num1]["tariffa".$nt] != "i")
} # fine for $nt
$dati_ca[$num1]['associasett'] = risul_query($costi,$num1,'associasett_ca');
$numsett = risul_query($costi,$num1,'numsett_ca');
$dati_ca[$num1]['numsett_orig'] = $numsett;
$dati_ca[$num1]['numsett'] = substr($numsett,0,1);
if ($dati_ca[$num1]['numsett'] == "m") $dati_ca[$num1]['sett_meno_una'] = substr($numsett,1,1);
if ($dati_ca[$num1]['numsett'] == "n" or $dati_ca[$num1]['numsett'] == "s") {
$sett_prime_seconde = explode(",",substr($numsett,1));
$dati_ca[$num1]['num_sett_prime'] = $sett_prime_seconde[0];
$dati_ca[$num1]['num_sett_seconde'] = $sett_prime_seconde[1];
} # fine if ($dati_ca[$num1]['numsett'] == "n" or $dati_ca[$num1]['numsett'] == "s")
if ($dati_ca[$num1]['numsett'] == "g") $dati_ca[$num1]['giornisett'] = substr($numsett,1);
$dati_ca[$num1]['mostra'] = risul_query($costi,$num1,'mostra_ca');
$dati_ca[$num1]['raggruppa'] = substr($dati_ca[$num1]['mostra'],1,1);
$dati_ca[$num1]['combina'] = substr($dati_ca[$num1]['mostra'],2,1);
$dati_ca[$num1]['mostra'] = substr($dati_ca[$num1]['mostra'],0,1);
$dati_ca[$num1]['moltiplica'] = risul_query($costi,$num1,'moltiplica_ca');
$dati_ca[$num1]['molt_max'] = substr($dati_ca[$num1]['moltiplica'],1,1);
$molt_agg = explode(",",substr($dati_ca[$num1]['moltiplica'],2));
$dati_ca[$num1]['molt_agg'] = $molt_agg[0];
$dati_ca[$num1]['molt_max_num'] = $molt_agg[1];
$dati_ca[$num1]['moltiplica'] = substr($dati_ca[$num1]['moltiplica'],0,1);
$dati_ca[$num1]['letto'] = risul_query($costi,$num1,'letto_ca');
$dati_ca[$num1]['var_periodip'] = risul_query($costi,$num1,'variazione_ca');
$dati_ca[$num1]['var_percentuale'] = substr($dati_ca[$num1]['var_periodip'],0,1);
$dati_ca[$num1]['var_numsett'] = substr($dati_ca[$num1]['var_periodip'],1,1);
$dati_ca[$num1]['var_moltiplica'] = substr($dati_ca[$num1]['var_periodip'],2,1);
$dati_ca[$num1]['var_tariffea'] = substr($dati_ca[$num1]['var_periodip'],4,1);
$dati_ca[$num1]['var_tariffei'] = substr($dati_ca[$num1]['var_periodip'],5,1);
$dati_ca[$num1]['var_beniinv'] = substr($dati_ca[$num1]['var_periodip'],6,1);
$dati_ca[$num1]['var_appi'] = substr($dati_ca[$num1]['var_periodip'],7,1);
$dati_ca[$num1]['var_comb'] = substr($dati_ca[$num1]['var_periodip'],8,1);
$dati_ca[$num1]['var_periodip'] = substr($dati_ca[$num1]['var_periodip'],3,1);
$dati_ca[$num1]['beniinv_orig'] = risul_query($costi,$num1,'beniinv_ca');
if ($dati_ca[$num1]['beniinv_orig']) {
$beniinv_vett = explode(";",$dati_ca[$num1]['beniinv_orig']);
$dati_ca[$num1]['tipo_beniinv'] = substr($beniinv_vett[0],0,3);
if ($dati_ca[$num1]['tipo_beniinv'] == "mag") $dati_ca[$num1]['mag_beniinv'] = substr($beniinv_vett[0],3);
$dati_ca[$num1]['num_beniinv'] = (count($beniinv_vett) - 1);
for ($num2 = 0 ; $num2 < $dati_ca[$num1]['num_beniinv'] ; $num2++) {
$bene_inv = explode(",",$beniinv_vett[($num2 + 1)]);
$dati_ca[$num1]['id_beneinv'][$num2] = $bene_inv[0];
$dati_ca[$num1]['molt_beneinv'][$num2] = $bene_inv[1];
} # fine for $num2
} # fine if ($dati_ca[$num1]['beniinv_orig'])
$dati_ca[$num1]['periodipermessi_orig'] = risul_query($costi,$num1,'periodipermessi_ca');
$dati_ca[$num1]['periodipermessi'] = substr($dati_ca[$num1]['periodipermessi_orig'],0,1);
if ($dati_ca[$num1]['periodipermessi']) {
$sett_periodipermessi = explode(",",substr($dati_ca[$num1]['periodipermessi_orig'],1));
$num_sett_periodipermessi = count($sett_periodipermessi);
for ($num2 = 0 ; $num2 < $num_sett_periodipermessi ; $num2++) {
$sett_periodipermesso = explode("-",$sett_periodipermessi[$num2]);
$dati_ca[$num1]['sett_periodipermessi_ini'][$num2] = $sett_periodipermesso[0];
$dati_ca[$num1]['sett_periodipermessi_fine'][$num2] = $sett_periodipermesso[1];
} # fine for $num2
} # fine if ($dati_ca[$num1][periodipermessi])
$dati_ca[$num1]['appincompatibili'] = risul_query($costi,$num1,'appincompatibili_ca');
$dati_ca[$num1]['categoria'] = risul_query($costi,$num1,'categoria_ca');
$dati_ca[$num1]['numlimite'] = risul_query($costi,$num1,'numlimite_ca');
$regoleassegna_ca = explode(";",risul_query($costi,$num1,'regoleassegna_ca'));
$dati_ca[$num1]['assegna_da_ini_prenota'] = $regoleassegna_ca[0];
$dati_ca[$num1]['assegna_con_num_prenota'] = $regoleassegna_ca[1];
} # fine for $num1

return $dati_ca;

} # fine function dati_costi_agg_ntariffe



function num_costi_in_periodo ($tablecostiprenota,$tableprenota,$id_periodo,$id_costo,$nome_costo,$id_prenota,$tra_anni) {

if ($tra_anni) {
global $PHPR_TAB_PRE;
$tableperiodi_prec = $PHPR_TAB_PRE."periodi".$tra_anni;
$tableperiodi_succ = $PHPR_TAB_PRE."periodi".($tra_anni + 1);
$data_fine = esegui_query("select datainizio,datafine from $tableperiodi_prec where idperiodi = '$id_periodo'");
$data_inizio = aggslashdb(risul_query($data_fine,0,'datainizio'));
$data_fine = aggslashdb(risul_query($data_fine,0,'datafine'));
$periodo_succ = esegui_query("select idperiodi from $tableperiodi_succ where datainizio = '$data_inizio' and datafine = '$data_fine'");
if (numlin_query($periodo_succ) == 1) {
$id_periodo = risul_query($periodo_succ,0,'idperiodi');
$tableprenota = $PHPR_TAB_PRE."prenota".($tra_anni + 1);
$tablecostiprenota = $PHPR_TAB_PRE."costiprenota".($tra_anni + 1);
if ($id_prenota) {
$prenota_esistente = esegui_query("select idprenota from $tableprenota where iddatainizio = '0' and commento = '$id_prenota'");
if (numlin_query($prenota_esistente) == 1) $id_prenota = risul_query($prenota_esistente,0,'idprenota');
else $id_prenota = "";
} # fine if ($id_prenota)
} # fine if (numlin_query($periodo_succ) == 1)
} # fine if ($tra_anni)
if ($id_prenota) $cond_escludi_prenota = " and $tablecostiprenota.idprenota != '$id_prenota'";
$costi = esegui_query("select distinct $tablecostiprenota.idcostiprenota,$tablecostiprenota.moltiplica,$tablecostiprenota.associasett,$tablecostiprenota.settimane from $tablecostiprenota inner join $tableprenota on $tablecostiprenota.idprenota = $tableprenota.idprenota where $tablecostiprenota.idntariffe = '$id_costo' and $tablecostiprenota.nome = '$nome_costo' and $tableprenota.iddatainizio <= '$id_periodo' and $tableprenota.iddatafine >= '$id_periodo'$cond_escludi_prenota");
$num_costi = numlin_query($costi);
$num_costi_orig = $num_costi;
for ($num1 = 0 ; $num1 < $num_costi_orig ; $num1++) {
$associasett = risul_query($costi,$num1,'associasett',$tablecostiprenota);
$settimane_costo = risul_query($costi,$num1,'settimane',$tablecostiprenota);
if ($associasett == "s" and str_replace(",$id_periodo,","",$settimane_costo) == $settimane_costo) $num_costi--;
else {
$moltiplica = risul_query($costi,$num1,'moltiplica',$tablecostiprenota);
if ($associasett == "s") {
$settimane = explode(",",$settimane_costo);
$moltiplica = explode(",",$moltiplica);
for ($num2 = 0 ; $num2 < count($settimane) ; $num2++) if ($settimane[$num2] == $id_periodo) $moltiplica = $moltiplica[$num2];
} # fine if ($associasett == "s")
if ($moltiplica > 1) $num_costi = $num_costi + $moltiplica - 1;
} # fine else if ($associasett == "s" and str_replace("","",$settimane) == $settimane)
} # fine for $num1

return $num_costi;

} # fine function num_costi_in_periodo



function trova_periodo_permesso_costo ($dati_ca,$num_costo,$idinizioperiodo,$idfineperiodo,$num_settimane_costo) {

$periodo_costo_trovato = "NO";
if ($dati_ca[$num_costo]['periodipermessi']) {
for ($num1 = 0 ; $num1 < count($dati_ca[$num_costo]['sett_periodipermessi_ini']) ; $num1++) {
if ($dati_ca[$num_costo]['sett_periodipermessi_ini'][$num1] <= $idinizioperiodo and $dati_ca[$num_costo]['sett_periodipermessi_fine'][$num1] >= $idfineperiodo) $periodo_costo_trovato = "SI";
else {
if ($dati_ca[$num_costo]['sett_periodipermessi_ini'][$num1] <= $idfineperiodo and $dati_ca[$num_costo]['sett_periodipermessi_fine'][$num1] >= $idinizioperiodo) {
if ($dati_ca[$num_costo]['periodipermessi'] == "u") $periodo_costo_trovato = "SI";
if ($dati_ca[$num_costo]['periodipermessi'] == "p") {
if ($dati_ca[$num_costo]['associasett'] == "s" or $dati_ca[$num_costo]['numsett'] != "c") $periodo_costo_trovato = "SI";
else {
if ($dati_ca[$num_costo]['sett_periodipermessi_ini'][$num1] > $idinizioperiodo) $periodo_costo_ini = $dati_ca[$num_costo]['sett_periodipermessi_ini'][$num1];
else $periodo_costo_ini = $idinizioperiodo;
if ($dati_ca[$num_costo]['sett_periodipermessi_fine'][$num1] < $idfineperiodo) $periodo_costo_fine = $dati_ca[$num_costo]['sett_periodipermessi_fine'][$num1];
else $periodo_costo_ini = $idfineperiodo;
if ($num_settimane_costo <= ($periodo_costo_fine - $periodo_costo_ini + 1)) $periodo_costo_trovato = "SI";
} # fine else if ($dati_ca[$num_costo][associasett] == "s" or...
} # fine if ($dati_ca[$num_costo][periodipermessi] == "p")
} # fine if ($dati_ca[$num_costo][sett_periodipermessi_ini][$num1] <= $idfineperiodo and...
} # fine else if ($dati_ca[$num_costo][sett_periodipermessi_ini][$num1] <= $idinizioperiodo and...
} # fine for $num1
} # fine if ($dati_ca[$num_costo][periodipermessi])
else $periodo_costo_trovato = "SI";

return $periodo_costo_trovato;

} # fine function trova_periodo_permesso_costo



function calcola_prezzo_totale_costo ($dati_ca,$num_costo,$idinizioperiodo,$idfineperiodo,$settimane_costo,$moltiplica,$costo_tariffa,$lista_tariffe,$costo_prenota_tot,$caparra,$numpersone) {

$prezzo_costo_fisso = (double) $dati_ca[$num_costo]['valore'];
if ($dati_ca[$num_costo]['tipo_val'] != "f") $prezzo_costo_perc = (double) $dati_ca[$num_costo]['valore_perc'];
else $prezzo_costo_perc = 0;
if ($dati_ca[$num_costo]['associasett'] == "s" or $dati_ca[$num_costo]['tipo_val'] == "q" or $dati_ca[$num_costo]['tipo_val'] == "s") {
$lista_tariffe = explode(";",$lista_tariffe);
$lista_tariffep = $lista_tariffe[1];
$lista_tariffe = explode(",",$lista_tariffe[0]);
if ($dati_ca[$num_costo]['tipo_val'] == "q" or $dati_ca[$num_costo]['tipo_val'] == "s") {
$costo_tariffap = (double) 0;
if ($lista_tariffep) {
$lista_tariffep = explode(",",$lista_tariffep);
for ($num1 = 0 ; $num1 < count($lista_tariffep) ; $num1++) $costo_tariffap += (double) $lista_tariffep[$num1];
} # fine ($lista_tariffep)
else for ($num1 = 0 ; $num1 < count($lista_tariffe) ; $num1++) $lista_tariffep[$num1] = (double) 0;
} # fine if ($dati_ca[$num_costo]['tipo_val'] == "q" or $dati_ca[$num_costo]['tipo_val'] == "s")
} # fine if ($dati_ca[$num_costo]['associasett'] == "s" or...

if ($dati_ca[$num_costo]['tipo'] == "u") {
if ($dati_ca[$num_costo]['tipo_val'] == "p") $prezzo_costo_perc = ($costo_tariffa * $prezzo_costo_perc) / 100;
if ($dati_ca[$num_costo]['tipo_val'] == "q") $prezzo_costo_perc = (($costo_tariffa - $costo_tariffap) * $prezzo_costo_perc) / 100;
if ($dati_ca[$num_costo]['tipo_val'] == "s") {
if ($numpersone) $prezzo_costo_perc = (($costo_tariffap / (double) $numpersone) * $prezzo_costo_perc) / 100;
else $prezzo_costo_perc = 0;
} # fine if ($dati_ca[$num_costo]['tipo_val'] == "s")
if ($dati_ca[$num_costo]['tipo_val'] == "t") $prezzo_costo_perc = ($costo_prenota_tot * $prezzo_costo_perc) / 100;
if ($dati_ca[$num_costo]['tipo_val'] == "c") $prezzo_costo_perc = ($caparra * $prezzo_costo_perc) / 100;
if ($dati_ca[$num_costo]['tipo_val'] == "r") $prezzo_costo_perc = (($costo_prenota_tot - $caparra) * $prezzo_costo_perc) / 100;
} # fine if ($dati_ca[$num_costo]['tipo'] == "u")
if ($dati_ca[$num_costo]['tipo'] == "s") {
if ($dati_ca[$num_costo]['associasett'] == "s") {
$prezzo_costo_fisso_tot = 0;
$prezzo_costo_perc_tot = 0;
$prezzo_costo_sett = 0;
$moltiplica = explode(",",$moltiplica);
$num_lista_tariffe = 0;
$num_sett = 1;
for ($num1 = $idinizioperiodo ; $num1 <= $idfineperiodo ; $num1++) {
if (str_replace(",".$num1.",","",$settimane_costo) != $settimane_costo) {
$prezzo_costo_fisso_tot = $prezzo_costo_fisso_tot + ($prezzo_costo_fisso * $moltiplica[$num_sett]);
if ($dati_ca[$num_costo]['tipo_val'] == "p") $prezzo_costo_sett = ($lista_tariffe[$num_lista_tariffe] * $prezzo_costo_perc) / 100;
if ($dati_ca[$num_costo]['tipo_val'] == "q") $prezzo_costo_sett = (($lista_tariffe[$num_lista_tariffe] - $lista_tariffep[$num_lista_tariffe]) * $prezzo_costo_perc) / 100;
if ($dati_ca[$num_costo]['tipo_val'] == "s") $prezzo_costo_sett = ($lista_tariffep[$num_lista_tariffe] * $prezzo_costo_perc) / 100;
$prezzo_costo_perc_tot = $prezzo_costo_perc_tot + ($prezzo_costo_sett * $moltiplica[$num_sett]);
$num_sett++;
} # fine (str_replace(",".$num1.",","",$settimane_costo) != $settimane_costo)
$num_lista_tariffe++;
} # fine for $num1
$prezzo_costo_fisso = $prezzo_costo_fisso_tot;
$prezzo_costo_perc = $prezzo_costo_perc_tot;
} # fine if ($dati_ca[$num_costo]['associasett'] == "s")
else $prezzo_costo_fisso = $prezzo_costo_fisso * $settimane_costo;
} # fine if ($dati_ca[$num_costo][tipo] == "s")

if ($dati_ca[$num_costo]['associasett'] != "s") {
$prezzo_costo_fisso = $prezzo_costo_fisso * $moltiplica;
$prezzo_costo_perc = $prezzo_costo_perc * $moltiplica;
} # fine if ($dati_ca[$num_costo]['associasett'] != "s")
if ($dati_ca[$num_costo]['tipo_val'] != "f") $prezzo_costo_perc = floor($prezzo_costo_perc / $dati_ca[$num_costo]['arrotonda']) * $dati_ca[$num_costo]['arrotonda'];
$prezzo_costo = $prezzo_costo_fisso + $prezzo_costo_perc;

return $prezzo_costo;

} # fine function calcola_prezzo_totale_costo



function calcola_settimane_costo ($tableperiodi,$dati_ca,$num_costo,$idinizioperiodo,$idfineperiodo,$id_periodi_costo,$numsettimane) {

$settimane_costo = "";
if ($dati_ca[$num_costo]['tipo'] == "s") {
if ($dati_ca[$num_costo]['associasett'] == "s") {
$num_attuale = 0;
for ($num1 = $idinizioperiodo; $num1 <= $idfineperiodo; $num1++) {
$periodo_costo_trovato = "NO";
if ($dati_ca[$num_costo]['periodipermessi'] == "p") {
for ($num2 = 0 ; $num2 < count($dati_ca[$num_costo]['sett_periodipermessi_ini']) ; $num2++) {
if ($dati_ca[$num_costo]['sett_periodipermessi_ini'][$num2] <= $num1 and $dati_ca[$num_costo]['sett_periodipermessi_fine'][$num2] >= $num1) $periodo_costo_trovato = "SI";
} # fine for $num2
} # fine if ($dati_ca[$num_costo][periodipermessi] == "p")
else $periodo_costo_trovato = "SI";
if ($periodo_costo_trovato == "SI") {
if ($dati_ca[$num_costo]['numsett'] == "t") $settimane_costo .= ",$num1";
if ($dati_ca[$num_costo]['numsett'] == "m" and (($dati_ca[$num_costo]['sett_meno_una'] == "p" and $num1 != $idinizioperiodo) or ($dati_ca[$num_costo]['sett_meno_una'] == "u" and $num1 != $idfineperiodo)) )  $settimane_costo .= ",$num1";
if ($dati_ca[$num_costo]['numsett'] == "c" and str_replace(",$num1,","",$id_periodi_costo) != $id_periodi_costo) $settimane_costo .= ",$num1";
if ($dati_ca[$num_costo]['numsett'] == "s" or $dati_ca[$num_costo]['numsett'] == "n") {
$num_attuale++;
if ($num_attuale <= $dati_ca[$num_costo]['num_sett_prime'] and $dati_ca[$num_costo]['numsett'] == "s") $settimane_costo .= ",$num1";
if ($num_attuale > $dati_ca[$num_costo]['num_sett_prime'] and $dati_ca[$num_costo]['numsett'] == "n") $settimane_costo .= ",$num1";
if ($num_attuale == ($dati_ca[$num_costo]['num_sett_prime'] + $dati_ca[$num_costo]['num_sett_seconde'])) $num_attuale = 0;
} # fine if ($dati_ca[$num_costo][numsett] == "s" or $dati_ca[$num_costo][numsett] == "n")
if ($dati_ca[$num_costo]['numsett'] == "g") {
$dataini_gio = esegui_query("select datainizio from $tableperiodi where idperiodi = '$num1'");
$dataini_gio = risul_query($dataini_gio,0,'datainizio');
$giorno = date("w", mktime(0,0,0,substr($dataini_gio,5,2),substr($dataini_gio,8,2),substr($dataini_gio,0,4)));
if ($giorno == 0) $giorno = 7;
if (str_replace($giorno,"",$dati_ca[$num_costo]['giornisett']) != $dati_ca[$num_costo]['giornisett']) $settimane_costo .= ",$num1";
} # fine if ($dati_ca[$num_costo][numsett] == "g")
} # fine if ($periodo_costo_trovato == "SI")
} # fine for $num1
if ($settimane_costo) $settimane_costo .= ",";
} # fine if ($dati_ca[$num_costo][associasett] == "s")
else {
if ($dati_ca[$num_costo]['numsett'] == "t") $settimane_costo = $idfineperiodo - $idinizioperiodo + 1;
if ($dati_ca[$num_costo]['numsett'] == "m") $settimane_costo = $idfineperiodo - $idinizioperiodo;
if ($dati_ca[$num_costo]['numsett'] == "c") $settimane_costo = $numsettimane;
} # fine else if ($dati_ca[$num_costo][associasett] == "s")
} # fine if ($dati_ca[$num_costo][tipo] == "s")
return $settimane_costo;

} # fine function calcola_settimane_costo



function calcola_moltiplica_costo ($dati_ca,$num_costo,&$moltiplica,$idinizioperiodo,$idfineperiodo,$settimane_costo,$nummoltiplica_ca,$numpersone,$num_letti_agg) {

$moltiplica = "";
if (!$dati_ca[$num_costo]['molt_agg']) $dati_ca[$num_costo]['molt_agg'] = 0;
if ($dati_ca[$num_costo]['moltiplica'] == "1") $moltiplica = 1;
if ($dati_ca[$num_costo]['moltiplica'] == "c") $moltiplica = $nummoltiplica_ca;
if ($dati_ca[$num_costo]['moltiplica'] == "p") $moltiplica = $numpersone;
if ($dati_ca[$num_costo]['moltiplica'] == "t") {
$letti_agg_max = 0;
if ($dati_ca[$num_costo]['tipo'] == "s" and $dati_ca[$num_costo]['associasett'] == "s") {
for ($num1 = $idinizioperiodo; $num1 <= $idfineperiodo; $num1++) {
if ($num_letti_agg[$num1] > $letti_agg_max) $letti_agg_max = $num_letti_agg[$num1];
if ($settimane_costo != str_replace(",$num1,","",$settimane_costo)) $moltiplica .= ",".max(($numpersone + $num_letti_agg[$num1] + $dati_ca[$num_costo]['molt_agg']),0);
} # fine for $num1
$moltiplica .= ",";
$moltiplica_max = $numpersone + $letti_agg_max;
} # fine if ($dati_ca[$num_costo][tipo] == "s" and $dati_ca[$num_costo]['associasett'] == "s")
else {
for ($num1 = $idinizioperiodo; $num1 <= $idfineperiodo; $num1++) if ($num_letti_agg[$num1] > $letti_agg_max) $letti_agg_max = $num_letti_agg[$num1];
$moltiplica = max(($numpersone + $letti_agg_max + $dati_ca[$num_costo]['molt_agg']),0);
$moltiplica_max = $moltiplica;
} # fine else if ($dati_ca[$num_costo][tipo] == "s" and $dati_ca[$num_costo]['associasett'] == "s")
} # fine if ($dati_ca[$num_costo][moltiplica] == "t")
else {
$moltiplica = max(($moltiplica + $dati_ca[$num_costo]['molt_agg']),0);
$moltiplica_max = $moltiplica;
if ($dati_ca[$num_costo]['tipo'] == "s" and $dati_ca[$num_costo]['associasett'] == "s") {
$moltiplica = "";
for ($num1 = $idinizioperiodo; $num1 <= $idfineperiodo; $num1++) {
if ($settimane_costo != str_replace(",$num1,","",$settimane_costo))  $moltiplica .= ",$moltiplica_max";
} # fine for $num1
$moltiplica .= ",";
} # fine if ($dati_ca[$num_costo]['tipo'] == "s" and $dati_ca[$num_costo]['associasett'] == "s")
} # fine else if ($dati_ca[$num_costo]['moltiplica'] == "t")

return $moltiplica_max;

} # fine function calcola_moltiplica_costo



function aggiorna_letti_agg_in_periodi ($dati_ca,$num_costo,&$num_letti_agg,$idinizioperiodo,$idfineperiodo,$settimane_costo,$moltiplica,$nummoltiplica_ca,$numpersone) {

if ($num_letti_agg['max'] == "") $num_letti_agg['max'] = 0;
if ($dati_ca[$num_costo]['letto'] == "s") {
if (!$moltiplica) calcola_moltiplica_costo($dati_ca,$num_costo,$moltiplica,$idinizioperiodo,$idfineperiodo,$settimane_costo,$nummoltiplica_ca,$numpersone,"");
for ($num1 = $idinizioperiodo; $num1 <= $idfineperiodo; $num1++) {
if (!$num_letti_agg[$num1]) $num_letti_agg[$num1] = 0;
if ($dati_ca[$num_costo]['associasett'] == "s") {
if ($settimane_costo != str_replace(",$num1,","",$settimane_costo)) {
$settimane = explode(",",$settimane_costo);
$moltiplica_sett = explode(",",$moltiplica);
for ($num2 = 0 ; $num2 < count($settimane) ; $num2++) if ($settimane[$num2] == $num1) $moltiplica_sett = $moltiplica_sett[$num2];
$num_letti_agg[$num1] = $num_letti_agg[$num1] + $moltiplica_sett;
} # fine if ($settimane_costo != str_replace(",$num1,","",$settimane_costo))
} # fine if ($dati_ca[$num_costo]['associasett'] == "s")
else $num_letti_agg[$num1] = $num_letti_agg[$num1] + $moltiplica;
if ($num_letti_agg[$num1] > $num_letti_agg['max']) $num_letti_agg['max'] = $num_letti_agg[$num1];
} # fine for $num1
} # fine if ($dati_ca[$num_costo]['letto'] == "s")

} # fine function aggiorna_letti_agg_in_periodi



function controlla_num_limite_costo ($tablecostiprenota,$tableprenota,$dati_ca,$num_costo,&$num_costi_presenti,$idinizioperiodo,$idfineperiodo,$settimane_costo,$moltiplica,$num_limite = "",$tra_anni = "") {

$limite_rispettato = "SI";
if ($num_limite == "") $num_limite = $dati_ca[$num_costo]['numlimite'];
if ($num_limite) {
if ($dati_ca[$num_costo]['idntariffe']) $idcostoagg = $dati_ca[$num_costo]['idntariffe'];
else $idcostoagg = $dati_ca[$num_costo]['id'];
$num_costi_presenti_copia = $num_costi_presenti;
for ($num1 = $idinizioperiodo; $num1 <= $idfineperiodo; $num1++) {
$sett_attivata = "SI";
if ($dati_ca[$num_costo]['associasett'] == "s" and $settimane_costo == str_replace(",$num1,","",$settimane_costo)) $sett_attivata = "NO";
if ($sett_attivata == "SI") {
if ($num_costi_presenti[$idcostoagg][$num1] == "") $num_costi_presenti[$idcostoagg][$num1] = num_costi_in_periodo($tablecostiprenota,$tableprenota,$num1,$idcostoagg,$dati_ca[$num_costo]['nome'],$dati_ca[$num_costo]['idprenota'],$tra_anni);
if ($dati_ca[$num_costo]['associasett'] == "s") {
if ($settimane_costo != str_replace(",$num1,","",$settimane_costo)) {
$settimane = explode(",",$settimane_costo);
$moltiplica_sett = explode(",",$moltiplica);
for ($num2 = 0 ; $num2 < count($settimane) ; $num2++) if ($settimane[$num2] == $num1) $moltiplica_sett = $moltiplica_sett[$num2];
} # fine if ($settimane_costo != str_replace(",$num1,","",$settimane_costo))
} # fine if ($dati_ca[$num_costo]['associasett'] == "s")
else $moltiplica_sett = $moltiplica;
if ($moltiplica_sett > 1) $num_costi_presenti[$idcostoagg][$num1] = $num_costi_presenti[$idcostoagg][$num1] + $moltiplica_sett;
else $num_costi_presenti[$idcostoagg][$num1]++;
if ($num_costi_presenti[$idcostoagg][$num1] > $num_limite) $limite_rispettato = "NO";
} # fine if ($sett_attivata == "SI")
} # fine for $num1
} # fine if ($num_limite)
if ($limite_rispettato == "NO") $num_costi_presenti = $num_costi_presenti_copia;

return $limite_rispettato;

} # fine function controlla_num_limite_costo



function dati_costi_agg_prenota ($tablecostiprenota,$id_prenota) {

$costi = esegui_query("select * from $tablecostiprenota where idprenota = '$id_prenota' order by tipo, idcostiprenota");
$dati_cap['num'] = numlin_query($costi);
for ($numca = 0 ; $numca < $dati_cap['num'] ; $numca++) {
$dati_cap[$numca]['tipo'] = risul_query($costi,$numca,'tipo');
$dati_cap[$numca]['tipo_val'] = substr($dati_cap[$numca]['tipo'],1,1);
$dati_cap[$numca]['tipo'] = substr($dati_cap[$numca]['tipo'],0,1);
$dati_cap[$numca]['id'] = risul_query($costi,$numca,'idcostiprenota');
$dati_cap['id'][$dati_cap[$numca]['id']] = $numca;
$dati_cap[$numca]['nome'] = risul_query($costi,$numca,'nome');
$dati_cap[$numca]['valore'] = risul_query($costi,$numca,'valore');
if ($dati_cap[$numca]['tipo_val'] != "f") {
$dati_cap[$numca]['valore_perc'] = risul_query($costi,$numca,'valore_perc');
$dati_cap[$numca]['arrotonda'] = (double) risul_query($costi,$numca,'arrotonda');
} # fine if ($dati_cap[$numca]['tipo_val'] != "f")
$dati_cap[$numca]['tasseperc'] = (double) risul_query($costi,$numca,'tasseperc');
$dati_cap[$numca]['associasett'] = risul_query($costi,$numca,'associasett');
$numsett = risul_query($costi,$numca,'varnumsett');
$dati_cap[$numca]['numsett_orig'] = $numsett;
$dati_cap[$numca]['numsett'] = substr($numsett,0,1);
if ($dati_cap[$numca]['numsett'] == "m") $dati_cap[$numca]['sett_meno_una'] = substr($numsett,1,1);
if ($dati_cap[$numca]['numsett'] == "n" or $dati_cap[$numca]['numsett'] == "s") {
$sett_prime_seconde = explode(",",substr($numsett,1));
$dati_cap[$numca]['num_sett_prime'] = $sett_prime_seconde[0];
$dati_cap[$numca]['num_sett_seconde'] = $sett_prime_seconde[1];
} # fine if ($dati_cap[$numca]['numsett'] == "n" or $dati_cap[$numca]['numsett'] == "s")
if ($dati_cap[$numca]['numsett'] == "g") $dati_cap[$numca]['giornisett'] = substr($numsett,1);
$dati_cap[$numca]['moltiplica'] = risul_query($costi,$numca,'varmoltiplica');
$dati_cap[$numca]['molt_max'] = substr($dati_cap[$numca]['moltiplica'],1,1);
$molt_agg = explode(",",substr($dati_cap[$numca]['moltiplica'],2));
$dati_cap[$numca]['molt_agg'] = $molt_agg[0];
$dati_cap[$numca]['molt_max_num'] = $molt_agg[1];
$dati_cap[$numca]['moltiplica'] = substr($dati_cap[$numca]['moltiplica'],0,1);
$dati_cap[$numca]['letto'] = risul_query($costi,$numca,'letto');
$dati_cap[$numca]['beniinv_orig'] = risul_query($costi,$numca,'varbeniinv');
if ($dati_cap[$numca]['beniinv_orig']) {
$beniinv_vett = explode(";",$dati_cap[$numca]['beniinv_orig']);
$dati_cap[$numca]['beniinv_ripeti'] = $beniinv_vett[0];
$dati_cap[$numca]['tipo_beniinv'] = substr($beniinv_vett[1],0,3);
if ($dati_cap[$numca]['tipo_beniinv'] == "mag") $dati_cap[$numca]['mag_beniinv'] = substr($beniinv_vett[1],3);
$dati_cap[$numca]['num_beniinv'] = (count($beniinv_vett) - 2);
for ($num1 = 0 ; $num1 < $dati_cap[$numca]['num_beniinv'] ; $num1++) {
$bene_inv = explode(",",$beniinv_vett[($num1 + 2)]);
$dati_cap[$numca]['id_beneinv'][$num1] = $bene_inv[0];
$dati_cap[$numca]['molt_beneinv'][$num1] = $bene_inv[1];
} # fine for $num1
} # fine if ($dati_cap[$numca]['beniinv_orig'])
$dati_cap[$numca]['periodipermessi_orig'] = risul_query($costi,$numca,'varperiodipermessi');
$dati_cap[$numca]['periodipermessi'] = substr($dati_cap[$numca]['periodipermessi_orig'],0,1);
if ($dati_cap[$numca]['periodipermessi']) {
$sett_periodipermessi = explode(",",substr($dati_cap[$numca]['periodipermessi_orig'],1));
for ($num1 = 0 ; $num1 < count($sett_periodipermessi) ; $num1++) {
$sett_periodipermesso = explode("-",$sett_periodipermessi[$num1]);
$dati_cap[$numca]['sett_periodipermessi_ini'][$num1] = $sett_periodipermesso[0];
$dati_cap[$numca]['sett_periodipermessi_fine'][$num1] = $sett_periodipermesso[1];
} # fine for $num1
} # fine if ($dati_cap[$numca]['periodipermessi'])
$dati_cap[$numca]['settimane'] = risul_query($costi,$numca,'settimane');
$dati_cap[$numca]['moltiplica_costo'] = risul_query($costi,$numca,'moltiplica');
if ($dati_cap[$numca]['associasett'] == "s") {
$sett = explode(",",$dati_cap[$numca]['settimane']);
$molt = explode(",",$dati_cap[$numca]['moltiplica_costo']);
for ($num1 = 1 ; $num1 < (count($sett) - 1) ; $num1++) $dati_cap[$numca]['moltiplica_costo_sett'][$sett[$num1]] = $molt[$num1];
} # fine if ($dati_cap[$numca]['associasett'] == "s")
$dati_cap[$numca]['idntariffe'] = risul_query($costi,$numca,'idntariffe');
$dati_cap[$numca]['appincompatibili'] = risul_query($costi,$numca,'varappincompatibili');
$dati_cap[$numca]['categoria'] = risul_query($costi,$numca,'categoria');
$dati_cap[$numca]['combina'] = risul_query($costi,$numca,'variazione');
$dati_cap[$numca]['tariffeassociate'] = risul_query($costi,$numca,'vartariffeassociate');
$dati_cap[$numca]['tipo_tariffeassociate'] = substr($dati_cap[$numca]['tariffeassociate'],0,1);
$dati_cap[$numca]['tariffeassociate'] = substr($dati_cap[$numca]['tariffeassociate'],1);
$incomp_tariffe = risul_query($costi,$numca,'vartariffeincomp');
$incomp_tariffe = explode(",",$incomp_tariffe);
for ($num1 = 0 ; $num1 < count($incomp_tariffe) ; $num1++) $dati_cap[$numca]["incomp_tariffa".$incomp_tariffe[$num1]] = "i";
$dati_cap[$numca]['idprenota'] = $id_prenota;
$dati_cap[$numca]['datainserimento'] = risul_query($costi,$numca,'datainserimento');
$dati_cap[$numca]['utente_inserimento'] = risul_query($costi,$numca,'utente_inserimento');
} # fine for $numca

return $dati_cap;

} # fine function dati_costi_agg_prenota



function associa_costo_a_tariffa ($dati_ca,$num_costo,$tariffa,$lunghezza_periodo) {

if ($dati_ca[$num_costo][$tariffa]) {
$associa_costo = "SI";
if (substr($dati_ca[$num_costo][$tariffa],0,1) == "=" and $lunghezza_periodo != substr($dati_ca[$num_costo][$tariffa],1)) $associa_costo = "NO";
if (substr($dati_ca[$num_costo][$tariffa],0,1) == ">" and $lunghezza_periodo < substr($dati_ca[$num_costo][$tariffa],1)) $associa_costo = "NO";
if (substr($dati_ca[$num_costo][$tariffa],0,1) == "<" and $lunghezza_periodo > substr($dati_ca[$num_costo][$tariffa],1)) $associa_costo = "NO";
if (substr($dati_ca[$num_costo][$tariffa],0,1) == "|") {
$valminmax = explode("<",substr($dati_ca[$num_costo][$tariffa],1));
if ($lunghezza_periodo < $valminmax[0] or $lunghezza_periodo > $valminmax[1]) $associa_costo = "NO";
} # fine if (substr($dati_ca[$num_costo][$tariffa],0,1) == "|")
} # fine if ($dati_ca[$num_costo][$tariffa])
else $associa_costo = "NO";

return $associa_costo;

} # fine function associa_costo_a_tariffa



function comunica_aggiunta_costo ($dati_ca,$num_costo,$n_prezzo_costo_agg,$stile_soldi,$pag,$Euro,$associasett_ca,$moltiplica,$settimane_costo,$per_la_prenotazione="",$silenzio="") {

global $parola_settimane,$parola_settimanale;
$val_costoagg_p = punti_in_num($n_prezzo_costo_agg,$stile_soldi);
if ($dati_ca[$num_costo]['tipo'] == "u") $mess .= mex("Il costo aggiuntivo unico",$pag);
if ($dati_ca[$num_costo]['tipo'] == "s") $mess .= mex("Il costo aggiuntivo $parola_settimanale",$pag);
$mess .= " \"<b>".$dati_ca[$num_costo]['nome']."</b>\"";
if ($associasett_ca == "s") {
if (!@is_array($moltiplica)) $valnummoltiplica_ca = 1;
else {
$valnummoltiplica_ca = $moltiplica[1];
for ($num2 = 2 ; $num2 < (count($moltiplica) - 1) ; $num2++) if ($moltiplica[$num2] != $valnummoltiplica_ca) $valnummoltiplica_ca = 1;
} # fine else if (!@is_array($moltiplica))
} # fine if ($associasett_ca == "s")
else $valnummoltiplica_ca = $moltiplica;
if ($dati_ca[$num_costo]['tipo'] == "s") {
if ($associasett_ca == "n") $numsettimane = $settimane_costo;
else {
if ($settimane_costo) $numsettimane = count(explode(",",$settimane_costo)) - 2;
else $numsettimane = "0";
} # fine else if ($associasett_ca == "n")
} # fine if ($dati_ca[$num_costo]['tipo'] == "s")
else $numsettimane = "";
if ($valnummoltiplica_ca != 1 or strcmp($numsettimane,"")) $mess .= " (";
if (strcmp($numsettimane,"")) $mess .= "$numsettimane ".mex("$parola_settimane",$pag);
if ($valnummoltiplica_ca != 1 and strcmp($numsettimane,"")) $mess .= " ";
if ($valnummoltiplica_ca != 1) $mess .= mex("moltiplicato per",$pag)." $valnummoltiplica_ca";
if ($valnummoltiplica_ca != 1 or strcmp($numsettimane,"")) $mess .= ")";
$mess .= " ".mex("verr aggiunto",$pag)."$per_la_prenotazione: <b>$val_costoagg_p</b> $Euro.<br>";

if (!$silenzio) echo $mess;
else return $mess;

} # fine function comunica_aggiunta_costo



function calcola_ripetizioni_costo ($dati_ca,$num_costo,$idinizioperiodo,$idfineperiodo,$settimane_costo,$moltiplica) {

$num_ripetizioni_costo = 0;
if ($dati_ca[$num_costo]['tipo'] == "u") $num_ripetizioni_costo = 1;
if ($dati_ca[$num_costo]['tipo'] == "s") {
if ($dati_ca[$num_costo]['associasett'] == "s") {
$num_sett = 1;
for ($num1 = $idinizioperiodo ; $num1 <= $idfineperiodo ; $num1++) {
if (str_replace(",".$num1.",","",$settimane_costo) != $settimane_costo) {
$num_ripetizioni_costo = $num_ripetizioni_costo + $moltiplica[$num_sett];
$num_sett++;
} # fine if (str_replace(",".$num1.",","",$settimane_costo) != $settimane_costo)
} # fine for $num1
$prezzo_costo = $prezzo_costo_tot;
} # fine if ($dati_ca[$num_costo]['associasett'] == "s")
else $num_ripetizioni_costo = $settimane_costo;
} # fine if ($dati_ca[$num_costo][tipo] == "s")
if ($dati_ca[$num_costo]['associasett'] != "s") $num_ripetizioni_costo = $num_ripetizioni_costo * $moltiplica;

return $num_ripetizioni_costo;

} # fine function calcola_ripetizioni_costo



function controlla_beni_inventario_costo ($tablerelinventario,$dati_ca,$num_costo,&$beniinv_presenti,&$num_ripetizioni_costo,$sottrai,$idinizioperiodo,$idfineperiodo,$settimane_costo,$moltiplica,$idapp,$beniinv_ripeti="") {

$beni_presenti = "SI";
if ($dati_ca[$num_costo]['tipo_beniinv']) {
if (!strcmp($num_ripetizioni_costo,"")) $num_ripetizioni_costo = calcola_ripetizioni_costo($dati_ca,$num_costo,$idinizioperiodo,$idfineperiodo,$settimane_costo,$moltiplica);
if (!strcmp($beniinv_ripeti,"")) $beniinv_ripeti = $dati_ca[$num_costo]['beniinv_ripeti'];
if ($beniinv_ripeti) $num_ripetizioni_costo_diff = $num_ripetizioni_costo - $beniinv_ripeti;
else $num_ripetizioni_costo_diff = $num_ripetizioni_costo;
if ($num_ripetizioni_costo_diff) {
$tipo_beniinv = $dati_ca[$num_costo]['tipo_beniinv'];
if ($tipo_beniinv == "mag") {
$tipo_beniinv .= $dati_ca[$num_costo]['mag_beniinv'];
$cond_mag = "idmagazzino = '".$dati_ca[$num_costo]['mag_beniinv']."'";
} # fine if ($tipo_beniinv == "mag")
if ($tipo_beniinv == "app") {
$tipo_beniinv .= $idapp;
$cond_mag = "idappartamento = '$idapp'";
} # fine if ($tipo_beniinv == "app")
for ($num1 = 0 ; $num1 < $dati_ca[$num_costo]['num_beniinv'] ; $num1++) {
$id_beneinv = $dati_ca[$num_costo]['id_beneinv'][$num1];
if (!strcmp($beniinv_presenti[$tipo_beniinv][$id_beneinv],"")) {
$beniinv_presenti[$tipo_beniinv][$id_beneinv] = 0;
$bip = esegui_query("select quantita from $tablerelinventario where idbeneinventario = '$id_beneinv' and $cond_mag ");
if (numlin_query($bip)) $beniinv_presenti[$tipo_beniinv][$id_beneinv] = risul_query($bip,0,'quantita');
else $beni_presenti = "NO";
} # fine if (!strcmp($beniinv_presenti[$tipo_beniinv][$id_beneinv],""))
$num_beni_tot = $num_ripetizioni_costo_diff * $dati_ca[$num_costo]['molt_beneinv'][$num1];
if (($beniinv_presenti[$tipo_beniinv][$id_beneinv] - $num_beni_tot) < 0) {
$beni_presenti = "NO";
break;
} # fine if (($beniinv_presenti[$tipo_beniinv][$id_beneinv] - $num_beni_tot) < 0)
elseif ($sottrai == "SI") $beniinv_presenti[$tipo_beniinv][$id_beneinv] = $beniinv_presenti[$tipo_beniinv][$id_beneinv] - $num_beni_tot;
} # fine for $num1
} # fine if ($num_ripetizioni_costo_diff)
} # fine if ($dati_ca[$num_costo]['tipo_beniinv'])

return $beni_presenti;

} # fine function controlla_beni_inventario_costo



function aggiorna_beniinv_presenti ($tablerelinventario,$beniinv_presenti) {

if ($beniinv_presenti) {
while (list($tipo_beniinv,$val) = each($beniinv_presenti)) {
$idmag = substr($tipo_beniinv,3);
$tipo_beneinv = substr($tipo_beniinv,0,3);
if ($tipo_beneinv == "mag") $cond_mag = "idmagazzino = '$idmag'";
else $cond_mag = "idappartamento = '".aggslashdb($idmag)."'";
$id_beniinv = $val;
while (list($id_beneinv,$n_num_bene) = each($id_beniinv)) {
esegui_query("update $tablerelinventario set quantita = '$n_num_bene' where idbeneinventario = '$id_beneinv' and $cond_mag ");
} # fine while (list($id_beneinv,$n_num_bene) = each($id_beniinv))
} # fine while (list($tipo_beniinv,$val) = each($beniinv_presenti))
} # fine if ($beniinv_presenti)

} # fine function aggiorna_beniinv_presenti






###########################################
###  FINE ./includes/funzioni_costi_agg.php 
###########################################

###########################################
###  INIZIO ./includes/funzioni_quadro_disp.php 
###########################################

##################################################################################
#    HOTELDRUID
#    Copyright (C) 2001-2012 by Marco Maria Francesco De Santis (marco@digitaldruid.net)
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    any later version accepted by Marco Maria Francesco De Santis, which
#    shall act as a proxy as defined in Section 14 of version 3 of the
#    license.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
##################################################################################


function crea_quadro_disp ($id_data_inizio_tab_disp,$num_colonne_tab_disp,$mostra_quadro_disp,$mostra_num_liberi,$app_consentito,$app_consentito_sett,$app_regola2_orig,$tipo_periodi,$numero_tariffe,$nome_tariffa,$dati_app,$prenota_in_app_sett,$app_orig_prenota_id,$tableperiodi,$allinea_disp="") {
global $c_sfondo_tab_disp,$c_inisett_tab_disp,$c_libero_tab_disp,$c_occupato_tab_disp,$aper_font_tab_disp,$chiu_font_tab_disp,$fr_persone,$fr_persona,$nome_mese,$colonna_destra_tab_disp,$tablepersonalizza,$id_utente,$anno;

if ($tipo_periodi == "s") $colspan = 14;
else $colspan = 2;
$num_raggr = 0;
unset($nome_raggr);
unset($app_ric_raggr);
unset($num_app_ric_raggr);

if ($mostra_quadro_disp == "app") {
$mostra_num_liberi = "NO";
ksort ($dati_app['maxocc']);
reset ($dati_app['maxocc']);
while (list($key, $val) = each($dati_app['maxocc'])) {
if ($app_consentito[$key] == "SI") {
$app_ric_raggr[$num_raggr] = $key;
$nome_raggr[$num_raggr] = $key;
$num_raggr++;
} # fine if ($app_consentito[$numapp] == "SI")
} # fine while (list($key, $val) = each($dati_app['maxocc']))
} # fine if ($mostra_quadro_disp == "app")

if ($mostra_quadro_disp == "reg2") {
for ($numtariffa = 1 ; $numtariffa <= $numero_tariffe ; $numtariffa++) {
if ($app_regola2_orig[$numtariffa]) {
$app_regola2 = explode(",",$app_regola2_orig[$numtariffa]);
for ($num1 = 0 ; $num1 < count($app_regola2) ; $num1++) if ($app_consentito[$app_regola2[$num1]] == "SI") $app_ric_raggr[$num_raggr] .= "$app_regola2[$num1],";
if ($app_ric_raggr[$num_raggr]) {
$app_ric_raggr[$num_raggr] = substr($app_ric_raggr[$num_raggr],0,-1);
$nome_raggr[$num_raggr] = str_replace(" ","&nbsp;",$nome_tariffa[$numtariffa]);
$num_raggr++;
} # fine if ($app_ric_raggr[$num_raggr])
} # fine if ($app_regola2_orig[$numtariffa])
} # fine for $numtariffa
} # fine if ($mostra_quadro_disp == "reg2")

if ($mostra_quadro_disp == "pers") {
asort ($dati_app['maxocc']);
reset ($dati_app['maxocc']);
$ultime_persone_casa = "vuoto";
while (list($key, $val) = each($dati_app['maxocc'])) {
$persone_casa = $val;
if ($persone_casa != $ultime_persone_casa) {
if ($app_ric_raggr[$num_raggr]) {
$app_ric_raggr[$num_raggr] = substr($app_ric_raggr[$num_raggr],0,-1);
if ($ultime_persone_casa) {
if ($ultime_persone_casa == 1) $nome_raggr[$num_raggr] = $ultime_persone_casa."&nbsp;".$fr_persona;
else $nome_raggr[$num_raggr] = $ultime_persone_casa."&nbsp;".$fr_persone;
} # fine if ($ultime_persone_casa)
else $nome_raggr[$num_raggr] = "?&nbsp;$fr_persone";
$num_raggr++;
} # fine if ($app_ric_raggr[$num_raggr])
$ultime_persone_casa = $persone_casa;
} # fine if ($persone_casa != $ultimepersone_casa)
if ($app_consentito[$key] == "SI") $app_ric_raggr[$num_raggr] .= "$key,";
} # fine while (list($key, $val) = each($dati_app[maxocc]))
if ($app_ric_raggr[$num_raggr]) {
$app_ric_raggr[$num_raggr] = substr($app_ric_raggr[$num_raggr],0,-1);
if ($ultime_persone_casa) {
if ($ultime_persone_casa == 1) $nome_raggr[$num_raggr] = $ultime_persone_casa."&nbsp;".$fr_persona;
else $nome_raggr[$num_raggr] = $ultime_persone_casa."&nbsp;".$fr_persone;
} # fine if ($ultime_persone_casa)
else $nome_raggr[$num_raggr] = "?&nbsp;$fr_persone";
$num_raggr++;
} # fine if ($app_ric_raggr[$num_raggr])
} # fine if ($mostra_quadro_disp == "pers")

$righe_tab_disp = "";
for ($num1 = 0 ; $num1 < $num_raggr ; $num1++) {
if ($app_ric_raggr[$num1]) {
$righe_tab_disp .= "<tr><td style=\"text-align: right;\">$aper_font_tab_disp".$nome_raggr[$num1]."$chiu_font_tab_disp</td>";
$max_app_liberi = explode(",",$app_ric_raggr[$num1]);
$max_app_liberi = count($max_app_liberi);
$app_ric_colonna = ",".$app_ric_raggr[$num1].",";
for ($num2 = 0 ; $num2 < $num_colonne_tab_disp ; $num2++) {
$id_periodo = $id_data_inizio_tab_disp + $num2;
$num_app_liberi = $max_app_liberi;
if ($app_consentito_sett[",attivo,"] == "SI") {
if ($num2 == 0) {
$app_ric_col_vett = explode(",",$app_ric_raggr[$num1]);
$num_app_ric_col = count($app_ric_col_vett);
} # fine if ($num2 == 0)
$app_ric_colonna = ",".$app_ric_raggr[$num1].",";
for ($num3 = 0 ; $num3 < $num_app_ric_col ; $num3++) {
if ($app_consentito_sett[$app_ric_col_vett[$num3]][$id_periodo] != "SI") {
$app_ric_colonna = str_replace(",".$app_ric_col_vett[$num3].",",",",$app_ric_colonna);
$num_app_liberi--;
} # fine if ($app_consentito_sett[$app_ric_col_vett[$num3]][$id_periodo] != "SI")
} # fine for $num3
} # fine if ($app_consentito_sett[",attivo,"] == "SI")
$pren_pres_in_lista = "";
$lista_prenota_periodo = "";
$num_lista_pren_per = 0;
lista_prenota_periodo($id_periodo,$id_periodo,$dati_app,$prenota_in_app_sett,$pren_pres_in_lista,$lista_prenota_periodo,$num_lista_pren_per);
for ($num3 = 0 ; $num3 < $num_lista_pren_per ; $num3++) {
if (str_replace(",".$app_orig_prenota_id[$lista_prenota_periodo[$num3]].",","",$app_ric_colonna) != $app_ric_colonna) $num_app_liberi--;
} # fine for $num3
if ($num_app_liberi > 0) $color = $c_libero_tab_disp;
else $color = $c_occupato_tab_disp;
if ($num_app_liberi > 0 and $mostra_num_liberi == "SI") $val_liberi = $num_app_liberi;
else $val_liberi = "&nbsp;";
if ($num2 == 0 and $allinea_disp == "SI") $colspan_v = $colspan / 2;
else $colspan_v = $colspan;
$righe_tab_disp .= "<td style=\"background-color: $color;\" colspan=\"$colspan_v\">$aper_font_tab_disp$val_liberi$chiu_font_tab_disp</td>";
} # fine for $num2

if ($colonna_destra_tab_disp != "NO") $righe_tab_disp .= "<td>$aper_font_tab_disp".$nome_raggr[$num1]."$chiu_font_tab_disp</td></tr>";
else $righe_tab_disp .= "</tr>";
} # fine if ($app_ric_raggr[$num1])
} # fine for $num1

if ($righe_tab_disp) {

if ($tipo_periodi == "s") $ripeti_giorni = 7;
else {
$ripeti_giorni = 1;
if (!$id_utente) $id_utente_gio = 1;
else $id_utente_gio = $id_utente;
$giorno_vedi_ini_sett = esegui_query("select valpersonalizza_num from $tablepersonalizza where idpersonalizza = 'giorno_vedi_ini_sett$anno' and idutente = '$id_utente_gio'");
if (numlin_query($giorno_vedi_ini_sett) == 1) $giorno_vedi_ini_sett = risul_query($giorno_vedi_ini_sett,0,'valpersonalizza_num');
else $giorno_vedi_ini_sett = 0;
} # fine else if ($tipo_periodi == "s")
$ultimo_mese = "";
$num_col_mese = 0;
$riga_mese = "<tr><td rowspan=\"2\">$aper_font_tab_disp&nbsp;$chiu_font_tab_disp</td>";
$riga_giorni = "<tr>";
for ($num1 = 0 ; $num1 < ($num_colonne_tab_disp + 1) ; $num1++) {
if ($allinea_disp != "SI" or $num1 != $num_colonne_tab_disp) {
if ($num1 != $num_colonne_tab_disp) $id_periodo = $id_data_inizio_tab_disp + $num1;
else $id_periodo = $id_data_inizio_tab_disp + $num1 - 1;
$riga_periodo = esegui_query("select * from $tableperiodi where idperiodi = '$id_periodo'");
if ($num1 != $num_colonne_tab_disp) $inizio_periodo = risul_query($riga_periodo,0,'datainizio');
else $inizio_periodo = risul_query($riga_periodo,0,'datafine');
$inizio_periodo = explode("-",$inizio_periodo);
$g_inizio_periodo = $inizio_periodo[2];
$m_inizio_periodo = $inizio_periodo[1];
$a_inizio_periodo = $inizio_periodo[0];
if ($num1 == $num_colonne_tab_disp) $ripeti_giorni = 1;
for ($num2 = 0 ; $num2 < $ripeti_giorni ; $num2++) {
$timestamp_periodo = mktime(0,0,0,$m_inizio_periodo,($g_inizio_periodo + $num2),$a_inizio_periodo);
$g_mostra = date("d",$timestamp_periodo);
$m_mostra = date("m",$timestamp_periodo);
if ($ultimo_mese != $m_mostra) {
if ($ultimo_mese) {
$a_mostra = date("Y",mktime(0,0,0,$m_inizio_periodo,($g_inizio_periodo + $num2 -1),$a_inizio_periodo));
$riga_mese .= "<td colspan=\"$num_col_mese\">$aper_font_tab_disp";
if ($num_col_mese > 7) $riga_mese .= $nome_mese["$ultimo_mese"]."&nbsp;$a_mostra";
else $riga_mese .= "&nbsp;";
$riga_mese .= "$chiu_font_tab_disp</td>";
$num_col_mese = 0;
} # fine if ($ultimo_mese)
$ultimo_mese = $m_mostra;
} # fine if ($ultimo_mese != $m_mostra)
if (($num1 != 0 or $num2 != 0) and $num1 != $num_colonne_tab_disp) $num_col_mese = $num_col_mese + 2;
else $num_col_mese++;
$bgcolor = "";
if ($tipo_periodi != "s") {
$giorno_sett_corr = date("w",$timestamp_periodo);
if ($giorno_sett_corr == $giorno_vedi_ini_sett) $bgcolor = "$c_inisett_tab_disp";
} # fine ($tipo_periodi != "s")
else if ($num2 == 0) $bgcolor = "$c_inisett_tab_disp";
$riga_giorni .= "<td";
if ($bgcolor) $riga_giorni .= " style=\"background-color: $bgcolor;\"";
if (($num1 != 0 or $num2 != 0) and $num1 != $num_colonne_tab_disp) $riga_giorni .= " colspan=2";
$riga_giorni .= ">$aper_font_tab_disp$g_mostra$chiu_font_tab_disp</td>";
} # fine for $num2
} # fine if ($allinea_disp != "SI" or $num1 != $num_colonne_tab_disp)
} # fine for $num1
$a_mostra = date("Y",mktime(0,0,0,$m_inizio_periodo,($g_inizio_periodo + $num2 -1),$a_inizio_periodo));
$riga_mese .= "<td colspan=\"$num_col_mese\">$aper_font_tab_disp";
if ($num_col_mese > 6) $riga_mese .= $nome_mese["$ultimo_mese"]."&nbsp;$a_mostra";
else $riga_mese .= "&nbsp;";
if ($colonna_destra_tab_disp != "NO") $riga_mese .= "$chiu_font_tab_disp</td><td rowspan=\"2\">$aper_font_tab_disp&nbsp;$chiu_font_tab_disp</td></tr>";
else $riga_mese .= "$chiu_font_tab_disp</td></tr>";
$riga_giorni .= "</tr>";

$righe_tab_disp = "$riga_mese
$riga_giorni
$righe_tab_disp";

} # fine if ($righe_tab_disp)

return $righe_tab_disp;

} # fine function crea_quadro_disp






###########################################
###  FINE ./includes/funzioni_quadro_disp.php 
###########################################

###########################################
###  INIZIO ./includes/funzioni_clienti.php 
###########################################

##################################################################################
#    HOTELDRUID
#    Copyright (C) 2001-2012 by Marco Maria Francesco De Santis (marco@digitaldruid.net)
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    any later version accepted by Marco Maria Francesco De Santis, which
#    shall act as a proxy as defined in Section 14 of version 3 of the
#    license.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
##################################################################################




function inserisci_dati_cliente (&$cognome,&$nome,$soprannome,$titolo_cli,$sesso,$mesenascita,$giornonascita,$annonascita,&$nazionenascita,&$cittanascita,&$regionenascita,$documento,$tipodoc,$mesescaddoc,$giornoscaddoc,$annoscaddoc,&$cittadoc,&$regionedoc,&$nazionedoc,&$nazionalita,&$lingua_cli,&$nazione,&$citta,&$regione,&$via,$nomevia,$numcivico,$cap,$telefono,$telefono2,$telefono3,$fax,$email,$cod_fiscale,$partita_iva,$max_num_ordine,$id_utente_ins,$attiva_prefisso_clienti,$prefisso_clienti,$idclienti="",$valida="") {
global $lingua_mex,$HOSTNAME,$id_utente,$PHPR_TAB_PRE;
$tableclienti = $PHPR_TAB_PRE."clienti";
$tablepersonalizza = $PHPR_TAB_PRE."personalizza";

if ($valida != "NO") {
if (@get_magic_quotes_gpc()) {
$cognome = stripslashes($cognome);
$nome = stripslashes($nome);
$soprannome = stripslashes($soprannome);
$titolo_cli = stripslashes($titolo_cli);
$documento = stripslashes($documento);
$tipodoc = stripslashes($tipodoc);
$cittadoc = stripslashes($cittadoc);
$regionedoc = stripslashes($regionedoc);
$nazionedoc = stripslashes($nazionedoc);
$cittanascita = stripslashes($cittanascita);
$regionenascita = stripslashes($regionenascita);
$nazionenascita = stripslashes($nazionenascita);
$nazionalita = stripslashes($nazionalita);
$nazione = stripslashes($nazione);
$regione = stripslashes($regione);
$citta = stripslashes($citta);
$nomevia = stripslashes($nomevia);
$numcivico = stripslashes($numcivico);
$cap = stripslashes($cap);
$telefono = stripslashes($telefono);
$telefono2 = stripslashes($telefono2);
$telefono3 = stripslashes($telefono3);
$fax = stripslashes($fax);
$email = stripslashes($email);
$cod_fiscale = stripslashes($cod_fiscale);
$partita_iva = stripslashes($partita_iva);
} # fine if (@get_magic_quotes_gpc())
$cognome = htmlspecialchars($cognome);
$nome = htmlspecialchars($nome);
$soprannome = htmlspecialchars($soprannome);
$titolo_cli = htmlspecialchars($titolo_cli);
$documento = htmlspecialchars($documento);
$tipodoc = htmlspecialchars($tipodoc);
$cittadoc = htmlspecialchars($cittadoc);
$regionedoc = htmlspecialchars($regionedoc);
$nazionedoc = htmlspecialchars($nazionedoc);
$cittanascita = htmlspecialchars($cittanascita);
$regionenascita = htmlspecialchars($regionenascita);
$nazionenascita = htmlspecialchars($nazionenascita);
$nazionalita = htmlspecialchars($nazionalita);
$nazione = htmlspecialchars($nazione);
$regione = htmlspecialchars($regione);
$citta = htmlspecialchars($citta);
$nomevia = htmlspecialchars($nomevia);
$numcivico = htmlspecialchars($numcivico);
$cap = htmlspecialchars($cap);
$telefono = htmlspecialchars($telefono);
$telefono2 = htmlspecialchars($telefono2);
$telefono3 = htmlspecialchars($telefono3);
$fax = htmlspecialchars($fax);
$email = htmlspecialchars($email);
$cod_fiscale = htmlspecialchars($cod_fiscale);
$partita_iva = htmlspecialchars($partita_iva);
} # fine if ($valida != "NO")

if (!$idclienti) {
$datainserimento = date("Y-m-d H:i:s",(time() + (C_DIFF_ORE * 3600)));
$idclienti = esegui_query("select idclienti from $tableclienti where idclienti = '1'");
if (numlin_query($idclienti) == 0) $idclienti = 1;
else {
$idclienti = esegui_query("select max(idclienti) from $tableclienti");
$idclienti = risul_query($idclienti,0,0) + 1;
} # fine else if (numlin_query($idclienti) == 0)
$cognome_maius = ucwords($cognome);
if ($attiva_prefisso_clienti == "p") $cognome_maius = $prefisso_clienti.$cognome_maius;
if ($attiva_prefisso_clienti == "s") $cognome_maius = $cognome_maius.$prefisso_clienti;
$cognome_maius = aggslashdb($cognome_maius);
esegui_query("insert into $tableclienti (idclienti,cognome,idclienti_compagni,datainserimento,hostinserimento,utente_inserimento) values ('$idclienti','$cognome_maius',',','$datainserimento','$HOSTNAME','$id_utente_ins')");
} # fine if (!$idclienti)
elseif ($cognome) {
$cognome_maius = ucwords($cognome);
if ($attiva_prefisso_clienti == "p") $cognome_maius = $prefisso_clienti.$cognome_maius;
if ($attiva_prefisso_clienti == "s") $cognome_maius = $cognome_maius.$prefisso_clienti;
$cognome_maius = aggslashdb($cognome_maius);
esegui_query("update $tableclienti set cognome = '$cognome_maius' where idclienti = '$idclienti' ");
} # fine elseif ($cognome)
if ($nome) {
$nome_maius = ucwords($nome);
$nome_maius = aggslashdb($nome_maius);
esegui_query("update $tableclienti set nome = '$nome_maius' where idclienti = '$idclienti' ");
} # fine if ($nome)
if ($soprannome) {
esegui_query("update $tableclienti set soprannome = '".aggslashdb($soprannome)."' where idclienti = '$idclienti' ");
} # fine if ($soprannome)
if ($titolo_cli) {
$titoli_cliente = esegui_query("select valpersonalizza from $tablepersonalizza where idpersonalizza = 'titoli_cliente' and idutente = '$id_utente'");
if (numlin_query($titoli_cliente) == 1) {
$titoli_cliente = risul_query($titoli_cliente,0,'valpersonalizza');
$titoli_cliente = explode(">",$titoli_cliente);
for ($num1 = 0 ; $num1 < count($titoli_cliente) ; $num1++) {
$tito = explode("<",$titoli_cliente[$num1]);
if ($titolo_cli == $tito[0]) {
esegui_query("update $tableclienti set titolo = '".aggslashdb($titolo_cli)."' where idclienti = '$idclienti' ");
if ($tito[1] and !$sesso) $sesso = $tito[1];
break;
} # fine if ($titolo_cli == $opt[0])
} # fine for $num1
} # fine if (numlin_query($titoli_cliente) == 1)
} # fine if ($titolo_cli)
if ($sesso) {
if ($sesso != "f") $sesso = "m";
esegui_query("update $tableclienti set sesso = '$sesso' where idclienti = '$idclienti' ");
} # fine if ($sesso)
if ($mesenascita and $giornonascita and strlen($annonascita) == 4) {
if ($annonascita > 1970) $datanascita = date("Y-m-d",mktime(0,0,0,$mesenascita,$giornonascita,$annonascita));
else $datanascita = $annonascita."-".$mesenascita."-".$giornonascita;
$datanascita = aggslashdb($datanascita);
esegui_query("update $tableclienti set datanascita = '$datanascita' where idclienti = '$idclienti' ");
} # fine if ($mesenascita and ...
if ($nazionenascita) {
$nazionenascita_maius = ucwords($nazionenascita);
$nazionenascita_maius = aggslashdb($nazionenascita_maius);
esegui_query("update $tableclienti set nazionenascita = '$nazionenascita_maius' where idclienti = '$idclienti' ");
} # fine if ($nazionenascita)
if ($cittanascita) {
$cittanascita_maius = ucwords($cittanascita);
$cittanascita_maius = aggslashdb($cittanascita_maius);
esegui_query("update $tableclienti set cittanascita = '$cittanascita_maius' where idclienti = '$idclienti' ");
} # fine if ($cittanascita)
if ($regionenascita) {
$regionenascita_maius = ucwords($regionenascita);
$regionenascita_maius = aggslashdb($regionenascita_maius);
esegui_query("update $tableclienti set regionenascita = '$regionenascita_maius' where idclienti = '$idclienti' ");
} # fine if ($regionenascita)
if ($documento) {
if ($tipodoc) esegui_query("update $tableclienti set tipodoc = '".aggslashdb($tipodoc)."' where idclienti = '$idclienti' ");
$documento = aggslashdb($documento);
esegui_query("update $tableclienti set documento = '$documento' where idclienti = '$idclienti' ");
} # fine if ($documento)
if ($mesescaddoc and $giornoscaddoc and $annoscaddoc) {
$datascaddoc = date("Y-m-d",mktime(0,0,0,$mesescaddoc,$giornoscaddoc,$annoscaddoc));
$datascaddoc = aggslashdb($datascaddoc);
esegui_query("update $tableclienti set scadenzadoc = '$datascaddoc' where idclienti = '$idclienti' ");
} # fine if ($mesescaddoc and ...
if ($nazionedoc) {
$nazionedoc_maius = ucwords($nazionedoc);
$nazionedoc_maius = aggslashdb($nazionedoc_maius);
esegui_query("update $tableclienti set nazionedoc = '$nazionedoc_maius' where idclienti = '$idclienti' ");
} # fine if ($nazionedoc)
if ($cittadoc) {
$cittadoc_maius = ucwords($cittadoc);
$cittadoc_maius = aggslashdb($cittadoc_maius);
esegui_query("update $tableclienti set cittadoc = '$cittadoc_maius' where idclienti = '$idclienti' ");
} # fine if ($cittadoc)
if ($regionedoc) {
$regionedoc_maius = ucwords($regionedoc);
$regionedoc_maius = aggslashdb($regionedoc_maius);
esegui_query("update $tableclienti set regionedoc = '$regionedoc_maius' where idclienti = '$idclienti' ");
} # fine if ($regionedoc)
if ($nazionalita) {
$nazionalita_maius = ucwords($nazionalita);
$nazionalita_maius = aggslashdb($nazionalita_maius);
esegui_query("update $tableclienti set nazionalita = '$nazionalita_maius' where idclienti = '$idclienti' ");
} # fine if ($nazionalita)
if ($lingua_cli) {
if (preg_replace("/[a-z]{2,3}/","",$lingua_cli) == "") {
if ($lingua_cli == $lingua_mex or $lingua_cli == "ita" or @is_dir("./includes/lang/$lingua_cli")) {
esegui_query("update $tableclienti set lingua = '".aggslashdb($lingua_cli)."' where idclienti = '$idclienti' ");
} # fine if ($lingua == $lingua_mex or $lingua_cli == "ita" or...
else $lingua_cli = "";
} # fine if (preg_replace("/[a-z]{2,3}/","",$lingua_cli) == "")
else $lingua_cli = "";
} # fine if ($lingua_cli)
if ($nazione) {
$nazione_maius = ucwords($nazione);
$nazione_maius = aggslashdb($nazione_maius);
esegui_query("update $tableclienti set nazione = '$nazione_maius' where idclienti = '$idclienti' ");
} # fine if ($nazione)
if ($citta) {
$citta_maius = ucwords($citta);
$citta_maius = aggslashdb($citta_maius);
esegui_query("update $tableclienti set citta = '$citta_maius' where idclienti = '$idclienti' ");
} # fine if ($citta)
if ($regione) {
$regione_maius = ucwords($regione);
$regione_maius = aggslashdb($regione_maius);
esegui_query("update $tableclienti set regione = '$regione_maius' where idclienti = '$idclienti' ");
} # fine if ($regione)
if ($nomevia) {
if ($lingua_mex != "ita") include("./includes/lang/$lingua_mex/ordine_frasi.php");
if ($ordine_strada == 2) $via = $nomevia . " " . $via;
else $via = $via . " " . $nomevia;
$via_maius = ucwords($via);
$via_maius = aggslashdb($via_maius);
esegui_query("update $tableclienti set via = '$via_maius' where idclienti = '$idclienti' ");
} # fine if ($nomevia)
$numcivico = aggslashdb($numcivico);
if ($numcivico) esegui_query("update $tableclienti set numcivico = '$numcivico' where idclienti = '$idclienti' ");
$cap = aggslashdb($cap);
if ($cap) esegui_query("update $tableclienti set cap = '$cap' where idclienti = '$idclienti' ");
$telefono = aggslashdb($telefono);
if ($telefono) esegui_query("update $tableclienti set telefono = '$telefono' where idclienti = '$idclienti' ");
$telefono2 = aggslashdb($telefono2);
if ($telefono2) esegui_query("update $tableclienti set telefono2 = '$telefono2' where idclienti = '$idclienti' ");
$telefono3 = aggslashdb($telefono3);
if ($telefono3) esegui_query("update $tableclienti set telefono3 = '$telefono3' where idclienti = '$idclienti' ");
$fax = aggslashdb($fax);
if ($fax) esegui_query("update $tableclienti set fax = '$fax' where idclienti = '$idclienti' ");
$email = aggslashdb($email);
if ($email) esegui_query("update $tableclienti set email = '$email' where idclienti = '$idclienti' ");
$cod_fiscale = aggslashdb($cod_fiscale);
if ($cod_fiscale) esegui_query("update $tableclienti set cod_fiscale = '$cod_fiscale' where idclienti = '$idclienti' ");
$partita_iva = aggslashdb($partita_iva);
if ($partita_iva) esegui_query("update $tableclienti set partita_iva = '$partita_iva' where idclienti = '$idclienti' ");
if ($max_num_ordine) esegui_query("update $tableclienti set max_num_ordine = '".aggslashdb($max_num_ordine)."' where idclienti = '$idclienti' ");
return $idclienti;
} # fine function inserisci_dati_cliente





function mostra_dati_cliente ($dati_cliente,&$dcognome,&$dnome,&$dsoprannome,&$dtitolo_cli,&$dsesso,&$ddatanascita,&$ddatanascita_f,&$dnazionenascita,&$dcittanascita,&$dregionenascita,&$ddocumento,&$dscadenzadoc,&$dscadenzadoc_f,&$dtipodoc,&$dnazionedoc,&$dregionedoc,&$dcittadoc,&$dnazionalita,&$dlingua_cli,&$dnazione,&$dregione,&$dcitta,&$dvia,&$dnumcivico,&$dtelefono,&$dtelefono2,&$dtelefono3,&$dfax,&$dcap,&$demail,&$dcod_fiscale,&$dpartita_iva,$mostra_num="",$priv_ins_clienti="",$silenzio="") {
global $pag,$id_utente,$PHPR_TAB_PRE;

if ($id_utente == 1 or !$id_utente) {
$priv_vedi_telefoni = "s";
$priv_vedi_indirizzo = "s";
} # fine if ($id_utente == 1 or !$id_utente)
else {
if (!$priv_ins_clienti) {
$privilegi_globali_utente = esegui_query("select * from $PHPR_TAB_PRE"."privilegi where idutente = '$id_utente' and anno = '1'");
$priv_ins_clienti = risul_query($privilegi_globali_utente,0,'priv_ins_clienti');
} # fine if (!$priv_ins_clienti)
$priv_vedi_telefoni = substr($priv_ins_clienti,3,1);
$priv_vedi_indirizzo = substr($priv_ins_clienti,4,1);
} # fine else if ($id_utente == 1 or !$id_utente)

$didclienti = risul_query($dati_cliente,0,'idclienti');
$dcognome = risul_query($dati_cliente,0,'cognome');
$dnome = risul_query($dati_cliente,0,'nome');
$dsoprannome = risul_query($dati_cliente,0,'soprannome');
$dtitolo_cli = risul_query($dati_cliente,0,'titolo');
$dsesso = risul_query($dati_cliente,0,'sesso');
$ddatanascita = risul_query($dati_cliente,0,'datanascita');
$ddatanascita_f = formatta_data($ddatanascita,$stile_data);
$ddocumento = risul_query($dati_cliente,0,'documento');
$dtipodoc = risul_query($dati_cliente,0,'tipodoc');
$dscadenzadoc = risul_query($dati_cliente,0,'scadenzadoc');
$dscadenzadoc_f = formatta_data($dscadenzadoc,$stile_data);
$dcittadoc = risul_query($dati_cliente,0,'cittadoc');
$dregionedoc = risul_query($dati_cliente,0,'regionedoc');
$dnazionedoc = risul_query($dati_cliente,0,'nazionedoc');
$dcittanascita = risul_query($dati_cliente,0,'cittanascita');
$dregionenascita = risul_query($dati_cliente,0,'regionenascita');
$dnazionenascita = risul_query($dati_cliente,0,'nazionenascita');
$dnazionalita = risul_query($dati_cliente,0,'nazionalita');
$dlingua_cli = risul_query($dati_cliente,0,'lingua');
$dnazione = risul_query($dati_cliente,0,'nazione');
$dregione = risul_query($dati_cliente,0,'regione');
$dcitta = risul_query($dati_cliente,0,'citta');
if ($priv_vedi_indirizzo == "s") {
$dvia = risul_query($dati_cliente,0,'via');
$dnumcivico = risul_query($dati_cliente,0,'numcivico');
$dcap = risul_query($dati_cliente,0,'cap');
} # fine if ($priv_vedi_indirizzo == "s")
if ($priv_vedi_telefoni == "s") {
$dtelefono = risul_query($dati_cliente,0,'telefono');
$dtelefono2 = risul_query($dati_cliente,0,'telefono2');
$dtelefono3 = risul_query($dati_cliente,0,'telefono3');
$dfax = risul_query($dati_cliente,0,'fax');
$demail = risul_query($dati_cliente,0,'email');
} # fine if ($priv_vedi_telefoni == "s")
$dcod_fiscale = risul_query($dati_cliente,0,'cod_fiscale');
$dpartita_iva = risul_query($dati_cliente,0,'partita_iva');

if ($dlingua_cli) {
if ($dlingua_cli == "ita") $d_nome_lingua = "Italiano";
elseif (preg_replace("/[a-z]{2,3}/","",$dlingua_cli) == "") {
if (@is_file("./includes/lang/$dlingua_cli/l_n")) {
$d_nome_lingua = file("./includes/lang/$dlingua_cli/l_n");
$d_nome_lingua = ucfirst(togli_acapo($d_nome_lingua[0]));
} # fine if (@is_file("./includes/lang/$dlingua_cli/l_n"))
} # fine elseif (preg_replace("/[a-z]{2,3}/","",$dlingua_cli) == "")
if (!$d_nome_lingua) $dlingua_cli = "";
} # fine if ($dlingua_cli)

$output = "";

$O = "o"; $O2 = "o";
if ($dsesso == "f") $O = "a";
if ($dsesso2 == "f") $O2 = "a";
if ($mostra_num == "SI") {
$output .= "$didclienti. <em>$dcognome</em> ";
if ($dnome) $output .= "<em>$dnome</em> ";
} # fine if ($mostra_num == "SI")
else {
if ($dtitolo_cli) $output .= "$dtitolo_cli ";
$output .= "<b>$dcognome</b>";
if ($dnome) $output .= " $dnome";
if ($dsoprannome) $output .= " ($dsoprannome)";
} # fine else if ($mostra_num == "SI")
if ($ddatanascita or $dcittanascita) $output .= " ".mex("nat$O",$pag);
if ($ddatanascita) $output .= " ".mex("il",$pag)." $ddatanascita_f";
if ($dcittanascita) $output .= mex(" a",$pag)." $dcittanascita";
if ($dregionenascita or $dnazionenascita) {
$output .= " ($dregionenascita";
if ($dregionenascita and $dnazionenascita) $output .= ", ";
$output .= "$dnazionenascita)";
} # fine if ($dregionenascita or $dnazionenascita)

$lin = "";
if ($dnazionalita) $lin .= "$dnazionalita";
if ($dnazionalita and $d_nome_lingua) $lin .= " ";
if ($d_nome_lingua) $lin .= "(".mex("ln.",$pag)." <em>$d_nome_lingua</em>)";
if ($lin and $ddocumento) {
if (!$dnazionedoc or $dnazionedoc == $dnazionalita) $lin .= " - ";
else {
$output .= "<br>$lin";
$lin = "";
} # fine else if (!$dnazionedoc or...
} # fine if ($lin and $ddocumento)
if ($ddocumento) {
if ($dtipodoc) $lin .= "$dtipodoc ";
$lin .= "$ddocumento";
if ($dscadenzadoc) {
if ($dcittadoc or ($dnazionedoc and $dnazionedoc != $dnazionalita)) {
$lin .= " ($dcittadoc";
if ($dcittadoc and $dnazionedoc and $dnazionedoc != $dnazionalita) $lin .= ", ";
if ($dnazionedoc and $dnazionedoc != $dnazionalita) $lin .= "$dnazionedoc";
$lin .= ")";
} # fine if ($dcittadoc or...
if (date("Ymd",(time() + (C_DIFF_ORE * 3600))) <= str_replace("-","",$dscadenzadoc)) $lin .= " ".mex("scade",$pag)." $dscadenzadoc_f";
else $lin .= " ".mex("scade",$pag)." <font color=\"red\">$dscadenzadoc_f</font>";
} # fine if ($dscadenzadoc)
} # fine if ($ddocumento)
if ($lin) $output .= "<br>$lin";

$lin = "";
if ($dcitta) {
$lin .= "$dcitta";
if ($dvia or $dnumcivico or $dcap) $lin .= ",";
$lin .= " ";
} # fine if ($dcitta)
if ($dvia) $lin .= "$dvia ";
if ($dnumcivico) $lin .= "n $dnumcivico ";
if ($dcap) $lin .= mex("CAP",$pag)." $dcap ";
if ($dnazione or $dregione) $lin .= "(";
if ($dregione) $lin .= $dregione;
if ($dnazione and $dregione) $lin .= ", ";
if ($dnazione) $lin .= $dnazione;
if ($dnazione or $dregione) $lin .= ") ";
if ($lin) $output .= "<br>$lin";

$lin = "";
if ($dtelefono) $lin .= mex("Telefono",$pag).": $dtelefono ";
if ($dtelefono2) $lin .= mex("2 telefono",$pag).": $dtelefono2 ";
if ($dtelefono3) $lin .= mex("3 telefono",$pag).": $dtelefono3, ";
if ($dfax) $lin .= "fax: $dfax, ";
if ($demail) $lin .= "email: <a href=\"mailto:$demail\">$demail</a> ";
if ($lin) $output .= "<br>$lin";

$lin = "";
if ($dcod_fiscale) $lin .= mex("Codice fiscale",$pag).": $dcod_fiscale ";
if ($dcod_fiscale and $dpartita_iva) $lin .= ", ";
if ($dpartita_iva) $lin .= mex("Partita iva",$pag).": $dpartita_iva ";
if ($lin) $output .= "<br>$lin";

if (!$silenzio) echo $output;
else return $output;

} # fine function mostra_dati_cliente



function mostra_funzjs_cpval () {
echo "
<script type=\"text/javascript\">
<!--

function cp_val (id,idcp,def) {
var elem = document.getElementById(id);
var elemcp = document.getElementById(idcp);
var valcp = elemcp.value;
if (valcp != '') elem.value = valcp;
else elem.value = def;
if (elem.onchange) elem.onchange();
} // fine function cp_val

-->
</script>
";
} # fine function mostra_funzjs_cpval



function mostra_funzjs_dati_rel ($mostra_cod,$pieno,$id_sessione,$anno,$var_extra = "",$pag_relutenti = "") {
if (!$pag_relutenti) $pag_relutenti = "./dati_relutenti.php";
echo "
<script type=\"text/javascript\">
<!--
var campo_agg = '';
function agg_dati_remoti (ifrm,campo_agg) {
if (campo_agg) {
var docfrm = '';
if (document.getElementById(ifrm).contentDocument) {
docfrm = document.getElementById(ifrm).contentDocument; 
}
else docfrm = document.frames[ifrm].document;
var dati_remoti = docfrm.getElementById(ifrm);
var inner_elem = document.getElementById(campo_agg.substr(2));
var funz_oc = inner_elem.onchange;
var val_oc = inner_elem.value;
document.getElementById(campo_agg).innerHTML = dati_remoti.innerHTML;
inner_elem = document.getElementById(campo_agg.substr(2));
if (funz_oc) {
inner_elem.onchange = funz_oc;
inner_elem.onchange();
}
if (val_oc) {
var val_orig = inner_elem.value;
inner_elem.value = val_oc;
if (inner_elem.value != val_oc) inner_elem.value = val_orig;
}
}
}
function ricarica_ifrm (ifrm,campo,sel,rel,rel_sup,id_ut) {
campo_agg = 'b_'+campo;
var sele = document.getElementById(sel);
var sel_ind = sele.selectedIndex;
if (sel_ind) { var val_sel = sele.options[sel_ind].value; }
else { var val_sel = sele.value }
//document.getElementById(ifrm).src = '$pag_relutenti?id_sessione=...
top.frames[ifrm].location.replace('$pag_relutenti?id_sessione=$id_sessione&anno=$anno&id='+val_sel+'&rel='+rel+'&rel_sup='+rel_sup+'&id_ut_sel='+id_ut+'&cmp='+campo+'&mostra_cod=$mostra_cod&pieno=$pieno&d=".date("siHd")."$var_extra');
}
-->
</script>
<iframe name=\"dati_rel\" id=\"dati_rel\" onload=\"agg_dati_remoti('dati_rel',campo_agg);\" style=\"width:0px; height:0px; border: 0px; visibility: hidden;\"></iframe>
";
} # fine function mostra_funzjs_dati_rel



unset($liste_relutente);
function mostra_lista_relutenti ($nome,$sel,$id_utente,$nomelista,$idlista,$idrelutenti,$tablelista,$tablerelutenti,$size="",$javascript="",$campo_opzionale="",$rel_inf_sing="",$id_rel_inf="",$rel_sup_sing="") {
global $liste_relutente;
if (!$liste_relutente[$nomelista]) {
if (!$rel_sup_sing) $lista_utente = esegui_query("select distinct $tablelista.$nomelista from $tablerelutenti inner join $tablelista on $tablerelutenti.$idrelutenti = $tablelista.$idlista where $tablerelutenti.idutente = '$id_utente' order by $tablelista.$nomelista");
else $lista_utente = esegui_query("select distinct $tablelista.$nomelista from $tablerelutenti inner join $tablelista on $tablerelutenti.$idrelutenti = $tablelista.$idlista where $tablerelutenti.idutente = '$id_utente' and $tablerelutenti.idsup is NULL order by $tablelista.$nomelista");
$num_lista_utente = numlin_query($lista_utente);
if (!$num_lista_utente) {
if (!$campo_opzionale) {
if ($size) $size = " size=\"$size\"";
else $size = "";
$liste_relutente[$nomelista] = "<input type=\"text\" name=\"\"$size>";
} # fine if (!$campo_opzionale)
} # fine if (!$num_lista_utente)
else {
$liste_relutente[$nomelista] = "<select name=\"\">\n<option value=\"\">------</option>";
for ($num1 = 0 ; $num1 < $num_lista_utente ; $num1++) {
$opzione = risul_query($lista_utente,$num1,$nomelista,$tablelista);
$liste_relutente[$nomelista] .= "<option value=\"$opzione\">$opzione</option>";
} # fine for $num1
$liste_relutente[$nomelista] .= "</select>";
} # fine else if (!$num_lista_utente)
} # fine if (!$liste_relutente[$nomelista])
$lista_return = $liste_relutente[$nomelista];
if ($sel) {
if (substr($lista_return,0,7) == "<select") $lista_return = str_replace("<option value=\"$sel\">","<option value=\"$sel\" selected>",$lista_return);
else $lista_return = str_replace(" name=\"\""," name=\"\" value=\"$sel\"",$lista_return);
} # fine if ($sel)
if ($rel_inf_sing) {
$inf_esist = esegui_query("select idsup from $tablerelutenti where idutente = '$id_utente' and id$rel_inf_sing is not NULL and idsup is not NULL limit 1 ");
if (!numlin_query($inf_esist)) $rel_inf_sing = "";
} # fine if ($rel_inf_sing)
if ($javascript) {
$lista_return = str_replace("\\","\\\\'",$lista_return);
$lista_return = str_replace("\n","\\\n",$lista_return);
$lista_return = str_replace("'","\'",$lista_return);
$lista_return = str_replace("</","<\/",$lista_return);
if ($rel_inf_sing) $lista_return = str_replace(" name=\"\""," name=\"\" onchange=\"ricarica_ifrm(\'dati_rel\',\'$id_rel_inf\',\'$nome\',\'$rel_inf_sing\',\'".substr($idrelutenti,2)."\',\'$id_utente\')\"",$lista_return);
if ($rel_sup_sing) $lista_return = "<b id=\"b_$nome\" style=\"font-weight: normal;\">".$lista_return."<\/b>";
} # fine if ($javascript)
else {
if ($rel_inf_sing) $lista_return = str_replace(" name=\"\""," name=\"\" onchange=\"ricarica_ifrm('dati_rel','$id_rel_inf','$nome','$rel_inf_sing','".substr($idrelutenti,2)."','$id_utente')\"",$lista_return);
if ($rel_sup_sing) $lista_return = "<b id=\"b_$nome\" style=\"font-weight: normal;\">".$lista_return."</b>";
} # fine else if ($javascript)
return str_replace(" name=\"\""," name=\"$nome\" id=\"$nome\"",$lista_return);
} # fine function mostra_lista_relutenti



###########################################
###  FINE ./includes/funzioni_clienti.php 
###########################################

###########################################
###  INIZIO ./includes/funzioni_dati_relutenti.php 
###########################################

##################################################################################
#    HOTELDRUID
#    Copyright (C) 2001-2009 by Marco Maria Francesco De Santis (marco@digitaldruid.net)
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    any later version accepted by Marco Maria Francesco De Santis, which
#    shall act as a proxy as defined in Section 14 of version 3 of the
#    license.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
##################################################################################



function trova_rel ($rel,&$rel_sing,&$rel_plur,&$tablerel) {
global $tablenazioni,$tableregioni,$tablecitta,$tabledocumentiid,$tableparentele;
$rel_sing = "nazione";
$rel_plur = "nazioni";
$tablerel = $tablenazioni;
if ($rel == "regione") {
$rel_sing = "regione";
$rel_plur = "regioni";
$tablerel = $tableregioni;
} # fine if ($rel == "regione")
if ($rel == "citta") {
$rel_sing = "citta";
$rel_plur = "citta";
$tablerel = $tablecitta;
} # fine if ($rel == "citta")
if ($rel == "documentoid") {
$rel_sing = "documentoid";
$rel_plur = "documentiid";
$tablerel = $tabledocumentiid;
} # fine if ($rel == "documentoid")
if ($rel == "parentela") {
$rel_sing = "parentela";
$rel_plur = "parentele";
$tablerel = $tableparentele;
} # fine if ($rel == "parentela")
} # fine function trova_rel



function mostra_frame_rel ($id,$rel,$rel_sup,$id_ut_sel,$cmp,$mostra_cod,$pieno,$titolo,$size="20",$maxlength="50") {
global $tablerelutenti,$tablenazioni,$tableregioni,$tablecitta,$tabledocumentiid,$tableparentele;

trova_rel($rel,$rel_sing,$rel_plur,$tablerel);
trova_rel($rel_sup,$rel_sup_sing,$rel_sup_plur,$tablerel_sup);

if (get_magic_quotes_gpc()) $id = stripslashes($id);
$id = htmlspecialchars($id);
$id_sup = esegui_query("select distinct $tablerel_sup.id$rel_sup_plur from $tablerelutenti inner join $tablerel_sup on $tablerelutenti.id$rel_sup_sing = $tablerel_sup.id$rel_sup_plur where $tablerelutenti.idutente = '$id_ut_sel' and $tablerel_sup.nome_$rel_sup_sing = '".aggslashdb($id)."' ");
if (numlin_query($id_sup)) $is_id = "= '".risul_query($id_sup,0,"id$rel_sup_plur",$tablerel_sup)."'";
else $is_id = "is NULL";



echo "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01//EN\"
        \"http://www.w3.org/TR/html4/strict.dtd\">
<html>
<head>
<meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\" >
<title> $titolo </title>
</head>
<body>
<div id=\"dati_rel\">";


$rel_utente = esegui_query("select distinct $tablerel.nome_$rel_sing,$tablerel.codice_$rel_sing,$tablerel.codice2_$rel_sing,$tablerel.codice3_$rel_sing from $tablerelutenti inner join $tablerel on $tablerelutenti.id$rel_sing = $tablerel.id$rel_plur where $tablerelutenti.idutente = '$id_ut_sel' and $tablerelutenti.idsup $is_id order by $tablerel.nome_$rel_sing");
$num_rel_utente = numlin_query($rel_utente);
if ($num_rel_utente) {
echo "<select name=\"$cmp\" id=\"$cmp\">";
if ($pieno != "SI") echo "<option value=\"\">------</option>";
for ($num1 = 0 ; $num1 < $num_rel_utente ; $num1++) {
$rel = htmlspecialchars(risul_query($rel_utente,$num1,"nome_$rel_sing",$tablerel));
echo "<option value=\"$rel\">$rel";
if ($mostra_cod) {
$codice = htmlspecialchars(risul_query($rel_utente,$num1,"codice_$rel_sing",$tablerel));
$codice2 = htmlspecialchars(risul_query($rel_utente,$num1,"codice2_$rel_sing",$tablerel));
$codice3 = htmlspecialchars(risul_query($rel_utente,$num1,"codice3_$rel_sing",$tablerel));
if (strcmp($codice,"")) echo " ($codice)";
if (strcmp($codice2,"")) echo " (".mex("2",'personalizza.php')." $codice2)";
if (strcmp($codice3,"")) echo " (".mex("3",'personalizza.php')." $codice3)";
} # fine if ($mostra_cod)
echo "</option>";
} # fine for $num1
echo "</select>";
} # fine if ($num_rel_utente)
else echo "<input type=\"text\" name=\"$cmp\" id=\"$cmp\" size=\"$size\" maxlength=\"$maxlength\">";


echo "</div>
</body>
</html>
";
} # fine function mostra_frame_rel




###########################################
###  FINE ./includes/funzioni_dati_relutenti.php 
###########################################

###########################################
###  INIZIO ./includes/templates/modello_disponibilita.php 
###########################################

##################################################################################
#    HOTELDRUID
#    Copyright (C) 2001-2011 by Marco Maria Francesco De Santis (marco@digitaldruid.net)
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    any later version accepted by Marco Maria Francesco De Santis, which
#    shall act as a proxy as defined in Section 14 of version 3 of the
#    license.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
##################################################################################



$tableperiodi = $PHPR_TAB_PRE."periodi".$anno;
$tableprenota = $PHPR_TAB_PRE."prenota".$anno;
$tablecostiprenota = $PHPR_TAB_PRE."costiprenota".$anno;
$tablenometariffe = $PHPR_TAB_PRE."ntariffe".$anno;
$tableregole = $PHPR_TAB_PRE."regole".$anno;
$tableappartamenti = $PHPR_TAB_PRE."appartamenti";
$tablepersonalizza = $PHPR_TAB_PRE."personalizza";
$tablemessaggi = $PHPR_TAB_PRE."messaggi";
$tableutenti = $PHPR_TAB_PRE."utenti";
$tablerelutenti = $PHPR_TAB_PRE."relutenti";
$tablenazioni = $PHPR_TAB_PRE."nazioni";
$tableregioni = $PHPR_TAB_PRE."regioni";
$tablecitta = $PHPR_TAB_PRE."citta";
$tabledocumentiid = $PHPR_TAB_PRE."documentiid";
$tablerelinventario = $PHPR_TAB_PRE."relinventario";
$tablecontratti = $PHPR_TAB_PRE."contratti";
$tablerclientiprenota = $PHPR_TAB_PRE."rclientiprenota".$anno;

unset($id_utente);



$utente_liste = esegui_query("select idutenti from $tableutenti where nome_utente = '".aggslashdb($utente_liste)."'");
if (numlin_query($utente_liste) != 1) $utente_liste = 1;
else $utente_liste = risul_query($utente_liste,0,'idutenti');

if ($dati_relutenti) {
mostra_frame_rel($id,$rel,$rel_sup,$utente_liste,$cmp,$mostra_cod,$pieno,"dati_rel","30","70");
exit();
} # fine ($dati_relutenti)


$target = "";
if ($framed) {
if ($blank) $target = " target=\"_blank\"";
else $target = " target=\"_top\"";
echo "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\"
        \"http://www.w3.org/TR/html4/loose.dtd\">
<html>
<head>
<meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\" >
<title>$pag</title>
";
if ($file_css_frame) echo "<link rel=\"stylesheet\" type=\"text/css\" href=\"$file_css_frame\" media=\"all\">
";
elseif ($extra_head_frame) echo "$extra_head_frame
";
echo "</head>
<body>
";
} # fine if ($framed)


if ($estendi_ultima_data == "SI" or $chiedi_oracheckin != "NO") {
$ultima_data_menu_periodi = explode("<option value=\"",$menu_periodi);
$penultima_data_menu_periodi = substr($ultima_data_menu_periodi[(count($ultima_data_menu_periodi) - 2)],0,10);
$ultima_data_menu_periodi = substr($ultima_data_menu_periodi[(count($ultima_data_menu_periodi) - 1)],0,10);
$date_mancanti = esegui_query("select datafine from  $tableperiodi where datafine > '$ultima_data_menu_periodi' order by idperiodi");
$num_date_mancanti = numlin_query($date_mancanti);
if ($num_date_mancanti > 0 or $chiedi_oracheckin != "NO") {
$id_ultima_data = esegui_query("select idperiodi from  $tableperiodi where datafine = '$ultima_data_menu_periodi'");
$id_ultima_data = risul_query($id_ultima_data,0,'idperiodi');
$id_penultima_data = esegui_query("select idperiodi from  $tableperiodi where datafine = '$penultima_data_menu_periodi'");
$id_penultima_data = risul_query($id_penultima_data,0,'idperiodi');
$intervalloperiodo = $id_ultima_data - $id_penultima_data;
} # fine if ($num_date_mancanti > 0 or $chiedi_oracheckin != "NO")
if ($num_date_mancanti > 0 and $estendi_ultima_data == "SI") {
if ($intervalloperiodo == 1) $num_intervallo = 1;
else $num_intervallo = 2;
for ($num1 = 0 ; $num1 < $num_date_mancanti ; $num1++) {
if ($num_intervallo == 1) {
$data_option = risul_query($date_mancanti,$num1,'datafine');
$giorno_option = substr($data_option,8,2);
$mese_option = substr($data_option,5,2);
$anno_option = substr($data_option,0,4);
$nome_giorno = date("D" , mktime(0,0,0,$mese_option,$giorno_option,$anno_option));
$nome_mese = date("M" , mktime(0,0,0,$mese_option,$giorno_option,$anno_option));
if ($tipo_periodi == "g") {
if ($nome_giorno == "Sun") $nome_giorno = mex_data(" Do");
if ($nome_giorno == "Mon") $nome_giorno = mex_data(" Lu");
if ($nome_giorno == "Tue") $nome_giorno = mex_data(" Ma");
if ($nome_giorno == "Wed") $nome_giorno = mex_data(" Me");
if ($nome_giorno == "Thu") $nome_giorno = mex_data(" Gi");
if ($nome_giorno == "Fri") $nome_giorno = mex_data(" Ve");
if ($nome_giorno == "Sat") $nome_giorno = mex_data(" Sa");
} # fine if ($tipo_periodi == "g")
else $nome_giorno = "";
if ($nome_mese == "Jan") $nome_mese = mex_data("Gen");
if ($nome_mese == "Feb") $nome_mese = mex_data("Feb");
if ($nome_mese == "Mar") $nome_mese = mex_data("Mar");
if ($nome_mese == "Apr") $nome_mese = mex_data("Apr");
if ($nome_mese == "May") $nome_mese = mex_data("Mag");
if ($nome_mese == "Jun") $nome_mese = mex_data("Giu");
if ($nome_mese == "Jul") $nome_mese = mex_data("Lug");
if ($nome_mese == "Aug") $nome_mese = mex_data("Ago");
if ($nome_mese == "Sep") $nome_mese = mex_data("Set");
if ($nome_mese == "Oct") $nome_mese = mex_data("Ott");
if ($nome_mese == "Nov") $nome_mese = mex_data("Nov");
if ($nome_mese == "Dec") $nome_mese = mex_data("Dic");
$menu_periodi .= "<option value=\"$data_option\">$nome_mese $giorno_option$nome_giorno, $anno_option</option>
";
} # fine if ($num_intervallo == 1)
if ($num_intervallo == $intervalloperiodo) $num_intervallo = 1;
else $num_intervallo++;
} # fine for $num1
} # fine if ($num_date_mancanti > 0 and $estendi_ultima_data == "SI")
} # fine if ($estendi_ultima_data == "SI" or $chiedi_oracheckin != "NO")

if (!$num_tipologie) $num_tipologie = 1;
else if (controlla_num_pos($num_tipologie) == "NO" or $num_tipologie == 0) $num_tipologie = 1;
if ($aggiungi_nuova_tipologia) $num_tipologie++;
if ($elimina_ultima_tipologia) $num_tipologie--;
if ($num_tipologie > $max_num_tipologie) $num_tipologie = $max_num_tipologie;
if ($aggiungi_tipologie != "SI") $num_tipologie = 1;


if ($contr_disp) {
$mostra_form = "NO";
echo $apertura_tag_font;

$liberato = "NO";
$verificare = "SI";
$torna_indietro = "NO";


$tabelle_lock = "";
$altre_tab_lock = array($tableprenota,$tablenometariffe,$tableperiodi,$tableappartamenti,$tableregole,$tablepersonalizza,$tablerelinventario);
$tabelle_lock = lock_tabelle($tabelle_lock,$altre_tab_lock);

$appartamenti = esegui_query("select * from $tableappartamenti ");
$numappartamenti = numlin_query($appartamenti);
$dati_tariffe = dati_tariffe($tablenometariffe,"","",$tableregole);
$dati_ca = dati_costi_agg_ntariffe($tablenometariffe,$dati_tariffe['num']);
$regole2 = esegui_query("select * from $tableregole where tariffa_per_app != ''");
$num_regole2 = numlin_query($regole2);
$regole4 = esegui_query("select * from $tableregole where tariffa_per_persone != ''");
$num_regole4 = numlin_query($regole4);
unset($numpers_regola4);
for ($num1 = 0 ; $num1 < $num_regole4 ; $num1++) {
$numtariffa_regola4 = str_replace("tariffa","",risul_query($regole4,$num1,'tariffa_per_persone'));
if ($tariffe_mostra[$numtariffa_regola4] == "SI") $numpers_regola4[$numtariffa_regola4] = risul_query($regole4,$num1,'iddatainizio');
} # fine for $num1


if ($da_passo2) {
$num_tipologie = 0;
$num_tipologie_prec = 0;
for ($numtariffa = 1 ; $numtariffa <= $dati_tariffe['num'] ; $numtariffa++) {
if ($tariffe_mostra[$numtariffa] == "SI") {
if (($aggiungi_tipologie_p2 == "SI" and ${"num_app_tipo_richiesti_p2_".$numtariffa}) or ($aggiungi_tipologie_p2 != "SI" and ${"pren_ora".$numtariffa})) {
$num_tipologie++;
${"numero_tariffa".$num_tipologie} = $numtariffa;
${"num_app_tipo_richiesti".$num_tipologie} = ${"num_app_tipo_richiesti_p2_".$numtariffa};
if ($chiedi_num_persone_passo_1_p2 != "SI") ${"numpersone".$num_tipologie} = ${"numpersone_p2_".$numtariffa};
${"numcostiagg".$num_tipologie} = ${"numcostiagg_p2_".$numtariffa};
if (!${"numcostiagg".$num_tipologie}) ${"numcostiagg".$num_tipologie} = 0;
for ($numca = 1 ; $numca <= ${"numcostiagg".$num_tipologie} ; $numca++) {
${"idcostoagg".$numca."_".$num_tipologie} = ${"idcostoagg_p2_".$numca."_".$numtariffa};
${"costoagg".$numca."_".$num_tipologie} = ${"costoagg_p2_".$numca."_".$numtariffa};
${"nummoltiplica_ca".$numca."_".$num_tipologie} = ${"nummoltiplica_ca_p2_".$numca."_".$numtariffa};
${"numsettimane".$numca."_".$num_tipologie} = ${"numsettimane_p2_".$numca."_".$numtariffa};
} # fine for $num1
} # fine if (($aggiungi_tipologie_p2 == "SI" and ${"num_app_tipo_richiesti_p2_".$numtariffa}) or...
if ($num_tipologie != $num_tipologie_prec) {
${"inizioperiodo".$num_tipologie} = $inizioperiodo1;
${"fineperiodo".$num_tipologie} = $fineperiodo1;
if ($chiedi_num_persone_passo_1_p2 == "SI") ${"numpersone".$num_tipologie} = $numpersone1;
$num_tipologie_prec = $num_tipologie;
} # fine if ($num_tipologie != $num_tipologie_prec)
} # fine if ($tariffe_mostra[$numtariffa] == "SI")
} # fine for $numtariffa
} # fine if ($da_passo2)


$dati_form_iniziale = "<input type=\"hidden\" name=\"num_tipologie\" value=\"$num_tipologie\">";
for ($n_t = 1 ; $n_t <= $num_tipologie ; $n_t++) {
$dati_form_iniziale .= "<input type=\"hidden\" name=\"inizioperiodo$n_t\" value=\"".${"inizioperiodo".$n_t}."\">
<input type=\"hidden\" name=\"fineperiodo$n_t\" value=\"".${"fineperiodo".$n_t}."\">
<input type=\"hidden\" name=\"numero_tariffa$n_t\" value=\"".${"numero_tariffa".$n_t}."\">
<input type=\"hidden\" name=\"numpersone$n_t\" value=\"".${"numpersone".$n_t}."\">
<input type=\"hidden\" name=\"num_app_tipo_richiesti$n_t\" value=\"".${"num_app_tipo_richiesti".$n_t}."\">";
$numcostiagg = "numcostiagg".$n_t;
for ($numca = 1 ; $numca <= $$numcostiagg ; $numca++) {

# Espando le variabili dei costi combinabili
if (substr(${"idcostoagg".$numca."_".$n_t},0,1) == "c") {
$categoria = substr(${"idcostoagg".$numca."_".$n_t},1);
$num_in_cat = 0;
for ($num1 = 0 ; $num1 < $dati_ca['num'] ; $num1++) {
if ($dati_ca[$num1]['mostra'] == "s" and $dati_ca[$num1]['combina'] == "s" and $dati_ca[$num1]['categoria'] == $categoria) {
$num_in_cat++;
if ($num_in_cat != 1) {
$$numcostiagg++;
${"costoagg".$$numcostiagg."_".$n_t} = ${"costoagg".$numca."_".$n_t};
${"idcostoagg".$$numcostiagg."_".$n_t} = $dati_ca[$num1]['id'];
${"numsettimane".$$numcostiagg."_".$n_t} = ${"numsettimane".$numca."_".$n_t};
${"nummoltiplica_ca".$$numcostiagg."_".$n_t} = ${"nummoltiplica_ca".$numca."_".$n_t};
} # fine else if ($num_in_cat == 1)
else ${"idcostoagg".$numca."_".$n_t} = $dati_ca[$num1]['id'];
} # fine if ($dati_ca[$num1]['mostra'] == "s" and $dati_ca[$num1]['combina'] == "s" and...
} # fine for $num1
if (!$num_in_cat) $verificare = "NO";
} # fine if (substr(${"idcostoagg".$numca."_".$n_t},0,1) == "c")

$dati_form_iniziale .= "<input type=\"hidden\" name=\"idcostoagg$numca"."_$n_t\" value=\"".${"idcostoagg".$numca."_".$n_t}."\">
<input type=\"hidden\" name=\"costoagg$numca"."_$n_t\" value=\"".${"costoagg".$numca."_".$n_t}."\">
<input type=\"hidden\" name=\"numsettimane$numca"."_$n_t\" value=\"".${"numsettimane".$numca."_".$n_t}."\">
<input type=\"hidden\" name=\"nummoltiplica_ca$numca"."_$n_t\" value=\"".${"nummoltiplica_ca".$numca."_".$n_t}."\">
<input type=\"hidden\" name=\"id_periodi_costo$numca"."_$n_t\" value=\"".${"id_periodi_costo".$numca."_".$n_t}."\">";
} # fine for $numca
$dati_form_iniziale .= "<input type=\"hidden\" name=\"numcostiagg$n_t\" value=\"".$$numcostiagg."\">";
} # fine for $n_t



unset($limiti_var);
$limiti_var['idperiodocorrente'] = calcola_id_periodo_corrente($anno);
$idperiodocorrente_reale = calcola_id_periodo_corrente($anno,"NO");
unset($idinizioperiodo_min);
unset($idfineperiodo_max);
unset($app_incomp_costi);
unset($app_eliminati_costi);
unset($beniinv_presenti);
unset($num_ripetizioni_costo);
unset($costo_tariffa_reg);
unset($tariffesettimanali_reg);
unset($caparra_reg);
unset($cmmissioni_reg);
unset($lista_app_reg);
unset($num_costi_reg);
unset($costo_tariffa_tot_reg);
unset($num_letti_agg_reg);
unset($nome_costo_reg);
unset($val_costo_reg);
unset($tasseperc_costo_reg);
unset($moltmax_costo_reg);


for ($n_t = 1 ; $n_t <= $num_tipologie ; $n_t++) {
$inizioperiodo = ${"inizioperiodo".$n_t};
$fineperiodo = ${"fineperiodo".$n_t};
$numero_tariffa = ${"numero_tariffa".$n_t};
$num_app_tipo_richiesti = ${"num_app_tipo_richiesti".$n_t};

if (!$inizioperiodo or !$fineperiodo or !$numero_tariffa) $verificare = "NO";

$data_inizioperiodo[$n_t] = $inizioperiodo;
$data_inizioperiodo_f[$n_t] = formatta_data($data_inizioperiodo[$n_t],$stile_data);
$data_fineperiodo[$n_t] = $fineperiodo;
$data_fineperiodo_f[$n_t] = formatta_data($data_fineperiodo[$n_t],$stile_data);
$idinizioperiodo[$n_t] = esegui_query("select idperiodi from $tableperiodi where datainizio = '$inizioperiodo' ");
$num_idinizioperiodo = numlin_query($idinizioperiodo[$n_t]);
if ($num_idinizioperiodo == 0) { $idinizioperiodo[$n_t] = 10000; }
else { $idinizioperiodo[$n_t] = risul_query($idinizioperiodo[$n_t],0,'idperiodi'); }
$inizioperiodo = $idinizioperiodo[$n_t];
if (!$idinizioperiodo_min or $inizioperiodo < $idinizioperiodo_min) $idinizioperiodo_min = $inizioperiodo;
$idfineperiodo[$n_t] = esegui_query("select idperiodi from $tableperiodi where datafine = '$fineperiodo' ");
$num_idfineperiodo = numlin_query($idfineperiodo[$n_t]);
if ($num_idfineperiodo == 0) { $idfineperiodo[$n_t] = -1; }
else { $idfineperiodo[$n_t] = risul_query($idfineperiodo[$n_t],0,'idperiodi'); }
$fineperiodo = $idfineperiodo[$n_t];
if (!$idfineperiodo_max or $fineperiodo > $idfineperiodo_max) $idfineperiodo_max = $fineperiodo;

if (str_replace("<option value=\"".$data_inizioperiodo[$n_t]."\">","",$menu_periodi) == $menu_periodi or str_replace("<option value=\"".$data_fineperiodo[$n_t]."\">","",$menu_periodi) == $menu_periodi) {
$idfineperiodo[$n_t] = -1;
$idinizioperiodo[$n_t] = 10000;
} # fine if (str_replace("<option value=\"$\">","",$menu_periodi) == $menu_periodi or...

if ($idfineperiodo[$n_t] < $idinizioperiodo[$n_t] or $idinizioperiodo[$n_t] < ($idperiodocorrente_reale + $sett_no_prenota)) {
$verificare = "NO";
echo "$fr_Le_date_sono_sbagliate";
if ($num_tipologie > 1) echo " ($n_t)";
echo ".<br>";
} # fine if ($idfineperiodo[$n_t] < $idinizioperiodo[$n_t] or...

unset(${"app_richiesti".$n_t});
if ($tariffe_mostra[$numero_tariffa] != "SI") {
$verificare = "NO";
echo "$fr_La_tipologia_e_sbagliata";
if ($num_tipologie > 1) echo " ($n_t)";
echo ".<br>";
} # fine if ($tariffe_mostra[$numero_tariffa] != "SI")
else {
$tipotariffa = "tariffa".$numero_tariffa;
$nometariffa = $dati_tariffe[$tipotariffa]['nome'];
$nometariffa_vedi[$n_t] = $nometariffa;
if ($nometariffa == "") {
$nometariffa = $tariffa;
$nometariffa_vedi[$n_t] = $fr_tariffa.$numero_tariffa;
} # fine if ($nometariffa == "")
if ($n_tariffe_imposte[$numero_tariffa]) ${"nometariffa_imposta".$n_t} = $n_tariffe_imposte[$numero_tariffa];
else ${"nometariffa_imposta".$n_t} = $nometariffa_vedi[$n_t];
unset($app_regola2_predef);
$lista_app_reg[$n_t] = trova_app_regola2($tipotariffa,$regole2,$num_regole2,$app_regola2_predef,$idperiodocorrente_reale,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$tipo_periodi,$anno,$tableregole);
if ($lista_app_reg[$n_t]) {
$vett_app = explode(",",$lista_app_reg[$n_t]);
for ($num1 = 0 ; $num1 < count($vett_app) ; $num1++) {
$idapp = $vett_app[$num1];
${"app_richiesti".$n_t}[$idapp] = "SI";
} # fine for $num1
} # fine if ($lista_app_reg[$n_t])
} # fine else if ($tariffe_mostra[$numero_tariffa] != "SI")

if ($chiedi_num_app_tipologia != "SI") ${"num_app_tipo_richiesti".$n_t} = 1;
if (!${"num_app_tipo_richiesti".$n_t} or ${"num_app_tipo_richiesti".$n_t} == 0) ${"num_app_tipo_richiesti".$n_t} = 1;
$num_app_tipo_richiesti = ${"num_app_tipo_richiesti".$n_t};
if (controlla_num_pos($num_app_tipo_richiesti) == "NO" or strlen($num_app_tipo_richiesti) > 3 or ($max_num_app_tipologia != 0 and $num_app_tipo_richiesti > $max_num_app_tipologia)) {
$verificare = "NO";
echo "$fr_Il_numero_di $fr_appartamenti $fr_richiesto_e_sbagliato";
if ($num_tipologie > 1) echo " ($n_t)";
echo ".<br>";
} # fine if (controlla_num_pos($num_app_tipo_richiesti) == "NO" or...

# prima parte dei controlli legati al numero di persone
if ($chiedi_num_persone != "SI") ${"numpersone".$n_t} = "";
if (!${"numpersone".$n_t} and $numpers_regola4[$numero_tariffa]) ${"numpersone".$n_t} = $numpers_regola4[$numero_tariffa];
$numpersone = ${"numpersone".$n_t};
${"aggiungi_costo_letto".$n_t} = "NO";
if ($numpersone) {
if (controlla_num_pos($numpersone) == "NO" or ($max_num_persone != 0 and $numpersone > $max_num_persone)) {
$verificare = "NO";
echo "$fr_Il_numero_di $fr_persone $fr_richiesto_e_sbagliato";
if ($num_tipologie > 1) echo " ($n_t)";
echo ".<br>";
} # fine if (controlla_num_pos($numpersone) == "NO" or...
$num_cal = $dati_ca['id'][$costo_aggiungi_letti];
if ($dati_ca[$num_cal]['letto'] == "s" and $dati_ca[$num_cal]['numsett'] != "c" and $dati_ca[$num_cal]['combina'] != "s") {
$max_capacita = 0;
for ($num1 = 0 ; $num1 < $numappartamenti ; $num1++) {
$idapp = risul_query($appartamenti,$num1,'idappartamenti');
if (((!${"app_richiesti".$n_t} or ${"app_richiesti".$n_t}[$idapp] == "SI") and !$app_regola2_predef) or (str_replace(",$idapp,","",",$app_regola2_predef,") != ",$app_regola2_predef," and $app_regola2_predef)) {
$maxoccupanti = risul_query($appartamenti,$num1,'maxoccupanti');
if (!$maxoccupanti) $max_capacita = $numpersone;
else if ($maxoccupanti > $max_capacita) $max_capacita = $maxoccupanti;
} # fine if (((!${"app_richiesti".$n_t} or ${"app_richiesti".$n_t}[$idapp] == "SI") and !$app_regola2_predef) or...
} # fine for $num1
if ($dati_ca[$num_cal]['moltiplica'] != "c") $max_num_aggiungi_letti = 1;
if ($numpersone > $max_capacita and ($numpersone - $max_capacita) <= $max_num_aggiungi_letti and $costi_agg_mostra[$costo_aggiungi_letti] == "SI") {
${"aggiungi_costo_letto".$n_t} = "SI";
${"num_aggiungi_letti".$n_t} = ($numpersone - $max_capacita);
$numpersone = $max_capacita;
${"numpersone".$n_t} = $numpersone;
} # fine if ($numpersone > $maxoccupanti and ($numpersone - $maxoccupanti) >= $max_num_aggiungi_letti and...
} # fine if ($dati_ca[$num_cal]['letto'] == "s" and $dati_ca[$num_cal]['numsett'] != "c" and...
} # fine if ($numpersone)


# se vi sono costi (anche da aggiungi_costo_letto) con appartamenti incompatibili
if ($mostra_costi_aggiuntivi == "SI") {
for ($numca = 1 ; $numca <= ${"numcostiagg".$n_t} ; $numca++) {
$idcostoagg = ${"idcostoagg".$numca."_".$n_t};
$num_costo = $dati_ca['id'][$idcostoagg];
if ($dati_ca[$num_costo]['mostra'] == "s" and $costi_agg_mostra[$idcostoagg] == "SI") {
$costoagg = ${"costoagg".$numca."_".$n_t};
if ($idcostoagg == $costo_aggiungi_letti) $costoagg = "";
if ($costoagg == "SI" and $dati_ca[$num_costo]['appincompatibili']) $app_incomp_costi[$n_t] .= ",".$dati_ca[$num_costo]['appincompatibili'];
} # fine if ($dati_ca[$num_costo]['mostra'] == "s" and...
} # fine for $numca
} # fine if ($mostra_costi_aggiuntivi == "SI")
if (${"aggiungi_costo_letto".$n_t} == "SI" and $dati_ca[$dati_ca['id'][$costo_aggiungi_letti]]['appincompatibili']) $app_incomp_costi[$n_t] .= ",".$dati_ca[$dati_ca['id'][$costo_aggiungi_letti]]['appincompatibili'];
if ($app_incomp_costi[$n_t]) {
$app_incomp_costi[$n_t] .= ",";
$app_richiesti_copia = ${"app_richiesti".$n_t};
if (!$lista_app_reg[$n_t]) {
for ($num1 = 0 ; $num1 < $numappartamenti ; $num1++) {
$idapp = risul_query($appartamenti,$num1,'idappartamenti');
$lista_app_reg[$n_t] .= ",$idapp";
} # fine for $num1
$lista_app_reg[$n_t] = substr($lista_app_reg[$n_t],1);
} # fine if (!$lista_app_reg[$n_t])
for ($num1 = 0 ; $num1 < $numappartamenti ; $num1++) {
$idapp = risul_query($appartamenti,$num1,'idappartamenti');
if (!$app_richiesti_copia or $app_richiesti_copia[$idapp] == "SI") {
if (str_replace(",$idapp,","",$app_incomp_costi[$n_t]) != $app_incomp_costi[$n_t]) {
${"app_richiesti".$n_t}[$idapp] = "NO";
$lista_app_reg[$n_t] = substr(str_replace(",$idapp,",",",",".$lista_app_reg[$n_t].","),1,-1);
$app_eliminati_costi[$n_t] .= ",$idapp";
} # fine if (str_replace(",$idapp,","",$app_incomp_costi[$n_t]) != $app_incomp_costi[$n_t])
else ${"app_richiesti".$n_t}[$idapp] = "SI";
} # fine if (!$app_richiesti_copia or $app_richiesti_copia[$idapp] == "SI")
} # fine for $num1
$app_eliminati_costi[$n_t] = substr($app_eliminati_costi[$n_t],1);
} # fine if ($app_incomp_costi[$n_t])

# se vi sono costi (anche da aggiungi_costo_letto) con beni inventario dall'appartamento
if (${"aggiungi_costo_letto".$n_t} == "SI") $num_ripeti = ${"numcostiagg".$n_t} + 1;
else $num_ripeti = ${"numcostiagg".$n_t};
for ($numca = 1 ; $numca <= $num_ripeti ; $numca++) {
$processa_costo = "NO";
if ($numca <= ${"numcostiagg".$n_t}) {
$idcostoagg = ${"idcostoagg".$numca."_".$n_t};
if ($costi_agg_mostra[$idcostoagg] == "SI" and ${"costoagg".$numca."_".$n_t} == "SI") $processa_costo = "SI";
$nummoltiplica_ca = ${"nummoltiplica_ca".$numca."_".$n_t};
$numsettimane = ${"numsettimane".$numca."_".$n_t};
} # fine if ($numca <= ${"numcostiagg".$n_t})
else {
$processa_costo = "SI";
$idcostoagg = $costo_aggiungi_letti;
$nummoltiplica_ca = ${"num_aggiungi_letti".$n_t};
$numsettimane = "";
} # fine else if ($numca <= ${"numcostiagg".$n_t})
$num_costo = $dati_ca['id'][$idcostoagg];
if ($dati_ca[$num_costo]['tipo_beniinv'] == "app" and $processa_costo == "SI" and $dati_ca[$num_costo]['mostra'] == "s") {
$settimane_costo = calcola_settimane_costo($tableperiodi,$dati_ca,$num_costo,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],"",aggslashdb($numsettimane));
calcola_moltiplica_costo($dati_ca,$num_costo,$moltiplica_costo,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo,aggslashdb($nummoltiplica_ca),$numpersone,"");
$app_richiesti_copia = ${"app_richiesti".$n_t};
$app_trovato = "NO";
for ($num1 = 0 ; $num1 < $numappartamenti ; $num1++) {
$idapp = risul_query($appartamenti,$num1,'idappartamenti');
if (!$app_richiesti_copia or $app_richiesti_copia[$idapp] == "SI") {
$risul = controlla_beni_inventario_costo($tablerelinventario,$dati_ca,$num_costo,$beniinv_presenti,$num_ripetizioni_costo[$n_t][$num_costo],"",$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo,$moltiplica_costo,$idapp);
if ($risul != "SI") {
${"app_richiesti".$n_t}[$idapp] = "NO";
$app_eliminati_costi['beniinv'][$n_t] = "SI";
} # fine if ($risul != "SI")
else {
${"app_richiesti".$n_t}[$idapp] = "SI";
$app_trovato = "SI";
} # fine else if ($risul != "SI")
} # fine if (!$app_richiesti_copia or $app_richiesti_copia[$idapp] == "SI")
} # fine for $num1
if ($app_trovato != "SI") {
$verificare = "NO";
if ($n_costi_agg_imposti[$idcostoagg]) $nomecosto_imposto = $n_costi_agg_imposti[$idcostoagg];
else $nomecosto_imposto = $dati_ca[$num_costo]['nome'];
echo "$fr_Errore_nei_servizi_opzionali_richiesti ($nomecosto_imposto).<br>";
break;
} # fine if ($app_trovato != "SI")
} # fine if ($dati_ca[$num_costo]['tipo_beniinv'] == "app" and...
} # fine for $numca


# riprendo i controlli legati al numero di persone
if ($numpersone and $verificare != "NO") {
$app_richiesti_copia = ${"app_richiesti".$n_t};
$app_trovato = "NO";
if ($app_regola2_predef) {
$app_regola2_predef = ",$app_regola2_predef,";
$posto_reg2_orig = 0;
} # fine if ($app_regola2_predef)
for ($num1 = 0 ; $num1 < $numappartamenti ; $num1++) {
$idapp = risul_query($appartamenti,$num1,'idappartamenti');
$maxoccupanti = risul_query($appartamenti,$num1,'maxoccupanti');
if (!$app_richiesti_copia or $app_richiesti_copia[$idapp] == "SI") {
if ($maxoccupanti and $maxoccupanti < $numpersone) ${"app_richiesti".$n_t}[$idapp] = "NO";
else {
${"app_richiesti".$n_t}[$idapp] = "SI";
$app_trovato = "SI";
} # fine else if ($maxoccupanti and $maxoccupanti < $numpersone)
} # fine if (!$app_richiesti or $app_richiesti[$idapp] == "SI")
if ($app_regola2_predef) {
if (str_replace(",$idapp,","",$app_regola2_predef) != $app_regola2_predef) {
if (!$maxoccupanti or $maxoccupanti >= $numpersone) $posto_reg2_orig = 1;
} # fine if (str_replace(",$idapp,","",$app_regola2_predef) != $app_regola2_predef)
} # fine if ($app_regola2_predef)
} # fine for $num1
if ($app_trovato != "SI" or ($app_regola2_predef and !$posto_reg2_orig)) {
$verificare = "NO";
echo "$fr_Il_numero_di $fr_persone $fr_supera_la_capienza_massima_della_tipologia_richiesta";
if ($num_tipologie > 1) echo " ($n_t)";
if ($app_eliminati_costi[$n_t] or $app_eliminati_costi['beniinv'][$n_t]) echo " $fr_con_i_servizi_opzionali_selezionati";
echo ".<br>";
} # fine if ($app_trovato != "SI" or...
} # fine if ($numpersone and $verificare != "NO")


if ($verificare != "NO") {
for ($num1 = $idinizioperiodo[$n_t]; $num1 <= $idfineperiodo[$n_t]; $num1 = $num1 + 1) {
$prenotazioni = esegui_query("select * from $tableprenota where iddatainizio <= $num1 and iddatafine >= $num1");
$numprenotazioni = numlin_query($prenotazioni);
$rigasettimana = esegui_query("select * from $tableperiodi where idperiodi = '$num1' ");
if ($numprenotazioni >= $numappartamenti) {
if (!$mostra_quadro_disp) $verificare = "NO";
$inizioperiodopieno = risul_query($rigasettimana,0,'datainizio');
$inizioperiodopieno_f = formatta_data($inizioperiodopieno,$stile_data);
$fineperiodopieno = risul_query($rigasettimana,0,'datafine');
$fineperiodopieno_f = formatta_data($fineperiodopieno,$stile_data);
if ($mostra_giorni_pieni == "SI") echo "$fr_parola_La $fr_parola_settimana $fr_dal $inizioperiodopieno_f $fr_al $fineperiodopieno_f $fr_est $fr_piena".".<br>";
} # fine if ($numprenotazioni >= $numappartamenti)
} # fine for $num1
if ($verificare == "NO" and $mostra_giorni_pieni != "SI") {
echo "$fr_Non_c_e_piu_disponibilita_nel_periodo_richiesto";
if ($verificare == "NO" and $num_tipologie > 1) echo " ($n_t)";
if ($verificare == "NO") echo ".<br>";
} # fine if ($verificare == "NO" and $mostra_giorni_pieni != "SI")
} # fine if ($verificare != "NO")

} # fine for $n_t


if ($verificare != "NO") {
unset ($testo_a_video);
unset($testo_tipologie_email);
unset($profondita);
unset($dati_app);
unset($app_prenota_id);
unset($app_orig_prenota_id);
unset($inizio_prenota_id);
unset($fine_prenota_id);
unset($app_assegnabili_id);
unset($prenota_in_app_sett);
if ($idinizioperiodo_min < $limiti_var['idperiodocorrente']) $n_ini = $idinizioperiodo_min;
else $n_ini = $limiti_var['idperiodocorrente'];
$limiti_var[n_ini] = $n_ini;
$max_periodo = esegui_query("select max(idperiodi) from $tableperiodi");
$max_periodo = risul_query($max_periodo,0,0);
if ($idfineperiodo_max <= $limiti_var['idperiodocorrente']) $n_fine = $idfineperiodo_max;
else $n_fine = $max_periodo;
$limiti_var['n_fine'] = $n_fine;

if ($mostra_quadro_disp) {
if ($tipo_periodi == "s") $num_colonne_tab_disp = 5;
else $num_colonne_tab_disp = 32;
$id_data_inizio_tab_disp = (floor(( (double) $idinizioperiodo_min + (double) $idfineperiodo_max) / 2) - floor((double) $num_colonne_tab_disp / 2));
if (($id_data_inizio_tab_disp + $num_colonne_tab_disp - 1) > $max_periodo) $id_data_inizio_tab_disp = ($max_periodo - $num_colonne_tab_disp + 1);
if ($id_data_inizio_tab_disp < 1) $id_data_inizio_tab_disp = 1;
if ($num_colonne_tab_disp > $max_periodo) $num_colonne_tab_disp = $max_periodo;
if ($limiti_var['n_ini'] > $id_data_inizio_tab_disp) $limiti_var[n_ini] = $id_data_inizio_tab_disp;
if ($limiti_var['n_fine'] < ($id_data_inizio_tab_disp + $num_colonne_tab_disp - 1)) $limiti_var['n_fine'] = ($id_data_inizio_tab_disp + $num_colonne_tab_disp - 1);
} # fine if ($mostra_quadro_disp)

$profondita['iniziale'] = "";
$profondita['attuale'] = 1;
$max_prenota = esegui_query("select max(idprenota) from $tableprenota");
$tot_prenota = risul_query($max_prenota,0,0);
$profondita['tot_prenota_ini'] = $tot_prenota;
$profondita['tot_prenota_attuale'] = $tot_prenota;
tab_a_var ($limiti_var,$app_prenota_id,$app_orig_prenota_id,$inizio_prenota_id,$fine_prenota_id,$app_assegnabili_id,$prenota_in_app_sett,$anno,$dati_app,$profondita,$PHPR_TAB_PRE."prenota");
$app_agenzia = esegui_query("select * from $tableregole where app_agenzia != ''");
$num_app_agenzia = numlin_query($app_agenzia);
unlock_tabelle($tabelle_lock);

$id_app_richiesti = 0;
if ($num_tipologie == 1 and $num_app_tipo_richiesti1 == 1) {
$idinizioperiodo_vett = $idinizioperiodo[1];
$idfineperiodo_vett = $idfineperiodo[1];
$app_richiesti = $app_richiesti1;
$id_app_richiesti = 1;
} # fine if ($num_tipologie == 1 and $num_app_tipo_richiesti1 == 1)
else {
$num_tariffe_diverse = 0;
unset ($app_richiesti);
unset($idinizioperiodo_vett);
unset($idfineperiodo_vett);
unset($vett_nomitariffe_presenti);
unset($lista_nomitariffa_imposti);
for ($n_t = 1 ; $n_t <= $num_tipologie ; $n_t++) {
$num_app_tipo_richiesti = ${"num_app_tipo_richiesti".$n_t};
$app_richiesti_copia = ${"app_richiesti".$n_t};
unset($lista_app_richiesti);
if (!$app_richiesti_copia) $lista_app_richiesti = ",tutti,,";
else while (list($key, $val) = each($app_richiesti_copia)) if ($val == "SI") $lista_app_richiesti .= $key.",";
$lista_app_richiesti = substr($lista_app_richiesti,0,-1);
for ($num1 = 1 ; $num1 <= $num_app_tipo_richiesti ; $num1++) {
$id_app_richiesti++;
$app_richiesti[$id_app_richiesti] = $lista_app_richiesti;
$idinizioperiodo_vett[$id_app_richiesti] = $idinizioperiodo[$n_t];
$idfineperiodo_vett[$id_app_richiesti] = $idfineperiodo[$n_t];
} # fine for $num1
} # fine for $n_t
$app_richiesti[',numero,'] = $id_app_richiesti;
} # fine else if ($num_tipologie == 1 and $num_app_tipo_richiesti1 == 1)

if ($num_app_agenzia != 0 and is_array($motivazioni_regola1)) {
$profondita2 = $profondita;
$prenota_in_app_sett2 = $prenota_in_app_sett;
$inizio_prenota_id2 = $inizio_prenota_id;
$fine_prenota_id2 = $fine_prenota_id;
$app_prenota_id2 = $app_prenota_id;
$app_assegnabili_id2 = $app_assegnabili_id;
for ($num1 = 0 ; $num1 < $num_app_agenzia ; $num1 = $num1 + 1) {
$id_app_agenzia[$num1] = risul_query($app_agenzia,$num1,'app_agenzia');
$idinizio_app_agenzia[$num1] = risul_query($app_agenzia,$num1,'iddatainizio');
$idfine_app_agenzia[$num1] = risul_query($app_agenzia,$num1,'iddatafine');
$motivazione_app_agenzia[$num1] = risul_query($app_agenzia,$num1,'motivazione');
if ($motivazione_app_agenzia[$num1] == "") $motivazione_app_agenzia[$num1] = " ";
if ($motivazioni_regola1[$motivazione_app_agenzia[$num1]] == "SI") {
unset($info_periodi_ag);
$info_periodi_ag['numero'] = 1;
$info_periodi_ag['app'][0] = $id_app_agenzia[$num1];
$info_periodi_ag['ini'][0] = $idinizio_app_agenzia[$num1];
$info_periodi_ag['fine'][0] = $idfine_app_agenzia[$num1];
inserisci_prenota_fittizie ($info_periodi_ag,$profondita2,$app_prenota_id2,$inizio_prenota_id2,$fine_prenota_id2,$prenota_in_app_sett2,$app_assegnabili_id2);
} # fine if ($motivazioni_regola1[$motivazione_app_agenzia[$num1]] == "SI")
} # fine for $num1
for ($n_t = 1 ; $n_t <= $num_tipologie ; $n_t++) {
for ($num1 = $idinizioperiodo[$n_t]; $num1 <= $idfineperiodo[$n_t]; $num1++) {
$numprenotazioni = 0;
for ($num2 = 0 ; $num2 < $dati_app['totapp'] ; $num2++) if ($prenota_in_app_sett2[$dati_app['posizione'][$num2]][$num1]) $numprenotazioni++;
if ($numprenotazioni >= $numappartamenti) $occupare_app_agenzia_sempre = "SI";
} # fine for $num1
} # fine for $n_t
if ($occupare_app_agenzia_sempre != "SI") {
$app_orig_prenota_id = $app_prenota_id2;
liberasettimane($idinizioperiodo_vett,$idfineperiodo_vett,$limiti_var,$anno,$fatto_libera,$app_liberato,$profondita2,$app_richiesti,$app_prenota_id2,$app_orig_prenota_id,$inizio_prenota_id2,$fine_prenota_id2,$app_assegnabili_id2,$prenota_in_app_sett2,$dati_app,$PHPR_TAB_PRE."prenota");
} # fine if ($occupare_app_agenzia_sempre != "SI")
if ($fatto_libera == "SI") {
$testo_a_video .= "<div class=\"avail_line\">";
if ($num_tipologie == 1) {
$testo_a_video .= "$fr_C_e_ancora_disponibilita $fr_nel_periodo_richiesto";
if (count($tariffe_mostra) != 1) $testo_a_video .= " $fr_per_la_tipologia $nometariffa_imposta1";
} # fine if ($num_tipologie == 1)
else $testo_a_video .= "$fr_C_e_ancora_disponibilita $fr_nei_periodi_richiesti";
if ($id_app_richiesti > 1) $testo_a_video .= " $fr_in $id_app_richiesti $fr_appartamenti";
$testo_a_video .= ".<br></div>";
$liberato = "SI";
} # fine if ($fatto_libera == "SI")
else $limiti_var['t_limite'] = (time() + $sec_limite_libsett);
} # fine if ($num_app_agenzia != 0 and is_array($motivazioni_regola1))

if ($liberato != "SI") {
$app_orig_prenota_id = $app_prenota_id;
if ($num_app_agenzia == 0 or !is_array($motivazioni_regola1) or $mostra_frase_alternativa_regola1 == "SI") {
liberasettimane($idinizioperiodo_vett,$idfineperiodo_vett,$limiti_var,$anno,$fatto_libera,$app_liberato,$profondita,$app_richiesti,$app_prenota_id,$app_orig_prenota_id,$inizio_prenota_id,$fine_prenota_id,$app_assegnabili_id,$prenota_in_app_sett,$dati_app,$PHPR_TAB_PRE."prenota");
if ($fatto_libera == "SI") {
$liberato = "SI";
if ($num_app_agenzia != 0 and is_array($motivazioni_regola1)) echo $fr_alternativa_regola1.".<br>";
else {
$testo_a_video .= "<div class=\"avail_line\">";
if ($num_tipologie == 1) {
$testo_a_video .= "$fr_C_e_ancora_disponibilita $fr_nel_periodo_richiesto";
if (count($tariffe_mostra) != 1) $testo_a_video .= " $fr_per_la_tipologia $nometariffa_imposta1";
} # fine if ($num_tipologie == 1)
else $testo_a_video .= "$fr_C_e_ancora_disponibilita $fr_nei_periodi_richiesti";
if ($id_app_richiesti > 1) $testo_a_video .= " $fr_in $id_app_richiesti $fr_appartamenti";
$testo_a_video .= ".<br></div>";
} # fine else if ($num_app_agenzia != 0 and is_array($motivazioni_regola1))
} # fine if ($fatto_libera == "SI")
} # fine if ($num_app_agenzia == 0 or !is_array($motivazioni_regola1) or $mostra_frase_alternativa_regola1 == "SI")
if ($fatto_libera != "SI") {
if ($num_tipologie == 1) {
echo "$fr_Non_c_e_piu_disponibilita $fr_nel_periodo_richiesto $fr_per_la_tipologia $nometariffa_imposta1";
if ($numpersone) {
if ($numpersone == 1) $testo_a_video .= " $fr_per $numpersone $fr_persona";
else $testo_a_video .= " $fr_per $numpersone $fr_persone";
} # fine if ($numpersone)
} # fine if ($num_tipologie == 1)
else echo "$fr_Non_c_e_piu_disponibilita $fr_nei_periodi_richiesti $fr_per_le_tipologie_richieste";
if ($id_app_richiesti > 1) echo " $fr_in $id_app_richiesti $fr_appartamenti";
if ($app_eliminati_costi) echo " $fr_con_i_servizi_opzionali_selezionati";
echo ".<br>";
} # fine if ($fatto_libera != "SI")
} # fine if ($liberato != "SI")

$tabelle_lock = "";
$altre_tab_lock = array($tableprenota,$tablecostiprenota,$tablerclientiprenota,$tablenometariffe,$tableperiodi,$tableappartamenti,$tablenazioni,$tableregioni,$tablecitta,$tabledocumentiid,$tablecontratti,$tablepersonalizza,$tableutenti,$tablerelutenti,$tablerelinventario);
$tabelle_lock = lock_tabelle($tabelle_lock,$altre_tab_lock);

if ($liberato == "SI") {
$continuare_totale = "SI";
$costi_agg_in_form = "";
$costo_totale = 0;
$caparra_totale = 0;
unset($num_costi_presenti);
$dati_transazione16 = "";
$continuare = "SI";

for ($n_t = 1 ; $n_t <= $num_tipologie ; $n_t++) {
$inizioperiodo = ${"inizioperiodo".$n_t};
$fineperiodo = ${"fineperiodo".$n_t};
$numero_tariffa = ${"numero_tariffa".$n_t};
$tipotariffa = "tariffa".$numero_tariffa;
$numpersone = ${"numpersone".$n_t};
$num_app_tipo_richiesti = ${"num_app_tipo_richiesti".$n_t};
$nometariffa_imposta = ${"nometariffa_imposta".$n_t};
$numcostiagg = ${"numcostiagg".$n_t};
for ($numca = 1 ; $numca <= $numcostiagg ; $numca++) {
${"idcostoagg".$numca} = ${"idcostoagg".$numca."_".$n_t};
${"costoagg".$numca} = ${"costoagg".$numca."_".$n_t};
${"numsettimane".$numca} = ${"numsettimane".$numca."_".$n_t};
${"nummoltiplica_ca".$numca} = ${"nummoltiplica_ca".$numca."_".$n_t};
} # fine for $numca

$lunghezza_periodo = $idfineperiodo[$n_t] - $idinizioperiodo[$n_t] + 1;
unset($tariffesettimanali);
unset($lista_tariffep_sett);
$testo_a_video .= "<div class=\"period_line\"><br>";
if ($num_tipologie > 1) $testo_a_video .= "<b>$n_t</b>: ";
$testo_a_video .= "$fr_Periodo_di $lunghezza_periodo ";
if ($lunghezza_periodo == 1) $testo_a_video .= $fr_parola_settimana;
else $testo_a_video .= $fr_parola_settimane;
$testo_a_video .= " $fr_dal ".$data_inizioperiodo_f[$n_t]." $fr_al ".$data_fineperiodo_f[$n_t];
if ($numpersone) {
if ($numpersone == 1) $testo_a_video .= " $fr_per [numpersone$n_t] $fr_persona";
else $testo_a_video .= " $fr_per [numpersone$n_t] $fr_persone";
} # fine if ($numpersone)
if ($num_tipologie > 1) $testo_a_video .= " $fr_tipologia $nometariffa_imposta.<br></div><table><tr><td style=\"height: 2px;\"></td></tr></table>";
else $testo_a_video .= ".<br><br></div>";
$costo_tariffa = 0;
for ($num1 = $idinizioperiodo[$n_t] ; $num1 <= $idfineperiodo[$n_t] ; $num1++) {
$rigasettimana = esegui_query("select * from $tableperiodi where idperiodi = '$num1' ");
$costo_tariffa_settimana = risul_query($rigasettimana,0,$tipotariffa);
$costo_tariffap_settimana = risul_query($rigasettimana,0,$tipotariffa."p");
if (!strcmp($costo_tariffa_settimana,"") and !strcmp($costo_tariffap_settimana,"")) {
$continuare = "NO";
$continuare_totale = "NO";
echo $fr_Non_c_e_tariffa_per_questa_tipologia_ecc;
if ($num_tipologie > 1) echo " ($n_t)";
echo ".<br>";
break;
} # fine if (!strcmp($costo_tariffa_settimana,"") and !strcmp($costo_tariffap_settimana,""))
else {
if ($dati_tariffe[$tipotariffa]['moltiplica'] == "p") {
if (!$numpersone) {
$continuare = "NO";
$continuare_totale = "NO";
echo $fr_E_necessario_inserire_il_numero_di_persone_ecc;
if ($num_tipologie > 1) echo " ($n_t)";
echo ".<br>";
break;
} # fine if (!$numpersone)
if (!strcmp($costo_tariffa_settimana,"")) $costo_tariffa_settimana = 0;
if (!strcmp($costo_tariffap_settimana,"")) $costo_tariffap_settimana = 0;
$costo_tariffap_settimana = (double) $costo_tariffap_settimana * (double) $numpersone;
$lista_tariffep_sett .= ",".$costo_tariffap_settimana;
$costo_tariffa_settimana = (double) $costo_tariffa_settimana + $costo_tariffap_settimana;
} # fine if ($dati_tariffe[$tipotariffa]['moltiplica'] == "p")
$costo_tariffa = $costo_tariffa + $costo_tariffa_settimana;
$tariffesettimanali .= ",".$costo_tariffa_settimana;
} # fine else if (!strcmp($costo_tariffa_settimana,"") and !strcmp($costo_tariffap_settimana,""))
} # fine for $num1
$tariffesettimanali = substr($tariffesettimanali,1);
if ($lista_tariffep_sett) {
$lista_tariffep_sett = substr($lista_tariffep_sett,1);
$tariffesettimanali .= ";$lista_tariffep_sett";
} # fine if ($lista_tariffep_sett)

if ($continuare == "SI") {

$caparra = calcola_caparra($dati_tariffe,$tipotariffa,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$costo_tariffa,$tariffesettimanali);
if ($num_app_tipo_richiesti > 1) $caparra_pre_tot = $caparra * $num_app_tipo_richiesti;
else $caparra_pre_tot = $caparra;
$caparra_totale = $caparra_totale + $caparra_pre_tot;


# Costi aggiuntivi
$costi_agg_tot = 0;
unset($costi_agg_tot_vett);
$num_costi_agg = 0;
unset($nomi_costi_agg);
unset($prezzi_costi_agg);
unset($moltiplica_costi_agg);
unset($settimane_costi_agg);
unset($moltiplica_costo);
unset($settimane_costo);
unset($num_letti_agg);
unset($num_app_reali_costo);

$costi_aggiuntivi_sbagliati = "";
if ($numcostiagg == "") $numcostiagg = 0;
$numcostiagg_orig = $numcostiagg;
if (${"aggiungi_costo_letto".$n_t} == "SI") {
$numcostiagg++;
${"costoagg".$numcostiagg} = "SI";
${"idcostoagg".$numcostiagg} = $costo_aggiungi_letti;
${"nummoltiplica_ca".$numcostiagg} = ${"num_aggiungi_letti".$n_t};
${"costoagg".$numcostiagg."_".$n_t} = "SI";
${"idcostoagg".$numcostiagg."_".$n_t} = $costo_aggiungi_letti;
${"nummoltiplica_ca".$numcostiagg."_".$n_t} = ${"num_aggiungi_letti".$n_t};
${"numsettimane".$numcostiagg."_".$n_t} = "";
${"id_periodi_costo".$numcostiagg."_".$n_t} = "";
} # fine if (${"aggiungi_costo_letto".$n_t} == "SI")
${"numcostiagg_transazione".$n_t} = $numcostiagg;
if ($aggiungi_costi_fissi == "SI") {
for ($num1 = 0 ; $num1 < $dati_ca['num'] ; $num1++) {
if ($dati_ca[$num1]["tipo_associa_".$tipotariffa] == "r") $periodo_costo_trovato = trova_periodo_permesso_costo($dati_ca,$num1,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],1);
if ($dati_ca[$num1]["tipo_associa_".$tipotariffa] == "s" or ($dati_ca[$num1]["tipo_associa_".$tipotariffa] == "r" and $periodo_costo_trovato != "NO")) {
if (associa_costo_a_tariffa($dati_ca,$num1,$tipotariffa,$lunghezza_periodo) == "SI") {
$numcostiagg++;
${"costoagg".$numcostiagg} = "SI";
${"idcostoagg".$numcostiagg} = $dati_ca[$num1]['id'];
} # fine if (associa_costo_a_tariffa($dati_ca,$num1,$tipotariffa,$lunghezza_periodo) == "SI")
else {
if ($dati_ca[$num1]["tipo_associa_".$tipotariffa] == "r" and $dati_ca[$num1]['tipo'] == "s") {
$sett_costo = calcola_settimane_costo($tableperiodi,$dati_ca,$num1,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],"","");
if ($sett_costo) $costi_aggiuntivi_sbagliati .= ",$num1";
} # fine if ($dati_ca[$numca]["tipo_associa_".$tariffa] == "r" and...
else $costi_aggiuntivi_sbagliati .= ",$num1";
} # fine else if (associa_costo_a_tariffa($dati_ca,$num1,$tipotariffa,$lunghezza_periodo) == "SI")
} # fine if ($dati_ca[$num1]["tipo_associa_".$tipotariffa] == "s" or...
} # fine for $num1
} # fine if ($aggiungi_costi_fissi == "SI")
for ($numca = 1 ; $numca <= $numcostiagg ; $numca++) {
$costoagg = "costoagg".$numca;
$idcostoagg = "idcostoagg".$numca;
$num_costo = $dati_ca['id'][$$idcostoagg];
if ($costi_agg_mostra[$$idcostoagg] != "SI") $$costoagg = "";
if (($mostra_costi_aggiuntivi != "SI" or $dati_ca[$num_costo]['mostra'] != "s") and $numca <= $numcostiagg_orig) $$costoagg = "";
if ($$idcostoagg == $costo_aggiungi_letti and $numca <= $numcostiagg_orig) $$costoagg = "";
if ($$costoagg == "SI") {
$numsettimane = "numsettimane".$numca;
$nummoltiplica_ca = "nummoltiplica_ca".$numca;
$id_periodi_costo = "id_periodi_costo".$numca."_".$n_t;
if ($$idcostoagg != $dati_ca[$num_costo]['id']) $costi_aggiuntivi_sbagliati .= ",$num_costo";
if ($dati_ca[$num_costo]["incomp_".$tipotariffa] == "i") {
if ($dati_ca[$num_costo]['combina'] == "s") $$costoagg = "";
else $costi_aggiuntivi_sbagliati .= ",$num_costo";
} # fine if ($dati_ca[$num_costo]["incomp_".$tipotariffa] == "i")
if (!$$numsettimane and $dati_ca[$num_costo]['numsett'] == "c" and $dati_ca[$num_costo]['associasett'] != "s") $costi_aggiuntivi_sbagliati .= ",$num_costo";
if ($$numsettimane and ($$numsettimane > $lunghezza_periodo or controlla_num_pos($$numsettimane) == "NO")) $costi_aggiuntivi_sbagliati .= ",$num_costo";
if ($$nummoltiplica_ca and controlla_num_pos($$nummoltiplica_ca) == "NO") $costi_aggiuntivi_sbagliati .= ",$num_costo";
$numsettimane_aux = $$numsettimane;
if (trova_periodo_permesso_costo($dati_ca,$num_costo,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$numsettimane_aux) == "NO") {
if ($dati_ca[$num_costo]['combina'] == "s") $$costoagg = "";
else $costi_aggiuntivi_sbagliati .= ",$num_costo";
} # fine if (trova_periodo_permesso_costo($dati_ca,$num_costo,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$numsettimane_aux) == "NO")
if ($n_costi_agg_imposti[$$idcostoagg]) $nomecosto_imposto = $n_costi_agg_imposti[$$idcostoagg];
else $nomecosto_imposto = $dati_ca[$num_costo]['nome'];
${"costoagg".$numca."_".$n_t} = $$costoagg;

if ($$id_periodi_costo == "inserire") {
$$id_periodi_costo = "";
for ($num1 = $idinizioperiodo[$n_t]; $num1 <= $idfineperiodo[$n_t]; $num1++) {
if (${"sett".$num1."costo".$numca."_".$n_t} == "SI") $$id_periodi_costo .= ",".$num1;
} # fine for $num1
if ($$id_periodi_costo) $$id_periodi_costo .= ",";
else $$id_periodi_costo = "nessuno";
} # fine if ($$id_periodi_costo == "inserire")
if ($dati_ca[$num_costo]['numsett'] == "c" and $dati_ca[$num_costo]['associasett'] == "s" and $continuare != "NO" and !$$id_periodi_costo) {
$continuare = "NO";
$continuare_totale = "NO";
echo "<hr style=\"width: 30%;\">
$fr_Scegliere_le_settimane_in_cui_applicare \"".$nomecosto_imposto;
if ($num_tipologie > 1) echo " ($n_t)";
echo "\":<br>
<form accept-charset=\"utf-8\" method=\"post\" action=\"$pag\">
<div class=\"ftxt\">";
for ($num1 = $idinizioperiodo[$n_t]; $num1 <= $idfineperiodo[$n_t]; $num1++) {
$periodo_costo_trovato = "NO";
if ($dati_ca[$num_costo]['periodipermessi'] == "p") {
for ($num2 = 0 ; $num2 < count($dati_ca[$num_costo]['sett_periodipermessi_ini']) ; $num2++) {
if ($dati_ca[$num_costo]['sett_periodipermessi_ini'][$num2] <= $num1 and $dati_ca[$num_costo]['sett_periodipermessi_fine'][$num2] >= $num1) $periodo_costo_trovato = "SI";
} # fine for $num2
} # fine if ($dati_ca[$num_costo]['periodipermessi'] == "p")
else $periodo_costo_trovato = "SI";
if ($periodo_costo_trovato == "SI") {
$date_sett_costo = esegui_query("select datainizio,datafine from $tableperiodi where idperiodi = '$num1'");
echo "<label><input type=\"checkbox\" name=\"sett$num1"."costo$numca"."_$n_t\" value=\"SI\">$fr_dal
 ".formatta_data(risul_query($date_sett_costo,0,'datainizio'),$stile_data)." $fr_al
 ".formatta_data(risul_query($date_sett_costo,0,'datafine'),$stile_data)."</label><br>";
} # fine if ($periodo_costo_trovato == "SI")
} # fine for $num1
echo $dati_form_iniziale;
$$id_periodi_costo = "inserire";
for ($n_t2 = 1 ; $n_t2 < $n_t ; $n_t2++) for ($numca2 = 1 ; $numca2 <= $numcostiagg ; $numca2++) echo "<input type=\"hidden\" name=\"id_periodi_costo$numca2"."_$n_t2\" value=\"".${"id_periodi_costo".$numca2."_".$n_t2}."\">";
for ($numca2 = 1 ; $numca2 <= $numca ; $numca2++) echo "<input type=\"hidden\" name=\"id_periodi_costo$numca2"."_$n_t\" value=\"".${"id_periodi_costo".$numca2."_".$n_t}."\">";
echo "<input type=\"hidden\" name=\"contr_disp\" value=\"SI\">
<input class=\"sbutton\" type=\"submit\" value=\"$fr_Continua\">
</div></form><hr style=\"width: 30%;\">";
} # fine if ($dati_ca[$num_costo]['numsett'] == "c" and $dati_ca[$num_costo]['associasett'] == "s" and...
else {
$id_periodi_costo_aux = $$id_periodi_costo;
$numsettimane_aux = $$numsettimane;
$nummoltiplica_ca_aux = $$nummoltiplica_ca;
$settimane_costo[$numca] = calcola_settimane_costo($tableperiodi,$dati_ca,$num_costo,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$id_periodi_costo_aux,$numsettimane_aux);
aggiorna_letti_agg_in_periodi($dati_ca,$num_costo,$num_letti_agg,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo[$numca],"",$nummoltiplica_ca_aux,$numpersone);
} # fine else if ($dati_ca[$num_costo]['numsett'] == "c" and $dati_ca[$num_costo]['associasett'] == "s" and...

if (($dati_ca[$num_costo]['moltiplica'] == "p" or $dati_ca[$num_costo]['moltiplica'] == "t") and !$numpersone) {
$costi_aggiuntivi_sbagliati .= ",$num_costo";
echo $fr_Si_deve_inserire_il_numero_delle_persone_per." \"$nomecosto_imposto\".<br>";
if ($num_tipologie > 1) echo " ($n_t)";
} # fine if (($dati_ca[$num1]['moltiplica'] == "p" or $dati_ca[$num1]['moltiplica'] == "t") and !$numpersone)
} # fine if ($$costoagg == "SI")
} # fine for $numca

if ($num_app_tipo_richiesti > 1) $num_controlla_limite = $num_app_tipo_richiesti;
else $num_controlla_limite = 1;
for ($numca = 1 ; $numca <= $numcostiagg ; $numca++) {
if (${"costoagg".$numca} == "SI") {
$idcostoagg = "idcostoagg".$numca;
$num_costo = $dati_ca['id'][$$idcostoagg];
$nummoltiplica_ca_aux = ${"nummoltiplica_ca".$numca};
calcola_moltiplica_costo($dati_ca,$num_costo,$moltiplica_costo[$numca],$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo[$numca],$nummoltiplica_ca_aux,$numpersone,$num_letti_agg);
for ($num1 = 0 ; $num1 < $num_controlla_limite ; $num1++) if (controlla_num_limite_costo($tablecostiprenota,$tableprenota,$dati_ca,$num_costo,$num_costi_presenti,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo[$numca],$moltiplica_costo[$numca]) == "NO") $costi_aggiuntivi_sbagliati .= ",$num_costo";
if ($dati_ca[$num_costo]['tipo_beniinv'] == "mag") {
for ($num1 = 0 ; $num1 < $num_controlla_limite ; $num1++) {
$risul = controlla_beni_inventario_costo($tablerelinventario,$dati_ca,$num_costo,$beniinv_presenti,$num_ripetizioni_costo[$n_t][$num_costo],"SI",$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo[$numca],$moltiplica_costo[$numca],"");
if ($risul != "SI") { $costi_aggiuntivi_sbagliati .= ",$num_costo"; break; }
} # fine for $num1
} # fine if ($dati_ca[$num_costo]['tipo_beniinv'] == "mag")
if ($dati_ca[$num_costo]['moltiplica'] == "c" and $dati_ca[$num_costo]['molt_max'] != "x") {
$num_max = 0;
if ($dati_ca[$num_costo]['molt_max'] == "n") $num_max = $dati_ca[$num_costo]['molt_max_num'];
if ($dati_ca[$num_costo]['molt_max'] != "n" and $numpersone) $num_max = $numpersone;
if ($dati_ca[$num_costo]['molt_max'] == "t" and $num_letti_agg['max']) $num_max += $num_letti_agg['max'];
if ($num_max) {
if ($dati_ca[$num_costo]['molt_max'] != "n" and $dati_ca[$num_costo]['molt_max_num']) $num_max = $num_max - $dati_ca[$num_costo]['molt_max_num'];
if ($nummoltiplica_ca_aux > $num_max) $costi_aggiuntivi_sbagliati .= ",$num_costo";
} # fine if ($num_max)
} # fine if ($dati_ca[$num_costo]['moltiplica'] == "c" and $dati_ca[$num1]['molt_max'] != "x")
} # fine if (${"costoagg".$numca} == "SI")
} # fine for $numca

if ($costi_aggiuntivi_sbagliati) {
echo "$fr_Errore_nei_servizi_opzionali_richiesti (";
$costi_aggiuntivi_sbagliati = explode(",",substr($costi_aggiuntivi_sbagliati,1));
unset($costo_sbagliato);
for ($num1 = 0 ; $num1 < count($costi_aggiuntivi_sbagliati) ; $num1++) {
if (!$costo_sbagliato[$costi_aggiuntivi_sbagliati[$num1]]) {
$costo_sbagliato[$costi_aggiuntivi_sbagliati[$num1]] = "SI";
if ($num1 != 0) echo ",";
if ($n_costi_agg_imposti[$dati_ca[$costi_aggiuntivi_sbagliati[$num1]]['id']]) echo $n_costi_agg_imposti[$dati_ca[$costi_aggiuntivi_sbagliati[$num1]]['id']];
else echo $dati_ca[$costi_aggiuntivi_sbagliati[$num1]]['nome'];
} # fine (!$costo_sbagliato[$costi_aggiuntivi_sbagliati[$num1]])
} # fine for $num1
echo ").<br>";
$continuare = "NO";
$continuare_totale = "NO";
} # fine if ($costi_aggiuntivi_sbagliati)

elseif ($aggiungi_costi_fissi == "SI") {

# costi opzionali
if (!$numpersone) $numpersone_costi_poss = 0;
else $numpersone_costi_poss = $numpersone;
$oggi_costo = date("Ymd",(time() + (C_DIFF_ORE * 3600)));
for ($num_costo = 0 ; $num_costo < $dati_ca['num'] ; $num_costo++) {
if ($costi_agg_mostra[$dati_ca[$num_costo]['id']] == "SI") {
$associa_costo = "NO";
$associa_costo_tariffa = associa_costo_a_tariffa($dati_ca,$num_costo,$tipotariffa,$lunghezza_periodo);
if ($associa_costo_tariffa == "SI" and $dati_ca[$num_costo]["tipo_associa_".$tipotariffa] == "p") $associa_costo = "SI";
if ($associa_costo_tariffa != "SI" and !$dati_ca[$num_costo]["incomp_".$tipotariffa]) {
if ($dati_ca[$num_costo]['assegna_con_num_prenota'] and $id_app_richiesti >= $dati_ca[$num_costo]['assegna_con_num_prenota']) $associa_costo = "SI";
if ($dati_ca[$num_costo]['assegna_da_ini_prenota']) {
$giorni_lim = substr($dati_ca[$num_costo]['assegna_da_ini_prenota'],1);
$limite = date("Ymd",mktime(0,0,0,substr($data_inizioperiodo[$n_t],5,2),(substr($data_inizioperiodo[$n_t],8,2) - $giorni_lim),substr($data_inizioperiodo[$n_t],0,4)));
if (substr($dati_ca[$num_costo]['assegna_da_ini_prenota'],0,1) == ">" and $oggi_costo < $limite) $associa_costo = "SI";
if (substr($dati_ca[$num_costo]['assegna_da_ini_prenota'],0,1) == "<" and $oggi_costo > $limite) $associa_costo = "SI";
} # fine if ($dati_ca[$num_costo][assegna_da_ini_prenota])
} # fine if ($associa_costo_tariffa != "SI" and...
if ($associa_costo == "SI") {
$settimane_costo2 = calcola_settimane_costo($tableperiodi,$dati_ca,$num_costo,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],"","");
$num_letti_agg_copia = $num_letti_agg;
$beniinv_presenti_copia = $beniinv_presenti;
$num_app_reali_costo2 = "";

if ($dati_ca[$num_costo]['letto'] == "s") {
aggiorna_letti_agg_in_periodi($dati_ca,$num_costo,$num_letti_agg_copia,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo2,"","",$numpersone_costi_poss);
unset($moltiplica_copia);
unset($num_costi_presenti_copia);
unset($num_ripetizioni_copia);
for ($numca = 1 ; $numca <= $numcostiagg ; $numca++) {
if (${"costoagg".$numca} == "SI") {
$num_costo2 = $dati_ca['id'][${"idcostoagg".$numca}];
if ($num_app_reali_costo[$numca]) $num_controlla_limite2 = $num_app_reali_costo[$numca];
else $num_controlla_limite2 = $num_controlla_limite;
if ($dati_ca[$num_costo2]['moltiplica'] != "t") $moltiplica_copia[$numca] = $moltiplica_costo[$numca];
else calcola_moltiplica_costo($dati_ca,$num_costo2,$moltiplica_copia[$numca],$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo[$numca],"",$numpersone,$num_letti_agg_copia);
for ($num1 = 0 ; $num1 < $num_controlla_limite2 ; $num1++) if (controlla_num_limite_costo($tablecostiprenota,$tableprenota,$dati_ca,$num_costo2,$num_costi_presenti_copia,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo[$numca],$moltiplica_copia[$numca]) == "NO") $associa_costo = "NO";
if ($dati_ca[$num_costo2]['moltiplica'] == "t") {
for ($num1 = 0 ; $num1 < $num_controlla_limite2 ; $num1++) {
$risul = controlla_beni_inventario_costo($tablerelinventario,$dati_ca,$num_costo2,$beniinv_presenti_copia,$num_ripetizioni_copia[$numca],"SI",$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo[$numca],$moltiplica_copia[$numca],"",$num_ripetizioni_costo[$n_t][$num_costo2]);
if ($risul != "SI") $associa_costo = "NO";
} # fine for $num1
} # fine if ($dati_ca[$num_costo2]['moltiplica'] == "t")
} # fine if (${"costoagg".$numca} == "SI")
} # fine for $numca
} # fine if ($dati_ca[$num_costo][letto] == "s")
else $num_costi_presenti_copia = $num_costi_presenti;

calcola_moltiplica_costo($dati_ca,$num_costo,$moltiplica_costo2,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo2,"",$numpersone_costi_poss,$num_letti_agg_copia);
$periodo_costo_trovato = trova_periodo_permesso_costo($dati_ca,$num_costo,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo2);
if ($periodo_costo_trovato == "NO") $associa_costo = "NO";
else {
if (controlla_num_limite_costo($tablecostiprenota,$tableprenota,$dati_ca,$num_costo,$num_costi_presenti_copia,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo2,$moltiplica_costo2) == "NO") $associa_costo = "NO";
else for ($num1 = 1 ; $num1 < $num_controlla_limite ; $num1++) if (controlla_num_limite_costo($tablecostiprenota,$tableprenota,$dati_ca,$num_costo,$num_costi_presenti_copia,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo2,$moltiplica_costo2) == "NO") { $num_app_reali_costo2 = $num1; break; }
} # fine else if ($periodo_costo_trovato == "NO")
if ($dati_ca[$num_costo]['tipo_beniinv'] and $associa_costo == "SI") {
$nrc = "";
$risul = controlla_beni_inventario_costo($tablerelinventario,$dati_ca,$num_costo,$beniinv_presenti_copia,$nrc,"SI",$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo2,$moltiplica_costo2,"");
if ($risul != "SI") $associa_costo = "NO";
else {
for ($num1 = 1 ; $num1 < $num_controlla_limite ; $num1++) {
$beniinv_presenti_copia2 = $beniinv_presenti_copia;
$risul = controlla_beni_inventario_costo($tablerelinventario,$dati_ca,$num_costo,$beniinv_presenti_copia,$nrc,"SI",$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo2,$moltiplica_costo2,"");
if ($risul != "SI") {
$beniinv_presenti_copia = $beniinv_presenti_copia2;
if (!$num_app_reali_costo2 or $num1 < $num_app_reali_costo2) $num_app_reali_costo2 = $num1;
break;
} # fine if ($risul != "SI")
} # fine for $num1
} # fine else if ($risul != "SI")
} # fine if ($dati_ca[$num_costo]['tipo_beniinv'] and $associa_costo == "SI")

if ($associa_costo == "SI") {
$beniinv_presenti = $beniinv_presenti_copia;
if ($dati_ca[$num_costo]['letto'] == "s") {
$num_costi_presenti = $num_costi_presenti_copia;
$num_letti_agg = $num_letti_agg_copia;
for ($numca = 1 ; $numca <= $numcostiagg ; $numca++) {
if (${"costoagg".$numca} == "SI") {
$num_costo2 = $dati_ca['id'][${"idcostoagg".$numca}];
$moltiplica_costo[$numca] = $moltiplica_copia[$numca];
if ($dati_ca[$num_costo2]['moltiplica'] == "t") $num_ripetizioni_costo[$n_t][$num_costo2] = $num_ripetizioni_copia[$numca];
} # fine if (${"costoagg".$numca} == "SI")
} # fine for $numca
} # fine if ($dati_ca[$num_costo]['letto'] == "s")
$numcostiagg++;
$numca = $numcostiagg;
${"costoagg".$numca} = "SI";
${"idcostoagg".$numca} = $dati_ca[$num_costo]['id'];
$settimane_costo[$numca] = $settimane_costo2;
$moltiplica_costo[$numca] = $moltiplica_costo2;
if ($num_app_reali_costo2) $num_app_reali_costo[$numca] = $num_app_reali_costo2;
if ($dati_ca[$num_costo]['tipo_beniinv']) $num_ripetizioni_costo[$n_t][$num_costo] = $nrc;
} # fine if ($associa_costo == "SI")
} # fine if ($associa_costo == "SI")
} # fine if ($attiva_costi_agg_consentiti == "n" or $costi_agg_consentiti_vett[$dati_ca[$num_costo]['id']] == "SI")
} # fine for $num_costo

} # fine elseif ($aggiungi_costi_fissi == "SI")

$num_letti_agg_reg[$n_t] = $num_letti_agg['max'];
for ($num1 = 1 ; $num1 <= ${"num_app_tipo_richiesti".$n_t} ; $num1++) {
$num_costi_reg[$n_t][$num1] = 0;
$costo_tariffa_tot_reg[$n_t][$num1] = $costo_tariffa;
} # fine for $num1

for ($num1 = 2 ; $num1 <= $num_controlla_limite ; $num1++) $costi_agg_tot_vett[$num1] = (double) 0;
for ($num_costo = 0 ; $num_costo < $dati_ca['num'] ; $num_costo++) {
$idcostoagg = $dati_ca[$num_costo]['id'];
$costo_trovato = "NO";
for ($numca = 1 ; $numca <= $numcostiagg ; $numca++) if ($idcostoagg == ${"idcostoagg".$numca}) $costo_trovato = $numca;
if ($costo_trovato != "NO") {
$numca = $costo_trovato;
if (${"costoagg".$numca} == "SI") {
$prezzo_costo = calcola_prezzo_totale_costo($dati_ca,$num_costo,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo[$numca],$moltiplica_costo[$numca],$costo_tariffa,$tariffesettimanali,($costo_tariffa + $costi_agg_tot),$caparra,$numpersone);
$costi_agg_tot = $costi_agg_tot + $prezzo_costo;
if ($num_app_reali_costo[$numca]) $num_controlla_limite2 = $num_app_reali_costo[$numca];
else $num_controlla_limite2 = $num_controlla_limite;
for ($num1 = 2 ; $num1 <= $num_controlla_limite2 ; $num1++) {
$prezzo_costo_parz = calcola_prezzo_totale_costo($dati_ca,$num_costo,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$settimane_costo[$numca],$moltiplica_costo[$numca],$costo_tariffa,$tariffesettimanali,($costo_tariffa + $costi_agg_tot_vett[$num1]),$caparra,$numpersone);
$costi_agg_tot_vett[$num1] = $costi_agg_tot_vett[$num1] + $prezzo_costo_parz;
} # fine for $num1
$valnumsettimane_ca = $settimane_costo[$numca];
if ($dati_ca[$num_costo]['associasett'] == "s") {
$moltiplica = explode(",",$moltiplica_costo[$numca]);
$valnummoltiplica_ca = $moltiplica[1];
for ($num2 = 2 ; $num2 < (count($moltiplica) - 1) ; $num2++) if ($moltiplica[$num2] != $valnummoltiplica_ca) $valnummoltiplica_ca = 1;
$numsettimane = explode(",",$valnumsettimane_ca);
if ($dati_ca[$num_costo]['numsett'] == "c") {
$valnumsettimane_ca = "";
for ($num2 = 1 ; $num2 < (count($numsettimane) - 1) ; $num2++) {
$date_sett_costo = esegui_query("select datainizio,datafine from $tableperiodi where idperiodi = '".$numsettimane[$num2]."'");
$valnumsettimane_ca .= formatta_data(risul_query($date_sett_costo,0,'datainizio'),$stile_data)." $fr_al ".formatta_data(risul_query($date_sett_costo,0,'datafine'),$stile_data)."; ";
} # fine for $num2
$valnumsettimane_ca = " ".substr($valnumsettimane_ca,0,-2)." ";
} # fine if ($dati_ca[$num_costo][numsett] == "c")
else {
$valnumsettimane_ca = (count($numsettimane) - 2);
if ($valnumsettimane_ca < 0) $valnumsettimane_ca = 0;
} # fine else if ($dati_ca[$num_costo][numsett] == "c")
} # fine if ($dati_ca[$num_costo][associasett] == "s")
else $valnummoltiplica_ca = $moltiplica_costo[$numca];
if ($n_costi_agg_imposti[$idcostoagg]) $nomecosto_imposto = $n_costi_agg_imposti[$idcostoagg];
else $nomecosto_imposto = $dati_ca[$num_costo]['nome'];
$nomi_costi_agg[$num_costi_agg] = $nomecosto_imposto;
$moltiplica_costi_agg[$num_costi_agg] = $valnummoltiplica_ca;
$settimane_costi_agg[$num_costi_agg] = $valnumsettimane_ca;
$prezzi_costi_agg[$num_costi_agg] = $prezzo_costo;
$num_ripeti_costo[$num_costi_agg] = $num_app_reali_costo[$numca];
$num_costi_agg++;
for ($num1 = 1 ; $num1 <= $num_controlla_limite2 ; $num1++) {
$nome_costo_reg[$n_t][$num1][$num_costi_reg[$n_t][$num1]] = $nomecosto_imposto;
$val_costo_reg[$n_t][$num1][$num_costi_reg[$n_t][$num1]] = $prezzo_costo;
$tasseperc_costo_reg[$n_t][$num1][$num_costi_reg[$n_t][$num1]] = $dati_ca[$num_costo]['tasseperc'];
$moltmax_costo_reg[$n_t][$num1][$num_costi_reg[$n_t][$num1]] = $moltiplica_costo[$numca];
$costo_tariffa_tot_reg[$n_t][$num1] += $prezzo_costo;
$num_costi_reg[$n_t][$num1]++;
} # fine for $num1
} # fine if (${"costoagg".$numca} == "SI")
} # fine if ($costo_trovato != "NO")
} # fine for $num_costo


$commissioni = calcola_commissioni($dati_tariffe,$tipotariffa,$idinizioperiodo[$n_t],$idfineperiodo[$n_t],$tariffesettimanali,0,$costi_agg_tot);

$costo_tariffa_tot = $costo_tariffa + $costi_agg_tot;
$costo_totale = $costo_totale + $costo_tariffa_tot;
for ($num1 = 2 ; $num1 <= $num_controlla_limite ; $num1++) $costo_totale = $costo_totale + $costo_tariffa + $costi_agg_tot_vett[$num1];
$costo_tariffa_tot_p = punti_in_num($costo_tariffa_tot,$stile_soldi);
$costi_agg_tot_p = punti_in_num($costi_agg_tot,$stile_soldi);
$testo_a_video .= "<div class=\"price_line\">$fr_Prezzo:";
if ($anteponi_nome_valuta != "SI") $testo_a_video .= " ".$costo_tariffa_tot_p;
if ($costo_tariffa_tot == 1) $testo_a_video .= " $fr_Euro";
else $testo_a_video .= " $fr_Euros";
if ($anteponi_nome_valuta == "SI") $testo_a_video .= $costo_tariffa_tot_p;
$primo_tav = "SI";
for ($num1 = 0 ; $num1 < $num_costi_agg ; $num1++) {
if ($prezzi_costi_agg[$num1] != 0 and str_replace(" ","",$nomi_costi_agg[$num1]) != "") {
if ($primo_tav == "NO") $testo_a_video .=  ", ";
else $testo_a_video .= " ($fr_compresi ";
$primo_tav = "NO";
if ($anteponi_nome_valuta != "SI") $testo_a_video .= $prezzi_costi_agg[$num1]." ";
if ($prezzi_costi_agg[$num1] == 1) $testo_a_video .= $fr_Euro;
else $testo_a_video .= $fr_Euros;
if ($anteponi_nome_valuta == "SI") $testo_a_video .= $prezzi_costi_agg[$num1];
$testo_a_video .=  " $fr_di ".$nomi_costi_agg[$num1];
if ($num_ripeti_costo[$num_costi_agg] and $num_ripeti_costo[$num_costi_agg] > 1) $testo_a_video .=  " ($fr_per ".$num_ripeti_costo[$num_costi_agg]." $fr_appartamenti)";
if ($num_ripeti_costo[$num_costi_agg] == 1) $testo_a_video .=  " ($fr_per 1 $fr_appartamento)";
} # fine if ($prezzi_costi_agg[$num1] != 0 and...
} # fine for $num1
if ($primo_tav == "NO") $testo_a_video .= ")";
if ($num_app_tipo_richiesti > 1) $testo_a_video .= " x $num_app_tipo_richiesti";
$testo_a_video .= ".<br></div>";

if ($numpersone) {
if ($num_letti_agg['max']) {
$testo_a_video = str_replace("$fr_per [numpersone$n_t] $fr_persone","$fr_per ".($numpersone + $num_letti_agg['max'])." $fr_persone",$testo_a_video);
$testo_a_video = str_replace("$fr_per [numpersone$n_t] $fr_persona","$fr_per ".($numpersone + $num_letti_agg['max'])." $fr_persone",$testo_a_video);
} # fine if ($num_letti_agg['max'])
else {
$testo_a_video = str_replace("$fr_per [numpersone$n_t] $fr_persone","$fr_per $numpersone $fr_persone",$testo_a_video);
$testo_a_video = str_replace("$fr_per [numpersone$n_t] $fr_persona","$fr_per $numpersone $fr_persona",$testo_a_video);
} # fine else if ($num_letti_agg['max'])
} # fine if ($numpersone)

if ($mostra_richiesta_via_mail == "SI" and $manda_mail == "SI") {
if ($num_tipologie > 1) $testo_tipologie_email .= "$n_t: ";
$costo_tariffa_p = punti_in_num($costo_tariffa,$stile_soldi);
$dati_transazione16 .= ";$costo_tariffa,$caparra,".$num_letti_agg['max'].":";
$testo_tipologie_email .= "$fre_Periodo: $fre_dal ".$data_inizioperiodo_f[$n_t]." $fre_al ".$data_fineperiodo_f[$n_t]."\n";
if ($anteponi_nome_valuta != "SI") $testo_tipologie_email .= "$fre_Tariffa: ".$nometariffa_vedi[$n_t]." ($costo_tariffa_p $fr_Euro)\n";
else $testo_tipologie_email .= "$fre_Tariffa: ".$nometariffa_vedi[$n_t]." ($fr_Euro$costo_tariffa_p)\n";
if ($numpersone) $testo_tipologie_email .= "$fre_Persone: $numpersone\n";
$testo_tipologie_email .= "$fre_Costi_aggiuntivi: ";
for ($num1 = 0 ; $num1 < $num_costi_agg ; $num1++) {
$dati_transazione16 .= $prezzi_costi_agg[$num1].",".str_replace(","," ",str_replace(";"," ",str_replace(":"," ",$nomi_costi_agg[$num1]))).",".$num_ripeti_costo[$num_costi_agg].":";
if ($num1 > 0) $testo_tipologie_email .=  ", ";
$testo_tipologie_email .= $nomi_costi_agg[$num1];
if ($moltiplica_costi_agg[$num1] != 1) $testo_tipologie_email .= "(x".$moltiplica_costi_agg[$num1].")";
if ($settimane_costi_agg[$num1]) $testo_tipologie_email .= "(x".$settimane_costi_agg[$num1]."$fre_sett)";
if ($anteponi_nome_valuta != "SI") $testo_tipologie_email .= " ".$prezzi_costi_agg[$num1]." $fr_Euro";
else $testo_tipologie_email .= " $fr_Euro".$prezzi_costi_agg[$num1];
} # fine for $num1
$testo_tipologie_email .= "\n";
if ($num_app_tipo_richiesti > 1) {
$testo_tipologie_email .= "$fre_Numero_di_appartamenti: $num_app_tipo_richiesti\n";
} # fine if ($num_app_tipo_richiesti > 1)
$testo_tipologie_email .= "\n";
} # fine if ($mostra_richiesta_via_mail == "SI" and $manda_mail == "SI")

$costo_tariffa_reg[$n_t] = $costo_tariffa;
$tariffesettimanali_reg[$n_t] = $tariffesettimanali;
$caparra_reg[$n_t] = $caparra;
$commissioni_reg[$n_t] = $commissioni;

} # fine if ($continuare == "SI")
} # fine for $n_t

if ($continuare_totale == "SI") {
$costo_totale_p = punti_in_num($costo_totale,$stile_soldi);
if ($num_app_tipo_richiesti1 > 1 or $num_tipologie > 1) {
$testo_a_video .= "<br>$fr_Totale: ";
if ($anteponi_nome_valuta != "SI") $testo_a_video .= $costo_totale_p." ";
if ($costo_totale == 1) $testo_a_video .= $fr_Euro;
else $testo_a_video .= $fr_Euros;
if ($anteponi_nome_valuta == "SI") $testo_a_video .= $costo_totale_p;
$testo_a_video .= ".<br>";
} # fine if ($num_app_tipo_richiesti1 > 1 or $num_tipologie > 1)
if ($mostra_caparra == "SI" and $caparra_totale > 0) {
$caparra_totale_p = punti_in_num($caparra_totale,$stile_soldi);
$testo_a_video .= "<br>$fr_Caparra: ";
if ($anteponi_nome_valuta != "SI") $testo_a_video .= $caparra_totale_p." ";
if ($caparra_totale == 1) $testo_a_video .= $fr_Euro;
else $testo_a_video .= $fr_Euros;
if ($anteponi_nome_valuta == "SI") $testo_a_video .= $caparra_totale_p;
$testo_a_video .= ".<br>";
} # fine if ($mostra_caparra == "SI" and $caparra_totale > 0)

$num_campi_doc_cond = 0;
$campi_form_doc_cond = "";
$chiedi_campi_form_doc_cond = "";
$num_campi_doc_condizioni = count($campi_form_doc_condizioni);
if (!function_exists('crea_contratto')) $num_campi_doc_condizioni = 0;
if ($num_campi_doc_condizioni) {
$nome_contratto = "";
$nomi_contratti = esegui_query("select valpersonalizza from $tablepersonalizza where idpersonalizza = 'nomi_contratti' and idutente = '$utente_liste' ");
if (numlin_query($nomi_contratti)) {
$nomi_contratti = explode("#@&",risul_query($nomi_contratti,0,'valpersonalizza'));
$num_nomi_contratti = count($nomi_contratti);
for ($num1 = 0 ; $num1 < $num_nomi_contratti ; $num1++) {
$dati_nome_contratto = explode("#?&",$nomi_contratti[$num1]);
if (strcmp($dati_nome_contratto[1],"")) $nome_contratto[$dati_nome_contratto[0]] = $dati_nome_contratto[1];
} # fine for $num1
} # fine if (numlin_query($nomi_contratti))
for ($num1 = 1 ; $num1 <= $num_campi_doc_condizioni ; $num1++) {
$num_doc = $campi_form_doc_condizioni[$num1];
if (controlla_num_pos($num_doc) == "SI") {
$contr_txt = esegui_query("select * from $tablecontratti where (tipo = 'contrtxt' or tipo = 'contrhtm') and numero = '$num_doc' ");
if (numlin_query($contr_txt)) {
$salva_contr = esegui_query("select numero from $tablecontratti where numero = '$num_doc' and tipo = 'dir' ");
if (!numlin_query($salva_contr)) {
$num_campi_doc_cond++;
$campi_form_doc_cond[$num_campi_doc_cond] = $num_doc;
$chiedi_campi_form_doc_cond[$num_campi_doc_cond] = $chiedi_campi_form_doc_condizioni[$num1];
$campi_form_doc_cond['tipo'][$num_campi_doc_cond] = substr(risul_query($contr_txt,0,'tipo'),5);
} # fine if (!numlin_query($salva_contr))
} # fine if (numlin_query($contr_txt))
} # fine if (controlla_num_pos($num_doc) == "SI")
} # fine for $num1
} # fine if ($num_campi_doc_condizioni)


$mostra_c_e_disp = "SI";
if ($mostra_richiesta_via_mail == "SI" and $manda_mail == "SI") {
$mostra_c_e_disp = "NO";
$inviare = "SI";

$num_campi_pers = count($campi_form_personalizzati);
if (@get_magic_quotes_gpc()) {
$cognome_richiedente = stripslashes($cognome_richiedente);
$nome_richiedente = stripslashes($nome_richiedente);
$documento = stripslashes($documento);
$tipodoc = stripslashes($tipodoc);
$nazione = stripslashes($nazione);
$regione = stripslashes($regione);
$citta = stripslashes($citta);
$via = stripslashes($via);
$numcivico = stripslashes($numcivico);
$cap = stripslashes($cap);
$telefono = stripslashes($telefono);
$telefono2 = stripslashes($telefono2);
$telefono3 = stripslashes($telefono3);
$fax = stripslashes($fax);
$commento = stripslashes($commento);
for ($num1 = 1 ; $num1 <= $num_campi_pers ; $num1++) ${"campo_pers".$num1} = stripslashes(${"campo_pers".$num1});
} # fine if (@get_magic_quotes_gpc())
$cognome_richiedente = htmlspecialchars($cognome_richiedente);
$nome_richiedente = htmlspecialchars($nome_richiedente);
$documento = htmlspecialchars($documento);
$tipodoc = htmlspecialchars($tipodoc);
$nazione = htmlspecialchars($nazione);
$regione = htmlspecialchars($regione);
$citta = htmlspecialchars($citta);
$via = htmlspecialchars($via);
$numcivico = htmlspecialchars($numcivico);
$cap = htmlspecialchars($cap);
$telefono = htmlspecialchars($telefono);
$telefono2 = htmlspecialchars($telefono2);
$telefono3 = htmlspecialchars($telefono3);
$fax = htmlspecialchars($fax);
$commento = htmlspecialchars($commento);
for ($num1 = 1 ; $num1 <= $num_campi_pers ; $num1++) ${"campo_pers".$num1} = htmlspecialchars(${"campo_pers".$num1});

if ($chiedi_cognome == "NO") $cognome_richiedente = "";
if ($chiedi_cognome == "SI" and !$cognome_richiedente) {
$cognome_richiedente_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_cognome == "SI" and !$cognome_richiedente)
if ($chiedi_nome == "NO") $nome_richiedente = "";
if ($chiedi_nome == "SI" and !$nome_richiedente) {
$nome_richiedente_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_nome == "SI" and !nome_richiedente)
if ($chiedi_email == "NO") $email_richiedente = "";
if ($chiedi_email == "SI" and !preg_match('/^[_\.0-9a-z-]+@([0-9a-z][0-9a-z-]+\.)+[a-z]{2,4}$/i',$email_richiedente)) {
$email_richiedente_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_email == "SI" and...
if ($chiedi_sesso == "NO") $sesso = "";
if ($sesso and $sesso != "M" and $sesso != "F") $sesso = "";
if ($chiedi_sesso == "SI" and !$sesso) {
$sesso_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_sesso == "SI" and !$sesso)
if ($chiedi_datanascita == "NO") $annonascita = "";
if (!preg_match("/[0-9]{4,4}/",$annonascita)) $annonascita = "";
if (!preg_match("/[0-9]{2,2}/",$mesenascita) or $mesenascita > 12) $mesenascita = "";
if (!preg_match("/[0-9]{2,2}/",$giornonascita) or $giornonascita > 31) $giornonascita = "";
if ($annonascita and $mesenascita and $giornonascita) $datanascita = $annonascita."-".$mesenascita."-".$giornonascita;
else $datanascita = "";
if ($chiedi_datanascita == "SI" and !$datanascita) {
$datanascita_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_datanascita == "SI" and !$datanascita)
if ($chiedi_documento == "NO") {
$documento = "";
$tipodoc = "";
} # fine if ($chiedi_documento == "NO")
else {
$lista_tipi_doc = mostra_lista_relutenti("tipodoc",$tipodoc,$utente_liste,"nome_documentoid","iddocumentiid","iddocumentoid",$tabledocumentiid,$tablerelutenti,"","","SI");
if (!$lista_tipi_doc) $tipodoc = "";
elseif (str_replace(">$tipodoc<","",$lista_tipi_doc) == $lista_tipi_doc) $tipodoc = "";
} # fine else if ($chiedi_documento == "NO")
if ($chiedi_documento == "SI" and (!$documento or ($lista_tipi_doc and !$tipodoc))) {
$documento_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_documento == "SI" and (!$documento or...
if ($chiedi_nazione == "NO") $nazione = "";
else {
$lista_nazioni = mostra_lista_relutenti("nazione",$nazione,$utente_liste,"nome_nazione","idnazioni","idnazione",$tablenazioni,$tablerelutenti,"","","SI");
if ($lista_nazioni and str_replace(">$nazione<","",$lista_nazioni) == $lista_nazioni) $nazione = "";
} # fine else if ($chiedi_nazione == "NO")
if ($chiedi_nazione == "SI" and !$nazione) {
$nazione_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_nazione == "SI" and !$nazione)
if ($chiedi_regione == "NO") $regione = "";
if ($chiedi_regione == "SI" and !$regione) {
$regione_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_regione == "SI" and !$regione)
if ($chiedi_citta == "NO") $citta = "";
if ($chiedi_citta == "SI" and !$citta) {
$citta_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_citta == "SI" and !$citta)
if ($chiedi_via == "NO") $via = "";
if ($chiedi_via == "SI" and !$via) {
$via_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_via == "SI" and !$via)
if ($chiedi_numcivico == "NO") $numcivico = "";
if ($chiedi_numcivico == "SI" and !$numcivico) {
$numcivico_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_numcivico == "SI" and !$numcivico)
if ($chiedi_cap == "NO") $cap = "";
if ($chiedi_cap == "SI" and !$cap) {
$cap_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_cap == "SI" and !$cap)
if ($chiedi_telefono == "NO") $telefono = "";
if (($chiedi_telefono == "SI" and (strlen($telefono) - strlen(preg_replace("/[0-9]/","",$telefono))) < 5) or strlen($telefono) > 50) { $inviare = "NO"; $telefono_sb = "SI"; }
if ($chiedi_telefono2 == "NO") $telefono2 = "";
if (($chiedi_telefono2 == "SI" and (strlen($telefono2) - strlen(preg_replace("/[0-9]/","",$telefono2))) < 5) or strlen($telefono2) > 50) { $inviare = "NO"; $telefono2_sb = "SI"; }
if ($chiedi_telefono3 == "NO") $telefono3 = "";
if (($chiedi_telefono3 == "SI" and (strlen($telefono3) - strlen(preg_replace("/[0-9]/","",$telefono3))) < 5) or strlen($telefono3) > 50) { $inviare = "NO"; $telefono3_sb = "SI"; }
if ($chiedi_fax == "NO") $fax = "";
if (($chiedi_fax == "SI" and (strlen($fax) - strlen(preg_replace("/[0-9]/","",$fax))) < 5) or strlen($fax) > 50) { $inviare = "NO"; $fax_sb = "SI"; }
if ($chiedi_commento == "NO") $commento = "";
if ($chiedi_commento == "SI" and !$commento) {
$commento_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_commento == "SI" and !$commento)
$oracheckin = "";
if ($chiedi_oracheckin == "NO") $ora_oracheckin = "";
if (!preg_match("/[0-9]{4,4}-[0-9]{2,2}-[0-9]{2,2}/",$data_oracheckin)) $data_oracheckin = "";
if (!preg_match("/[0-9]{2,2}/",$ora_oracheckin) or $ora_oracheckin > 23) $ora_oracheckin = "";
if ($min_oracheckin != "00" and $min_oracheckin != "15" and $min_oracheckin != "30" and $min_oracheckin != "45") $min_oracheckin = "";
if ($data_oracheckin and $ora_oracheckin and $min_oracheckin) $oracheckin = $data_oracheckin." ".$ora_oracheckin.":".$min_oracheckin;
if ($chiedi_oracheckin == "SI" and !$oracheckin) {
$oracheckin_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_oracheckin == "SI" and !$oracheckin)
if ($caparra_totale > 0 and $chiedi_metodopagamento != "NO") {
if ($metodo_pagamento) {
if (@get_magic_quotes_gpc()) $metodo_pagamento = stripslashes($metodo_pagamento);
$metodo_trovato = "NO";
reset($metodi_pagamento_da_chiedere);
while (list($metodo,$val) = each($metodi_pagamento_da_chiedere)) {
if ($metodo == $metodo_pagamento) $metodo_trovato = "SI";
} # fine while (list($metodo,$val) = each($metodi_pagamento_da_chiedere))
if ($metodo_trovato == "NO") $metodo_pagamento = "";
} # fine if ($metodo_pagamento)
if ($chiedi_metodopagamento == "SI" and !$metodo_pagamento and count($metodi_pagamento_da_chiedere)) {
$metodopagamento_sb = "SI";
$inviare = "NO";
} # fine if ($chiedi_metodopagamento == "SI" and !$metodo_pagamento and...
} # fine if ($caparra_totale > 0 and $chiedi_metodopagamento != "NO")
else $metodo_pagamento = "";
for ($num1 = 1 ; $num1 <= $num_campi_pers ; $num1++) {
if ($chiedi_campi_form_personalizzati[$num1] == "SI" and !${"campo_pers".$num1}) {
${"campo_pers_sb".$num1} = "SI";
$inviare = "NO";
} # fine if ($chiedi_campi_form_personalizzati[$num1] == "SI" and !${"campo_pers".$num1})
} # fine for $num1
for ($num1 = 1 ; $num1 <= $num_campi_doc_cond ; $num1++) {
if ($chiedi_campi_form_doc_cond[$num1] == "SI") {
$num_contr = $campi_form_doc_cond[$num1];
if (${"cond_contr".$num_contr} != "SI") { $inviare = "NO"; ${"cond_contr_sb".$num_contr} = "SI"; }
} # fine if ($chiedi_campi_form_doc_cond[$num1] == "SI")
} # fine for $num1

if ($inviare == "SI") {
if ($PHP_SELF != str_replace($pag,"",$PHP_SELF)) $riferimento = $PHP_SELF;
else $riferimento = $pag;
if ($_SERVER['REMOTE_ADDR']) $REMOTE_ADDR = $_SERVER['REMOTE_ADDR'];
$REMOTE_ADDR = htmlspecialchars($REMOTE_ADDR);
$REMOTE_ADDR = aggslashdb($REMOTE_ADDR);

$testo_email = "$fre_Riferimento: $riferimento\nIP: $REMOTE_ADDR\n\n";
if ($cognome_richiedente) $testo_email .= "$fre_Cognome: $cognome_richiedente\n";
if ($nome_richiedente) $testo_email .= "$fre_Nome: $nome_richiedente\n";
if ($email_richiedente) $testo_email .= "$fre_Email: $email_richiedente\n";
if ($sesso) $testo_email .= "$fre_Genere: $sesso\n";
if ($datanascita) $testo_email .= "$fre_Data_di_nascita: ".formatta_data($datanascita,$stile_data)."\n";
if ($documento) $testo_email .= "$fre_Documento: $tipodoc $documento\n";
if ($nazione) $testo_email .= "$fre_Nazione: $nazione\n";
if ($regione) $testo_email .= "$fre_Regione: $regione\n";
if ($citta) $testo_email .= "$fre_Citta: $citta\n";
if ($via) $testo_email .= "$fre_Via: $via\n";
if ($numcivico) $testo_email .= "$fre_Numero_civico: $numcivico\n";
if ($cap) $testo_email .= "$fre_Codice_postale: $cap\n";
if ($telefono) $testo_email .= "$fre_Telefono: $telefono\n";
if ($telefono2) $testo_email .= "$fre_Secondo_telefono: $telefono2\n";
if ($telefono3) $testo_email .= "$fre_Terzo_telefono: $telefono3\n";
if ($fax) $testo_email .= "$fre_Fax: $fax\n";
if ($commento) $testo_email .= "$fre_Commento: $commento\n\n";
if ($oracheckin) $testo_email .= "$fre_Orario_stimato_di_arrivo: ".formatta_data($oracheckin,$stile_data)."\n";
if ($metodo_pagamento) $testo_email .= "$fre_Metodo_di_pagamento_della_caparra: $metodo_pagamento\n";
for ($num1 = 1 ; $num1 <= $num_campi_pers ; $num1++) {
if (${"campo_pers".$num1}) $testo_email .= $campi_form_personalizzati[$num1].": ".${"campo_pers".$num1}."\n";
} # fine for $num1
for ($num1 = 1 ; $num1 <= $num_campi_doc_cond ; $num1++) {
if ($chiedi_campi_form_doc_cond[$num1] != "SI") {
$num_contr = $campi_form_doc_cond[$num1];
$nome_contr = $nome_contratto[$num_contr];
if (!strcmp($nome_contr,"")) $nome_contr = "doc$num_contr";
if (${"cond_contr".$num_contr} == "SI") $testo_email .= $nome_contr."\n";
} # fine if ($chiedi_campi_form_doc_cond[$num1] != "SI")
} # fine for $num1

$testo_email .= "\n".$testo_tipologie_email;
if ($anteponi_nome_valuta != "SI") $testo_email .= "$fre_Prezzo_totale: $costo_totale_p $fr_Euro\n";
else $testo_email .= "$fre_Prezzo_totale: $fr_Euro$costo_totale_p\n";
if ($mostra_caparra == "SI" and $caparra_totale > 0) {
if ($anteponi_nome_valuta != "SI") $testo_email .= "\n$fre_Caparra: $caparra_totale $fr_Euro\n";
else $testo_email .= "\n$fre_Caparra: $fr_Euro$caparra_totale\n";
} # fine if ($mostra_caparra == "SI" and $caparra_totale > 0)

if ($indirizzo_email) {
if ($cognome_richiedente) {
if ($nome_richiedente) $nome_da = $nome_richiedente." ".$cognome_richiedente;
else $nome_da = $cognome_richiedente;
} # fine if ($cognome_richiedente)
else $nome_da = $REMOTE_ADDR;
if ($email_richiedente) $email_da = $email_richiedente;
else $email_da = $indirizzo_email;
switch (strtoupper(substr(PHP_OS,0,3))) {
case "WIN": $mailh_nl = "\r\n"; break;
case "MAC": $mailh_nl = "\r"; break;
default: $mailh_nl = "\n"; break;
} # fine switch (strtoupper(substr(PHP_OS,0,3)))
$headers = "From: \"$nome_da\" <$email_da>$mailh_nl";
$headers .= "Content-type: text/plain; charset=utf-8$mailh_nl";
$headers .= "Content-Transfer-Encoding: base64$mailh_nl";
$headers .= "X-Sender: <$email_da>$mailh_nl";
$headers .= "X-Mailer: PHP$mailh_nl";
$headers .= "X-Priority: 3$mailh_nl";
$headers .= "Return-Path: <$email_da>$mailh_nl";
if ($maschera_envelope == "SI") $inviato = mail($indirizzo_email,$fre_Richesta_prenotazione,chunk_split(base64_encode($testo_email)),$headers,"-f$email_richiedente");
else $inviato = mail($indirizzo_email,$fre_Richesta_prenotazione,chunk_split(base64_encode($testo_email)),$headers);
$inviato_c = "";
if ($manda_copia_richiesta_email == "SI" and $email_richiedente) {
$headers = "From: <$indirizzo_email>$mailh_nl";
$headers .= "Content-type: text/plain; charset=utf-8$mailh_nl";
$headers .= "Content-Transfer-Encoding: base64$mailh_nl";
$headers .= "X-Sender: <$indirizzo_email>$mailh_nl";
$headers .= "X-Mailer: PHP$mailh_nl";
$headers .= "X-Priority: 3$mailh_nl";
$headers .= "Return-Path: <$indirizzo_email>$mailh_nl";
$testo_email_copia = "
$fr_Abbiamo_ricevuto_la_sua_richiesta_di_prenotazione_ecc.


".preg_replace("/<[^>]*>/","",str_replace("<br>","\n",$testo_a_video))."


If you received this email without requesting it, it is because someone
with ip address $REMOTE_ADDR has used your email address in our form. In 
this case you can ignore this message.";
if ($maschera_envelope == "SI") $inviato_c = mail($email_richiedente,$fr_Richesta_prenotazione,chunk_split(base64_encode($testo_email_copia)),$headers,"-f$indirizzo_email");
else $inviato_c = mail($email_richiedente,$fr_Richesta_prenotazione,chunk_split(base64_encode($testo_email_copia)),$headers);
} # fine if ($manda_copia_richiesta_email == "SI")
} # fine if ($indirizzo_email)

if ($utente_messaggio) {
unlock_tabelle($tabelle_lock);
$tabelle_lock = array($tablemessaggi);
$altre_tab_lock = array($tablepersonalizza,$tableutenti);
$tabelle_lock = lock_tabelle($tabelle_lock,$altre_tab_lock);
$utente_trovato = "SI";
if ($utente_messaggio == "tutti") {
$tutti_utenti = esegui_query("select * from $tableutenti order by idutenti");
$num_tutti_utenti = numlin_query($tutti_utenti);
$lista_utenti = ",";
for ($num1 = 0 ; $num1 < $num_tutti_utenti ; $num1++) {
$idutenti = risul_query($tutti_utenti,$num1,'idutenti');
$lista_utenti .= $idutenti.",";
} # fine for $num1
} # fine if ($utente_messaggio == "tutti")
else {
$utente_esistente = esegui_query("select idutenti from $tableutenti where nome_utente = '$utente_messaggio'");
if (numlin_query($utente_esistente) != 1) $utente_trovato = "NO";
else $lista_utenti = ",".risul_query($utente_esistente,0,'idutenti').",";
} # fine else if ($utente_messaggio == "tutti")
if ($utente_trovato == "SI") {
$data_limite = date("Y-m-d H:i:s",(time() + (C_DIFF_ORE * 3600) - (24 * 3600)));
$richieste_precedenti = esegui_query("select idmessaggi from $tablemessaggi where tipo_messaggio = 'rprenota' and dati_messaggio17 = '$REMOTE_ADDR' and  datainserimento > '$data_limite'");
if (numlin_query($richieste_precedenti) > 30) $utente_trovato = "NO";
} # fine if ($utente_trovato == "SI")
if ($utente_trovato == "SI") {
$cognome_richiedente = htmlspecialchars($cognome_richiedente);
$nome_richiedente = htmlspecialchars($nome_richiedente);
$email_richiedente = htmlspecialchars($email_richiedente);
$sesso = htmlspecialchars($sesso);
$datanascita = htmlspecialchars($datanascita);
$documento = htmlspecialchars($documento);
$tipodoc = htmlspecialchars($tipodoc);
$nazione = htmlspecialchars($nazione);
$regione = htmlspecialchars($regione);
$citta = htmlspecialchars($citta);
$via = htmlspecialchars($via);
$numcivico = htmlspecialchars($numcivico);
$cap = htmlspecialchars($cap);
$telefono = htmlspecialchars($telefono);
$telefono2 = htmlspecialchars($telefono2);
$telefono3 = htmlspecialchars($telefono3);
$fax = htmlspecialchars($fax);
$commento = htmlspecialchars($commento);
$oracheckin = htmlspecialchars($oracheckin);
$metodo_pagamento = htmlspecialchars($metodo_pagamento);
if ((string) $origine_prenotazione != "") {
$origini_prenota = esegui_query("select valpersonalizza from $tablepersonalizza where idpersonalizza = 'origini_prenota' and idutente = '1'");
$origini_prenota = risul_query($origini_prenota,0,'valpersonalizza');
if ($origini_prenota) {
$origini_prenota = explode(",",$origini_prenota);
$orig_prenota_trovata = "NO";
for ($num1 = 0 ; $num1 < count($origini_prenota) ; $num1++) if ($origini_prenota[$num1] == $origine_prenotazione) $orig_prenota_trovata = "SI";
if ($orig_prenota_trovata == "NO") $origine_prenotazione = "";
} # fine if ($origini_prenota)
else $origine_prenotazione = "";
$origine_prenotazione = aggslashdb($origine_prenotazione);
} # fine if ((string) $origine_prenotazione != "")
$max_mess = esegui_query("select max(idmessaggi) from $tablemessaggi");
if (numlin_query($max_mess) != 0) $max_mess = (risul_query($max_mess,0,0) + 1);
else $max_mess = 1;
$datainserimento = date("Y-m-d H:i:s",(time() + (C_DIFF_ORE * 3600)));
$mittente = $REMOTE_ADDR;
if ($email_richiedente) $mittente = "<a style=\"color: #222222;\" href=\"mailto:$email_richiedente\">$email_richiedente</a>";
else if ($cognome_richiedente) $mittente = $cognome_richiedente;
$mittente = aggslashdb($mittente);
$testo_email = htmlspecialchars($testo_email);
$testo_email = aggslashdb($testo_email);

$dati_transazione3 = aggslashdb($num_tipologie);
$dati_transazione4 = "";
$dati_transazione5 = "";
$dati_transazione6 = "";
$dati_transazione7 = "";
$dati_transazione8 = "";
$dati_transazione9 = "";
$dati_transazione10 = "";
$dati_transazione11 = "";
$dati_transazione12 = "";
$dati_transazione13 = "";
$dati_transazione14 = "";
for ($n_t = 1 ; $n_t <= $num_tipologie ; $n_t++) {
$dati_transazione4 .= ",".aggslashdb(${"inizioperiodo".$n_t});
$dati_transazione5 .= ",".aggslashdb(${"fineperiodo".$n_t});
$dati_transazione6 .= ",".aggslashdb(${"numero_tariffa".$n_t});
$dati_transazione7 .= ",".aggslashdb(${"numpersone".$n_t});
$dati_transazione8 .= ",".aggslashdb(${"num_app_tipo_richiesti".$n_t});
$dati_transazione9 .= ",".aggslashdb(${"numcostiagg_transazione".$n_t});
$dati_transazione10 .= ";";
$dati_transazione11 .= ";";
$dati_transazione12 .= ";";
$dati_transazione13 .= ";";
$dati_transazione14 .= ";";
for ($numca = 1 ; $numca <= ${"numcostiagg_transazione".$n_t} ; $numca++) {
if ($numca > 1) {
$dati_transazione10 .= ",";
$dati_transazione11 .= ",";
$dati_transazione12 .= ",";
$dati_transazione13 .= ",";
$dati_transazione14 .= ":";
} # fine if ($numca > 1)
$dati_transazione10 .= aggslashdb(${"idcostoagg".$numca."_".$n_t});
$dati_transazione11 .= aggslashdb(${"costoagg".$numca."_".$n_t});
$dati_transazione12 .= aggslashdb(${"numsettimane".$numca."_".$n_t});
$dati_transazione13 .= aggslashdb(${"nummoltiplica_ca".$numca."_".$n_t});
$dati_transazione14 .= aggslashdb(${"id_periodi_costo".$numca."_".$n_t});
} # fine for $numca
} # fine for $n_t
$dati_transazione4 = substr($dati_transazione4,1);
$dati_transazione5 = substr($dati_transazione5,1);
$dati_transazione6 = substr($dati_transazione6,1);
$dati_transazione7 = substr($dati_transazione7,1);
$dati_transazione8 = substr($dati_transazione8,1);
$dati_transazione9 = substr($dati_transazione9,1);
$dati_transazione10 = substr($dati_transazione10,1);
$dati_transazione11 = substr($dati_transazione11,1);
$dati_transazione12 = substr($dati_transazione12,1);
$dati_transazione13 = substr($dati_transazione13,1);
$dati_transazione14 = substr($dati_transazione14,1);
$dati_transazione15 = aggslashdb($cognome_richiedente)."<d>".aggslashdb($nome_richiedente)."<d>".aggslashdb($email_richiedente)."<d>".aggslashdb($sesso)."<d>".aggslashdb($datanascita)."<d>".aggslashdb($documento)."<d>".aggslashdb($nazione)."<d>".aggslashdb($regione)."<d>";
$dati_transazione15 .= aggslashdb($citta)."<d>".aggslashdb($via)."<d>".aggslashdb($numcivico)."<d>".aggslashdb($cap)."<d>".aggslashdb($telefono)."<d>".aggslashdb($telefono2)."<d>".aggslashdb($telefono3)."<d>".aggslashdb($fax)."<d>".aggslashdb($oracheckin)."<d>".aggslashdb($metodo_pagamento)."<d>".aggslashdb($tipodoc)."<d>".aggslashdb($lingua_modello);
$dati_transazione16 = substr($dati_transazione16,1);

esegui_query("insert into $tablemessaggi (idmessaggi,tipo_messaggio,idutenti,idutenti_visto,datavisione,mittente,testo,dati_messaggio1,dati_messaggio2,dati_messaggio3,dati_messaggio4,dati_messaggio5,dati_messaggio6,dati_messaggio7,dati_messaggio8,dati_messaggio9,dati_messaggio10,dati_messaggio11,dati_messaggio12,dati_messaggio13,dati_messaggio14,dati_messaggio15,dati_messaggio16,dati_messaggio17,dati_messaggio18,dati_messaggio19,datainserimento)
 values ('$max_mess','rprenota','$lista_utenti','$lista_utenti','$datainserimento','$mittente','$testo_email','da_inserire','$costo_totale,$caparra_totale','$dati_transazione3','$dati_transazione4','$dati_transazione5','$dati_transazione6','$dati_transazione7','$dati_transazione8','$dati_transazione9','$dati_transazione10','$dati_transazione11','$dati_transazione12','$dati_transazione13','$dati_transazione14','$dati_transazione15','$dati_transazione16','$REMOTE_ADDR','$anno','$origine_prenotazione','$datainserimento')");
$inviato = "SI";
} # fine if ($utente_trovato == "SI")
unlock_tabelle($tabelle_lock);
$tabelle_lock = "";
} # fine if ($utente_messaggio)

if ($inviato) {
echo "<br>".$fr_Richiesta_di_prenotazione_inviata;
if ($email_richiedente) echo " $fr_da <b>$email_richiedente</b>";
echo ".<br>";
if ($inviato_c and $email_richiedente) echo "<br>$fr_Copia_della_richiesta_e_stata_inviata_a $email_richiedente.<br>";
} # fine if ($inviato)
else echo "$fr_Non_e_stato_possibile_inviare_la_richiesta.<br>";
} # fine if ($inviare == "SI")
else $mostra_c_e_disp = "SI";
} # fine if ($mostra_richiesta_via_mail == "SI" and $manda_mail == "SI")


if ($mostra_c_e_disp == "SI") {
echo $testo_a_video;
if ($mostra_richiesta_via_mail == "SI") {
echo "<br>$chiusura_tag_font
<form accept-charset=\"utf-8\" method=\"post\" action=\"$pag\" id=\"cust_data\">
<div class=\"ftxt\">
<input type=\"hidden\" name=\"contr_disp\" value=\"SI\">
<input type=\"hidden\" name=\"num_tipologie\" value=\"$num_tipologie\">
<input type=\"hidden\" name=\"manda_mail\" value=\"SI\">
$dati_form_iniziale";
for ($n_t = 1 ; $n_t <= $num_tipologie ; $n_t++) {
for ($numca = 1 ; $numca <= ${"numcostiagg".$n_t} ; $numca++) echo "<input type=\"hidden\" name=\"id_periodi_costo$numca"."_$n_t\" value=\"".${"id_periodi_costo".$numca."_".$n_t}."\">";
} # fine for $n_t
if ($chiedi_nazione != "NO" or $chiedi_regione != "NO" or $chiedi_citta != "NO") mostra_funzjs_dati_rel("","","",$anno,"&framed=1&dati_relutenti=1",$pag);
echo "<table class=\"t_book\" $stile_tabella_prenotazione><tr><td>";
echo "<div class=\"reserve_line\">$apertura_tag_font$fr_Prenota ";
if ($num_tipologie > 1) echo "$id_app_richiesti $fr_appartamenti ";
else echo "$fr_dal ".$data_inizioperiodo_f[1]." $fr_al ".$data_fineperiodo_f[1]." ";
echo "$fr_per ";
if ($anteponi_nome_valuta != "SI") echo $costo_totale_p." ";
if ($costo_totale == 1) echo $fr_Euro;
else echo $fr_Euros;
if ($anteponi_nome_valuta == "SI") echo $costo_totale_p;
echo ".<br>$chiusura_tag_font</div><table><tr><td style=\"height: 6px;\"></td></tr>";

if ($chiedi_cognome != "NO") {
if ($cognome_richiedente_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\">$apertura_tag_f $fr_Cognome: $chiusura_tag_f</td><td>$apertura_tag_font
 <input type=\"text\" name=\"cognome_richiedente\" size=\"30\" value=\"$cognome_richiedente\">";
if ($chiedi_cognome == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_cognome != "NO")
if ($chiedi_nome != "NO") {
if ($nome_richiedente_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\">$apertura_tag_f $fr_Nome: $chiusura_tag_f</td><td>$apertura_tag_font
 <input type=\"text\" name=\"nome_richiedente\" size=\"30\" value=\"$nome_richiedente\">";
if ($chiedi_nome == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_nome != "NO")
if ($chiedi_email != "NO") {
if ($email_richiedente_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\">$apertura_tag_f $fr_Email: $chiusura_tag_f</td><td>$apertura_tag_font
 <input type=\"text\" name=\"email_richiedente\" size=\"30\" value=\"$email_richiedente\">";
if ($chiedi_email == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_email != "NO")
if ($chiedi_sesso != "NO") {
if ($sesso_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
if ($sesso == "M") $sel_M = " selected";
if ($sesso == "F") $sel_F = " selected";
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Genere: $chiusura_tag_f</td><td>$apertura_tag_font
 <select name=\"sesso\">
<option value=\"\">-</option>
<option value=\"M\"$sel_M>$fr_maschile</option>
<option value=\"F\"$sel_F>$fr_femminile</option>
</select>";
if ($chiedi_sesso == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_sesso != "NO")
if ($chiedi_datanascita != "NO") {
if ($datanascita_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
if (!$annonascita) $annonascita = "19";
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Data_di_nascita: $chiusura_tag_f</td><td>$apertura_tag_font
 <select name=\"giornonascita\">
<option value=\"\">--</option>";
for ($num1 = 1 ; $num1 <= 31 ; $num1++) {
if (strlen($num1) == 1) $num1 = "0".$num1;
if ($giornonascita == $num1) $sel = " selected";
else $sel = "";
echo "<option value=\"$num1\"$sel>$num1</option>";
} # fine for $num1
echo "</select>/
<select name=\"mesenascita\">
<option value=\"\">--</option>";
for ($num1 = 1 ; $num1 <= 12 ; $num1++) {
if (strlen($num1) == 1) $num1 = "0".$num1;
if ($mesenascita == $num1) $sel = " selected";
else $sel = "";
echo "<option value=\"$num1\"$sel>$num1</option>";
} # fine for $num
echo "</select>/
<input type=\"text\" name=\"annonascita\" size=\"5\" maxlength=\"4\" value=\"$annonascita\">";
if ($chiedi_datanascita == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_datanascita != "NO")
if ($chiedi_documento != "NO") {
if ($documento_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Documento: $chiusura_tag_f</td><td>$apertura_tag_font";
$lista_tipi_doc = mostra_lista_relutenti("tipodoc",$tipodoc,$utente_liste,"nome_documentoid","iddocumentiid","iddocumentoid",$tabledocumentiid,$tablerelutenti,"","","SI");
if ($lista_tipi_doc) $size = 18;
else $size = 30;
echo " $lista_tipi_doc<input type=\"text\" name=\"documento\" size=\"$size\" value=\"$documento\">";
if ($chiedi_documento == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_documento != "NO")
if ($chiedi_nazione != "NO") {
if ($nazione_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
if ($chiedi_regione != "NO") $rel_regione = "regione";
else $rel_regione = "";
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Nazione: $chiusura_tag_f</td><td>$apertura_tag_font
 ".mostra_lista_relutenti("nazione",$nazione,$utente_liste,"nome_nazione","idnazioni","idnazione",$tablenazioni,$tablerelutenti,"30","","",$rel_regione,$rel_regione)."";
if ($chiedi_nazione == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_nazione != "NO")
if ($chiedi_regione != "NO") {
if ($regione_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
if ($chiedi_nazione != "NO") $rel_nazione = "nazione";
else $rel_nazione = "";
if ($chiedi_citta != "NO") $rel_citta = "citta";
else $rel_citta = "";
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Regione: $chiusura_tag_f</td><td>$apertura_tag_font
 ".mostra_lista_relutenti("regione",$regione,$utente_liste,"nome_regione","idregioni","idregione",$tableregioni,$tablerelutenti,"30","","",$rel_citta,$rel_citta,$rel_nazione)."";
if ($chiedi_regione == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_regione != "NO")
if ($chiedi_citta != "NO") {
if ($citta_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
if ($chiedi_regione != "NO") $rel_regione = "regione";
else $rel_regione = "";
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Citta: $chiusura_tag_f</td><td>$apertura_tag_font
 ".mostra_lista_relutenti("citta",$citta,$utente_liste,"nome_citta","idcitta","idcitta",$tablecitta,$tablerelutenti,"30","","","","",$rel_regione)."";
if ($chiedi_citta == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_citta != "NO")
if ($chiedi_cap != "NO") {
if ($cap_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Codice_postale: $chiusura_tag_f</td><td>$apertura_tag_font
 <input type=\"text\" name=\"cap\" size=\"30\" value=\"$cap\">";
if ($chiedi_cap == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_cap != "NO")
if ($chiedi_via != "NO") {
if ($via_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Via: $chiusura_tag_f</td><td>$apertura_tag_font
 <input type=\"text\" name=\"via\" size=\"30\" value=\"$via\">";
if ($chiedi_via == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_via != "NO")
if ($chiedi_numcivico != "NO") {
if ($numcivico_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Numero_civico: $chiusura_tag_f</td><td>$apertura_tag_font
 <input type=\"text\" name=\"numcivico\" size=\"30\" value=\"$numcivico\">";
if ($chiedi_numcivico == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_numcivico != "NO")
if ($chiedi_telefono != "NO") {
if ($telefono_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Telefono: $chiusura_tag_f</td><td>$apertura_tag_font
 <input type=\"text\" name=\"telefono\" size=\"30\" value=\"$telefono\">";
if ($chiedi_telefono == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_telefono != "NO")
if ($chiedi_telefono2 != "NO") {
if ($telefono2_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Secondo_telefono: $chiusura_tag_f</td><td>$apertura_tag_font
 <input type=\"text\" name=\"telefono2\" size=\"30\" value=\"$telefono2\">";
if ($chiedi_telefono2 == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_telefono2 != "NO")
if ($chiedi_telefono3 != "NO") {
if ($telefono3_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Terzo_telefono: $chiusura_tag_f</td><td>$apertura_tag_font
 <input type=\"text\" name=\"telefono3\" size=\"30\" value=\"$telefono3\">";
if ($chiedi_telefono3 == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_telefono3 != "NO")
if ($chiedi_fax != "NO") {
if ($fax_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Fax: $chiusura_tag_f</td><td>$apertura_tag_font
 <input type=\"text\" name=\"fax\" size=\"30\" value=\"$fax\">";
if ($chiedi_fax == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_fax != "NO")
if ($chiedi_commento != "NO") {
if ($commento_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Commento: $chiusura_tag_f</td><td>$apertura_tag_font
 <textarea name=\"commento\" rows=3 cols=23>$commento</textarea>";
if ($chiedi_commento == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_commento != "NO")

if ($chiedi_oracheckin != "NO") {
if ($oracheckin_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Orario_stimato_di_arrivo: $chiusura_tag_f</td><td>$apertura_tag_font
 <select name=\"data_oracheckin\">";
$formato_vedi = "d-m-Y";
if ($stile_data == "usa") $formato_vedi = "m-d-Y";
$data_inizio_minima = "";
for ($n_t = 1 ; $n_t <= $num_tipologie ; $n_t++) {
if (!$data_inizio_minima or $data_inizio_minima > $data_inizioperiodo[$n_t]) $data_inizio_minima = $data_inizioperiodo[$n_t];
} # fine for $n_t
$anno_ini = substr($data_inizio_minima,0,4);
$mese_ini = substr($data_inizio_minima,5,2);
$giorno_ini = substr($data_inizio_minima,8,2);
if (!$data_oracheckin) $data_sel = $data_inizio_minima;
else $data_sel = $data_oracheckin;
if ($tipo_periodi == "g") $giorno_fine = $giorno_ini + $intervalloperiodo;
else $giorno_fine = $giorno_ini + 5;
if ($giorno_fine > ($giorno_ini + 5)) $giorno_fine = $giorno_ini + 5;
for ($num1 = $giorno_ini ; $num1 <= $giorno_fine ; $num1++) {
$data_select = date("Y-m-d" , mktime(0,0,0,$mese_ini,$num1,$anno_ini));
$data_select_vedi = date($formato_vedi,mktime(0,0,0,$mese_ini,$num1,$anno_ini));
if ($data_select == $data_sel) $sel = " selected";
else $sel = "";
echo "<option value=\"$data_select\"$sel>$data_select_vedi</option>";
} # fine for $num1
if (!$ora_oracheckin) $sel = " selected";
else $sel = "";
echo "</select>&nbsp;&nbsp;<select name=\"ora_oracheckin\">
<option value=\"\"$sel>--</option>";
for ($num1 = 0 ; $num1 < 24 ; $num1++) {
if (strlen($num1) == 1) $num1 = "0".$num1;
if ($num1 == $ora_oracheckin) $sel = " selected";
else $sel = "";
echo "<option value=\"$num1\"$sel>$num1</option>";
} # fine for $num1
if (!$n_min_stima_checkin) $sel = " selected";
else $sel = "";
echo "</select>:<select name=\"min_oracheckin\">
<option value=\"\"$sel>--</option>";
for ($num1 = 0 ; $num1 < 60 ; $num1 = $num1 + 15) {
if (strlen($num1) == 1) $num1 = "0".$num1;
if ($num1 == $min_oracheckin) $sel = " selected";
else $sel = "";
echo "<option value=\"$num1\"$sel>$num1</option>";
} # fine for $num1
echo "</select>";
if ($chiedi_oracheckin == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($chiedi_oracheckin != "NO")

if ($caparra_totale > 0) {
if ($chiedi_metodopagamento != "NO") {
if ($metodopagamento_sb == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
$num_metodi_pagamento = count($metodi_pagamento_da_chiedere);
if ($num_metodi_pagamento > 0) {
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f $fr_Metodo_di_pagamento_della_caparra: $chiusura_tag_f</td><td>$apertura_tag_font
 <select name=\"metodo_pagamento\">
<option value=\"\">----</option>";
if (@get_magic_quotes_gpc()) $metodo_pagamento = stripslashes($metodo_pagamento);
reset($metodi_pagamento_da_chiedere);
while (list($metodo,$val) = each($metodi_pagamento_da_chiedere)) {
if ($metodo == $metodo_pagamento) $sel = " selected";
else $sel = "";
if ($nomi_metodi_pagamento_imposti[$metodo]) $nome_metodo = $nomi_metodi_pagamento_imposti[$metodo];
else $nome_metodo = $metodo;
echo "<option value=\"$metodo\"$sel>$nome_metodo</option>";
} # fine while
echo "</select>";
if ($chiedi_metodopagamento == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine if ($num_metodi_pagamento > 0)
} # fine if ($chiedi_metodopagamento != "NO")
} # fine if ($caparra_totale > 0)

$num_campi_pers = count($campi_form_personalizzati);
for ($num1 = 1 ; $num1 <= $num_campi_pers ; $num1++) {
if (${"campo_pers_sb".$num1} == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td align=\"right\" valign=\"top\">$apertura_tag_f ".$campi_form_personalizzati[$num1].": $chiusura_tag_f</td><td>$apertura_tag_font
 <input type=\"text\" name=\"campo_pers$num1\" size=\"30\" value=\"".${"campo_pers".$num1}."\">";
if ($chiedi_campi_form_personalizzati[$num1] == "SI") echo "&nbsp;$asterisco";
echo "$chiusura_tag_font</td></tr>";
} # fine for $num1

if ($num_campi_doc_cond) {
$num_ripeti = 0;
$tariffa_selezionata = "";
$num_costo_agg_sel = "";
$lingua_mex = "";
$modifica_pers = "SI";
$vedi_clienti = "SI";
$data_inizio_selezione = "";
$data_fine_selezione = "";
for ($n_t = 1 ; $n_t <= $num_tipologie ; $n_t++) {
for ($num1 = 1 ; $num1 <= ${"num_app_tipo_richiesti".$n_t} ; $num1++) {
$num_ripeti++;
${"cognome_".$num_ripeti} = "";
${"nome_".$num_ripeti} = "";
${"soprannome_".$num_ripeti} = "";
${"titolo_".$num_ripeti} = "";
${"sesso_".$num_ripeti} = "";
${"data_nascita_".$num_ripeti} = "";
${"citta_nascita_".$num_ripeti} = "";
${"regione_nascita_".$num_ripeti} = "";
${"nazione_nascita_".$num_ripeti} = "";
${"cittadinanza_".$num_ripeti} = "";
${"nazione_".$num_ripeti} = "";
${"regione_".$num_ripeti} = "";
${"citta_".$num_ripeti} = "";
${"via_".$num_ripeti} = "";
${"numcivico_".$num_ripeti} = "";
${"cap_".$num_ripeti} = "";
${"documento_".$num_ripeti} = "";
${"tipo_documento_".$num_ripeti} = "";
${"citta_documento_".$num_ripeti} = "";
${"regione_documento_".$num_ripeti} = "";
${"nazione_documento_".$num_ripeti} = "";
${"scadenza_documento_".$num_ripeti} = "";
${"telefono_".$num_ripeti} = "";
${"telefono2_".$num_ripeti} = "";
${"telefono3_".$num_ripeti} = "";
${"fax_".$num_ripeti} = "";
${"email_".$num_ripeti} = "";
${"codice_fiscale_".$num_ripeti} = "";
${"partita_iva_".$num_ripeti} = "";
${"numero_prenotazione_".$num_ripeti} = "";
${"codice_prenotazione_".$num_ripeti} = "";
${"data_inizio_".$num_ripeti} = $data_inizioperiodo[$n_t];
${"data_fine_".$num_ripeti} = $data_fineperiodo[$n_t];
${"num_periodi_".$num_ripeti} = $idfineperiodo[$n_t] - $idinizioperiodo[$n_t] + 1;
${"nome_tariffa_".$num_ripeti} = ${"nometariffa_imposta".$n_t};
${"costo_tariffa_".$num_ripeti} = (double) $costo_tariffa_reg[$n_t];
${"tariffesettimanali_".$num_ripeti} = $tariffesettimanali_reg[$n_t];
${"sconto_".$num_ripeti} = "";
${"percentuale_tasse_tariffa_".$num_ripeti} = $dati_tariffe["tariffa".${"numero_tariffa".$n_t}]['tasse_percent'];
${"commento_".$num_ripeti} = "";
${"origine_prenotazione_".$num_ripeti} = $origine_prenotazione;
${"caparra_".$num_ripeti} = $caparra_reg[$n_t];
${"commissioni_".$num_ripeti} = $commissioni_reg[$n_t];
${"num_persone_".$num_ripeti} = ${"numpersone".$n_t};
${"appartamento_".$num_ripeti} = $app_liberato[$num_ripeti];
${"app_assegnabili_".$num_ripeti} = $lista_app_reg[$n_t];
${"pagato_".$num_ripeti} = "";
for ($numca = 0 ; $numca < $num_costi_reg[$n_t][$num1] ; $numca++) {
${"nome_costo_agg".$numca."_".$num_ripeti} = $nome_costo_reg[$n_t][$num1][$numca];
${"val_costo_agg".$numca."_".$num_ripeti} = $val_costo_reg[$n_t][$num1][$numca];
${"percentuale_tasse_costo_agg".$numca."_".$num_ripeti} = $tasseperc_costo_reg[$n_t][$num1][$numca];
${"moltiplica_max_costo_agg".$numca."_".$num_ripeti} = $moltmax_costo_reg[$n_t][$num1][$numca];
${"data_inserimento_costo_agg".$numca."_".$num_ripeti} = "";
${"utente_inserimento_costo_agg".$numca."_".$num_ripeti} = "";
} # fine for $numca
${"num_costi_aggiuntivi_".$num_ripeti} = $num_costi_reg[$n_t][$num1];
${"n_letti_agg_".$num_ripeti} = $num_letti_agg_reg[$n_t];
${"costo_tot_".$num_ripeti} = $costo_tariffa_tot_reg[$n_t][$num1];
${"orario_entrata_stimato_".$num_ripeti} = "";
${"num_pagamenti_".$num_ripeti} = 0;
${"data_paga0_".$num_ripeti} = "";
${"utente_paga0_".$num_ripeti} = "";
${"metodo_paga0_".$num_ripeti} = "";
${"saldo_paga0_".$num_ripeti} = "";
${"data_inserimento_prenotazione_".$num_ripeti} = "";
${"utente_inserimento_prenotazione_".$num_ripeti} = "";
} # fine for $num1
} # fine for $n_t
crea_trad_var_vett($trad_var_vett);
for ($num1 = 1 ; $num1 <= $num_campi_doc_cond ; $num1++) {
$num_contr = $campi_form_doc_cond[$num1];
$testo_contr = crea_contratto($num_contr,$tipo_contratto,$utente_liste,"","","",$trad_var_vett,1);
if (${"cond_contr_sb".$num_contr} == "SI") { $apertura_tag_f = $apertura_tag_font_rosse; $chiusura_tag_f = $chiusura_tag_font_rosse; $asterisco = $fr_asterisco_rosso; }
else { $apertura_tag_f = $apertura_tag_font; $chiusura_tag_f = $chiusura_tag_font; $asterisco = $fr_asterisco_nero; }
echo "<tr><td style=\"height: 6px;\"></td></tr><tr><td class=\"agreem\" colspan=\"2\">";
if (strcmp($nome_contratto[$num_contr],"")) echo "<div class=\"agreemtitl\">".$nome_contratto[$num_contr]."</div>";
if ($campi_form_doc_cond['tipo'][$num1] == "txt") echo "<textarea class=\"agreem\" rows=3 cols=70 readonly=\"readonly\">".htmlspecialchars($testo_contr)."</textarea>";
else echo "<div class=\"agreem\">$testo_contr</div>";
if (${"cond_contr".$num_contr} == "SI") $checked = " checked";
else $checked = "";
echo "<label><div class=\"agreemacc\"><input type=\"checkbox\" name=\"cond_contr$num_contr\" value=\"SI\"$checked>
$apertura_tag_f $fr_Accetto$chiusura_tag_f</label>";
if ($chiedi_campi_form_doc_cond[$num1] == "SI") echo "&nbsp;$asterisco";
echo "</div></td></tr>";
} # fine for $num1
unset($trad_var_vett);
} # fine if ($num_campi_doc_cond)


echo "<tr><td style=\"height: 5px;\"></td></tr>
<tr><td colspan=\"2\" valign=\"middle\" align=\"center\">$apertura_tag_font
<input class=\"sbutton\" type=\"submit\" name=\"m_m\" value=\"$fr_Invia_la_richiesta_di_prenotazione\"><br>";
echo "$chiusura_tag_font</td></tr>";
if ($fr_campi_necessari) echo "<tr><td colspan=\"2\" align=\"left\"><br>$apertura_tag_font$fr_asterisco_nero $fr_campi_necessari$chiusura_tag_font</td></tr>";
echo "</table></td></tr></table></div></form>";
if ($mostra_bottone_paypal) {
if (@is_file("./".$nome_modello_paypal)) {
echo "<script type=\"text/javascript\">
<!--
function update_form_avail() {
var form1 = document.getElementById('cust_data');
var form2 = document.getElementById('inst_data');
var el = new Array();
for (var i=0 ; i < form1.length ; i++) {
if (form1.elements[i].type != 'hidden') {
el[i] = document.createElement('input');
el[i].type = 'hidden';
el[i].name = form1.elements[i].name;
el[i].value = form1.elements[i].value;
form2.appendChild(el[i]);
}
}
}
//-->
</script>
<div class=\"pay_form\" style=\"text-align: center\">$apertura_tag_font<br>
$fr_OPPURE_linee<br><br>$chiusura_tag_font
<form accept-charset=\"utf-8\" method=\"post\" action=\"$nome_modello_paypal\" id =\"inst_data\" onSubmit=\"update_form_avail()\">
<input type=\"hidden\" name=\"contr_disp\" value=\"SI\">
$dati_form_iniziale
<input class=\"sbutton\" type=\"submit\" value=\"$fr_Prenotazione_istantanea_con_PayPal\">
</form></div>";
if (!$mostra_quadro_disp) echo "<br>";
} # fine if (@is_file("./".$nome_modello_paypal))
} # fine if ($mostra_bottone_paypal)
} # fine if ($mostra_richiesta_via_mail == "SI")

} # fine if ($mostra_c_e_disp == "SI")
} # fine if ($continuare_totale == "SI")


} # fine if ($liberato == "SI")


if ($mostra_quadro_disp and $manda_mail != "SI") {

unset($app_regola2_orig);
for ($num1 = 0 ; $num1 < $num_regole2 ; $num1++) {
$numtariffa_regola2 = str_replace("tariffa","",risul_query($regole2,$num1,'tariffa_per_app'));
if ($tariffe_mostra[$numtariffa_regola2] == "SI") $app_regola2_orig[$numtariffa_regola2] = risul_query($regole2,$num1,'motivazione');
} # fine for $num1

$colonna_destra_tab_disp = "NO";
$fr_persone = $fr_persone;
$fr_persona = $fr_persona;
$nome_mese["01"] = $fr_Gennaio;
$nome_mese["02"] = $fr_Febbraio;
$nome_mese["03"] = $fr_Marzo;
$nome_mese["04"] = $fr_Aprile;
$nome_mese["05"] = $fr_Maggio;
$nome_mese["06"] = $fr_Giugno;
$nome_mese["07"] = $fr_Luglio;
$nome_mese["08"] = $fr_Agosto;
$nome_mese["09"] = $fr_Settembre;
$nome_mese["10"] = $fr_Ottobre;
$nome_mese["11"] = $fr_Novembre;
$nome_mese["12"] = $fr_Dicembre;
unset($app_consentito);
unset($app_consentito_sett);

# Calcolo gli appartamenti consentiti dalla regola 2 e i nomi delle tariffe
$tutti_consentiti = "NO";
for ($numtariffa = 1 ; $numtariffa <= $dati_tariffe['num'] ; $numtariffa++) {
if ($tariffe_mostra[$numtariffa] == "SI") {
if ($mostra_quadro_disp == "reg2") {
if ($n_tariffe_imposte[$numtariffa]) $nome_tariffa[$numtariffa] = $n_tariffe_imposte[$numtariffa];
else {
$nome_tariffa[$numtariffa] = $dati_tariffe["tariffa".$numtariffa]['nome'];
if ($nome_tariffa[$numtariffa] == "") $nome_tariffa[$numtariffa] = $fr_tariffa.$numtariffa;
} # fine else if ($n_tariffe_imposte[$numtariffa])
} # fine if ($mostra_quadro_disp == "reg2")
if (!$app_regola2_orig[$numtariffa]) $tutti_consentiti = "SI";
if ($tutti_consentiti != "SI") {
$appartamenti_regola2 = explode(",",$app_regola2_orig[$numtariffa]);
for ($num1 = 0 ; $num1 < count($appartamenti_regola2) ; $num1++) $app_consentito[$appartamenti_regola2[$num1]] = "SI";
} # fine if ($tutti_consentiti != "SI")
} # fine if ($tariffe_mostra[$numtariffa] == "SI")
} # fine for $numtariffa
if ($tutti_consentiti == "SI") for ($num1 = 0 ; $num1 < $dati_app['totapp'] ; $num1++) $app_consentito[$dati_app['posizione'][$num1]] = "SI";

# Calcolo gli appartamenti consentiti dalla regola 1
if ($num_app_agenzia != 0 and is_array($motivazioni_regola1)) {
$app_consentito_sett[",attivo,"] = "SI";
for ($num1 = 0 ; $num1 < $dati_app['totapp'] ; $num1++) {
for ($num2 = $id_data_inizio_tab_disp ; $num2 <= ($id_data_inizio_tab_disp + $num_colonne_tab_disp - 1) ; $num2++) {
$app_consentito_sett[$dati_app['posizione'][$num1]][$num2] = "SI";
} # fine for $num2
} # fine for $num1
for ($num1 = 0 ; $num1 < $num_app_agenzia ; $num1++) {
if ($motivazioni_regola1[$motivazione_app_agenzia[$num1]] == "SI") {
#if ($idinizio_app_agenzia[$num1] == 1 and $idfine_app_agenzia[$num1] == $max_periodo) $app_consentito[$id_app_agenzia[$num1]] = "NO";
for ($num2 = $idinizio_app_agenzia[$num1] ; $num2 <= $idfine_app_agenzia[$num1] ; $num2++) {
$app_consentito_sett[$id_app_agenzia[$num1]][$num2] = "NO";
} # fine for $num2
} # fine if ($motivazioni_regola1[$motivazione_app_agenzia[$num1]] == "SI")
} # fine for $num1
} # fine if ($num_app_agenzia != 0 and is_array($motivazioni_regola1))

$righe_tab_disp = crea_quadro_disp($id_data_inizio_tab_disp,$num_colonne_tab_disp,$mostra_quadro_disp,$mostra_num_liberi,$app_consentito,$app_consentito_sett,$app_regola2_orig,$tipo_periodi,$dati_tariffe['num'],$nome_tariffa,$dati_app,$prenota_in_app_sett,$app_orig_prenota_id,$tableperiodi,$allinea_disponibilita_con_arrivo);

if ($righe_tab_disp) {
echo "<br><br>$chiusura_tag_font
<div style=\"text-align: center;\">$apertura_tag_font<small>$fr_Quadro_indicativo_disponibilita</small>$chiusura_tag_font
<table class=\"tab_disp\" border=1 cellspacing=0 cellpadding=1  style=\"background-color: $c_sfondo_tab_disp; text-align: center; margin-left: auto;  margin-right: auto;\">
$righe_tab_disp
</table></div>$apertura_tag_font";
} # fine if ($righe_tab_disp)

} # fine if ($mostra_quadro_disp and $manda_mail != "SI")


if ($tabelle_lock) unlock_tabelle($tabelle_lock);


} # fine if ($verificare != "NO")
else $torna_indietro = "SI";
echo $chiusura_tag_font;

if ($torna_indietro == "SI") {
echo "<br><form accept-charset=\"utf-8\" method=\"post\" action=\"$pag\">
<div class=\"ftxt\">
$dati_form_iniziale";
if ($manda_mail == "SI") {
echo "<input type=\"hidden\" name=\"contr_disp\" value=\"SI\">
<input type=\"hidden\" name=\"cognome_richiedente\" value=\"$cognome_richiedente\">
<input type=\"hidden\" name=\"nome_richiedente\" value=\"$nome_richiedente\">
<input type=\"hidden\" name=\"email_richiedente\" value=\"$email_richiedente\">
<input type=\"hidden\" name=\"sesso\" value=\"$sesso\">
<input type=\"hidden\" name=\"annonascita\" value=\"$annonascita\">
<input type=\"hidden\" name=\"mesenascita\" value=\"$mesenascita\">
<input type=\"hidden\" name=\"giornonascita\" value=\"$giornonascita\">
<input type=\"hidden\" name=\"tipodoc\" value=\"$tipodoc\">
<input type=\"hidden\" name=\"documento\" value=\"$documento\">
<input type=\"hidden\" name=\"nazione\" value=\"$nazione\">
<input type=\"hidden\" name=\"regione\" value=\"$regione\">
<input type=\"hidden\" name=\"citta\" value=\"$citta\">
<input type=\"hidden\" name=\"via\" value=\"$via\">
<input type=\"hidden\" name=\"numcivico\" value=\"$numcivico\">
<input type=\"hidden\" name=\"cap\" value=\"$cap\">
<input type=\"hidden\" name=\"telefono\" value=\"$telefono\">
<input type=\"hidden\" name=\"telefono2\" value=\"$telefono2\">
<input type=\"hidden\" name=\"telefono3\" value=\"$telefono3\">
<input type=\"hidden\" name=\"fax\" value=\"$fax\">
<input type=\"hidden\" name=\"commento\" value=\"$commento\">
<input type=\"hidden\" name=\"data_oracheckin\" value=\"$data_oracheckin\">
<input type=\"hidden\" name=\"ora_oracheckin\" value=\"$ora_oracheckin\">
<input type=\"hidden\" name=\"min_oracheckin\" value=\"$min_oracheckin\">
<input type=\"hidden\" name=\"metodo_pagamento\" value=\"$metodo_pagamento\">";
for ($num1 = 1 ; $num1 <= $num_campi_pers ; $num1++) {
echo "<input type=\"hidden\" name=\"campo_pers$num1\" value=\"".${"campo_pers".$num1}."\">";
} # fine for $num1
for ($num1 = 1 ; $num1 <= $num_campi_doc_cond ; $num1++) {
$num_contr = $campi_form_doc_cond[$num1];
echo "<input type=\"hidden\" name=\"cond_contr$num_contr\" value=\"".${"cond_contr".$num_contr}."\">";
} # fine for $num1
} # fine if ($manda_mail == "SI")
echo "<input class=\"sbutton\" type=\"submit\" name=\"tor_ind\" value=\"$fr_Torna_indietro\">
</div></form><br>";
} # fine if ($torna_indietro == "SI")

else {
echo "<br><form accept-charset=\"utf-8\" method=\"post\" action=\"$pag\">
<div class=\"ftxt\">
<input class=\"sbutton\" type=\"submit\" name=\"ricontrolla\" value=\"$fr_Nuovo_controllo\">
</div></form><br>";
} # fine else if ($torna_indietro == "SI")

} # fine if ($contr_disp)



if ($mostra_form != "NO") {

if ($aggiungi_nuova_tipologia) {
${"inizioperiodo".$num_tipologie} = ${"inizioperiodo".($num_tipologie -1)};
${"fineperiodo".$num_tipologie} = ${"fineperiodo".($num_tipologie -1)};
${"numero_tariffa".$num_tipologie} = ${"numero_tariffa".($num_tipologie -1)};
${"numpersone".$num_tipologie} = ${"numpersone".($num_tipologie -1)};
${"num_app_tipo_richiesti".$num_tipologie} = ${"num_app_tipo_richiesti".($num_tipologie -1)};
for ($numca = 1 ; $numca <= ${"numcostiagg".($num_tipologie -1)} ; $numca++) {
${"costoagg".$numca."_".$num_tipologie} = ${"costoagg".$numca."_".($num_tipologie -1)};
${"idcostoagg".$numca."_".$num_tipologie} = ${"idcostoagg".$numca."_".($num_tipologie -1)};
${"numsettimane".$numca."_".$num_tipologie} = ${"numsettimane".$numca."_".($num_tipologie -1)};
${"nummoltiplica_ca".$numca."_".$num_tipologie} = ${"nummoltiplica_ca".$numca."_".($num_tipologie -1)};
} # fine for $numca
} # fine if ($aggiungi_nuova_tipologia)
echo "<script type=\"text/javascript\">
<!--
function update_selected_dates(id) {
var sel_opt=document.getElementById(\"id_sdm\"+id);
var other_id = id;
if (Math.ceil(id/2) != Math.floor(id/2)) other_id++;
else other_id--;
var other_sel_opt = document.getElementById(\"id_sdm\"+other_id);
var num_sel = sel_opt.selectedIndex;
var other_num_sel = other_sel_opt.selectedIndex;
if (other_sel_opt.options[other_num_sel].text != \"----\") {
var add_ns = 0;
var o_add_ns = 0;
var new_sel_opt = -1;
if (sel_opt.options[0].text == \"----\") add_ns = 1;
if (other_sel_opt.options[0].text == \"----\") o_add_ns = 1;
if ((other_id > id) && ((num_sel - add_ns) >= (other_num_sel - o_add_ns))) new_sel_opt = num_sel - add_ns + o_add_ns + 1;
if ((other_id < id) && ((num_sel - add_ns) <= (other_num_sel - o_add_ns))) new_sel_opt = num_sel - add_ns + o_add_ns - 1;
if (new_sel_opt >= 0) other_sel_opt.selectedIndex = new_sel_opt;
}
}";
if ($mostra_calendario_scelta_date == "SI") {
echo "
giorni = new Array($d_names);
mesi = new Array($m_names);

function agg_zero (c) {
r = \"\";
if (c < 10) {
r = \"0\";
} // fine if (c < 10)
return r;
}

function nasc_cal (ncal) {
var lcal=document.getElementById('cal'+ncal);
lcal.style.visibility='hidden';
}

function mos_cal (ncal) {
var lcal = document.getElementById('cal'+ncal);
var elementoid=document.getElementById('bcal'+ncal);
var elementi = elementoid;
var iTop = 0;
var prova = lcal.style.visibility;
if (prova != 'visible') {
while(elementi.tagName != 'BODY') {
iTop += elementi.offsetTop;
elementi = elementi.offsetParent;
}
elementi = elementoid;
var iLeft = 0;
while(elementi.tagName != 'BODY') {
iLeft += elementi.offsetLeft;
elementi = elementi.offsetParent;        
}
lcal.style.left=(iLeft + 2) + 'px';
lcal.style.top=(iTop + elementoid.offsetHeight + 2) + 'px';
var ind_data = 0;
var data_sel = document.getElementById('id_sdm'+ncal);
if (!data_sel.selectedIndex) ind_data = 2;
else ind_data = data_sel.selectedIndex;
data_sel = data_sel.options[ind_data].value;
mese = (data_sel.substring(5,7) - 1);
anno = data_sel.substring(0,4);
crea_cal_mese(ncal,mese,anno);
lcal.style.visibility='visible';
}
if (prova == 'visible') {
nasc_cal(ncal);
}
}

function rendi_link (val_cal,n_lista_d,lista_d,ncal) {
var elem = document.getElementById('d'+val_cal+ncal)
if (!elem) return;
elem.bgColor = '$colore_data_attiva_calendario';
elem.onmouseover = function() {
this.bgColor = '$colore_data_selezionata_calendario';
}
elem.onmouseout = function() {
this.bgColor = '$colore_data_attiva_calendario';
}
elem.onmousedown = function() {
lista_d.selectedIndex = n_lista_d;
update_selected_dates(ncal);
nasc_cal(ncal);
}
}

function crea_cal_mese (ncal,mese,anno) {
var n_giorni_l = 0;
var giorni_l = new Array();
var n1 = 0;
d = new Date(anno,mese,1);
anno = d.getFullYear();
mese = d.getMonth();
giorno = d.getDay() * -1;
giorno = giorno + 2;
if (giorno > 1) giorno = giorno - 7;
var mese_orig = mese;
var anno_orig = anno;
var testo_cal = ' '+mesi[mese]+' '+anno+'<br>\
 <input type=\"button\" class= \"calbutton\"onclick=\"crea_cal_mese(\''+ncal+'\',\''+mese+'\',\''+(anno - 1)+'\')\" value=\"&lt;&lt;\" $stile_bottoni_calendario>\
 <input type=\"button\" class= \"calbutton\" onclick=\"crea_cal_mese(\''+ncal+'\',\''+(mese - 1)+'\',\''+anno+'\')\" value=\"&lt;\" $stile_bottoni_calendario>\
 <input type=\"button\" class= \"calbutton\" onclick=\"crea_cal_mese(\''+ncal+'\',\''+(mese + 1)+'\',\''+anno+'\')\" value=\"&gt;\" $stile_bottoni_calendario>\
 <input type=\"button\" class= \"calbutton\" onclick=\"crea_cal_mese(\''+ncal+'\',\''+mese+'\',\''+(anno + 1)+'\')\" value=\"&gt;&gt;\" $stile_bottoni_calendario><br>\
<table $stile_tabella_calendario>\
<tr><td>'+giorni['1']+'<'+'/td><td>'+giorni['2']+'<'+'/td><td>'+giorni['3']+'<'+'/td><td>'+giorni['4']+'<'+'/td><td>'+giorni['5']+'<'+'/td><td>'+giorni['6']+'<'+'/td><td>'+giorni['0']+'<'+'/td><'+'/tr>';
d = new Date(anno,mese,giorno);
mese = d.getMonth();
anno = d.getFullYear();
giorno = d.getDate();
while (mese_orig == mese || n1 == 0) {
testo_cal += '<tr>';
for (n1 = 1 ; n1 <= 7 ; n1++) {
if (mese == mese_orig) {
testo_cal += '<td id=\"d'+anno+'-'+agg_zero((mese + 1))+(mese + 1)+'-'+agg_zero(giorno)+giorno+ncal+'\">'+giorno+'<'+'/td>';
n_giorni_l = n_giorni_l + 1;
}
else testo_cal += '<td><'+'/td>';
giorno = giorno + 1;
d = new Date(anno,mese,giorno);
mese = d.getMonth();
anno = d.getFullYear();
giorno = d.getDate();
}
testo_cal += '<'+'/tr>';
}
testo_cal += '<'+'/table><div style=\"padding: 3px 0 0 0\">\
<input type=\"button\" class= \"calbutton\" onclick=\"nasc_cal(\''+ncal+'\')\" value=\"$fr_Chiudi\" $stile_bottoni_calendario><'+'/div>';
document.getElementById('cal'+ncal).innerHTML = testo_cal;
var lista_d = document.getElementById('id_sdm'+ncal);
var num_opz = lista_d.length;
var val_cal = 0;
var val_comp = anno_orig+'-'+agg_zero(mese_orig + 1)+(mese_orig + 1);
for (n1 = 0 ; n1 < num_opz ; n1++) {
val_cal = lista_d.options[n1].value;
if (val_cal.substring(0,7) == val_comp) {
rendi_link(val_cal,n1,lista_d,ncal);
}
}
}";
} # fine if ($mostra_calendario_scelta_date == "SI")
echo "
//-->
</script>";
if ($framed and $apri_nuova_finestra_da_frame == "SI") echo "<form accept-charset=\"utf-8\" method=\"post\" id=\"dates_form\" action=\"$pag\" target=\"windowName\" onsubmit=\"window.open('',this.target,'dialog,modal,scrollbars=yes,resizable=no,width=$larghezza_finestra_da_frame,height=$altezza_finestra_da_frame,left=30,top=20');\"><div class=\"ftxt\">";
else echo "<form accept-charset=\"utf-8\" method=\"post\" id=\"dates_form\" action=\"$pag\"$target><div class=\"ftxt\">";
if (!$framed) {
if ($num_tipologie == 1) echo "<div class=\"check_avail_line\">";
echo $apertura_tag_font.$fr_Controlla_la_disponibilita;
if ($num_tipologie > 1) echo " $fr_in:<br>";
echo $chiusura_tag_font;
} # fine if (!$framed)

$oggi = date("Y-m-d",(time() + (C_DIFF_ORE * 3600)));
function seleziona_data_vicina ($menu_periodi,$data_sel,$pos) {
$lista_date = explode("<option value=\"",$menu_periodi);
$n_lista_date = count($lista_date);
for ($num1 = 1 ; $num1 < $n_lista_date ; $num1++) {
$data_corr = substr($lista_date[$num1],0,10);
if ((int) str_replace("-","",$data_corr) >= (int) str_replace("-","",$data_sel)) {
if ($pos == "prec") $data_sel = $data_corr;
else $data_sel = substr($lista_date[($num1 + 1)],0,10);
break;
} # fine if ((int) str_replace("-","",$data_corr) > (int) str_replace("-","",$inizio_select))
} # fine for $num1
if (strlen($data_sel) != 10) $data_sel = "";
return $data_sel;
} # fine function seleziona_data_vicina
$date_select = esegui_query("select idperiodi from $tableperiodi where datainizio <= '$oggi' and datafine > '$oggi' ");
if (numlin_query($date_select) == 1) $date_select = esegui_query("select datainizio,datafine from $tableperiodi where idperiodi = '".(risul_query($date_select,0,idperiodi) + $sett_no_prenota)."'");
if (numlin_query($date_select) == 1) {
$inizio_select = risul_query($date_select,0,'datainizio');
$fine_select = risul_query($date_select,0,'datafine');
if (!strpos($menu_periodi,$inizio_select)) $inizio_select = seleziona_data_vicina($menu_periodi,$inizio_select,"prec");
$menu_periodi_vett = explode("<option value=\"$inizio_select\">",$menu_periodi);
if ($menu_periodi_vett[1]) {
$menu_periodi = "<option value=\"$inizio_select\">".$menu_periodi_vett[1];
$fine_select = seleziona_data_vicina($menu_periodi,$inizio_select,"succ");
} # fine if ($menu_periodi_vett[1])
} # fine if (numlin_query($date_select) == 1)
else {
$inizio_select = explode("<option value=\"",$menu_periodi);
$inizio_select = substr($inizio_select[1],0,10);
$fine_select = seleziona_data_vicina($menu_periodi,$inizio_select,"succ");
} # fine else if (numlin_query($date_select) == 1)
$dati_tariffe = dati_tariffe($tablenometariffe);
if ($mostra_costi_aggiuntivi == "SI") $dati_ca = dati_costi_agg_ntariffe($tablenometariffe,"NO","SI");
$id_select_dates_menu = 0;

for ($n_t = 1 ; $n_t <= $num_tipologie ; $n_t++) {
if ($num_tipologie > 1) echo "<div class=\"check_avail_line\">$apertura_tag_font<br><b>$n_t</b>: $chiusura_tag_font";
$id_select_dates_menu++;
if (!$framed) echo "$apertura_tag_font $fr_dal";
else echo "\n<div class=\"arrdate\">$apertura_tag_font<span class=\"ftxt_phr\">$fr_Data_di_arrivo:</span>";
echo "\n <select name=\"inizioperiodo$n_t\" onChange=\"update_selected_dates('$id_select_dates_menu')\" id=\"id_sdm$id_select_dates_menu\">";
if (${"inizioperiodo".$n_t}) echo str_replace(${"inizioperiodo".$n_t}."\"",${"inizioperiodo".$n_t}."\" selected",$menu_periodi);
else {
if ($inizio_select) echo str_replace($inizio_select."\"",$inizio_select."\" selected",$menu_periodi);
else echo $menu_periodi;
} # fine else if (${"inizioperiodo".$n_t})
echo "</select>";
if ($mostra_calendario_scelta_date == "SI") echo "<input type=\"button\" class=\"dbutton\" id=\"bcal$id_select_dates_menu\" onclick=\"mos_cal($id_select_dates_menu)\" value=\"..\" $stile_bottone_apertura_calendario>
$chiusura_tag_font<div id=\"cal$id_select_dates_menu\" class=\"datepick\" $stile_riquadro_calendario></div>$apertura_tag_font";
$id_select_dates_menu++;
if (!$framed) echo " $fr_al";
else echo "$chiusura_tag_font</div>\n<div class=\"depdate\">$apertura_tag_font<span class=\"ftxt_phr\">$fr_Data_di_partenza:</span>";
echo "\n <select name=\"fineperiodo$n_t\" onChange=\"update_selected_dates('$id_select_dates_menu')\" id=\"id_sdm$id_select_dates_menu\">";
if (${"fineperiodo".$n_t}) echo str_replace(${"fineperiodo".$n_t}."\"",${"fineperiodo".$n_t}."\" selected",$menu_periodi);
else {
if ($fine_select) echo str_replace($fine_select."\"",$fine_select."\" selected",$menu_periodi);
else echo $menu_periodi;
} # fine else if (${"fineperiodo".$n_t})
echo "</select>";
if ($mostra_calendario_scelta_date == "SI") echo "<input type=\"button\" class=\"dbutton\" id=\"bcal$id_select_dates_menu\" onclick=\"mos_cal($id_select_dates_menu)\" value=\"..\" $stile_bottone_apertura_calendario>
$chiusura_tag_font<div id=\"cal$id_select_dates_menu\" class=\"datepick\" $stile_riquadro_calendario></div>$apertura_tag_font";
if ($framed) echo "$chiusura_tag_font</div>";

if (count($tariffe_mostra) != 1) {
if ($num_tipologie == 1 and !$framed) echo "<br>$chiusura_tag_font
<table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tr><td style=\"height: 4px;\"></td></tr></table>$apertura_tag_font";
if (!$framed) echo " $fr_per_la_tipologia";
else echo "\n<div class=\"typesel\">$apertura_tag_font<span class=\"ftxt_phr\">$fr_Tipologia:</span>";
echo "\n <select name=\"numero_tariffa$n_t\">";
for ($numtariffa = 1 ; $numtariffa <= $dati_tariffe['num'] ; $numtariffa = $numtariffa + 1) {
if ($tariffe_mostra[$numtariffa] == "SI") {
$tariffa = "tariffa".$numtariffa;
$nometariffa = $dati_tariffe[$tariffa]['nome'];
$nometariffa_vedi = $nometariffa;
if ($nometariffa == "") {
$nometariffa = $tariffa;
$nometariffa_vedi = $fr_tariffa.$numtariffa;
} # fine if ($nometariffa == "")
if ($n_tariffe_imposte[$numtariffa]) $nometariffa_imposta = $n_tariffe_imposte[$numtariffa];
else $nometariffa_imposta = $nometariffa_vedi;
if (${"numero_tariffa".$n_t} == $numtariffa) $selected = " selected";
else $selected = "";
echo "<option value=\"$numtariffa\"$selected>$nometariffa_imposta</option>";
} # fine if ($tariffe_mostra[$numtariffa] == "SI")
} # fine for $numtariffa
echo "</select>";
if ($framed) echo "$chiusura_tag_font</div>";
} # fine if (count($tariffe_mostra) != 1)
else echo "<input type=\"hidden\" name=\"numero_tariffa$n_t\" value=\"".key($tariffe_mostra)."\">";

if (!$framed) echo ".<br>$chiusura_tag_font</div>";

if ($chiedi_num_persone == "SI") {
if (!$framed) echo "<table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tr><td style=\"height: 10px;\"></td></tr><tr><td>$apertura_tag_font";
else echo "\n<div class=\"persnum\">$apertura_tag_font<span class=\"ftxt_phr\">";
echo "$fr_Numero_di $fr_persone";
if ($chiedi_num_app_tipologia == "SI" and $max_num_app_tipologia != 1) echo " $fr_per_ogni $fr_appartamento";
echo ":";
if ($framed) echo "</span>";
if ($max_num_persone == 0) echo "\n <input type=\"text\" name=\"numpersone$n_t\" size=\"2\" maxlength=\"2\" value=\"".${"numpersone".$n_t}."\">";
else {
echo " <select name=\"numpersone$n_t\">";
if (!${"numpersone".$n_t}) ${"numpersone".$n_t} = 2;
for ($num1 = 1 ; $num1 <= $max_num_persone ; $num1++) {
if (${"numpersone".$n_t} == $num1) $selected = " selected";
else $selected = "";
echo "<option value=\"$num1\"$selected>$num1</option>";
} # fine for $num1
echo "</select>";
} # fine else if ($max_num_persone == 0)
echo $chiusura_tag_font;
if (!$framed) echo "</td></tr></table>";
else echo "</div>";
} # fine if ($chiedi_num_persone == "SI")

if ($chiedi_num_app_tipologia == "SI" and $max_num_app_tipologia != 1) {
if (!$framed) echo "<table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tr><td style=\"height: 10px;\"></td></tr><tr><td>$apertura_tag_font";
else echo "\n<div class=\"persnum\">$apertura_tag_font<span class=\"ftxt_phr\">";
echo "$fr_Numero_di $fr_appartamenti:";
if ($framed) echo "</span>";
if (!${"num_app_tipo_richiesti".$n_t}) ${"num_app_tipo_richiesti".$n_t} = 1;
if ($max_num_app_tipologia == 0) echo "\n <input type=\"text\" name=\"num_app_tipo_richiesti$n_t\" size=\"2\" maxlength=\"2\" value=\"".${"num_app_tipo_richiesti".$n_t}."\">";
else {
echo " <select name=\"num_app_tipo_richiesti$n_t\">";
for ($num1 = 1 ; $num1 <= $max_num_app_tipologia ; $num1++) {
if (${"num_app_tipo_richiesti".$n_t} == $num1) $selected = " selected";
else $selected = "";
echo "<option value=\"$num1\"$selected>$num1</option>";
} # fine for $num1
echo "</select>";
} # fine else if ($max_num_app_tipologia == 0)
echo $chiusura_tag_font;
if (!$framed) {
echo "</td>";
if ($aggiungi_tipologie != "SI" or $n_t != $num_tipologie) echo "</tr></table>";
} # fine if (!$framed)
else echo "</div>";
} # fine if ($chiedi_num_app_tipologia == "SI" and $max_num_app_tipologia != 1)

if ($aggiungi_tipologie == "SI" and $n_t == $num_tipologie) {
if ($chiedi_num_app_tipologia != "SI" or $max_num_app_tipologia == 1) echo "<table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tr><td style=\"height: 10px;\"></td></tr><tr>";
if ($max_num_tipologie > $num_tipologie) {
if (!$framed) {
if ($num_tipologie > 1) echo "<td style=\"width: 20px;\"></td><td>";
else echo "<td style=\"width: 30px;\"></td><td>";
} # fine if (!$framed)
else echo "\n<div class=\"addremtype\">";
echo "$apertura_tag_font<input class=\"sbutton\" type=\"submit\" name=\"aggiungi_nuova_tipologia\" value=\"$fr_Aggiungi_una_nuova_tipologia\">$chiusura_tag_font";
if (!$framed) echo "</td>";
else echo "</div>";
} # fine if ($max_num_tipologie > $num_tipologie)
if ($num_tipologie > 1) {
if (!$framed) {
if ($max_num_tipologie > $num_tipologie) echo "<td style=\"width: 12px;\"></td><td>";
else echo "<td style=\"width: 30px;\"></td><td>";
} # fine if (!$framed)
else echo "<div class=\"addremtype\">";
echo "$apertura_tag_font<input class=\"sbutton\" type=\"submit\" name=\"elimina_ultima_tipologia\" value=\"$fr_Elimina_questa_tipologia\">$chiusura_tag_font";
if (!$framed) echo "</td>";
else echo "</div>";
} # fine if ($num_tipologie > 1)
if (!$framed) echo "</tr></table>";
} # fine if ($aggiungi_tipologie == "SI" and...

if ($mostra_costi_aggiuntivi == "SI" and $dati_ca['num'] > 0) {
$numcostiagg = 0;
unset($costi_agg_raggr);
unset($chiedi_combina);
if (!$framed) echo "<table><tr><td style=\"height: 10px;\"></td></tr></table>";
echo "<table class=\"extra_costs\">";
$distanza_colonne_costi_agg = 10;
$num_colonna = 0;
for ($numca = 0 ; $numca < $dati_ca['num'] ; $numca++) {
$idcostoagg = $dati_ca[$numca]['id'];
if ($costi_agg_mostra[$idcostoagg] == "SI" and $idcostoagg != $costo_aggiungi_letti) {
if ($dati_ca[$numca]['combina'] != "s") {
$numcostiagg++;
if ($n_costi_agg_imposti[$idcostoagg]) $nomecosto_imposto = $n_costi_agg_imposti[$idcostoagg];
else $nomecosto_imposto = $dati_ca[$numca]['nome'];
$nome_idcostoagg = "idcostoagg".$numcostiagg;
$num_colonna++;
if ($num_colonna == 1) echo "<tr>";
if (${$nome_idcostoagg."_".$n_t} == $idcostoagg and ${"costoagg".$numcostiagg."_".$n_t} == "SI") $checked = " checked";
else $checked = "";
echo "<td>$apertura_tag_font<input type=\"hidden\" name=\"idcostoagg$numcostiagg"."_$n_t\" value=\"$idcostoagg\">
<label><input type=\"checkbox\" id=\"ca_$numcostiagg"."_$n_t\" name=\"costoagg$numcostiagg"."_$n_t\" value=\"SI\"$checked>
 $nomecosto_imposto";
if ($dati_ca[$numca]['numsett'] == "c" and $dati_ca[$numca]['associasett'] == "n") {
$numsettimane = "numsettimane".$numcostiagg;
if (${$nome_idcostoagg."_".$n_t} == $idcostoagg and ${$numsettimane."_".$n_t}) $valnumsettimane = ${$numsettimane."_".$n_t};
else $valnumsettimane = 0;
echo " $fr_per </label>
<input type=\"text\" name=\"$numsettimane"."_$n_t\" size=\"3\" maxlength=\"3\" value=\"$valnumsettimane\"
 onclick=\"document.getElementById('ca_$numcostiagg"."_$n_t').checked='1';\"><label for=\"ca_$numcostiagg"."_$n_t\">
$fr_parola_settimane";
} # fine if ($dati_ca[$numca]['numsett'] == "c" and $dati_ca[$numca]['associasett'] == "n")
if ($dati_ca[$numca]['moltiplica'] == "c") {
$nummoltiplica_ca = "nummoltiplica_ca".$numcostiagg;
if (${$nome_idcostoagg."_".$n_t} == $idcostoagg and ${$nummoltiplica_ca."_".$n_t}) $valnummoltiplica_ca = ${$nummoltiplica_ca."_".$n_t};
else $valnummoltiplica_ca = 1;
echo " $fr_per: </label>";
if ($dati_ca[$numca]['molt_max'] != "n") echo "<input type=\"text\" name=\"$nummoltiplica_ca"."_$n_t\" value=\"$valnummoltiplica_ca\" size=\"3\" maxlength=\"3\"
 onclick=\"document.getElementById('ca_$numcostiagg"."_$n_t').checked='1';\">";
else {
echo "<select name=\"$nummoltiplica_ca"."_$n_t\" onclick=\"document.getElementById('ca_$numcostiagg"."_$n_t').checked='1';\">";
for ($num2 = 1 ; $num2 <= $dati_ca[$numca]['molt_max_num'] ; $num2++) {
if ($num2 == $valnummoltiplica_ca) $sel = " selected";
else $sel = "";
echo "<option value=\"$num2\"$sel>$num2</option>";
} # fine for $num2
echo "</select>";
} # fine else if ($dati_ca[$num1]['molt_max'] != "n")
echo "<label for=\"ca_$numcostiagg"."_$n_t\">";
} # fine if ($dati_ca[$numca]['moltiplica'] == "c")
echo ".</label>";
if ($num_colonna == $num_colonne_costi_agg) {
echo "$chiusura_tag_font</td></tr>";
$num_colonna = 0;
} # fine if ($num_colonna == $num_colonne_costi_agg)
else echo "$chiusura_tag_font</td><td style=\"width: $distanza_colonne_costi_agg"."px;\">&nbsp;</td>";
} # fine if ($dati_ca[$numca]['combina'] != "s")
else {
$testo_costo = "combina";
$categ = $dati_ca[$numca]['categoria'];
if ($dati_ca[$numca]['numsett'] == "c" and $dati_ca[$numca]['associasett'] == "n") $chiedi_combina[$categ]['sett'] = 1;
if ($dati_ca[$numca]['moltiplica'] == "c") {
if (!$chiedi_combina[$categ]['molt']) $chiedi_combina[$categ]['molt_max_num'] = $dati_ca[$numca]['molt_max_num'];
if ($dati_ca[$numca]['molt_max'] != "n") $chiedi_combina[$categ]['molt_max_num'] = 0;
elseif ($chiedi_combina[$categ]['molt_max_num'] and $chiedi_combina[$categ]['molt_max_num'] < $dati_ca[$numca]['molt_max_num']) $chiedi_combina[$categ]['molt_max_num'] = $dati_ca[$numca]['molt_max_num'];
$chiedi_combina[$categ]['molt'] = 1;
} # fine if ($dati_ca[$numca]['moltiplica'] == "c")
$costi_agg_raggr[$testo_costo."<>".$dati_ca[$numca]['categoria']] .= $dati_ca[$numca]['id'].",";
} # fine else if ($dati_ca[$numca]['combina'] != "s")
} # fine if ($costi_agg_mostra[$idcostoagg] == "SI" and $idcostoagg != $costo_aggiungi_letti)
} # fine for $numca

if (@is_array($costi_agg_raggr)) {
while (list($testo_costo,$id_costi) = each($costi_agg_raggr)) {
$testo_costo = explode("<>",$testo_costo);
$numcostiagg++;
$id_costi_vett = explode(",",substr($id_costi,0,-1));
$num_id_costi = count($id_costi_vett);
if ($testo_costo[0] == "combina") {
$num_colonna++;
$categoria = $testo_costo[1];
if (strcmp($cat_costi_agg_imposte[$categoria],"")) $categoria_vedi = htmlspecialchars($cat_costi_agg_imposte[$categ]);
else $categoria_vedi = htmlspecialchars($categoria);
if (${"costoagg".$numcostiagg."_".$n_t} == "SI") $checked = " checked";
else $checked = "";
echo "<td><input type=\"hidden\" name=\"idcostoagg$numcostiagg"."_$n_t\" value=\"c".htmlspecialchars($categoria)."\">
<label><input type=\"checkbox\" id=\"ca_$numcostiagg"."_$n_t\" name=\"costoagg$numcostiagg"."_$n_t\" value=\"SI\"$checked>
 $categoria_vedi";
if ($chiedi_combina[$categoria]['sett']) {
$numsettimane = "numsettimane".$numcostiagg;
if (${$numsettimane."_".$n_t}) $valnumsettimane = ${$numsettimane."_".$n_t};
else $valnumsettimane = 0;
echo " $fr_per </label>
<input type=\"text\" name=\"$numsettimane"."_$n_t\" size=\"3\" maxlength=\"3\" value=\"$valnumsettimane\"
 onclick=\"document.getElementById('ca_$numcostiagg"."_$n_t').checked='1';\"><label for=\"ca_$numcostiagg"."_$n_t\">
$fr_parola_settimane ";
} # fine if ($chiedi_combina[$categoria]['sett'])
if ($chiedi_combina[$categoria]['molt']) {
$nummoltiplica_ca = "nummoltiplica_ca".$numcostiagg;
if (${$nummoltiplica_ca."_".$n_t}) $valnummoltiplica_ca = ${$nummoltiplica_ca."_".$n_t};
else $valnummoltiplica_ca = 1;
echo " $fr_per: </label>";
if (!$chiedi_combina[$categoria]['molt_max_num']) echo "<input type=\"text\" name=\"$nummoltiplica_ca"."_$n_t\" size=\"3\" maxlength=\"3\" value=\"$valnummoltiplica_ca\"
 onclick=\"document.getElementById('ca_$numcostiagg"."_$n_t').checked='1';\"><label for=\"ca_$numcostiagg"."_$n_t\">";
else {
echo "<select name=\"$nummoltiplica_ca"."_$n_t\" onclick=\"document.getElementById('ca_$numcostiagg"."_$n_t').checked='1';\">";
for ($num2 = 1 ; $num2 <= $chiedi_combina[$categoria]['molt_max_num'] ; $num2++) {
if ($num2 == $valnummoltiplica_ca) $sel = " selected";
else $sel = "";
echo "<option value=\"$num2\"$sel>$num2</option>";
} # fine for $num2
echo "</select>";
} # fine else if (!$chiedi_combina[$categoria]['molt_max_num'])
echo "<label for=\"ca_$numcostiagg"."_$n_t\">";
} # fine if ($chiedi_combina[$categoria]['molt'])
echo ".</label>";
if ($num_colonna == $num_colonne_costi_agg) {
echo "$chiusura_tag_font</td></tr>";
$num_colonna = 0;
} # fine if ($num_colonna == $num_colonne_costi_agg)
else echo "$chiusura_tag_font</td><td style=\"width: $distanza_colonne_costi_agg"."px;\">&nbsp;</td>";
} # fine if ($testo_costo[0] == "combina")
} # fine while (list($testo_costo,$id_costi) = each($costi_agg_raggr))
} # fine if (@is_array($costi_agg_raggr))

if ($num_colonna != 0) {
for ($num1 = $num_colonna ; $num1 < $num_colonne_costi_agg ; $num1++) {
$num_colonna++;
if ($num_colonna == $num_colonne_costi_agg) echo "<td>&nbsp;</td></tr>";
else echo "<td>&nbsp;</td><td style=\"width: $distanza_colonne_costi_agg"."px;\">&nbsp;</td>";
} # fine for $num1
} # fine if ($num_colonna != 0)
echo "</table>
<input type=\"hidden\" name=\"numcostiagg$n_t\" value=\"".$numcostiagg."\">";
} # fine if ($mostra_costi_aggiuntivi == "SI" and...

} # fine for $n_t

echo "<input type=\"hidden\" name=\"num_tipologie\" value=\"$num_tipologie\">";
if (!$framed) echo "<table><tr><td style=\"height: 7px;\"></td></tr></table><div style=\"text-align: center;\">";
else echo "<div class=\"submit_check\">";
echo "$apertura_tag_font
<input class=\"sbutton\" type=\"submit\" name=\"contr_disp\" value=\"$fr_Controlla_la_disponibilita\">
$chiusura_tag_font";
if (!$framed) echo "</div>";
else echo "</div>";
echo "</div></form>";

} # fine if ($mostra_form != "NO")


if ($framed) {
echo "
</body>
</html>
";
} # fine if ($framed)



###########################################
###  FINE ./includes/templates/modello_disponibilita.php 
###########################################

if (!$framed) {
?>


<!-- BEGINNING OF THE SECOND PART OF CUSTOM HTML  -->





<br></td></tr></table>
</td></tr></table>

<small><small>Powered by 
<a href="http://www.hoteldruid.com" style="color: #000000;">
HotelDruid booking software</a></small></small></div>

</body>
</html>
<!-- END OF THE SECOND PART OF CUSTOM HTML  --><?php } # fine if (!$framed) ?>